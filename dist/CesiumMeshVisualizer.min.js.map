{"version":3,"sources":["node_modules/browser-pack/_prelude.js","Source/Core/ArrowGeometry.js","Source/Core/BasicGeometry.js","Source/Core/BasicMeshMaterial.js","Source/Core/FramebufferTexture.js","Source/Core/GeometryUtils.js","Source/Core/LOD.js","Source/Core/MaterialUtils.js","Source/Core/Mesh.js","Source/Core/MeshMaterial.js","Source/Core/MeshPhongMaterial.js","Source/Core/MeshUtils.js","Source/Core/MeshVisualizer.js","Source/Core/PlaneBufferGeometry.js","Source/Core/PlaneGeometry.js","Source/Core/ReferenceMesh.js","Source/Core/RendererUtils.js","Source/Core/Rotation.js","Source/Core/ShaderUtils.js","Source/Core/Shaders/ShaderChunk.js","Source/Core/Shaders/ShaderLib.js","Source/Core/Shaders/normals_frag.js","Source/Core/Shaders/texture_frag.js","Source/Main.js","Source/ThirdParty/csg/csg.js","Source/ThirdParty/tiff-js/tiff.js","Source/Util/CSG.js","Source/Util/Path.js","Source/Util/defineProperty.js"],"names":["f","exports","module","define","amd","g","window","global","self","this","CesiumMeshVisualizer","r","e","n","t","o","i","c","require","u","a","Error","code","p","call","length","1","ArrowGeometry","options","Cesium","defaultValue","width","headLength","headWidth","reverse","_GeometryUtils","createGeometry","arrowGeometry","arrow","line","CylinderGeometry","topRadius","bottomRadius","_GeometryUtils2","default","translate","mergeGeometries","BasicGeometry","positions","normals","uvs","indices","basicGeometry","Int32Array","attributes","position","GeometryAttribute","componentDatatype","ComponentDatatype","DOUBLE","componentsPerAttribute","values","Float32Array","normal","FLOAT","uv","bs","BoundingSphere","fromVertices","Geometry","primitiveType","PrimitiveType","TRIANGLES","boundingSphere","BasicMeshMaterial","uniforms","ambientColor","emissionColor","diffuseColor","specularColor","specularShininess","alpha","undefined","ambientColorMap","emissionColorMap","diffuseColorMap","specularColorMap","specularShininessMap","normalMap","alphaMap","side","_MeshMaterial2","Sides","FRONT","apply","blendEnable","withTexture","withNormals","depthTest","depthMask","blending","toLowerCase","extension","_Path2","GetExtension","translucent","slice","HTMLCanvasElement","HTMLVideoElement","defined","flipY","sampler","magnificationFilter","WebGLConstants","LINEAR","minificationFilter","NEAREST_MIPMAP_LINEAR","wrapS","REPEAT","wrapT","vertexShaderUri","fragmentShaderUri","_ShaderChunk2","texture_normals_vert","texture_normals_frag","texture_vert","texture_frag","normals_vert","normals_frag","none_vert","none_frag","vertexShader","fragmentShader","_MeshMaterial","_ShaderChunk","_Path","prototype","Object","create","FramebufferTexture","mesh","renderTarget","depthTexture","texture","framebuffer","ready","readyPromise","when","defer","Framebuffer","_colorTextures","_depthTexture","resolve","destroyAttachments","destroy","GeometryUtils","getAttrs","geo","attrNames","name","hasOwnProperty","push","initConstants","constantsHasInit","scratchPosition","Cartesian3","scratchMatrix4","Matrix4","scratchRotation","Matrix3","scratchOffset","normalizeNormals","geometry","x","y","z","Math","sqrt","geometries","valueArrs","valueTypes","valueConstructors","valueComponents","valueNormalizes","valueOffsets","indexOffst","componentCounts","_attrName","attr","constructor","normalize","_geometry","j","_attrName2","_j","_i","_geometry2","ai","attrName","valueArr","attrValues","set","_j2","index","_i2","Uint16Array","Uint32Array","_CSG","rotateX","angle","fromRotationX","fromRotationTranslation","ZERO","multiplyByPoint","rotateY","fromRotationY","rotateZ","fromRotationZ","computeVertexNormals","il","array","vA","vB","vC","pA","pB","pC","cb","ab","fromArray","subtract","cross","needsUpdate","geometriesAttrs","lengthChanged","primitiveTypeChanged","lastGeoAttrs","offset","Array","isArray","clone","getAttributeComponentType","attributeComponentType","SHORT","Int8Array","BYTE","Uint8Array","Uint8ClampedArray","UNSIGNED_BYTE","Int16Array","UNSIGNED_SHORT","INT","UNSIGNED_INT","Float64Array","isGeometry3js","THREE","BufferGeometry","vertices","faces","parseBufferGeometry3js","computeFaceNormals","getAttribute","itemSize","normalized","groups","forEach","group","count","start","fromGeometry3js","geometry3js","fromGeometry","GeometryPipeline","computeNormal","toGeometry3js","positionIdx","Vector3","idx1","idx2","idx3","Face3","toCSG","_toCSG3js","_CSG2","polygons","normalIdx","Vertex","Polygon","fromPolygons","fromCSG","csg_model","_fromCSG3js","toPolygons","getGeometryVertice","pos","plane","pop","three_model","rotation","rotation_matrix","Mesh","Euler","makeRotationFromEuler","add","applyMatrix4","b","Face4","d","face","three_geometry","_getGeometryVertice3js","copy","faceVertexUvs","Vector2","computeBoundingBox","vertice_position","LOD","uuid","createGuid","show","maxAvailableDistance","Number","MAX_VALUE","_position","_scale","scale","_rotation","axis","_Rotation2","_boundingSphere","_needsUpdate","_modelMatrixNeedsUpdate","_modelMatrix","IDENTITY","_onNeedUpdateChanged","paramChanged","removeEventListener","_children","_parent","type","defineProperties","levels","enumerable","value","removeByValue","arr","val","splice","_Rotation","_RendererUtils","setPosition","changed","arguments","setScale","addLevel","object","distance","abs","l","parent","radius","update","parentModelMatrix","frameState","_RendererUtils2","computeModelMatrix","modelMatrix","getTranslation","center","max","camera","positionWC","cullingVolume","computeVisibility","Intersect","OUTSIDE","getObjectForDistance","get","children","_needUpdate","addEventListener","MaterialUtils","cloneUniforms","uniforms3js","bindUniformValue","refreshUniformsCommon","material","opacity","diffuse","color","emissive","val3js","multiplyScalar","emissiveIntensity","map","specularMap","lightMap","lightMapIntensity","aoMap","aoMapIntensity","uvScaleMap","displacementMap","bumpMap","roughnessMap","metalnessMap","emissiveMap","isWebGLRenderTarget","repeat","offsetRepeat","envMap","flipEnvMap","isCubeTexture","reflectivity","refractionRatio","refreshUniformsLine","refreshUniformsDash","dashSize","totalSize","gapSize","refreshUniformsPoints","size","_pixelRatio","_height","refreshUniformsLambert","refreshUniformsPhong","specular","shininess","bumpScale","normalScale","displacementScale","displacementBias","refreshUniformsToon","gradientMap","refreshUniformsStandard","roughness","metalness","envMapIntensity","refreshUniformsPhysical","clearCoat","clearCoatRoughness","refreshUniformsNormal","valCesium","_typeof","Cartesian2","Vector4","Cartesian4","Color","Texture","image","console","log","shaderIDs","MeshDepthMaterial","MeshNormalMaterial","MeshBasicMaterial","MeshLambertMaterial","MeshPhongMaterial","MeshToonMaterial","MeshStandardMaterial","MeshPhysicalMaterial","LineBasicMaterial","LineDashedMaterial","PointsMaterial","fromMaterial3js","material3js","shaderID","shader","ShaderLib","updateMaterialFrom3js","materialWidth3js","transparent","wireframe","m_uniforms","isMeshBasicMaterial","isMeshLambertMaterial","isMeshPhongMaterial","isMeshStandardMaterial","isMeshNormalMaterial","isMeshDepthMaterial","isLineBasicMaterial","isLineDashedMaterial","isPointsMaterial","isMeshToonMaterial","isMeshPhysicalMaterial","ambientLightColor","isMaterial3js","Material","isGeometrySupported","instances","instancedAttributes","_material","quaternion","modelMatrixNeedsUpdate","_drawCommand","_instances","_center","instance","addInstance","userData","_MeshPhongMaterial2","addReference","_MeshPhongMaterial","primitive","id","instanceId","traverse","node","callback","child","removeReference","destroyObject","MeshMaterial","initUniform","srcUniforms","_uniforms","item","_disposeCallbacks","onDispose","disposeCallback","indexOf","_defineProperty2","owner","onPropertyChanged","that","referenceCount","_uuid","_defaultColor","defaultColor","WHITE","fromCssColorString","_pickedColor","pickedColor","YELLOW","_picked","picked","uniformStateUsed","uniformStateName","glslVarName","_vertexShader","_fragmentShader","allowPick","pickColorQualifier","_defineProperty","BACK","key","emission","_phong_vert2","_phong_frag2","_phong_frag","_phong_vert","MeshUtils","_MaterialUtils","_Mesh","fromMesh3js","mesh3js","isMesh3js","_MaterialUtils2","_Mesh2","DrawCommand","BufferUsage","BlendingState","VertexArray","ShaderProgram","DepthFunction","CullFace","RenderState","PixelFormat","CesiumMath","Buffer","loadArrayBuffer","Resource","fetchArrayBuffer","loadImage","fetchImage","src","Quaternion","w","scratchMatrix","world2localMatrix","surfacePointLocal","rayDir","rayOriginLocal","scratchRay","Ray","getVertexBufferTypedArray","collection","_availableInstances","instancesLength","collectionCenter","bufferData","_vertexBufferTypedArray","instanceMatrix","getPickIdBufferTypedArray","context","pickIdBuffer","_pickIdBufferTypedArray","pickId","_pickIds","createPickId","pickColor","floatToByte","red","green","blue","getInstancedAttribTypedArray","instancedAttribute","isColorValue","createInstancedAttributes","vertexArrayAttributes","attributeLocations","maxAttribLocation","buffer","createVertexBuffer","typedArray","usage","STATIC_DRAW","_buffer","attribute","vertexBuffer","offsetInBytes","strideInBytes","instanceDivisor","_pickIdBuffer","vertexBufferTypedArray","_vertexBuffer","copyFromBufferView","arrayView","gl","_gl","target","_bufferTarget","bindBuffer","DYNAMIC_DRAW","updateVertexBuffer","pickIdBufferTypedArray","bufferTypedArray","createPickIds","pickIds","MeshVisualizer","_actualModelMatrix","_ready","_isWireframe","_up","up","onModelMatrixNeedUpdate","_chidren","_debug","_show","_framebufferTextures","_uniformValueCache","_textureCache","_uniformMaps","referenceMesh","_ReferenceMesh2","axisParameter","referenceAxisParameter","showReference","beforeUpdate","Event","_scene","scene","_FramebufferTexture","_LOD","_ReferenceMesh","_tiff","_MeshUtils","_ShaderUtils","remove","freeDrawCommand","cmd","vertexArray","shaderProgram","freeMesh","_pickCommand","_textureCommand","_actualMesh","actualMesh","pickPosition","windowPosition","result","worldCoordinatesToLocal","getPickRay","direction","origin","worldCoordinates","inverseTransformation","localToWorldCoordinates","localCoordinates","toWireframe","TRIANGLE_FAN","TRIANGLE_STRIP","triangleIndices","restoreFromWireframe","POINTS","createBoundingSphere","points","fromPoints","createDrawCommand","pickObject","command","cull","instanceCount","pass","Pass","TRANSLUCENT","OPAQUE","createAttributeLocations","location","componentSizeInBytes","getSizeInBytes","czm_modelMatrixRow0","czm_modelMatrixRow1","czm_modelMatrixRow2","a_pickColor","bufferUsage","_cacehVertexArrayAttributes","_attributeLocations","getFragmentShaderSource","getVertexShaderSource","_ShaderUtils2","processShader3js","vs","ShaderSource","replaceMain","sources","fs","fragmentDepth","defines","_sp","fromCache","fragmentShaderSource","vertexShaderSource","renderState","getRenderState","_renderStateOptions","uniformMap","getUniformMap","czm_pickColor","czm_instanced_modifiedModelView","getModifiedModelViewCallback","pickCommand","pickOnly","cullFrustum","_pickSP","replaceCache","executeInClosestFrustum","_rtcTransform","_rtcModelView","multiplyByTranslation","multiply","uniformState","view","getRenderState_old","ALPHA_BLEND","DISABLED","enabled","func","GREATER","depthRange","near","far","colorMask","renderStateOpts","LESS","getCubeTextureCallback","mtl","allLoaded","isLoading","promises","HTMLImageElement","deferred","requestAnimationFrame","all","images","CubeMap","source","positiveX","negativeX","positiveY","negativeY","positiveZ","negativeZ","defaultCubeMap","defaultTextureImage","document","createElement","height","createTexture","TextureMinificationFilter","TextureWrap","mipmap","NEAREST_MIPMAP_NEAREST","LINEAR_MIPMAP_NEAREST","LINEAR_MIPMAP_LINEAR","requiresNpot","MIRRORED_REPEAT","npot","isPowerOfTwo","canvas","nextPowerOfTwo","getContext","drawImage","tx","TEXTURE_2D","pixelFormat","internalFormat","pixelDatatype","generateMipmap","onTextureImageLoaded","tex","arrayBufferView","bufferView","format","RGB","toLocaleLowerCase","RGBA","Sampler","getTextureCallback","cacheKey","url","then","imageArrayBuffer","tiffParser","_tiff2","tiffCanvas","parseTIFF","otherwise","err","defaultTexture","uniformMaps","cameraPosition","u_cameraPosition","u_normalMatrix","u_projectionMatrix","projection","u_modelViewMatrix","modelView","normalMatrix","projectionMatrix","modelViewMatrix","model","u_modelMatrix","u_viewMatrix","viewMatrix","logDepthBufFC","frustum","LN2","isImageUrl","isCssColorString","itemLowerCase","endsWith","startsWith","Matrix2","isColor","isCartesian2","isCartesian3","isCartesian4","_FramebufferTexture2","_renderToTextureCommands","innerUniforms","userDefine","glsl","attrs","parseIncludes","_computeModelMatrix","_LOD2","raiseEvent","wireframeChanged","sysWireframe","_globe","_surface","tileProvider","debug","yUp2Zup","_oldScale","_oldPosition","_MeshUtils2","pn","attrLocation","vb","_attributes","indexNeedsUpdate","indexBuffer","boundingVolume","passes","pick","commandList","_geometryChanged","initFrameBufferTexture","frameBufferTexture","viewport","drawCommands","getIndex","vaNeedsUpdate","_sizeInBytes","BYTES_PER_ELEMENT","createIndexBuffer","indexDatatype","IndexDatatype","_indexBuffer","drawingBufferWidth","drawingBufferHeight","fbNeedsUpdate","notFullScreen","_notFullScreen","DEPTH_COMPONENT","updateFrameBufferTexture","renderToTexture","getPixels","readState","pixels","_canvas","_computeTexture","PixelDatatype","getExtension","DeveloperError","traverseFunc","visibleOnly","scratchTraverseArgs","cancelCurrent","cancelAll","visible","widthSegments","heightSegments","planeBufferGeometry","width_half","gridY","floor","gridX1","gridX","gridY1","segment_width","iy","segment_height","height_half","ix","PlaneGeometry","planeGeometry","positionsVal","_axisParameter","_ArrowGeometry2","_axisParameterY","materialX","axisLine","axisLineY","meshY","materialY","meshX","meshZ","defineProperty","_ArrowGeometry","_interopRequireDefault","ReferenceMesh","RendererUtils","validateFramebuffer","status","checkFramebufferStatus","FRAMEBUFFER","FRAMEBUFFER_COMPLETE","message","FRAMEBUFFER_INCOMPLETE_ATTACHMENT","FRAMEBUFFER_INCOMPLETE_DIMENSIONS","FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT","FRAMEBUFFER_UNSUPPORTED","_currentFramebuffer","WebGLRenderingContext","scratchBackBufferArray","_bind","buffers","_getActiveColorAttachments","drawCommand","outputTexture","outputDepthTexture","colorTextures","clearCommandScratch","ClearCommand","clearCommand","renderToPixels","execute","readPixels","assign","bindFramebuffer","ALPHA","scratchPixelFormat","scratchPixelDatatype","multiplyTransformation","srcMatrix","yUpToZUp","dstMatrix","srcModelMatrix","translation","outModelMatrix","scratchTranslation","scratchQuaternion","scratchScale","scratchTranslationQuaternionRotationScale","fromAxisAngle","Rotation","_axis","_angle","18","ShaderUtils","WebGLProgram","ShaderChunk","BackSide","DoubleSide","FlatShading","CubeUVRefractionMapping","CubeUVReflectionMapping","GammaEncoding","LinearEncoding","NoToneMapping","AddOperation","MixOperation","MultiplyOperation","EquirectangularRefractionMapping","CubeRefractionMapping","SphericalReflectionMapping","EquirectangularReflectionMapping","CubeReflectionMapping","PCFShadowMap","Uncharted2ToneMapping","RGBDEncoding","RGBM16Encoding","obj","__esModule","_none_frag","_none_vert","_normals_frag","_normals_vert","_texture_frag","_texture_vert2","_texture_vert","_texture_normals_frag","_texture_normals_frag2","_texture_normals_vert","_texture_normals_vert2","alphamap_fragment","alphamap_pars_fragment","alphatest_fragment","aomap_fragment","aomap_pars_fragment","begin_vertex","beginnormal_vertex","bsdfs","bumpmap_pars_fragment","clipping_planes_fragment","clipping_planes_pars_fragment","clipping_planes_pars_vertex","clipping_planes_vertex","color_fragment","color_pars_fragment","color_pars_vertex","color_vertex","common","cube_uv_reflection_fragment","defaultnormal_vertex","displacementmap_pars_vertex","displacementmap_vertex","emissivemap_fragment","emissivemap_pars_fragment","encodings_fragment","encodings_pars_fragment","envmap_fragment","envmap_pars_fragment","envmap_pars_vertex","envmap_vertex","fog_vertex","fog_pars_vertex","fog_fragment","fog_pars_fragment","gradientmap_pars_fragment","lightmap_fragment","lightmap_pars_fragment","lights_lambert_vertex","lights_pars","lights_phong_fragment","lights_phong_pars_fragment","lights_physical_fragment","lights_physical_pars_fragment","lights_template","logdepthbuf_fragment","logdepthbuf_pars_fragment","logdepthbuf_pars_vertex","logdepthbuf_vertex","map_fragment","map_pars_fragment","map_particle_fragment","map_particle_pars_fragment","metalnessmap_fragment","metalnessmap_pars_fragment","morphnormal_vertex","morphtarget_pars_vertex","morphtarget_vertex","normal_flip","normal_fragment","normalmap_pars_fragment","packing","premultiplied_alpha_fragment","project_vertex","dithering_fragment","dithering_pars_fragment","roughnessmap_fragment","roughnessmap_pars_fragment","shadowmap_pars_fragment","shadowmap_pars_vertex","shadowmap_vertex","shadowmask_pars_fragment","skinbase_vertex","skinning_pars_vertex","skinning_vertex","specularmap_fragment","specularmap_pars_fragment","tonemapping_fragment","tonemapping_pars_fragment","uv_pars_fragment","uv_pars_vertex","uv_vertex","uv2_pars_fragment","uv2_pars_vertex","uv2_vertex","worldpos_vertex","cube_frag","cube_vert","depth_frag","depth_vert","distanceRGBA_frag","distanceRGBA_vert","equirect_frag","equirect_vert","linedashed_frag","linedashed_vert","meshbasic_frag","meshbasic_vert","meshlambert_vert","meshphong_frag","meshphong_vert","meshphysical_frag","meshphysical_vert","normal_frag","normal_vert","points_frag","points_vert","shadow_vert","_none_frag2","_normals_frag2","_texture_frag2","replace","match","include","UniformsLib","aomap","bumpmap","normalmap","displacementmap","roughnessmap","metalnessmap","gradientmap","fog","fogDensity","fogFar","lights","directionalLights","properties","shadow","shadowBias","shadowRadius","shadowMapSize","directionalShadowMatrix","spotLights","coneCos","decay","spotShadowMap","spotShadowMatrix","pointLights","pointShadowMap","pointShadowMatrix","hemisphereLights","skyColor","groundColor","UniformsUtils","merge","merged","uniforms_src","uniforms_dst","parameter_src","basic","lightmap","lambert","emissivemap","meshlambert_frag","phong","standard","depth","equirect","tEquirect","tFlip","lightPos","29","30","31","CSG","PlaneBufferGeometry","_MeshVisualizer","_MeshVisualizer2","_PlaneGeometry","_PlaneGeometry2","_BasicMeshMaterial","_BasicGeometry","_BasicGeometry2","_ShaderLib","_ShaderLib2","_PlaneBufferGeometry","_PlaneBufferGeometry2","_BasicMeshMaterial2","MeshVisualizerVERSION","csg","union","Node","clipTo","invert","build","allPolygons","intersect","inverse","flip","info","Vector","theta","PI","dir","cos","sin","phi","plus","times","slices","stacks","vertex","cylinder","point","stack","normalBlend","out","axisX","axisY","s","ray","axisZ","end","minus","unit","isY","negated","t0","t1","dividedBy","dot","interpolate","other","lerp","Plane","EPSILON","splitPolygon","polygon","coplanarFront","coplanarBack","front","back","polygonType","types","ti","tj","vj","vi","v","shared","temp","clipPolygons","bsp","concat","33","TIFFParser","littleEndian","fileDirectories","BOM","getBytes","TypeError","hasTowel","RangeError","258","265","320","33432","338","266","289","288","291","290","270","257","271","281","272","274","262","284","278","305","273","263","283","326","327","328","434","336","346","285","297","319","532","339","559","330","292","325","323","324","322","318","344","529","531","530","345","40961","36868","36867","34665","36864","41728","37385","40960","33437","42016","37384","37500","37510","33723","700","42112","42113","34377","fieldTag","fieldTagNames","fieldTypeNames","2","3","4","5","7","8","9","11","12","fieldType","fieldTypeName","getFieldTypeLength","fieldTypeLength","bitOffset","extraBytes","newByteOffset","byteOffset","totalBits","numBits","shiftRight","shiftLeft","rawBits","tiffDataView","getUint16","getUint32","numBytes","getUint8","fieldValues","fieldValueSize","typeCount","valueOffset","indexOffset","String","fromCharCode","multiplier","pow","bitsPerSample","makeRGBAFillValue","numDirEntries","tiffFields","entryCount","fieldTagName","getFieldTagName","getFieldTypeName","getFieldValues","nextIFDByteOffset","parseFileDirectory","tiffArrayBuffer","DataView","isLittleEndian","firstIFDByteOffset","fileDirectory","imageWidth","ImageWidth","imageLength","strips","samplesPerPixel","SamplesPerPixel","sampleProperties","hasBytesPerPixel","BitsPerSample","bitsPerSampleValues","hasBytesPerSample","bitsPerPixel","bytesPerPixel","stripOffsetValues","StripOffsets","numStripOffsetValues","stripByteCountValues","StripByteCounts","ceil","jIncrement","getHeader","pixel","sample","currentSample","stripByteCount","compression","m","sampleInfo","header","getInt8","stripOffset","iterations","currentByte","blockLength","ctx","fillStyle","rowsPerStrip","RowsPerStrip","ExtraSamples","extraSamplesValues","colorMapValues","ColorMap","colorMapSampleSize","numStrips","numRowsInStrip","rowsInLastStrip","numPixels","pixelSamples","numExtraSamples","k","invertValue","bytesPerSample","colorMapIndex","clampColorSample"],"mappings":"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","file":"CesiumMeshVisualizer.min.js","sourcesContent":["(function(){function r(e,n,t){function o(i,f){if(!n[i]){if(!e[i]){var c=\"function\"==typeof require&&require;if(!f&&c)return c(i,!0);if(u)return u(i,!0);var a=new Error(\"Cannot find module '\"+i+\"'\");throw a.code=\"MODULE_NOT_FOUND\",a}var p=n[i]={exports:{}};e[i][0].call(p.exports,function(r){var n=e[i][1][r];return o(n||r)},p,p.exports,r,e,n,t)}return n[i].exports}for(var u=\"function\"==typeof require&&require,i=0;i<t.length;i++)o(t[i]);return o}return r})()","﻿ \r\nimport GeometryUtils from './GeometryUtils.js'\r\n/**\r\n*\r\n  <pre><code>  \r\n          +            ——\r\n        +   +           |\r\n      +       +     headLength\r\n    +           +       |\r\n  ++++headWidth++++   ——\r\n        +  +            |\r\n        +  +            |\r\n        +  +            |\r\n        +  +          length\r\n        +  +            |\r\n        +  +            |\r\n        +  +            |\r\n        ++++           ——\r\n        width\r\n\r\n    </code> </pre>\r\n*@param {Object}[options] \r\n*@param {Number}[options.length=50000]   \r\n*@param {Number}[options.width=250]   \r\n*@param {Number}[options.headLength=5000]   \r\n*@param {Number}[options.headWidth=1000]    \r\n*@param {Boolean}[options.reverse=false]   \r\n* \r\n*@property {Number}length   \r\n*@property {Number}width   \r\n*@property {Number}headLength   \r\n*@property {Number}headWidth   \r\n*@property {Boolean}reverse  \r\n*\r\n*@constructor\r\n*@memberof Cesium\r\n*/\r\nfunction ArrowGeometry(options) {\r\n    options = Cesium.defaultValue(options, {});\r\n    this.length = Cesium.defaultValue(options.length, 50000);\r\n    this.width = Cesium.defaultValue(options.width, 125);\r\n    this.headLength = Cesium.defaultValue(options.headLength, 5000);\r\n    this.headWidth = Cesium.defaultValue(options.headWidth, 1000);\r\n    this.reverse = Cesium.defaultValue(options.reverse, false);\r\n}\r\n\r\n/**\r\n*\r\n*@param {Cesium.ArrowGeometry}\r\n*@return {Cesium.Geometry}\r\n*/\r\nArrowGeometry.createGeometry = function (arrowGeometry) {\r\n    var length = arrowGeometry.length;\r\n    var width = arrowGeometry.width;\r\n    var headLength = arrowGeometry.headLength;\r\n    var headWidth = arrowGeometry.headWidth;\r\n    var reverse = arrowGeometry.reverse;\r\n\r\n    var line = Cesium.CylinderGeometry.createGeometry(new Cesium.CylinderGeometry({\r\n        length: length,\r\n        topRadius: width,\r\n        bottomRadius: width,\r\n    }));\r\n    var arrow;\r\n    if (reverse) {\r\n        arrow = Cesium.CylinderGeometry.createGeometry(new Cesium.CylinderGeometry({\r\n            length: headLength,\r\n            topRadius: headWidth,\r\n            bottomRadius: 0,\r\n        }));\r\n        GeometryUtils.translate(arrow, [0, 0, -(length + headLength) / 2]);\r\n    } else {\r\n        arrow = Cesium.CylinderGeometry.createGeometry(new Cesium.CylinderGeometry({\r\n            length: headLength,\r\n            topRadius: 0,\r\n            bottomRadius: headWidth,\r\n        }));\r\n        GeometryUtils.translate(arrow, [0, 0, (length + headLength) / 2]);\r\n    }\r\n\r\n    var lineWithArrow = GeometryUtils.mergeGeometries([line, arrow]);\r\n\r\n    return lineWithArrow;\r\n}\r\nexport default ArrowGeometry;","﻿ \r\n/**\r\n*\r\n*@param {Object}options\r\n*@param {Array<Number>|Float32Array}options.positions\r\n*@param {Array<Number>|Int32Array}options.indices\r\n*@param {Array<Number>|Float32Array}[options.normals]\r\n*@param {Array<Number>|Float32Array}[options.uvs]\r\n*\r\n*@memberof Cesium\r\n*@constructor\r\n*/\r\nfunction BasicGeometry(options) {\r\n    this.positions = options.positions;\r\n    this.normals = options.normals;\r\n    this.uvs = options.uvs;\r\n    this.indices = options.indices;\r\n}\r\n/**\r\n*\r\n*@param {Cesium.BasicGeometry}basicGeometry\r\n*@return {Cesiumm.Geometry} \r\n*/\r\nBasicGeometry.createGeometry = function (basicGeometry) {\r\n    if (!basicGeometry.positions) {\r\n        throw new Error(\"缺少positions参数\");\r\n    }\r\n    if (!basicGeometry.indices) {\r\n        throw new Error(\"缺少indices参数\");\r\n    }\r\n    var positions = basicGeometry.positions;\r\n    var normals = basicGeometry.normals;\r\n    var uvs = basicGeometry.uvs;\r\n    var indices = basicGeometry.indices instanceof Int32Array ? basicGeometry.indices : new Int32Array(basicGeometry.indices);\r\n\r\n    var attributes = {\r\n        position: new Cesium.GeometryAttribute({\r\n            componentDatatype: Cesium.ComponentDatatype.DOUBLE,\r\n            componentsPerAttribute: 3,\r\n            values: positions instanceof Float32Array ? positions : new Float32Array(basicGeometry.positions)\r\n        })\r\n    };\r\n    if (normals) {\r\n        attributes.normal = new Cesium.GeometryAttribute({\r\n            componentDatatype: Cesium.ComponentDatatype.FLOAT,\r\n            componentsPerAttribute: 3,\r\n            values: normals instanceof Float32Array ? normals : new Float32Array(normals)\r\n        })\r\n    }\r\n    if (uvs) {\r\n        attributes.uv = new Cesium.GeometryAttribute({\r\n            componentDatatype: Cesium.ComponentDatatype.FLOAT,\r\n            componentsPerAttribute: 2,\r\n            values: uvs instanceof Float32Array ? uvs : new Float32Array(uvs)\r\n        })\r\n    }\r\n\r\n\r\n    var bs = Cesium.BoundingSphere.fromVertices(positions);\r\n    var geo = new Cesium.Geometry({\r\n        attributes: attributes,\r\n        indices: new Int32Array(indices),\r\n        primitiveType: Cesium.PrimitiveType.TRIANGLES,\r\n        boundingSphere: bs\r\n    });\r\n    return geo;\r\n}\r\nexport default BasicGeometry;","﻿\r\nimport MeshMaterial from './MeshMaterial.js';\r\nimport ShaderChunk from './Shaders/ShaderChunk.js';\r\nimport Path from '../Util/Path.js';\r\n\r\nfunction BasicMeshMaterial(options) {\r\n    options = options ? options : {};\r\n\r\n    options.uniforms = options.uniforms ? options.uniforms : {\r\n        ambientColor: [0, 0, 0, 1.0],               // Ka\r\n        emissionColor: [0, 0, 0, 1.0],              // Ke\r\n        diffuseColor: [0, 0, 0, 1.0],               // Kd\r\n        specularColor: [0, 0, 0, 1.0],              // Ks\r\n        specularShininess: 0,          // Ns\r\n        alpha: undefined,                      // d / Tr\r\n        ambientColorMap: undefined,            // map_Ka\r\n        emissionColorMap: undefined,           // map_Ke\r\n        diffuseColorMap: undefined,            // map_Kd\r\n        specularColorMap: undefined,           // map_Ks\r\n        specularShininessMap: undefined,       // map_Ns\r\n        normalMap: undefined,                  // map_Bump\r\n        alphaMap: undefined                    // map_d\r\n    };\r\n    options.uniforms.ambientColor = Cesium.defaultValue(options.uniforms.ambientColor, [0, 0, 0, 1.0]);\r\n    options.uniforms.emissionColor = Cesium.defaultValue(options.uniforms.emissionColor, [0, 0, 0, 1.0]);\r\n    options.uniforms.diffuseColor = Cesium.defaultValue(options.uniforms.diffuseColor, [0, 0, 0, 1.0]);\r\n    options.uniforms.specularColor = Cesium.defaultValue(options.uniforms.specularColor, [0, 0, 0, 1.0]);\r\n    options.uniforms.alpha = Cesium.defaultValue(options.uniforms.alpha, 1);\r\n    options.uniforms.specularShininess = Cesium.defaultValue(options.uniforms.specularShininess, 0);\r\n    options.side = Cesium.defaultValue(options.side, MeshMaterial.Sides.FRONT)\r\n\r\n    MeshMaterial.apply(this, [options]);\r\n    this.blendEnable = false;\r\n    var withTexture = options.withTexture;\r\n    var withNormals = options.withNormals;\r\n    this.depthTest = true;\r\n    this.depthMask = true;\r\n    this.blending = true;\r\n    if (options.uniforms.diffuseColorMap) {//&& options.uniforms.diffuseColorMap.toLowerCase().indexOf(\".png\")) {\r\n\r\n        if (typeof options.uniforms.diffuseColorMap === 'string') {\r\n            var diffuseColorMap = options.uniforms.diffuseColorMap.toLowerCase();\r\n            var extension = Path.GetExtension(diffuseColorMap);\r\n            if (extension == \".tif\" || extension == \".png\") {\r\n                this.translucent = true;\r\n            } else if (diffuseColorMap.slice(0, \"data:image/png\".length) === \"data:image/png\") {\r\n                this.translucent = true;\r\n            } else if (diffuseColorMap.slice(0, \"data:image/tif\".length) === \"data:image/tif\") {\r\n                this.translucent = true;\r\n            }\r\n        } else if (diffuseColorMap instanceof HTMLCanvasElement\r\n            || diffuseColorMap instanceof HTMLVideoElement\r\n        ) {\r\n            this.translucent = true;\r\n        }\r\n        withTexture = true;\r\n        if (!Cesium.defined(this.uniforms.diffuseColorMap.flipY)) {\r\n            this.uniforms.diffuseColorMap.flipY = false;\r\n        }\r\n\r\n        if (!this.uniforms.diffuseColorMap.sampler) {\r\n            var sampler = {};\r\n\r\n            sampler.magnificationFilter = Cesium.WebGLConstants.LINEAR;\r\n            sampler.minificationFilter = Cesium.WebGLConstants.NEAREST_MIPMAP_LINEAR;\r\n            sampler.wrapS = Cesium.WebGLConstants.REPEAT;\r\n            sampler.wrapT = Cesium.WebGLConstants.REPEAT;\r\n            this.uniforms.diffuseColorMap.sampler = sampler;\r\n        }\r\n\r\n    } else {\r\n        withTexture = false;\r\n    }\r\n\r\n    var vertexShaderUri = null;// \"texture_normals.vert\"; \r\n    var fragmentShaderUri = null;  //\"texture_normals.frag\";\r\n    if (withTexture && withNormals) {\r\n        vertexShaderUri = ShaderChunk.texture_normals_vert;// \"texture_normals.vert\"; \r\n        fragmentShaderUri = ShaderChunk.texture_normals_frag;  //\"texture_normals.frag\";\r\n    } else if (withTexture && !withNormals) {\r\n        vertexShaderUri = ShaderChunk.texture_vert;//\"texture.vert\";\r\n        fragmentShaderUri = ShaderChunk.texture_frag;// \"texture.frag\";\r\n    } else if (!withTexture && withNormals) {\r\n        vertexShaderUri = ShaderChunk.normals_vert;// \"normals.vert\";\r\n        fragmentShaderUri = ShaderChunk.normals_frag;//\"normals.frag\";\r\n    }\r\n    else {\r\n        vertexShaderUri = ShaderChunk.none_vert;// \"none.vert\";\r\n        fragmentShaderUri = ShaderChunk.none_frag;// \"none.frag\";\r\n    }\r\n    this.vertexShader = vertexShaderUri;\r\n    this.fragmentShader = fragmentShaderUri;\r\n\r\n}\r\nBasicMeshMaterial.prototype = Object.create(MeshMaterial.prototype);\r\nexport default BasicMeshMaterial;\r\n","﻿\r\n/**\r\n*帧缓存纹理类，可以将一个mesh渲染到帧缓存并作为纹理提供给其他mesh。<br/>\r\n*需要配合{@link Cesium.MeshVisualizer}、{@link Cesium.Mesh}、{@link Cesium.MeshMaterial}使用。\r\n*@param {Cesium.Mesh}mesh \r\n*\r\n*@property {Cesium.Mesh}mesh \r\n*@property {Cesium.Texture}texture \r\n*\r\n*@constructor\r\n*@memberof Cesium\r\n*@example\r\n \r\n    MeshVisualizer = Cesium.MeshVisualizer;\r\n    Mesh = Cesium.Mesh;\r\n    MeshMaterial = Cesium.MeshMaterial; \r\n    FramebufferTexture = Cesium.FramebufferTexture; \r\n    Shaders = VolumeRendering.Shaders; \r\n\r\n    var center2 = Cesium.Cartesian3.fromDegrees(homePosition[0]+3.5, homePosition[1] , 50000);\r\n    var modelMatrix2 = Cesium.Transforms.eastNorthUpToFixedFrame(center2);\r\n\r\n    var meshVisualizer = new MeshVisualizer({\r\n        modelMatrix: modelMatrix2,\r\n        up: { y: 1 },\r\n        scale: new Cesium.Cartesian3(2,2,2)\r\n    });\r\n    viewer.scene.primitives.add(meshVisualizer);\r\n\r\n    var guiControls = new function () {\r\n        this.model = 'bonsai';\r\n        this.steps = 256.0;\r\n        this.alphaCorrection = 1.0;\r\n        this.color1 = \"#00FA58\";\r\n        this.stepPos1 = 0.1;\r\n        this.color2 = \"#CC6600\";\r\n        this.stepPos2 = 0.7;\r\n        this.color3 = \"#F2F200\";\r\n        this.stepPos3 = 1.0;\r\n    };\r\n    function updateTransferFunction() {\r\n        var canvas = document.createElement('canvas');\r\n        canvas.height = 20;\r\n        canvas.width = 256;\r\n\r\n        var ctx = canvas.getContext('2d');\r\n\r\n        var grd = ctx.createLinearGradient(0, 0, canvas.width - 1, canvas.height - 1);\r\n        grd.addColorStop(guiControls.stepPos1, guiControls.color1);\r\n        grd.addColorStop(guiControls.stepPos2, guiControls.color2);\r\n        grd.addColorStop(guiControls.stepPos3, guiControls.color3);\r\n\r\n        ctx.fillStyle = grd;\r\n        ctx.fillRect(0, 0, canvas.width - 1, canvas.height - 1);\r\n\r\n        return canvas;\r\n    }\r\n\r\n    var dimensions = new Cesium.Cartesian3(50000, 50000, 50000);\r\n    var boxGeometry = Cesium.BoxGeometry.createGeometry(Cesium.BoxGeometry.fromDimensions({\r\n        dimensions: dimensions,\r\n        vertexFormat: Cesium.VertexFormat.POSITION_ONLY\r\n    }));\r\n\r\n    var materialFirstPass = new MeshMaterial({\r\n        vertexShader: Shaders.vertexShaderFirstPass,\r\n        fragmentShader: Shaders.fragmentShaderFirstPass,\r\n        side: MeshMaterial.Sides.BACK,\r\n        uniforms: {\r\n            dimensions: dimensions\r\n        }\r\n    });\r\n    var meshFirstPass = new Mesh(boxGeometry, materialFirstPass);\r\n    var rtTexture = new FramebufferTexture(meshFirstPass);//这里使用FramebufferTexture\r\n    var transferTexture = updateTransferFunction();\r\n    var materialSecondPass = new MeshMaterial({\r\n        vertexShader: Shaders.vertexShaderSecondPass,\r\n        fragmentShader: Shaders.fragmentShaderSecondPass,\r\n        side: MeshMaterial.Sides.FRONT,\r\n        uniforms: {\r\n            alpha: 1,\r\n            dimensions: dimensions,\r\n            tex: rtTexture,\r\n            cubeTex: \"./teapot.raw.png\",\r\n            transferTex: transferTexture,\r\n            steps: guiControls.steps,\r\n            alphaCorrection: guiControls.alphaCorrection\r\n        }\r\n    });\r\n\r\n    var meshSecondPass = new Mesh(boxGeometry, materialSecondPass);\r\n    meshVisualizer.add(meshSecondPass);\r\n*/\r\nfunction FramebufferTexture(mesh, renderTarget, depthTexture) {\r\n    this.mesh = mesh;\r\n\r\n    this.texture = renderTarget;\r\n    this.depthTexture = depthTexture;\r\n    this.framebuffer = null;\r\n    this.ready = false;\r\n    this.readyPromise = Cesium.when.defer();\r\n    if (renderTarget && renderTarget instanceof Cesium.Framebuffer) {\r\n        this.framebuffer = renderTarget;\r\n        this.texture = this.framebuffer._colorTextures[0];\r\n        this.depthTexture = this.framebuffer._depthTexture;\r\n        this.ready = true;\r\n        this.readyPromise.resolve(true);\r\n\r\n    } else {\r\n        this.destroyAttachments = true;\r\n    }\r\n}\r\n/**\r\n * \r\n */\r\nFramebufferTexture.prototype.destroy = function () {\r\n    if (this.destroyAttachments) {\r\n        if (this.texture) {\r\n            this.texture.destroy();\r\n            delete this.texture;\r\n        }\r\n        if (this.depthTexture) {\r\n            this.depthTexture.destroy();\r\n            delete this.depthTexture;\r\n        }\r\n\r\n        if (this.framebuffer) {\r\n            this.framebuffer.destroy();\r\n            delete this.framebuffer;\r\n        }\r\n\r\n        if (this.mesh) {\r\n            this.mesh.destroy();\r\n            delete this.mesh;\r\n        }\r\n    }\r\n\r\n}\r\n\r\nexport default FramebufferTexture;","﻿\r\nimport CSG from '../Util/CSG.js'\r\n/**\r\n*\r\n*@constructor\r\n*@memberof Cesium\r\n*/\r\nfunction GeometryUtils() {\r\n\r\n}\r\n\r\nfunction getAttrs(geo) {\r\n    var attrNames = [];\r\n\r\n    for (var name in geo.attributes) {\r\n        if (geo.attributes.hasOwnProperty(name) && geo.attributes[name]) {\r\n            attrNames.push(name);\r\n        }\r\n    }\r\n    return attrNames\r\n}\r\n\r\nvar scratchPosition;//= new Cesium.Cartesian3();\r\nvar scratchMatrix4;//= new Cesium.Matrix4();\r\nvar scratchRotation;//= new Cesium.Matrix3();\r\nvar scratchOffset;//= new Cesium.Cartesian3();\r\n\r\nvar constantsHasInit = false;\r\nfunction initConstants() {\r\n    if (constantsHasInit) return;\r\n    constantsHasInit = true;\r\n\r\n    scratchPosition = new Cesium.Cartesian3();\r\n    scratchMatrix4 = new Cesium.Matrix4();\r\n    scratchRotation = new Cesium.Matrix3();\r\n    scratchOffset = new Cesium.Cartesian3();\r\n\r\n}\r\n/**\r\n*绕x轴旋转，修改顶点坐标\r\n*@param {Cesium.Geometry}geometry\r\n*@param {Number}angle 弧度\r\n*/\r\nGeometryUtils.rotateX = function (geometry, angle) {\r\n    initConstants();\r\n\r\n    var positions = geometry.attributes.position.values;\r\n\r\n    Cesium.Matrix3.fromRotationX(angle, scratchRotation);\r\n    Cesium.Matrix4.fromRotationTranslation(scratchRotation, Cesium.Cartesian3.ZERO, scratchMatrix4);\r\n\r\n    for (var i = 0; i < positions.length; i += 3) {\r\n        scratchPosition.x = positions[i];\r\n        scratchPosition.y = positions[i + 1];\r\n        scratchPosition.z = positions[i + 2];\r\n        Cesium.Matrix4.multiplyByPoint(scratchMatrix4, scratchPosition, scratchPosition);\r\n        positions[i] = scratchPosition.x;\r\n        positions[i + 1] = scratchPosition.y;\r\n        positions[i + 2] = scratchPosition.z;\r\n    }\r\n\r\n}\r\n/**\r\n*绕y轴旋转，修改顶点坐标\r\n*@param {Cesium.Geometry}geometry\r\n*@param {Number}angle 弧度\r\n*/\r\nGeometryUtils.rotateY = function (geometry, angle) {\r\n    initConstants();\r\n\r\n    var positions = geometry.attributes.position.values;\r\n\r\n    Cesium.Matrix3.fromRotationY(angle, scratchRotation);\r\n    Cesium.Matrix4.fromRotationTranslation(scratchRotation, Cesium.Cartesian3.ZERO, scratchMatrix4);\r\n\r\n    for (var i = 0; i < positions.length; i += 3) {\r\n        scratchPosition.x = positions[i];\r\n        scratchPosition.y = positions[i + 1];\r\n        scratchPosition.z = positions[i + 2];\r\n        Cesium.Matrix4.multiplyByPoint(scratchMatrix4, scratchPosition, scratchPosition);\r\n        positions[i] = scratchPosition.x;\r\n        positions[i + 1] = scratchPosition.y;\r\n        positions[i + 2] = scratchPosition.z;\r\n    }\r\n\r\n}\r\n\r\n/**\r\n*绕z轴旋转，修改顶点坐标\r\n*@param {Cesium.Geometry}geometry\r\n*@param {Number}angle 弧度\r\n*/\r\nGeometryUtils.rotateZ = function (geometry, angle) {\r\n    initConstants();\r\n\r\n    var positions = geometry.attributes.position.values;\r\n\r\n    Cesium.Matrix3.fromRotationZ(angle, scratchRotation);\r\n    Cesium.Matrix4.fromRotationTranslation(scratchRotation, Cesium.Cartesian3.ZERO, scratchMatrix4);\r\n\r\n    for (var i = 0; i < positions.length; i += 3) {\r\n        scratchPosition.x = positions[i];\r\n        scratchPosition.y = positions[i + 1];\r\n        scratchPosition.z = positions[i + 2];\r\n        Cesium.Matrix4.multiplyByPoint(scratchMatrix4, scratchPosition, scratchPosition);\r\n        positions[i] = scratchPosition.x;\r\n        positions[i + 1] = scratchPosition.y;\r\n        positions[i + 2] = scratchPosition.z;\r\n    }\r\n\r\n}\r\n/**\r\n*\r\n*@param {Cesium.Geometry}geometry\r\n*/\r\nGeometryUtils.computeVertexNormals = function (geometry) {\r\n\r\n    var indices = geometry.indices;\r\n    var attributes = geometry.attributes;\r\n    var il = indices.length;\r\n    if (attributes.position) {\r\n\r\n        var positions = attributes.position.values;\r\n\r\n        if (attributes.normal === undefined) {\r\n            attributes.normal = new Cesium.GeometryAttribute({\r\n                componentDatatype: Cesium.ComponentDatatype.FLOAT,\r\n                componentsPerAttribute: 3,\r\n                values: new Float32Array(positions.length)\r\n            })\r\n\r\n        } else {\r\n\r\n            // reset existing normals to zero\r\n\r\n            var array = attributes.normal.values;\r\n\r\n            for (var i = 0; i < il; i++) {\r\n\r\n                array[i] = 0;\r\n\r\n            }\r\n\r\n        }\r\n\r\n        var normals = attributes.normal.values;\r\n\r\n        var vA, vB, vC;\r\n\r\n        var pA = new Cesium.Cartesian3(), pB = new Cesium.Cartesian3(), pC = new Cesium.Cartesian3();\r\n        var cb = new Cesium.Cartesian3(), ab = new Cesium.Cartesian3();\r\n\r\n        for (var i = 0; i < il; i += 3) {\r\n\r\n            vA = indices[i + 0] * 3;\r\n            vB = indices[i + 1] * 3;\r\n            vC = indices[i + 2] * 3;\r\n\r\n            Cesium.Cartesian3.fromArray(positions, vA, pA);\r\n            Cesium.Cartesian3.fromArray(positions, vB, pB);\r\n            Cesium.Cartesian3.fromArray(positions, vC, pC);\r\n\r\n            Cesium.Cartesian3.subtract(pC, pB, cb);\r\n            Cesium.Cartesian3.subtract(pA, pB, ab);\r\n            Cesium.Cartesian3.cross(cb, ab, cb);\r\n\r\n            normals[vA] += cb.x;\r\n            normals[vA + 1] += cb.y;\r\n            normals[vA + 2] += cb.z;\r\n\r\n            normals[vB] += cb.x;\r\n            normals[vB + 1] += cb.y;\r\n            normals[vB + 2] += cb.z;\r\n\r\n            normals[vC] += cb.x;\r\n            normals[vC + 1] += cb.y;\r\n            normals[vC + 2] += cb.z;\r\n\r\n        }\r\n\r\n        normalizeNormals(geometry);\r\n\r\n        attributes.normal.needsUpdate = true;\r\n\r\n    }\r\n\r\n    return geometry;\r\n}\r\nfunction normalizeNormals(geometry) {\r\n\r\n    var normals = geometry.attributes.normal.values;\r\n\r\n    var x, y, z, n;\r\n\r\n    for (var i = 0; i < normals.length; i += 3) {\r\n\r\n        x = normals[i];\r\n        y = normals[i + 1];\r\n        z = normals[i + 2];\r\n\r\n        n = 1.0 / Math.sqrt(x * x + y * y + z * z);\r\n\r\n        normals[i] = x * n;\r\n        normals[i + 1] = y * n;\r\n        normals[i + 2] = z * n;\r\n    }\r\n\r\n}\r\n\r\n/**\r\n*合并两个或两个以上图形类型（primitiveType），属性数量、名称以及属性值的类型（GeometryAttribute的componentDatatype、componentsPerAttribute等）都一致的几何体\r\n*@param {Array<Cesium.Geometry>}geometries \r\n*@return {Cesium.Geometry}\r\n*/\r\nGeometryUtils.mergeGeometries = function (geometries) {\r\n    if (!geometries || !geometries.length) {\r\n        throw new Error(\"缺少geometries参数\");\r\n    }\r\n\r\n    if (geometries.length == 1) {\r\n        return geometries[0];\r\n    }\r\n    var geometriesAttrs = [];\r\n\r\n    var lengthChanged = false;\r\n    var primitiveTypeChanged = false;\r\n    var primitiveType = geometries[0].primitiveType;\r\n    for (var i = 0; i < geometries.length; i++) {\r\n\r\n        geometriesAttrs[i] = getAttrs(geometries[i]);\r\n        if (i > 0) {\r\n            if (primitiveType != geometries[i].primitiveType) {\r\n                primitiveTypeChanged = true;\r\n                break;\r\n            }\r\n            var lastGeoAttrs = geometriesAttrs[i - 1];\r\n            lengthChanged = lastGeoAttrs.length != geometriesAttrs[i].length;\r\n            if (!lengthChanged) {\r\n\r\n                for (var j = 0; j < lastGeoAttrs.length; j++) {\r\n                    if (lastGeoAttrs[j] != geometriesAttrs[i][j]) {\r\n                        lengthChanged = true;\r\n                        break;\r\n                    }\r\n\r\n                }\r\n            }\r\n        }\r\n        primitiveType = geometries[i].primitiveType;\r\n        if (lengthChanged || primitiveTypeChanged) {\r\n            break;\r\n        }\r\n    }\r\n    if (primitiveTypeChanged) {\r\n        throw new Error(\"待合并的几何体中primitiveType属性不完全一致\");\r\n    }\r\n    if (lengthChanged) {\r\n        throw new Error(\"待合并的几何体中属性数量和和名称不完全一致\");\r\n    }\r\n    return mergeGeometries(geometries);\r\n\r\n    var newAttrs = {};\r\n    var attrNames = geometriesAttrs[0];\r\n    for (var i = 0; i < attrNames.length; i++) {\r\n        var attrName = attrNames[i];\r\n        var geometry = geometries[0];\r\n        newAttrs[attrName] = {};\r\n        //newAttrs[attrName] = Cesium.clone(geometry.attributes[attrName]);\r\n        for (var n in geometry.attributes[attrName]) {\r\n            if (geometry.attributes[attrName].hasOwnProperty(n)) {\r\n                newAttrs[attrName][n] = geometry.attributes[attrName][n];\r\n            }\r\n        }\r\n        var values = Array.from(newAttrs[attrName].values);\r\n\r\n        for (var j = 1; j < geometries.length; j++) {\r\n            geometry = geometries[j];\r\n            for (var vi = 0; vi < geometry.attributes[attrName].values.length; vi++) {\r\n                values.push(geometry.attributes[attrName].values[vi]);\r\n            }\r\n        }\r\n\r\n        newAttrs[attrName].values = new newAttrs[attrName].values.constructor(values);\r\n    }\r\n    var indices = [];\r\n    var currIndex = 0;\r\n    for (var j = 0; j < geometries.length; j++) {\r\n        var geometry = geometries[0];\r\n        for (var i = 0; i < geometry.indices.length; i++) {\r\n            indices.push(geometry.indices[i] + currIndex);\r\n        }\r\n        currIndex += geometry.attributes.position.values.length / 3;\r\n    }\r\n\r\n    var bs = Cesium.BoundingSphere.fromVertices(newAttrs.position.values);\r\n    var geo = new Cesium.Geometry({\r\n        attributes: newAttrs,\r\n        indices: new Uint32Array(indices),\r\n        primitiveType: geometries[0].primitiveType,\r\n        boundingSphere: bs\r\n    });\r\n    return geo;\r\n}\r\n\r\nfunction mergeGeometries(geometries) {\r\n    if (geometries.length == 1) return geometries[0];\r\n    var attrNames = [];\r\n    var valueArrs = [];\r\n    var valueTypes = [];\r\n    var valueConstructors = [];\r\n    var valueComponents = [];\r\n    var valueNormalizes = [];\r\n    var valueOffsets = [];\r\n    var indices = [];\r\n    var primitiveType;\r\n    var indexOffst = 0;\r\n\r\n    var componentCounts = [];\r\n\r\n    var geometry = geometries[0];\r\n    primitiveType = geometry.primitiveType;\r\n    for (const attrName in geometry.attributes) {\r\n        if (geometry.attributes.hasOwnProperty(attrName) && geometry.attributes[attrName]) {\r\n            const attr = geometry.attributes[attrName];\r\n            attrNames.push(attrName);\r\n\r\n            // valueArrs.push([]);\r\n\r\n            valueComponents.push(attr.componentsPerAttribute);\r\n            valueTypes.push(attr.componentDatatype);\r\n            valueConstructors.push(attr.values.constructor);\r\n            valueNormalizes.push(attr.normalize);\r\n\r\n            componentCounts.push(0);\r\n            valueOffsets.push(0);\r\n        }\r\n    }\r\n    for (let i = 0; i < geometries.length; i++) {\r\n        const geometry = geometries[i];\r\n        for (let j = 0; j < attrNames.length; j++) {\r\n            const attrName = attrNames[j];\r\n            componentCounts[j] += geometry.attributes[attrName].values.length\r\n        }\r\n    }\r\n\r\n    for (let j = 0; j < attrNames.length; j++) {\r\n        valueArrs.push(new valueConstructors[j](componentCounts[j]));\r\n    }\r\n\r\n    for (let i = 0; i < geometries.length; i++) {\r\n        const geometry = geometries[i];\r\n        for (let ai = 0; ai < attrNames.length; ai++) {\r\n            var attrName = attrNames[ai];\r\n            var valueArr = valueArrs[ai];\r\n            var attrValues = geometry.attributes[attrName].values;\r\n            valueArr.set(attrValues, valueOffsets[ai]);\r\n            valueOffsets[ai] += attrValues.length;\r\n        }\r\n\r\n        for (let j = 0; j < geometry.indices.length; j++) {\r\n            const index = geometry.indices[j];\r\n            indices.push(index + indexOffst);\r\n        }\r\n\r\n        indexOffst += geometry.attributes.position.values.length / 3;\r\n    }\r\n\r\n    var attributes = {};\r\n    for (let i = 0; i < attrNames.length; i++) {\r\n        const attrName = attrNames[i];\r\n        attributes[attrName] = {\r\n            values: valueArrs[i],\r\n            componentsPerAttribute: valueComponents[i],\r\n            componentDatatype: valueTypes[i],\r\n            normalize: valueNormalizes[i]\r\n        }\r\n    }\r\n\r\n    var vertexCount = valueArrs[0] / valueComponents[0];\r\n    if (vertexCount < 65535) {\r\n        indices = new Uint16Array(indices);\r\n    } else {\r\n        indices = new Uint32Array(indices);\r\n    }\r\n\r\n    geometry = new Cesium.Geometry({\r\n        attributes: attributes,\r\n        indices: indices,\r\n        primitiveType: primitiveType\r\n    })\r\n    return geometry;\r\n}\r\n\r\n/**\r\n*\r\n*@param {Cesium.Geometry}geometry\r\n*@param {Cesium.Cartesian3}offset\r\n*/\r\nGeometryUtils.translate = function (geometry, offset) {\r\n    initConstants()\r\n    if (Array.isArray(offset)) {\r\n        scratchOffset.x = offset[0];\r\n        scratchOffset.y = offset[1];\r\n        scratchOffset.z = offset[2];\r\n    } else {\r\n        Cesium.Cartesian3.clone(offset, scratchOffset);\r\n    }\r\n\r\n    for (var i = 0; i < geometry.attributes.position.values.length; i += 3) {\r\n        geometry.attributes.position.values[i] += scratchOffset.x;\r\n        geometry.attributes.position.values[i + 1] += scratchOffset.y;\r\n        geometry.attributes.position.values[i + 2] += scratchOffset.z;\r\n    }\r\n    //if (geometry.attributes.normal) {\r\n    //    Cesium.GeometryPipeline.computeNormal(geometry);\r\n    //}\r\n}\r\n\r\n/**\r\n*\r\n*@param {TypeArray} array\r\n*@return {Cesium.ComponentDatatype}  \r\n*/\r\nGeometryUtils.getAttributeComponentType = function (array) {\r\n\r\n    var attributeComponentType = Cesium.ComponentDatatype.SHORT;\r\n    if (array instanceof Int8Array) {\r\n        attributeComponentType = Cesium.ComponentDatatype.BYTE;\r\n\r\n    } else if (array instanceof Uint8Array || array instanceof Uint8ClampedArray) {\r\n        attributeComponentType = Cesium.ComponentDatatype.UNSIGNED_BYTE;\r\n\r\n    } else if (array instanceof Int16Array) {\r\n        attributeComponentType = Cesium.ComponentDatatype.SHORT;\r\n\r\n    } else if (array instanceof Uint16Array) {\r\n        attributeComponentType = Cesium.ComponentDatatype.UNSIGNED_SHORT;\r\n\r\n    } else if (array instanceof Int32Array) {\r\n        attributeComponentType = Cesium.ComponentDatatype.INT;\r\n\r\n    } else if (array instanceof Uint32Array) {\r\n        attributeComponentType = Cesium.ComponentDatatype.UNSIGNED_INT;\r\n\r\n    } else if (array instanceof Float32Array) {\r\n        attributeComponentType = Cesium.ComponentDatatype.FLOAT;\r\n\r\n    } else if (array instanceof Float64Array) {\r\n        attributeComponentType = Cesium.ComponentDatatype.DOUBLE;\r\n\r\n    }\r\n\r\n    return attributeComponentType;\r\n\r\n}\r\n\r\n/**\r\n*\r\n*@param {Object}geometry\r\n*@return {Boolean}\r\n*/\r\nGeometryUtils.isGeometry3js = function (geometry) {\r\n    return (typeof THREE !== 'undefined' && (geometry instanceof THREE.Geometry || geometry instanceof THREE.BufferGeometry))\r\n        || (geometry.attributes && geometry.attributes.position && geometry.index)\r\n        || (geometry.vertices && geometry.faces);\r\n}\r\n\r\n/**\r\n *\r\n *@param {THREE.BufferGeometry}geometry \r\n *@private\r\n */\r\nGeometryUtils.parseBufferGeometry3js = function (geometry) {\r\n    // var start = new Date();\r\n\r\n    var attributes = {};\r\n    if (!geometry.attributes.normal) {\r\n        geometry.computeFaceNormals();\r\n    }\r\n    for (var attrName in geometry.attributes) {\r\n\r\n        if (geometry.attributes.hasOwnProperty(attrName)) {\r\n            var attr = geometry.getAttribute(attrName);\r\n            if (attr && attr.array.length > 0) {\r\n\r\n                attributes[attrName] = new Cesium.GeometryAttribute({\r\n                    componentDatatype: GeometryUtils.getAttributeComponentType(attr.array),\r\n                    componentsPerAttribute: attr.itemSize,\r\n                    values: attr.array,\r\n                    normalize: attr.normalized\r\n                });\r\n\r\n            }\r\n\r\n        }\r\n    }\r\n    var indices = [];\r\n    if (!geometry.index && geometry.groups) {\r\n        geometry.groups.forEach(function (group) {\r\n            for (var i = 0; i < group.count; i++) {\r\n                indices.push(i + group.start);\r\n            }\r\n        })\r\n        indices = new Int32Array(indices);\r\n    } else {\r\n        indices = geometry.index.array;\r\n    }\r\n    var cesGeometry = new Cesium.Geometry({\r\n        attributes: attributes,\r\n        indices: indices,\r\n        primitiveType: Cesium.PrimitiveType.TRIANGLES\r\n    });\r\n\r\n    return cesGeometry;\r\n}\r\n\r\n/**\r\n*\r\n*@param {THREE.Geometry}geometry3js\r\n*@return {Cesium.Geometry} \r\n*/\r\nGeometryUtils.fromGeometry3js = function (geometry3js) {\r\n\r\n    if (geometry3js.attributes && (geometry3js.index || geometry3js.groups.length)) {\r\n\r\n    } else {\r\n        geometry3js = new THREE.BufferGeometry().fromGeometry(geometry3js);\r\n    }\r\n    var geometry = GeometryUtils.parseBufferGeometry3js(geometry3js);\r\n    //GeometryUtils.computeVertexNormals(geometry);\r\n    Cesium.GeometryPipeline.computeNormal(geometry);\r\n    return geometry;\r\n    var positions = new Float32Array(geometry3js.vertices.length * 3);\r\n    for (var i = 0; i < geometry3js.vertices.length; i++) {\r\n        positions[i * 3] = geometry3js.vertices[i].x;\r\n        if (!geometry3js.up || geometry3js.up.y) {\r\n            positions[i * 3 + 1] = geometry3js.vertices[i].z;\r\n            positions[i * 3 + 2] = geometry3js.vertices[i].y;\r\n        } else {\r\n            positions[i * 3 + 1] = geometry3js.vertices[i].y;\r\n            positions[i * 3 + 2] = geometry3js.vertices[i].z;\r\n        }\r\n    }\r\n    var indices = new Int32Array(geometry3js.faces.length * 3);\r\n    for (var i = 0; i < geometry3js.faces.length; i++) {\r\n        indices[i * 3] = geometry3js.faces[i].a;\r\n        indices[i * 3 + 1] = geometry3js.faces[i].b;\r\n        indices[i * 3 + 2] = geometry3js.faces[i].c;\r\n    }\r\n    var attributes = {};\r\n    attributes.position = new Cesium.GeometryAttribute({\r\n        componentDatatype: Cesium.ComponentDatatype.FLOAT,\r\n        componentsPerAttribute: 3,\r\n        values: positions\r\n    });\r\n    var cesGeometry = new Cesium.Geometry({\r\n        attributes: attributes,\r\n        indices: indices,\r\n        primitiveType: Cesium.PrimitiveType.TRIANGLES\r\n    });\r\n    return cesGeometry;\r\n}\r\n/**\r\n*\r\n*@param {Cesium.Geometry}geometry\r\n*@return {THREE.Geometry} \r\n*/\r\nGeometryUtils.toGeometry3js = function (geometry) {\r\n    if (typeof THREE === 'undefined') {\r\n        throw new Error(\"THREE 未加载\");\r\n    }\r\n\r\n    var positions = geometry.attributes.position.values;\r\n    var positionIdx = 0;\r\n\r\n    var geometry3js = new THREE.Geometry();\r\n\r\n    for (var i = 0; i < positions.length; i += 3) {\r\n        positionIdx = i * 3;\r\n        geometry3js.vertices.push(\r\n            new THREE.Vector3(positions[positionIdx], positions[positionIdx + 2], positions[positionIdx + 1])\r\n        );\r\n    }\r\n\r\n    for (var i = 0; i < geometry.indices.length; i += 3) {\r\n        var idx1 = geometry.indices[i];\r\n        var idx2 = geometry.indices[i + 1];\r\n        var idx3 = geometry.indices[i + 2];\r\n        geometry3js.faces.push(new THREE.Face3(idx1, idx2, idx3));\r\n    }\r\n\r\n    return geometry3js;\r\n}\r\n\r\n/**\r\n*@param {Cesium.Geometry|THREE.Geometry}geometry\r\n*@param {Cesium.Cartesian3}[offset]\r\n*@return {CSG}\r\n*/\r\nGeometryUtils.toCSG = function (geometry, offset) {\r\n    if (!(typeof THREE === 'undefined')) {\r\n        if (geometry instanceof THREE.Geometry) {\r\n            return GeometryUtils._toCSG3js(geometry, offset);\r\n        }\r\n    }\r\n    if (!offset) {\r\n        offset = { x: 0, y: 0, z: 0 };\r\n    }\r\n    if (!geometry.attributes.normal) {\r\n        geometry = Cesium.GeometryPipeline.computeNormal(geometry);\r\n    }\r\n    if (geometry.primitiveType !== Cesium.PrimitiveType.TRIANGLES) {\r\n        throw new Error(\"暂不支持此类几何体\");\r\n    }\r\n    if (!CSG) {\r\n        throw new Error('CSG 库未加载。请从 https://github.com/evanw/csg.js 获取');\r\n    }\r\n    var faceCount = geometry.indices.length / 3;\r\n    var polygons = [], vertices = [];\r\n    var positions = geometry.attributes.position.values;\r\n    var normals = geometry.attributes.normal.values;\r\n    var normalIdx = 0, positionIdx = 0;\r\n\r\n    for (var i = 0; i < geometry.indices.length; i += 3) {\r\n        vertices = [];\r\n\r\n        var idx1 = geometry.indices[i];\r\n        var idx2 = geometry.indices[i + 1];\r\n        var idx3 = geometry.indices[i + 2];\r\n\r\n        positionIdx = idx1 * 3;\r\n        normalIdx = idx1 * 3;\r\n\r\n        vertices.push(new CSG.Vertex(\r\n            [positions[positionIdx++] + offset.x, positions[positionIdx++] + offset.y, positions[positionIdx++] + offset.z],\r\n            [normals[normalIdx++], normals[normalIdx++], normals[normalIdx++]]\r\n        ));\r\n\r\n        positionIdx = idx2 * 3;\r\n        normalIdx = idx2 * 3;\r\n        vertices.push(new CSG.Vertex(\r\n            [positions[positionIdx++] + offset.x, positions[positionIdx++] + offset.y, positions[positionIdx++] + offset.z],\r\n            [normals[normalIdx++], normals[normalIdx++], normals[normalIdx++]]\r\n        ));\r\n\r\n        positionIdx = idx3 * 3;\r\n        normalIdx = idx3 * 3;\r\n        vertices.push(new CSG.Vertex(\r\n            [positions[positionIdx++] + offset.x, positions[positionIdx++] + offset.y, positions[positionIdx++] + offset.z],\r\n            [normals[normalIdx++], normals[normalIdx++], normals[normalIdx++]]\r\n        ));\r\n        polygons.push(new CSG.Polygon(vertices));\r\n    }\r\n    return CSG.fromPolygons(polygons);\r\n}\r\n/**\r\n*@param {CSG}csg_model\r\n*@param {Boolean}[toGeometry3js=false]\r\n*@return {Cesium.Geometry|THREE.Geometry}\r\n*/\r\nGeometryUtils.fromCSG = function (csg_model, toGeometry3js) {\r\n    if (!(typeof THREE === 'undefined')) {\r\n        if (geometry instanceof THREE.Geometry) {\r\n            return GeometryUtils._fromCSG3js(geometry, offset);\r\n        }\r\n    }\r\n    var i, j, vertices,\r\n        polygons = csg_model.toPolygons();\r\n\r\n    if (!CSG) {\r\n        throw new Error('CSG 库未加载。请从 https://github.com/evanw/csg.js 获取');\r\n    }\r\n\r\n    var positions = [];\r\n    var normals = [];\r\n    var indices = [];\r\n\r\n    for (i = 0; i < polygons.length; i++) {\r\n\r\n        // Vertices\r\n        vertices = [];\r\n        for (j = 0; j < polygons[i].vertices.length; j++) {\r\n            vertices.push(this.getGeometryVertice(positions, normals, polygons[i].vertices[j].pos, polygons[i].plane.normal));\r\n        }\r\n        if (vertices[0] === vertices[vertices.length - 1]) {\r\n            vertices.pop();\r\n        }\r\n\r\n        for (var j = 2; j < vertices.length; j++) {\r\n            indices.push(vertices[0], vertices[j - 1], vertices[j]);\r\n        }\r\n    }\r\n\r\n    positions = new Float32Array(positions);\r\n    normals = new Float32Array(normals);\r\n\r\n    indices = new Int32Array(indices);\r\n    var attributes = {};\r\n    attributes.position = new Cesium.GeometryAttribute({\r\n        componentDatatype: Cesium.ComponentDatatype.FLOAT,\r\n        componentsPerAttribute: 3,\r\n        values: positions\r\n    });\r\n    attributes.normal = new Cesium.GeometryAttribute({\r\n        componentDatatype: Cesium.ComponentDatatype.FLOAT,\r\n        componentsPerAttribute: 3,\r\n        values: normals\r\n    });\r\n\r\n    var cesGeometry = new Cesium.Geometry({\r\n        attributes: attributes,\r\n        indices: indices,\r\n        primitiveType: Cesium.PrimitiveType.TRIANGLES\r\n    });\r\n\r\n    return cesGeometry;\r\n}\r\n\r\nGeometryUtils._toCSG3js = function (three_model, offset, rotation) {\r\n    if (typeof THREE === 'undefined') {\r\n        throw new Error(\"THREE 未加载\");\r\n    }\r\n\r\n    var i, geometry, polygons, vertices, rotation_matrix;\r\n\r\n    if (!CSG) {\r\n        throw 'CSG library not loaded. Please get a copy from https://github.com/evanw/csg.js';\r\n    }\r\n\r\n    if (three_model instanceof THREE.Mesh) {\r\n        geometry = three_model.geometry;\r\n        offset = offset || three_model.position;\r\n        rotation = rotation || three_model.rotation;\r\n    } else if (three_model instanceof THREE.Geometry) {\r\n        geometry = three_model;\r\n        offset = offset || new THREE.Vector3(0, 0, 0);\r\n        rotation = rotation || new THREE.Euler(0, 0, 0);\r\n    } else {\r\n        throw 'Model type not supported.';\r\n    }\r\n    rotation_matrix = new THREE.Matrix4().makeRotationFromEuler(rotation);\r\n\r\n    var polygons = [];\r\n    for (i = 0; i < geometry.faces.length; i++) {\r\n        if (geometry.faces[i] instanceof THREE.Face3) {\r\n\r\n            vertices = [];\r\n            vertices.push(new CSG.Vertex(geometry.vertices[geometry.faces[i].a].clone().add(offset).applyMatrix4(rotation_matrix), [geometry.faces[i].normal.x, geometry.faces[i].normal.y, geometry.faces[i].normal.z]));\r\n            vertices.push(new CSG.Vertex(geometry.vertices[geometry.faces[i].b].clone().add(offset).applyMatrix4(rotation_matrix), [geometry.faces[i].normal.x, geometry.faces[i].normal.y, geometry.faces[i].normal.z]));\r\n            vertices.push(new CSG.Vertex(geometry.vertices[geometry.faces[i].c].clone().add(offset).applyMatrix4(rotation_matrix), [geometry.faces[i].normal.x, geometry.faces[i].normal.y, geometry.faces[i].normal.z]));\r\n            polygons.push(new CSG.Polygon(vertices));\r\n\r\n        } else if (geometry.faces[i] instanceof THREE.Face4) {\r\n\r\n            vertices = [];\r\n            vertices.push(new CSG.Vertex(geometry.vertices[geometry.faces[i].a].clone().add(offset).applyMatrix4(rotation_matrix), [geometry.faces[i].normal.x, geometry.faces[i].normal.y, geometry.faces[i].normal.z]));\r\n            vertices.push(new CSG.Vertex(geometry.vertices[geometry.faces[i].b].clone().add(offset).applyMatrix4(rotation_matrix), [geometry.faces[i].normal.x, geometry.faces[i].normal.y, geometry.faces[i].normal.z]));\r\n            vertices.push(new CSG.Vertex(geometry.vertices[geometry.faces[i].d].clone().add(offset).applyMatrix4(rotation_matrix), [geometry.faces[i].normal.x, geometry.faces[i].normal.y, geometry.faces[i].normal.z]));\r\n            polygons.push(new CSG.Polygon(vertices));\r\n\r\n            vertices = [];\r\n            vertices.push(new CSG.Vertex(geometry.vertices[geometry.faces[i].b].clone().add(offset).applyMatrix4(rotation_matrix), [geometry.faces[i].normal.x, geometry.faces[i].normal.y, geometry.faces[i].normal.z]));\r\n            vertices.push(new CSG.Vertex(geometry.vertices[geometry.faces[i].c].clone().add(offset).applyMatrix4(rotation_matrix), [geometry.faces[i].normal.x, geometry.faces[i].normal.y, geometry.faces[i].normal.z]));\r\n            vertices.push(new CSG.Vertex(geometry.vertices[geometry.faces[i].d].clone().add(offset).applyMatrix4(rotation_matrix), [geometry.faces[i].normal.x, geometry.faces[i].normal.y, geometry.faces[i].normal.z]));\r\n            polygons.push(new CSG.Polygon(vertices));\r\n\r\n        } else {\r\n            throw 'Model contains unsupported face.';\r\n        }\r\n    }\r\n\r\n    return CSG.fromPolygons(polygons);\r\n}\r\n\r\nGeometryUtils._fromCSG3js = function (csg_model) {\r\n    if (typeof THREE === 'undefined') {\r\n        throw new Error(\"THREE 未加载\");\r\n    }\r\n    var i, j, vertices, face,\r\n        three_geometry = new THREE.Geometry(),\r\n        polygons = csg_model.toPolygons();\r\n\r\n    if (!CSG) {\r\n        throw 'CSG library not loaded. Please get a copy from https://github.com/evanw/csg.js';\r\n    }\r\n\r\n    for (i = 0; i < polygons.length; i++) {\r\n\r\n        // Vertices\r\n        vertices = [];\r\n        for (j = 0; j < polygons[i].vertices.length; j++) {\r\n            vertices.push(GeometryUtils._getGeometryVertice3js(three_geometry, polygons[i].vertices[j].pos));\r\n        }\r\n        if (vertices[0] === vertices[vertices.length - 1]) {\r\n            vertices.pop();\r\n        }\r\n\r\n        for (var j = 2; j < vertices.length; j++) {\r\n            face = new THREE.Face3(vertices[0], vertices[j - 1], vertices[j], new THREE.Vector3().copy(polygons[i].plane.normal));\r\n            three_geometry.faces.push(face);\r\n            three_geometry.faceVertexUvs[0].push(new THREE.Vector2());\r\n        }\r\n    }\r\n\r\n    three_geometry.computeBoundingBox();\r\n\r\n    return three_geometry;\r\n}\r\n\r\nGeometryUtils._getGeometryVertice3js = function (geometry, vertice_position) {\r\n    var i;\r\n    for (i = 0; i < geometry.vertices.length; i++) {\r\n        if (geometry.vertices[i].x === vertice_position.x && geometry.vertices[i].y === vertice_position.y && geometry.vertices[i].z === vertice_position.z) {\r\n            // Vertice already exists\r\n            return i;\r\n        }\r\n    };\r\n\r\n    geometry.vertices.push(new THREE.Vector3(vertice_position.x, vertice_position.y, vertice_position.z));\r\n    return geometry.vertices.length - 1;\r\n}\r\n\r\nexport default GeometryUtils;","﻿\r\nimport Rotation from './Rotation.js';\r\nimport RendererUtils from './RendererUtils.js';\r\n\r\n/**\r\n*\r\n*@param {Object|geometry}options   \r\n*@param {Boolean}[options.show=true]  \r\n*@param {Cesium.Cartesian3}[options.position]\r\n*@param {Cesium.Rotation}[options.rotation]\r\n*@param {Cesium.Cartesian3}[options.scale]    \r\n* \r\n*@property {Boolean}show  \r\n*@property {Cesium.Cartesian3}position\r\n*@property {Cesium.Rotation}rotation\r\n*@property {Cesium.Cartesian3}scale   \r\n*@property {Boolean}needUpdate\r\n*\r\n*@constructor\r\n*@memberof Cesium\r\n*@example\r\n    \r\n    MeshVisualizer = Cesium.MeshVisualizer;\r\n    Mesh = Cesium.Mesh;\r\n    MeshMaterial = Cesium.MeshMaterial; \r\n    LOD = Cesium.LOD;\r\n\r\n    var center = Cesium.Cartesian3.fromDegrees(homePosition[0], homePosition[1], 50000);\r\n    var modelMatrix = Cesium.Transforms.eastNorthUpToFixedFrame(center);\r\n\r\n    var meshVisualizer = new MeshVisualizer({\r\n        modelMatrix: modelMatrix,\r\n        up: { z: 1 }\r\n    });\r\n    viewer.scene.primitives.add(meshVisualizer);\r\n\r\n\r\n    var material = new MeshMaterial({\r\n        defaultColor: \"rgba(200,0,0,1.0)\",\r\n        wireframe: true,\r\n        side: MeshMaterial.Sides.FRONT\r\n    });\r\n    var radius = 20000;\r\n    var sphereL0 = Cesium.SphereGeometry.createGeometry(new Cesium.SphereGeometry({\r\n        radius: radius,\r\n        vertexFormat: Cesium.VertexFormat.POSITION_ONLY,\r\n        stackPartitions:4,\r\n        slicePartitions: 4\r\n    }));\r\n    var sphereL1 = Cesium.SphereGeometry.createGeometry(new Cesium.SphereGeometry({\r\n        radius: radius,\r\n        vertexFormat: Cesium.VertexFormat.POSITION_ONLY,\r\n        stackPartitions: 8,\r\n        slicePartitions: 8\r\n    }));\r\n    var sphereL2 = Cesium.SphereGeometry.createGeometry(new Cesium.SphereGeometry({\r\n        radius: radius,\r\n        vertexFormat: Cesium.VertexFormat.POSITION_ONLY,\r\n        stackPartitions: 16,\r\n        slicePartitions: 16\r\n    }));\r\n    var sphereL3 = Cesium.SphereGeometry.createGeometry(new Cesium.SphereGeometry({\r\n        radius: radius,\r\n        vertexFormat: Cesium.VertexFormat.POSITION_ONLY,\r\n        stackPartitions: 32,\r\n        slicePartitions: 32\r\n    }));\r\n    var sphereL4 = Cesium.SphereGeometry.createGeometry(new Cesium.SphereGeometry({\r\n        radius: radius,\r\n        vertexFormat: Cesium.VertexFormat.POSITION_ONLY,\r\n        stackPartitions: 64,\r\n        slicePartitions: 64\r\n    }));\r\n\r\n    var geometries = [\r\n                [sphereL4, 5],\r\n                [sphereL3, 200],\r\n                [sphereL2, 300],\r\n                [sphereL1, 500],\r\n                [sphereL0, 2000]\r\n    ];\r\n\r\n    var maxAvailableDistance = 10000000;\r\n\r\n    var i, j, mesh, lod;\r\n    var scale = new Cesium.Cartesian3(1, 1, 1);\r\n    for (j = 0; j < 1000; j++) {\r\n\r\n        lod = new LOD();\r\n\r\n        for (i = 0; i < geometries.length; i++) {\r\n\r\n            mesh = new Mesh(geometries[i][0], material);\r\n            mesh.scale = scale;\r\n\r\n            lod.addLevel(mesh, geometries[i][1] * 1000);\r\n        }\r\n        lod.maxAvailableDistance = maxAvailableDistance;\r\n        lod.position.x = 1500000 * (0.5 - Math.random());\r\n        lod.position.y = 1750000 * (0.5 - Math.random());\r\n        lod.position.z = 130000 * (0.5 - Math.random());\r\n\r\n        meshVisualizer.add(lod);\r\n\r\n    }\r\n*/\r\nfunction LOD(options) {\r\n\r\n    options = Cesium.defaultValue(options, {});\r\n\r\n    this.uuid = Cesium.createGuid();\r\n    this.show = Cesium.defaultValue(options.show, true);\r\n    this.maxAvailableDistance = Cesium.defaultValue(options.maxAvailableDistance, Number.MAX_VALUE);\r\n    this._position = Cesium.defaultValue(options.position, new Cesium.Cartesian3(0, 0, 0));\r\n    this._scale = Cesium.defaultValue(options.scale, new Cesium.Cartesian3(1, 1, 1));\r\n    this._rotation = Cesium.defaultValue(options.rotation, { axis: new Cesium.Cartesian3(0, 0, 1), angle: 0 });\r\n    this._rotation = new Rotation(this._rotation.axis, this._rotation.angle);\r\n    this._boundingSphere = new Cesium.BoundingSphere();\r\n    this._needsUpdate = false;\r\n    this._modelMatrixNeedsUpdate = true;\r\n    this._modelMatrix = new Cesium.Matrix4();\r\n    Cesium.Matrix4.clone(Cesium.Matrix4.IDENTITY, this._modelMatrix);\r\n\r\n    this._onNeedUpdateChanged = function () {\r\n        this._modelMatrixNeedsUpdate = true;\r\n    };\r\n    this._rotation.paramChanged.removeEventListener(this._onNeedUpdateChanged);\r\n\r\n    this._children = [];\r\n    this._parent = null;\r\n    this.type = 'LOD';\r\n\r\n    Object.defineProperties(this, {\r\n        levels: {\r\n            enumerable: true,\r\n            value: []\r\n        }\r\n    });\r\n\r\n}\r\nfunction removeByValue(arr, val) {\r\n    for (var i = 0; i < arr.length; i++) {\r\n        if (arr[i] == val) {\r\n            arr.splice(i, 1);\r\n            break;\r\n        }\r\n    }\r\n}\r\nLOD.prototype = {\r\n\r\n    constructor: LOD,\r\n    /**\r\n     *\r\n     *@param {Number}x\r\n     *@param {Number}y\r\n     *@param {Number}z\r\n     */\r\n    setPosition: function (x, y, z) {\r\n        var changed = false;\r\n        if (arguments.length == 1) {\r\n            if (typeof x == 'number') {\r\n                if (x != this._position.x) changed = true;\r\n                this._position.x = x;\r\n            } else if (x instanceof Cesium.Cartesian3) {\r\n                if (x != this._position.x\r\n                    || y != this._position.y\r\n                    || z != this._position.z) {\r\n                    changed = true;\r\n                }\r\n\r\n                this._position.x = x.x;\r\n                this._position.y = x.y;\r\n                this._position.z = x.z;\r\n            }\r\n        }\r\n        if (arguments.length == 2 && typeof y == 'number') {\r\n            if (y != this._position.y) changed = true;\r\n            this._position.y = y;\r\n        }\r\n        if (arguments.length == 3 && typeof z == 'number') {\r\n            if (z != this._position.z) changed = true;\r\n            this._position.z = z;\r\n        }\r\n        if (changed) {\r\n            this._modelMatrixNeedsUpdate = true;\r\n        }\r\n    },\r\n    /**\r\n     *\r\n     *@param {Number}x\r\n     *@param {Number}y\r\n     *@param {Number}z\r\n     */\r\n    setScale: function (x, y, z) {\r\n        var changed = false;\r\n        if (arguments.length == 1) {\r\n            if (typeof x == 'number') {\r\n                if (x != this._scale.x) changed = true;\r\n                this._scale.x = x;\r\n            } else if (x instanceof Cesium.Cartesian3) {\r\n                if (x != this._scale.x\r\n                    || y != this._scale.y\r\n                    || z != this._scale.z) {\r\n                    changed = true;\r\n                }\r\n\r\n                this._scale.x = x.x;\r\n                this._scale.y = x.y;\r\n                this._scale.z = x.z;\r\n            }\r\n        }\r\n        if (arguments.length == 2 && typeof y == 'number') {\r\n            if (y != this._scale.y) changed = true;\r\n            this._scale.y = y;\r\n        }\r\n        if (arguments.length == 3 && typeof z == 'number') {\r\n            if (z != this._scale.z) changed = true;\r\n            this._scale.z = z;\r\n        }\r\n        if (changed) {\r\n            this._modelMatrixNeedsUpdate = true;\r\n        }\r\n    },\r\n\r\n    /**\r\n    *@param {Cesium.Mesh}mesh\r\n    *@param {Number}distance\r\n    */\r\n    addLevel: function (object, distance) {\r\n\r\n        if (distance === undefined) distance = 0;\r\n\r\n        distance = Math.abs(distance);\r\n\r\n        var levels = this.levels;\r\n\r\n        for (var l = 0; l < levels.length; l++) {\r\n\r\n            if (distance < levels[l].distance) {\r\n\r\n                break;\r\n\r\n            }\r\n\r\n        }\r\n\r\n        levels.splice(l, 0, { distance: distance, object: object });\r\n        object.parent = this;\r\n        this._children.push(object);\r\n        if (this.levels[0].object.geometry) {\r\n            this._boundingSphere.radius = this.levels[0].object.geometry.boundingSphere.radius;\r\n        } else if (this.levels[0].object.boundingSphere) {\r\n            this._boundingSphere.radius = this.levels[0].object.boundingSphere.radius;\r\n        }\r\n    },\r\n    update: function () {\r\n \r\n\r\n        return function update(parentModelMatrix, frameState) {\r\n\r\n            var levels = this.levels;\r\n\r\n            if (levels.length > 1) {\r\n                if (this._modelMatrixNeedsUpdate) {\r\n\r\n                    RendererUtils.computeModelMatrix(\r\n                        parentModelMatrix,\r\n                        this.position,\r\n                        this.rotation,\r\n                        this.scale,\r\n                        this.modelMatrix\r\n                    );\r\n\r\n                    this._modelMatrixNeedsUpdate = false;\r\n                }\r\n\r\n                Cesium.Matrix4.getTranslation(this.modelMatrix, this._boundingSphere.center);\r\n\r\n                var bs = this._boundingSphere;\r\n                var distance = Math.max(0.0, Cesium.Cartesian3.distance(bs.center, frameState.camera.positionWC) - bs.radius);\r\n\r\n                var show = this.maxAvailableDistance > distance;\r\n\r\n                show = show && frameState.cullingVolume.computeVisibility(this._boundingSphere) !== Cesium.Intersect.OUTSIDE;\r\n                levels[0].object.show = show;\r\n\r\n                for (var i = 1, l = levels.length; i < l; i++) {\r\n\r\n                    if (distance >= levels[i].distance) {\r\n\r\n                        levels[i - 1].object.show = false;\r\n                        levels[i].object.show = show;\r\n\r\n                    } else {\r\n\r\n                        break;\r\n\r\n                    }\r\n\r\n                }\r\n\r\n                for (; i < l; i++) {\r\n\r\n                    levels[i].object.show = false;\r\n\r\n                }\r\n            }\r\n        };\r\n\r\n    }(),\r\n    getObjectForDistance: function (distance) {\r\n\r\n        var levels = this.levels;\r\n\r\n        for (var i = 1, l = levels.length; i < l; i++) {\r\n\r\n            if (distance < levels[i].distance) {\r\n\r\n                break;\r\n\r\n            }\r\n\r\n        }\r\n\r\n        return levels[i - 1].object;\r\n\r\n    }\r\n};\r\n\r\nObject.defineProperties(LOD.prototype, {\r\n    modelMatrix: {\r\n        get: function () {\r\n            return this._modelMatrix;\r\n        }\r\n    },\r\n    parent: {\r\n        get: function () {\r\n            return this._parent;\r\n        },\r\n        set: function (val) {\r\n            if (val && ((val._children && Array.isArray(val._children)) || (val.children && Array.isArray(val.children)))) {\r\n\r\n                if (this._parent && this._parent != val) {\r\n                    var children = this._parent._children ? this._parent._children : this._parent.children;\r\n                    if (Array.isArray(children)) {\r\n                        removeByValue(children, this);\r\n                    }\r\n                }\r\n                this._parent = val;\r\n                if (typeof this._parent.add === 'function') {\r\n                    this._parent.add(this);\r\n                } else {\r\n                    var children = val._children ? val._children : val.children;\r\n                    children.push(this);\r\n                }\r\n            }\r\n            this._needsUpdate = true;\r\n        }\r\n    },\r\n    children: {\r\n        get: function () {\r\n            return this._children;\r\n        },\r\n        set: function (val) {\r\n            this._children = val;\r\n            this._needsUpdate = true;\r\n        }\r\n    },\r\n    needsUpdate: {\r\n        get: function () {\r\n            return this._needsUpdate;\r\n        },\r\n        set: function (val) {\r\n            this._needsUpdate = val;\r\n        }\r\n    },\r\n    rotation: {\r\n        get: function () {\r\n            return this._rotation;\r\n        },\r\n        set: function (val) {\r\n            if (val != this._rotation) {\r\n                this._rotation = val;\r\n                this._needUpdate = true;\r\n            }\r\n            this._rotation.paramChanged.removeEventListener(this._onNeedUpdateChanged);\r\n            this._rotation = val;\r\n            this._rotation.paramChanged.addEventListener(this._onNeedUpdateChanged);\r\n        }\r\n    },\r\n    position: {\r\n        get: function () {\r\n            return this._position;\r\n        },\r\n        set: function (val) {\r\n            if (val.x != this._position.x || val.y != this._position.y || val.z != this._position.z) {\r\n                this._position = val;\r\n                this._needsUpdate = true;\r\n            }\r\n            this._position = val;\r\n        }\r\n    },\r\n    scale: {\r\n        get: function () {\r\n            return this._scale;\r\n        },\r\n        set: function (val) {\r\n            if (val.x != this._scale.x || val.y != this._scale.y || val.z != this._scale.z) {\r\n                this._scale = val;\r\n                this._needsUpdate = true;\r\n            }\r\n            this._scale = val;\r\n        }\r\n    }\r\n});\r\n\r\nexport default LOD;","﻿  \r\nimport MeshMaterial from './MeshMaterial.js';\r\n\r\nvar shaderIDs = {\r\n    MeshDepthMaterial: 'depth',\r\n    MeshNormalMaterial: 'normal',\r\n    MeshBasicMaterial: 'basic',\r\n    MeshLambertMaterial: 'lambert',\r\n    MeshPhongMaterial: 'phong',\r\n    MeshToonMaterial: 'phong',\r\n    MeshStandardMaterial: 'physical',\r\n    MeshPhysicalMaterial: 'physical',\r\n    LineBasicMaterial: 'basic',\r\n    LineDashedMaterial: 'dashed',\r\n    PointsMaterial: 'points'\r\n};\r\n\r\n/**\r\n*\r\n*@constructor\r\n*@memberof Cesium\r\n*/\r\nfunction MaterialUtils() {\r\n\r\n}\r\n\r\n/**\r\n*\r\n*@param {THREE.Material}material3js\r\n*@return {Cesium.MeshMaterial}\r\n*/\r\nMaterialUtils.fromMaterial3js = function (material3js) {\r\n    if(typeof THREE=='undefined'){\r\n        throw new Error('Three.js is required.')\r\n    }\r\n    var shaderID = shaderIDs[material3js.type];\r\n    material3js[\"is\" + material3js.type] = true;\r\n    var shader = THREE.ShaderLib[shaderID];\r\n\r\n    if (!shader) {\r\n        shader = material3js;\r\n    }\r\n\r\n    var material = new MeshMaterial({\r\n        vertexShader: shader.vertexShader,\r\n        fragmentShader: shader.fragmentShader,\r\n        uniforms: cloneUniforms(shader.uniforms)\r\n    });\r\n\r\n    material.material3js = material3js;\r\n    MaterialUtils.updateMaterialFrom3js(material);\r\n    return material;\r\n}\r\n\r\nfunction cloneUniforms(uniforms3js) {\r\n    var uniforms = {};\r\n    for (var i in uniforms3js) {\r\n        if (uniforms3js.hasOwnProperty(i)) {\r\n            uniforms[i] = {\r\n                value: {}\r\n            };\r\n            for (var n in uniforms3js[i]) {\r\n                if (n !== \"value\") {\r\n                    uniforms[i][n] = uniforms3js[i][n];\r\n                }\r\n            }\r\n            if (uniforms3js[i].t) {\r\n                switch (uniforms3js[i].t) {\r\n\r\n                    default:\r\n                }\r\n            }\r\n\r\n            bindUniformValue(uniforms[i], uniforms3js[i].value);\r\n        }\r\n    }\r\n    return uniforms;\r\n}\r\n\r\n/**\r\n*\r\n*@param {Cesium.MeshMaterial}materialWidth3js\r\n*@private\r\n*/\r\nMaterialUtils.updateMaterialFrom3js = function (materialWidth3js) {\r\n    if (!materialWidth3js || !materialWidth3js.material3js) {\r\n        return;\r\n    }\r\n\r\n    var material3js = materialWidth3js.material3js;\r\n    materialWidth3js.translucent = material3js.transparent;\r\n\r\n    materialWidth3js.wireframe = material3js.wireframe;\r\n\r\n    var m_uniforms = materialWidth3js.uniforms;\r\n    var material = materialWidth3js.material3js;\r\n    if (material.isMeshBasicMaterial ||\r\n        material.isMeshLambertMaterial ||\r\n        material.isMeshPhongMaterial ||\r\n        material.isMeshStandardMaterial ||\r\n        material.isMeshNormalMaterial ||\r\n        material.isMeshDepthMaterial) {\r\n\r\n        refreshUniformsCommon(m_uniforms, material);\r\n\r\n    }\r\n\r\n    // refresh single material specific uniforms\r\n\r\n    if (material.isLineBasicMaterial) {\r\n\r\n        refreshUniformsLine(m_uniforms, material);\r\n\r\n    } else if (material.isLineDashedMaterial) {\r\n\r\n        refreshUniformsLine(m_uniforms, material);\r\n        refreshUniformsDash(m_uniforms, material);\r\n\r\n    } else if (material.isPointsMaterial) {\r\n\r\n        refreshUniformsPoints(m_uniforms, material);\r\n\r\n    } else if (material.isMeshLambertMaterial) {\r\n\r\n        refreshUniformsLambert(m_uniforms, material);\r\n\r\n    } else if (material.isMeshToonMaterial) {\r\n\r\n        refreshUniformsToon(m_uniforms, material);\r\n\r\n    } else if (material.isMeshPhongMaterial) {\r\n\r\n        refreshUniformsPhong(m_uniforms, material);\r\n\r\n    } else if (material.isMeshPhysicalMaterial) {\r\n\r\n        refreshUniformsPhysical(m_uniforms, material);\r\n\r\n    } else if (material.isMeshStandardMaterial) {\r\n\r\n        refreshUniformsStandard(m_uniforms, material);\r\n\r\n    } else if (material.isMeshDepthMaterial) {\r\n\r\n        if (material.displacementMap) {\r\n\r\n            bindUniformValue(m_uniforms.displacementMap, material.displacementMap);\r\n            bindUniformValue(m_uniforms.displacementScale, material.displacementScale);\r\n            bindUniformValue(m_uniforms.displacementBias, material.displacementBias);\r\n\r\n        }\r\n\r\n    } else if (material.isMeshNormalMaterial) {\r\n\r\n        refreshUniformsNormal(m_uniforms, material);\r\n\r\n    } else {\r\n        for (var i in material.uniforms) {\r\n            if (material.uniforms.hasOwnProperty(i)) {\r\n                bindUniformValue(m_uniforms[i], material.uniforms[i].value);\r\n            }\r\n        }\r\n    }\r\n    //if (material.lights) {\r\n\r\n    //    // wire up the material to this renderer's lighting state\r\n\r\n    //    //uniforms.ambientLightColor.value = _lights.ambient;\r\n    //    //uniforms.directionalLights.value = _lights.directional;\r\n    //    //uniforms.spotLights.value = _lights.spot;\r\n    //    //uniforms.rectAreaLights.value = _lights.rectArea;\r\n    //    //uniforms.pointLights.value = _lights.point;\r\n    //    //uniforms.hemisphereLights.value = _lights.hemi;\r\n\r\n    //    //uniforms.directionalShadowMap.value = _lights.directionalShadowMap;\r\n    //    //uniforms.directionalShadowMatrix.value = _lights.directionalShadowMatrix;\r\n    //    //uniforms.spotShadowMap.value = _lights.spotShadowMap;\r\n    //    //uniforms.spotShadowMatrix.value = _lights.spotShadowMatrix;\r\n    //    //uniforms.pointShadowMap.value = _lights.pointShadowMap;\r\n    //    //uniforms.pointShadowMatrix.value = _lights.pointShadowMatrix;\r\n    //    // TODO (abelnation): add area lights shadow info to uniforms\r\n\r\n    //} else {\r\n    m_uniforms.ambientLightColor = { value: new Cesium.Color(0.06666666666666667, 0.06666666666666667, 0.06666666666666667) };\r\n    //}\r\n}\r\n\r\n\r\n\r\n/**\r\n *\r\n *@param {Object}material3js\r\n *@return {Boolean}\r\n */\r\nMaterialUtils.isMaterial3js = function (material3js) {\r\n    return typeof THREE !== 'undefined' && material3js instanceof THREE.Material;\r\n}\r\n// Uniforms (refresh bindUniformValue(uniforms objects)\r\n\r\nfunction refreshUniformsCommon(uniforms, material) {\r\n\r\n    bindUniformValue(uniforms.opacity, material.opacity);\r\n\r\n    bindUniformValue(uniforms.diffuse, material.color);\r\n\r\n    if (material.emissive) {\r\n        var val3js = new material.emissive.constructor().copy(material.emissive).multiplyScalar(material.emissiveIntensity)\r\n        bindUniformValue(uniforms.emissive, val3js);\r\n\r\n    }\r\n\r\n    bindUniformValue(uniforms.map, material.map);\r\n    bindUniformValue(uniforms.specularMap, material.specularMap);\r\n    bindUniformValue(uniforms.alphaMap, material.alphaMap);\r\n\r\n    if (material.lightMap) {\r\n\r\n        bindUniformValue(uniforms.lightMap, material.lightMap);\r\n        bindUniformValue(uniforms.lightMapIntensity, material.lightMapIntensity);\r\n\r\n    }\r\n\r\n    if (material.aoMap) {\r\n\r\n        bindUniformValue(uniforms.aoMap, material.aoMap);\r\n        bindUniformValue(uniforms.aoMapIntensity, material.aoMapIntensity);\r\n\r\n    }\r\n\r\n    // uv repeat and offset setting priorities\r\n    // 1. color map\r\n    // 2. specular map\r\n    // 3. normal map\r\n    // 4. bump map\r\n    // 5. alpha map\r\n    // 6. emissive map\r\n\r\n    var uvScaleMap\r\n\r\n    if (material.map) {\r\n\r\n        uvScaleMap = material.map\r\n\r\n    } else if (material.specularMap) {\r\n\r\n        uvScaleMap = material.specularMap\r\n\r\n    } else if (material.displacementMap) {\r\n\r\n        uvScaleMap = material.displacementMap\r\n\r\n    } else if (material.normalMap) {\r\n\r\n        uvScaleMap = material.normalMap\r\n\r\n    } else if (material.bumpMap) {\r\n\r\n        uvScaleMap = material.bumpMap\r\n\r\n    } else if (material.roughnessMap) {\r\n\r\n        uvScaleMap = material.roughnessMap\r\n\r\n    } else if (material.metalnessMap) {\r\n\r\n        uvScaleMap = material.metalnessMap\r\n\r\n    } else if (material.alphaMap) {\r\n\r\n        uvScaleMap = material.alphaMap\r\n\r\n    } else if (material.emissiveMap) {\r\n\r\n        uvScaleMap = material.emissiveMap\r\n\r\n    }\r\n\r\n    if (uvScaleMap !== undefined) {\r\n\r\n        // backwards compatibility\r\n        if (uvScaleMap.isWebGLRenderTarget) {\r\n\r\n            uvScaleMap = uvScaleMap.texture\r\n\r\n        }\r\n\r\n        var offset = uvScaleMap.offset\r\n        var repeat = uvScaleMap.repeat\r\n\r\n        bindUniformValue(uniforms.offsetRepeat, offset);\r\n\r\n    }\r\n\r\n    bindUniformValue(uniforms.envMap, material.envMap);\r\n\r\n    // don't flip CubeTexture envMaps, flip everything else:\r\n    //  WebGLRenderTargetCube will be flipped for backwards compatibility\r\n    //  WebGLRenderTargetCube.texture will be flipped because it's a Texture and NOT a CubeTexture\r\n    // this check must be handled differently, or removed entirely, if WebGLRenderTargetCube uses a CubeTexture in the future\r\n    bindUniformValue(uniforms.flipEnvMap, (!(material.envMap && material.envMap.isCubeTexture)) ? 1 : -1);\r\n\r\n    bindUniformValue(uniforms.reflectivity, material.reflectivity);\r\n    bindUniformValue(uniforms.refractionRatio, material.refractionRatio);\r\n\r\n}\r\n\r\nfunction refreshUniformsLine(uniforms, material) {\r\n\r\n    bindUniformValue(uniforms.diffuse, material.color);\r\n    bindUniformValue(uniforms.opacity, material.opacity);\r\n\r\n}\r\n\r\nfunction refreshUniformsDash(uniforms, material) {\r\n\r\n    bindUniformValue(uniforms.dashSize, material.dashSize);\r\n    bindUniformValue(uniforms.totalSize, material.dashSize + material.gapSize);\r\n    bindUniformValue(uniforms.scale, material.scale);\r\n\r\n}\r\n\r\nfunction refreshUniformsPoints(uniforms, material) {\r\n\r\n    bindUniformValue(uniforms.diffuse, material.color);\r\n    bindUniformValue(uniforms.opacity, material.opacity);\r\n    bindUniformValue(uniforms.size, material.size * _pixelRatio);\r\n    bindUniformValue(uniforms.scale, _height * 0.5);\r\n\r\n    bindUniformValue(uniforms.map, material.map);\r\n\r\n    if (material.map !== null) {\r\n\r\n        var offset = material.map.offset;\r\n        var repeat = material.map.repeat;\r\n\r\n        bindUniformValue(uniforms.offsetRepeat.value.set(offset.x, offset.y, repeat.x, repeat.y));\r\n\r\n    }\r\n\r\n}\r\n\r\nfunction refreshUniformsFog(uniforms, fog) {\r\n\r\n    bindUniformValue(uniforms.fogColor, fog.color);\r\n\r\n    if (fog.isFog) {\r\n\r\n        bindUniformValue(uniforms.fogNear, fog.near);\r\n        bindUniformValue(uniforms.fogFar, fog.far);\r\n\r\n    } else if (fog.isFogExp2) {\r\n\r\n        bindUniformValue(uniforms.fogDensity, fog.density);\r\n\r\n    }\r\n\r\n}\r\n\r\nfunction refreshUniformsLambert(uniforms, material) {\r\n\r\n    if (material.emissiveMap) {\r\n\r\n        bindUniformValue(uniforms.emissiveMap, material.emissiveMap);\r\n\r\n    }\r\n\r\n}\r\n\r\nfunction refreshUniformsPhong(uniforms, material) {\r\n\r\n    bindUniformValue(uniforms.specular, material.specular);\r\n    bindUniformValue(uniforms.shininess, Math.max(material.shininess, 1e-4)); // to prevent pow( 0.0, 0.0 )\r\n\r\n    if (material.emissiveMap) {\r\n\r\n        bindUniformValue(uniforms.emissiveMap, material.emissiveMap);\r\n\r\n    }\r\n\r\n    if (material.bumpMap) {\r\n\r\n        bindUniformValue(uniforms.bumpMap, material.bumpMap);\r\n        bindUniformValue(uniforms.bumpScale, material.bumpScale);\r\n\r\n    }\r\n\r\n    if (material.normalMap) {\r\n\r\n        bindUniformValue(uniforms.normalMap, material.normalMap);\r\n        bindUniformValue(uniforms.normalScale.value.copy(material.normalScale));\r\n\r\n    }\r\n\r\n    if (material.displacementMap) {\r\n\r\n        bindUniformValue(uniforms.displacementMap, material.displacementMap);\r\n        bindUniformValue(uniforms.displacementScale, material.displacementScale);\r\n        bindUniformValue(uniforms.displacementBias, material.displacementBias);\r\n\r\n    }\r\n\r\n}\r\n\r\nfunction refreshUniformsToon(uniforms, material) {\r\n\r\n    refreshUniformsPhong(uniforms, material);\r\n\r\n    if (material.gradientMap) {\r\n\r\n        bindUniformValue(uniforms.gradientMap, material.gradientMap);\r\n\r\n    }\r\n\r\n}\r\n\r\nfunction refreshUniformsStandard(uniforms, material) {\r\n\r\n    bindUniformValue(uniforms.roughness, material.roughness);\r\n    bindUniformValue(uniforms.metalness, material.metalness);\r\n\r\n    if (material.roughnessMap) {\r\n\r\n        bindUniformValue(uniforms.roughnessMap, material.roughnessMap);\r\n\r\n    }\r\n\r\n    if (material.metalnessMap) {\r\n\r\n        bindUniformValue(uniforms.metalnessMap, material.metalnessMap);\r\n\r\n    }\r\n\r\n    if (material.emissiveMap) {\r\n\r\n        bindUniformValue(uniforms.emissiveMap, material.emissiveMap);\r\n\r\n    }\r\n\r\n    if (material.bumpMap) {\r\n\r\n        bindUniformValue(uniforms.bumpMap, material.bumpMap);\r\n        bindUniformValue(uniforms.bumpScale, material.bumpScale);\r\n\r\n    }\r\n\r\n    if (material.normalMap) {\r\n\r\n        bindUniformValue(uniforms.normalMap, material.normalMap);\r\n        bindUniformValue(uniforms.normalScale.value.copy(material.normalScale));\r\n\r\n    }\r\n\r\n    if (material.displacementMap) {\r\n\r\n        bindUniformValue(uniforms.displacementMap, material.displacementMap);\r\n        bindUniformValue(uniforms.displacementScale, material.displacementScale);\r\n        bindUniformValue(uniforms.displacementBias, material.displacementBias);\r\n\r\n    }\r\n\r\n    if (material.envMap) {\r\n\r\n        //bindUniformValue(uniforms.envMap, material.envMap); // part of bindUniformValue(uniforms common\r\n        bindUniformValue(uniforms.envMapIntensity, material.envMapIntensity);\r\n\r\n    }\r\n\r\n}\r\n\r\nfunction refreshUniformsPhysical(uniforms, material) {\r\n\r\n    bindUniformValue(uniforms.clearCoat, material.clearCoat);\r\n    bindUniformValue(uniforms.clearCoatRoughness, material.clearCoatRoughness);\r\n\r\n    refreshUniformsStandard(uniforms, material)\r\n\r\n}\r\n\r\nfunction refreshUniformsNormal(uniforms, material) {\r\n\r\n    if (material.bumpMap) {\r\n\r\n        bindUniformValue(uniforms.bumpMap, material.bumpMap);\r\n        bindUniformValue(uniforms.bumpScale, material.bumpScale);\r\n\r\n    }\r\n\r\n    if (material.normalMap) {\r\n\r\n        bindUniformValue(uniforms.normalMap, material.normalMap);\r\n        bindUniformValue(uniforms.normalScale.value.copy(material.normalScale));\r\n\r\n    }\r\n\r\n    if (material.displacementMap) {\r\n\r\n        bindUniformValue(uniforms.displacementMap, material.displacementMap);\r\n        bindUniformValue(uniforms.displacementScale, material.displacementScale);\r\n        bindUniformValue(uniforms.displacementBias, material.displacementBias);\r\n\r\n    }\r\n\r\n}\r\n\r\nfunction bindUniformValue(valCesium, val3js) {\r\n\r\n    var type = typeof val3js;\r\n    if (type === 'undefined') {\r\n        valCesium.value = undefined;\r\n        return;\r\n    }\r\n    if (val3js === null) {\r\n        valCesium.value = null; return;\r\n    }\r\n    if (typeof valCesium.value !== \"undefined\"\r\n        && valCesium.value != null\r\n        && (valCesium.value.constructor\r\n            && valCesium.value.constructor.clone\r\n            && val3js.constructor == valCesium.value.constructor)) {\r\n\r\n        valCesium.value = valCesium.value.constructor.clone(val3js);\r\n    } else {\r\n        switch (type) {\r\n            case \"number\":\r\n            case \"string\":\r\n                valCesium.value = val3js;\r\n                break;\r\n            case \"object\":\r\n                if (val3js instanceof THREE.Vector2) {\r\n                    if (!valCesium.value.constructor.clone) {\r\n                        valCesium.value = new Cesium.Cartesian2();\r\n                    }\r\n                }\r\n                if (val3js instanceof THREE.Vector3) {\r\n                    if (!valCesium.value.constructor.clone) {\r\n                        valCesium.value = new Cesium.Cartesian3();\r\n                    }\r\n                }\r\n                if (val3js instanceof THREE.Vector4) {\r\n                    if (!valCesium.value.constructor.clone) {\r\n                        valCesium.value = new Cesium.Cartesian4();\r\n                    }\r\n                }\r\n                if (val3js instanceof THREE.Matrix3) {\r\n                    if (!valCesium.value.constructor.clone) {\r\n                        valCesium.value = new Cesium.Matrix3();\r\n                    }\r\n                }\r\n                if (val3js instanceof THREE.Matrix4) {\r\n                    if (!valCesium.value.constructor.clone) {\r\n                        valCesium.value = new Cesium.Matrix4();\r\n                    }\r\n                }\r\n                if (val3js instanceof THREE.Color) {\r\n                    if (!valCesium.value.constructor.clone) {\r\n                        valCesium.value = new Cesium.Color(val3js.r, val3js.g, val3js.b, val3js.a);\r\n                    }\r\n                } else if (valCesium.value != null && valCesium.value.constructor.clone) {\r\n                    valCesium.value.constructor.clone(val3js, valCesium.value);\r\n                } else if (val3js instanceof THREE.Texture) {\r\n                    if (valCesium.value != val3js.image) {\r\n                        valCesium.value = val3js.image;\r\n                        var sampler = {};\r\n\r\n                        sampler.magnificationFilter = Cesium.WebGLConstants.LINEAR;\r\n                        sampler.minificationFilter = Cesium.WebGLConstants.NEAREST_MIPMAP_LINEAR;\r\n                        sampler.wrapS = Cesium.WebGLConstants.REPEAT;\r\n                        sampler.wrapT = Cesium.WebGLConstants.REPEAT;\r\n                        valCesium.sampler = sampler;\r\n                        valCesium.flipY = val3js.flipY;\r\n\r\n                        valCesium.needsUpdate = true;\r\n                    }\r\n                } else {\r\n                    valCesium.value = val3js;\r\n                }\r\n                break;\r\n            default:\r\n                console.log(\"未知uniform.value类型\");\r\n                break;\r\n        }\r\n    }\r\n}\r\n\r\nexport default MaterialUtils; ","\r\nimport Rotation from './Rotation.js';\r\nimport CSG from '../Util/CSG.js'\r\nimport MeshMaterial from './MeshMaterial.js';\r\nimport GeometryUtils from './GeometryUtils.js';\r\nimport MeshPhongMaterial from './MeshPhongMaterial.js';\r\n\r\n/**\r\n*\r\n*@param {Object|geometry}options \r\n*@param {Cesium.Geometry|Cesium.CSG|THREE.Geometry|THREE.BufferGeometry}options.geometry  \r\n*@param {Cesium.MeshMaterial}options.material  \r\n*@param {Boolean}[options.show=true]  \r\n*@param {Cesium.Cartesian3}[options.position]\r\n*@param {Cesium.Rotation}[options.rotation]\r\n*@param {Cesium.Cartesian3}[options.scale]   \r\n*@param {{modelMatrix:Cesium.Matrix4,show:boolean}[]}[options.instances]\r\n*@param {Cesium.MeshMaterial}[material]\r\n*@param {{modelMatrix:Cesium.Matrix4,show:boolean}[]}[instances]\r\n*@param {{name:string,default:number|Cesium.Cartesian2|Cesium.Cartesian3|Cesium.Cartesian4|Cesium.Color}[]}[instancedAttributes]\r\n*\r\n*@property {Cesium.Geometry}geometry  \r\n*@property {Cesium.MeshMaterial}material\r\n*@property {Boolean}show  \r\n*@property {Cesium.Cartesian3}position\r\n*@property {Cesium.VolumeRendering.Rotation}rotation\r\n*@property {Cesium.Cartesian3}scale   \r\n*@property {Boolean}needUpdate \r\n*@property {Cesium.Mesh|Cesium.LOD}parent \r\n*@property {{modelMatrix:Cesium.Matrix4}[]}instances\r\n*\r\n*@constructor\r\n*@memberof Cesium\r\n*@example\r\n    //1.\r\n    var mesh=new Mesh(geomertry,material);\r\n\r\n    //2.\r\n    var mesh2=new Mesh({\r\n        geomertry:geomertry2,\r\n        material:material2,\r\n        position:position2\r\n    });\r\n\r\n*/\r\nfunction Mesh(options) {\r\n    if (Mesh.isGeometrySupported(options)) {\r\n        var geometry = options;\r\n\r\n        options = {\r\n            geometry: geometry,\r\n            material: arguments[1],\r\n            instances: arguments[2],\r\n            instancedAttributes: arguments[3]\r\n        };\r\n    }\r\n    if (!options || !options.geometry) {\r\n        throw new Error(\"geometry是必须参数\");\r\n    }\r\n    if (!Mesh.isGeometrySupported(options.geometry)) {\r\n        throw new Error(\"暂不支持此类型的geometry\");\r\n    }\r\n\r\n    if (GeometryUtils.isGeometry3js(options.geometry)) {\r\n        options.geometry = GeometryUtils.fromGeometry3js(options.geometry);\r\n    } else if (options.geometry instanceof CSG) {\r\n        if (options.geometry.polygons.length == 0) {\r\n            options.show = false;\r\n        }\r\n        options.geometry = CSG.fromCSG(options.geometry);\r\n    } else if (typeof options.geometry.constructor.createGeometry == 'function') {\r\n        options.geometry = options.geometry.constructor.createGeometry(options.geometry);\r\n    }\r\n\r\n    this.uuid = Cesium.createGuid();\r\n    this.show = Cesium.defaultValue(options.show, true);\r\n    this._geometry = options.geometry;\r\n    this._material = Cesium.defaultValue(options.material, new MeshMaterial());\r\n    this._position = Cesium.defaultValue(options.position, new Cesium.Cartesian3(0, 0, 0));\r\n    this._scale = Cesium.defaultValue(options.scale, new Cesium.Cartesian3(1, 1, 1));\r\n    this._rotation = Cesium.defaultValue(options.rotation, { axis: new Cesium.Cartesian3(0, 0, 1), angle: 0 });\r\n    this._rotation = new Rotation(this._rotation.axis, this._rotation.angle);\r\n    this._needsUpdate = false;\r\n    this._modelMatrix = new Cesium.Matrix4();\r\n    Cesium.Matrix4.clone(Cesium.Matrix4.IDENTITY, this._modelMatrix);\r\n\r\n    //用于设置旋转，优先级大于rotation\r\n    this.quaternion = null;\r\n\r\n    this._modelMatrixNeedsUpdate = true;\r\n    this._onNeedUpdateChanged = function () {\r\n        this.modelMatrixNeedsUpdate = true;\r\n    };\r\n    this._rotation.paramChanged.removeEventListener(this._onNeedUpdateChanged);\r\n    this._drawCommand = null;\r\n    this._children = [];\r\n    this._parent = null;\r\n    this._instances = null;\r\n    this._center = this._position.clone();\r\n    this.instancedAttributes = options.instancedAttributes || [];\r\n    if (options.instances && options.instances.length) {\r\n        this._instances = [];\r\n        options.instances.forEach(function (instance) {\r\n            this.addInstance(instance);\r\n        }, this);\r\n    }\r\n\r\n    this.userData = {};\r\n\r\n    if (!this._geometry.attributes.normal\r\n        && this.material instanceof MeshPhongMaterial\r\n        && this._geometry.primitiveType == Cesium.PrimitiveType.TRIANGLES\r\n    ) {\r\n        Cesium.GeometryPipeline.computeNormal(this._geometry);\r\n        //GeometryUtils.computeVertexNormals(this._geometry);\r\n    }\r\n\r\n    if (this._material && this._material.addReference) {\r\n        this._material.addReference();\r\n    }\r\n}\r\n\r\nMesh.isGeometrySupported = function (geometry) {\r\n    var supported = (geometry instanceof Cesium.Geometry\r\n        || geometry instanceof CSG\r\n        || typeof geometry.constructor.createGeometry == 'function'\r\n        || GeometryUtils.isGeometry3js(geometry));\r\n    return supported;\r\n}\r\n\r\n/**\r\n * \r\n * @param {object}instance\r\n * @param {Cesium.Matrix4}instance.modelMatrix\r\n * @param {boolean}[instance.show=true]\r\n */\r\nMesh.prototype.addInstance = function (instance) {\r\n    this._instances = this._instances || [];\r\n    instance.show = Cesium.defaultValue(instance.show, true);\r\n    instance.primitive = this;\r\n    instance.boundingSphere = new Cesium.BoundingSphere(new Cesium.Cartesian3(), this.geometry.boundingSphere ? this.geometry.boundingSphere.radius : 0)\r\n\r\n    Cesium.Matrix4.getTranslation(instance.modelMatrix, instance.boundingSphere.center)\r\n\r\n    instance.id = instance.id || Cesium.createGuid();\r\n    instance.instanceId = this._instances.length;\r\n\r\n    this.instancedAttributes.forEach(function (attr) {\r\n        if (!instance[attr.name]) {\r\n            instance[attr.name] = attr.default;\r\n        }\r\n    })\r\n\r\n    this._instances.push(instance);\r\n\r\n    return instance;\r\n}\r\n\r\n/**\r\n*\r\n*@param {Cesium.Mesh|Cesium.LOD}node\r\n*@param {Cesium.Mesh~TraverseCallback}callback\r\n*/\r\nMesh.traverse = function (node, callback) {\r\n    callback(node);\r\n    if (node.children) {\r\n        node.children.forEach(function (child) {\r\n            callback(child);\r\n        })\r\n    }\r\n}\r\n\r\n\r\n/**\r\n *  \r\n * @callback Cesium.Mesh~TraverseCallback\r\n * @param {Cesium.Mesh|Cesium.LOD}node\r\n */\r\n\r\nObject.defineProperties(Mesh.prototype, {\r\n    instances: {\r\n        get: function () {\r\n            return this._instances;\r\n        }\r\n    },\r\n    modelMatrix: {\r\n        get: function () {\r\n            return this._modelMatrix;\r\n        }\r\n    },\r\n    parent: {\r\n        get: function () {\r\n            return this._parent;\r\n        },\r\n        set: function (val) {\r\n            this._parent = val;\r\n            this.modelMatrixNeedsUpdate = true;\r\n\r\n        }\r\n    },\r\n    modelMatrixNeedsUpdate: {\r\n        get: function () {\r\n            return this._modelMatrixNeedsUpdate;\r\n        },\r\n        set: function (val) {\r\n            this._modelMatrixNeedsUpdate = val;\r\n            if (this._modelMatrixNeedsUpdate) {\r\n                Mesh.traverse(this, function (mesh) {\r\n                    mesh._modelMatrixNeedsUpdate = val;\r\n                });\r\n            }\r\n        }\r\n    },\r\n    children: {\r\n        get: function () {\r\n            return this._children;\r\n        },\r\n        set: function (val) {\r\n            this._children = val;\r\n            this._needsUpdate = true;\r\n        }\r\n    },\r\n    geometry: {\r\n        get: function () {\r\n            return this._geometry;\r\n        },\r\n        set: function (val) {\r\n            this._geometry = val;\r\n            this._needsUpdate = true;\r\n            this.modelMatrixNeedsUpdate = true;\r\n        }\r\n    },\r\n    material: {\r\n        get: function () {\r\n            return this._material;\r\n        },\r\n        set: function (val) {\r\n            this._material = val;\r\n            this._needsUpdate = true;\r\n        }\r\n    },\r\n    needsUpdate: {\r\n        get: function () {\r\n            return this._needsUpdate;\r\n        },\r\n        set: function (val) {\r\n            this._needsUpdate = val;\r\n        }\r\n    },\r\n    rotation: {\r\n        get: function () {\r\n            return this._rotation;\r\n        },\r\n        set: function (val) {\r\n            if (val != this._rotation) {\r\n                this._rotation = val;\r\n                // this._needUpdate = true;\r\n                this.modelMatrixNeedsUpdate = true;\r\n            }\r\n            this._rotation.paramChanged.removeEventListener(this._onNeedUpdateChanged);\r\n            this._rotation = val;\r\n            this._rotation.paramChanged.addEventListener(this._onNeedUpdateChanged);\r\n        }\r\n    },\r\n    position: {\r\n        get: function () {\r\n            return this._position;\r\n        },\r\n        set: function (val) {\r\n            if (val.x != this._position.x || val.y != this._position.y || val.z != this._position.z) {\r\n                this._position = val;\r\n                //this._needsUpdate = true;\r\n                this.modelMatrixNeedsUpdate = true;\r\n            }\r\n            this._position = val;\r\n        }\r\n    },\r\n    scale: {\r\n        get: function () {\r\n            return this._scale;\r\n        },\r\n        set: function (val) {\r\n            if (val.x != this._scale.x || val.y != this._scale.y || val.z != this._scale.z) {\r\n                this._scale = val;\r\n                // this._needsUpdate = true; \r\n                this.modelMatrixNeedsUpdate = true;\r\n            }\r\n            this._scale = val;\r\n        }\r\n    }\r\n});\r\n\r\n/**\r\n*@oaram {Cesium.Mesh|Cesium.LOD}child\r\n*/\r\nMesh.prototype.add = function (mesh) {\r\n\r\n    if (mesh.parent !== this) {\r\n        mesh.parent = this;\r\n    }\r\n    this._children.push(mesh);\r\n}\r\n\r\nMesh.prototype.destroy = function () {\r\n    if (this.material && this.material.removeReference) {\r\n        this.material.removeReference();\r\n    }\r\n    if (this.geometry) {\r\n        Cesium.destroyObject(this.geometry);\r\n        delete this.geometry;\r\n    }\r\n}\r\n\r\nexport default Mesh;","﻿\r\nimport defineProperty from '../Util/defineProperty.js';\r\n\r\n/**\r\n*\r\n*@param {Object}options\r\n*@param {Object}[options.uniforms]\r\n*@param {Object}[options.uniformStateUsed]\r\n*@param {Boolean}[options.translucent]\r\n*@param {Boolean}[options.wireframe]\r\n*@param {Enum}[options.side=Cesium.MeshMaterial.Sides.DOUBLE]\r\n*@param {String|Cesium.Color}[options.defaultColor=Cesium.Color.WHITE]\r\n*@param {String}[options.vertexShader]\r\n*@param {String}[options.fragmentShader]\r\n*@param {string}[options.pickColorQualifier]\r\n*\r\n*\r\n*@property {Object}uniforms\r\n*@property {Object}uniformStateUsed\r\n*@property {Boolean}translucent\r\n*@property {Boolean}wireframe\r\n*@property {Enum}side\r\n*@property {String|Cesium.Color}defaultColor\r\n*@property {String}vertexShader\r\n*@property {String}fragmentShader\r\n*\r\n*@constructor\r\n*@memberof Cesium\r\n*/\r\nfunction MeshMaterial(options) {\r\n    options = Cesium.defaultValue(options, {});\r\n    options.uniforms = Cesium.defaultValue(options.uniforms, {});\r\n    var that = this;\r\n    this.referenceCount = 0;\r\n    this._disposeCallbacks = [];\r\n\r\n    this._uuid = Cesium.createGuid();\r\n\r\n    function initUniform(srcUniforms) {\r\n        var _uniforms = {};\r\n\r\n        for (var i in srcUniforms) {\r\n            if (srcUniforms.hasOwnProperty(i) && Cesium.defined(srcUniforms[i])) {\r\n                var item = srcUniforms[i];\r\n\r\n                var val = {};\r\n                val.needsUpdate = true;\r\n                val._disposeCallbacks = [];\r\n                val.onDispose = function (disposeCallback) {\r\n                    if (this._disposeCallbacks.indexOf(disposeCallback) == -1) {\r\n                        this._disposeCallbacks.push(disposeCallback);\r\n                    }\r\n                }\r\n                val.destroy = function () {\r\n                    for (var i = 0; i < this._disposeCallbacks.length; i++) {\r\n                        var disposeCallback = this._disposeCallbacks[i];\r\n                        disposeCallback.call(this);\r\n                    }\r\n\r\n                    this._disposeCallbacks.splice(0);\r\n                }\r\n\r\n                if (Array.isArray(item) && item.length >= 3 && item.length <= 4 && typeof item[0] === 'number') {\r\n                    srcUniforms[i] = new Cesium.Color(srcUniforms[i][0], srcUniforms[i][1], srcUniforms[i][2], srcUniforms[i][3]);\r\n                } else if (Cesium.defined(item.value)) {\r\n                    for (var n in item) {\r\n                        if (item.hasOwnProperty(n)) {\r\n                            val[n] = item[n];\r\n                        }\r\n                    }\r\n                }\r\n\r\n                if (srcUniforms[i].hasOwnProperty(\"uuid\")) {\r\n                    defineProperty(val, \"uuid\", srcUniforms[i].uuid, function (changed, owner) {\r\n                        owner.needsUpdate = changed;\r\n                    });\r\n                } else {\r\n                    defineProperty(val, \"uuid\", Cesium.createGuid(), function (changed, owner) {\r\n                        owner.needsUpdate = changed;\r\n                    });\r\n                }\r\n                if (srcUniforms[i].hasOwnProperty(\"value\")) {\r\n                    defineProperty(val, \"value\", srcUniforms[i].value, function (changed, owner) {\r\n                        owner.needsUpdate = changed;\r\n                    });\r\n                } else {\r\n                    defineProperty(val, \"value\", srcUniforms[i], function (changed, owner) {\r\n                        owner.needsUpdate = changed;\r\n                    });\r\n                }\r\n                _uniforms[i] = val;\r\n                //defineProperty(_uniforms, i, val, function (changed) {\r\n                //    that.needsUpdate = changed;\r\n                //});\r\n            }\r\n        }\r\n        return _uniforms;\r\n    }\r\n    this._defaultColor = Cesium.defaultValue(options.defaultColor, Cesium.Color.WHITE);\r\n    if (typeof this._defaultColor == 'string') {\r\n        this._defaultColor = Cesium.Color.fromCssColorString(this._defaultColor);\r\n    }\r\n\r\n    this._pickedColor = Cesium.defaultValue(options.pickedColor, Cesium.Color.YELLOW);\r\n    if (typeof this._pickedColor == 'string') {\r\n        this._pickedColor = Cesium.Color.fromCssColorString(this._pickedColor);\r\n    }\r\n    this._picked = Cesium.defaultValue(options.picked, 0);\r\n    options.uniforms.pickedColor = this._pickedColor;\r\n    options.uniforms.defaultColor = this._defaultColor;\r\n    options.uniforms.picked = this._picked;\r\n\r\n    this._uniforms = initUniform(options.uniforms);\r\n\r\n    function onPropertyChanged(changed) {\r\n        that.needsUpdate = changed;\r\n    }\r\n\r\n    defineProperty(this, \"translucent\", Cesium.defaultValue(options.translucent, false), onPropertyChanged);\r\n    defineProperty(this, \"wireframe\", Cesium.defaultValue(options.wireframe, false), onPropertyChanged);\r\n    defineProperty(this, \"side\", Cesium.defaultValue(options.side, MeshMaterial.Sides.DOUBLE), onPropertyChanged);\r\n\r\n    defineProperty(this, \"uniformStateUsed\", Cesium.defaultValue(options.uniformStateUsed, [{\r\n        uniformStateName: \"model\",\r\n        glslVarName: \"modelMatrix\"\r\n    }]), onPropertyChanged);\r\n    defineProperty(this, \"uniforms\", this._uniforms, function () {\r\n        that._uniforms = initUniform(that._uniforms);\r\n    });\r\n\r\n\r\n    this._vertexShader = '//#inner\\n void main() {\\n\\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\\n\\n}';\r\n    this._fragmentShader = '//#inner' + this._uuid + '\\n uniform float picked;\\n uniform vec4  pickedColor;\\n uniform vec4  defaultColor;\\n void main() {\\ngl_FragColor = defaultColor;\\n if(picked!=0.0){\\ngl_FragColor = pickedColor;}}';// vec4( ' + this._defaultColor.red + ',' + this._defaultColor.green + ',' + this._defaultColor.blue + ',' + this._defaultColor.alpha + ');\\n}';\r\n\r\n    defineProperty(this, \"vertexShader\", Cesium.defaultValue(options.vertexShader, this._vertexShader), onPropertyChanged);\r\n    defineProperty(this, \"fragmentShader\", Cesium.defaultValue(options.fragmentShader, this._fragmentShader), onPropertyChanged);\r\n\r\n    this.depthTest = Cesium.defaultValue(options.depthTest, true);\r\n    this.depthMask = Cesium.defaultValue(options.depthMask, true);\r\n    this.blending = Cesium.defaultValue(options.blending, true);\r\n\r\n    this.allowPick = Cesium.defaultValue(options.allowPick, true);\r\n    this.pickColorQualifier = Cesium.defaultValue(options.pickColorQualifier, 'uniform');\r\n    this.needsUpdate = true;\r\n}\r\n\r\n\r\nObject.defineProperties(MeshMaterial.prototype, {\r\n    uuid: {\r\n        get: function () {\r\n            return this._uuid;\r\n        }\r\n    },\r\n    defaultColor: {\r\n        set: function (val) {\r\n            if (typeof val == 'string') {\r\n                val = Cesium.Color.fromCssColorString(val);\r\n            }\r\n            Cesium.Color.clone(val, this._defaultColor);\r\n        },\r\n        get: function () {\r\n            return this._defaultColor;\r\n        }\r\n    }\r\n});\r\n\r\n/**\r\n*\r\n*@memberof Cesium.MeshMaterial\r\n*@property {Enum}FRONT\r\n*@property {Enum}BACK\r\n*@property {Enum}DOUBLE\r\n*/\r\nMeshMaterial.Sides = {\r\n    FRONT: 3,\r\n    BACK: 1,\r\n    DOUBLE: 2\r\n}\r\n\r\nMeshMaterial.prototype.onDispose = function (disposeCallback) {\r\n    if (this._disposeCallbacks.indexOf(disposeCallback) == -1) {\r\n        this._disposeCallbacks.push(disposeCallback);\r\n    }\r\n}\r\n\r\nMeshMaterial.prototype.addReference = function () {\r\n    this.referenceCount++\r\n}\r\n\r\nMeshMaterial.prototype.removeReference = function () {\r\n    this.referenceCount--\r\n    if (this.referenceCount <= 0) {\r\n        for (var i = 0; i < this._disposeCallbacks.length; i++) {\r\n            var disposeCallback = this._disposeCallbacks[i];\r\n            disposeCallback.call(this);\r\n        }\r\n\r\n        this._disposeCallbacks.splice(0);\r\n        this.destroy();\r\n    }\r\n}\r\n\r\nMeshMaterial.prototype.destroy = function () {\r\n    for (var key in this._uniforms) {\r\n        if (this._uniforms.hasOwnProperty(key)) {\r\n            this._uniforms[key].destroy && this._uniforms[key].destroy()\r\n        }\r\n    }\r\n}\r\nexport default MeshMaterial;","\r\nimport MeshMaterial from './MeshMaterial.js';\r\nimport phong_frag from './Shaders/phong_frag.js';\r\nimport phong_vert from './Shaders/phong_vert.js';\r\n\r\n/**\r\n* \r\n*@constructor\r\n*@memberof Cesium\r\n*@extends Cesium.MeshMaterial\r\n*/\r\nfunction MeshPhongMaterial(options) {\r\n    options = options ? options : {};\r\n\r\n    options.uniforms = options.uniforms ? options.uniforms : {\r\n        shininess: -1,\r\n        emission: [0, 0, 0],\r\n        specular: 0\r\n    };\r\n    options.uniforms.shininess = Cesium.defaultValue(options.uniforms.shininess, 0);\r\n    options.uniforms.emission = Cesium.defaultValue(options.uniforms.emission, [0.2, 0.2, 0.2]);\r\n    options.uniforms.specular = Cesium.defaultValue(options.uniforms.specular, 0);\r\n\r\n    MeshMaterial.apply(this, arguments);\r\n    this.vertexShader = phong_vert;\r\n    this.fragmentShader = phong_frag;\r\n}\r\nMeshPhongMaterial.prototype = Object.create(MeshMaterial.prototype);\r\nexport default MeshPhongMaterial;","﻿\r\nimport MaterialUtils from './MaterialUtils.js';\r\nimport GeometryUtils from './GeometryUtils.js';\r\nimport Mesh from './Mesh.js';\r\n\r\n/**\r\n*\r\n*@constructor\r\n*@memberof Cesium\r\n*/\r\nfunction MeshUtils() {\r\n\r\n}\r\n\r\n/**\r\n*\r\n*@param {THREE.Mesh}mesh3js\r\n*@return {Cesium.Mesh}\r\n*/\r\nMeshUtils.fromMesh3js = function (mesh3js) {\r\n    if (!MeshUtils.isMesh3js(mesh3js)) {\r\n        return undefined;\r\n    }\r\n    var geometry = mesh3js.geometry;\r\n    if (GeometryUtils.isGeometry3js(geometry)) {\r\n        geometry = GeometryUtils.fromGeometry3js(geometry);\r\n        //if (mesh3js.material.type === \"MeshNormalMaterial\" || mesh3js.material.type === \"MeshPhongMaterial\") {\r\n        //    GeometryUtils.computeVertexNormals(geometry)\r\n        //}\r\n    }\r\n    var material = mesh3js.material;\r\n    if (MaterialUtils.isMaterial3js(material)) {\r\n        material = MaterialUtils.fromMaterial3js(material);\r\n    }\r\n    var mesh = new Mesh({\r\n        geometry: geometry,\r\n        material: material,\r\n        position: mesh3js.position,\r\n        scale: mesh3js.scale\r\n    });\r\n    mesh.quaternion = mesh3js.quaternion;\r\n    return mesh;\r\n}\r\n/**\r\n *\r\n *@param {Object}mesh\r\n *@return {Boolean}\r\n */\r\nMeshUtils.isMesh3js = function (mesh) {\r\n    return typeof THREE !== 'undefined' && mesh instanceof THREE.Mesh;\r\n}\r\nexport default MeshUtils; ","\r\nimport RendererUtils from './RendererUtils.js';\r\nimport MeshMaterial from './MeshMaterial.js';\r\nimport ShaderChunk from './Shaders/ShaderChunk.js';\r\nimport Rotation from './Rotation.js';\r\nimport FramebufferTexture from './FramebufferTexture.js';\r\nimport LOD from './LOD.js';\r\nimport ReferenceMesh from './ReferenceMesh.js';\r\nimport TIFFParser from '../ThirdParty/tiff-js/tiff.js';\r\nimport Path from '../Util/Path.js';\r\nimport MaterialUtils from './MaterialUtils.js';\r\nimport MeshUtils from './MeshUtils.js';\r\nimport ShaderUtils from './ShaderUtils.js';\r\n\r\nvar Matrix4;//= Cesium.Matrix4;\r\nvar DrawCommand;//= Cesium.DrawCommand;\r\nvar defined;//= Cesium.defined;\r\nvar GeometryPipeline;//= Cesium.GeometryPipeline;\r\nvar BufferUsage;//= Cesium.BufferUsage;\r\nvar BlendingState;//= Cesium.BlendingState;\r\nvar VertexArray;//= Cesium.VertexArray;\r\nvar ShaderProgram;//= Cesium.ShaderProgram;\r\nvar DepthFunction;//= Cesium.DepthFunction;\r\nvar CullFace;//= Cesium.CullFace;\r\nvar RenderState;//= Cesium.RenderState;\r\nvar defaultValue;//= Cesium.defaultValue;\r\nvar Texture;//= Cesium.Texture;\r\nvar PixelFormat;//= Cesium.PixelFormat; \r\nvar Cartesian3;//= Cesium.Cartesian3;\r\nvar Cartesian2;//= Cesium.Cartesian2;\r\nvar Cartesian4;//= Cesium.Cartesian4; \r\nvar CesiumMath;//= Cesium.Math;\r\nvar Color;//= Cesium.Color;\r\nvar Buffer;//= Cesium.Buffer;\r\nvar ComponentDatatype;//= Cesium.ComponentDatatype;\r\nvar loadArrayBuffer;\r\nvar loadImage;\r\n\r\nvar scratchMatrix;\r\nvar world2localMatrix;\r\nvar surfacePointLocal;\r\nvar rayDir;\r\nvar pos;\r\nvar rayOriginLocal;\r\nvar scratchRay;\r\n\r\nvar constantsHasInit = false;\r\nfunction initConstants() {\r\n    if (constantsHasInit) return;\r\n    constantsHasInit = true;\r\n\r\n    Matrix4 = Cesium.Matrix4;\r\n    DrawCommand = Cesium.DrawCommand;\r\n    defined = Cesium.defined;\r\n    GeometryPipeline = Cesium.GeometryPipeline;\r\n    BufferUsage = Cesium.BufferUsage;\r\n    BlendingState = Cesium.BlendingState;\r\n    VertexArray = Cesium.VertexArray;\r\n    ShaderProgram = Cesium.ShaderProgram;\r\n    DepthFunction = Cesium.DepthFunction;\r\n    CullFace = Cesium.CullFace;\r\n    RenderState = Cesium.RenderState;\r\n    defaultValue = Cesium.defaultValue;\r\n    Texture = Cesium.Texture;\r\n    PixelFormat = Cesium.PixelFormat;\r\n    Cartesian3 = Cesium.Cartesian3;\r\n    Cartesian2 = Cesium.Cartesian2;\r\n    Cartesian4 = Cesium.Cartesian4;\r\n    CesiumMath = Cesium.Math;\r\n    Color = Cesium.Color;\r\n    Buffer = Cesium.Buffer;\r\n    ComponentDatatype = Cesium.ComponentDatatype;\r\n\r\n    // Cesium.loadText = Cesium.Resource.fetchText;\r\n    // Cesium.loadJson = Cesium.Resource.fetchJson;\r\n    // Cesium.loadBlob = Cesium.Resource.fetchBlob;\r\n    loadArrayBuffer = Cesium.loadArrayBuffer || Cesium.Resource.fetchArrayBuffer;\r\n    loadImage = Cesium.loadImage || Cesium.Resource.fetchImage;\r\n\r\n    Cesium.Cartesian3.prototype.set = function (x, y, z) {\r\n        this.x = x; this.y = y; this.z = z;\r\n    }\r\n    Cesium.Cartesian3.prototype.copy = function (src) {\r\n        this.x = src.x; this.y = src.y; this.z = src.z;\r\n    }\r\n\r\n    Cesium.Cartesian2.prototype.set = function (x, y) {\r\n        this.x = x; this.y = y;\r\n    }\r\n    Cesium.Cartesian2.prototype.copy = function (src) {\r\n        this.x = src.x; this.y = src.y;\r\n    }\r\n    Cesium.Quaternion.prototype.set = function (x, y, z, w) {\r\n        this.x = x; this.y = y; this.z = z; this.w = w;\r\n    }\r\n    Cesium.Quaternion.prototype.copy = function (src) {\r\n        this.x = src.x; this.y = src.y; this.z = src.z; this.w = src.w;\r\n    }\r\n\r\n    scratchMatrix = new Matrix4();\r\n    world2localMatrix = new Cesium.Matrix4();\r\n    surfacePointLocal = new Cesium.Cartesian3();\r\n    rayDir = new Cesium.Cartesian3();\r\n    pos = new Cesium.Cartesian3();\r\n    rayOriginLocal = new Cesium.Cartesian3();\r\n    scratchRay = new Cesium.Ray();\r\n}\r\n\r\nfunction getVertexBufferTypedArray(collection) {\r\n\r\n    var instances = collection._availableInstances;\r\n    var instancesLength = instances.length;\r\n    var collectionCenter = collection._center;\r\n\r\n    var vertexSizeInFloats = 12;\r\n\r\n    var bufferData = collection._vertexBufferTypedArray;\r\n    if (!defined(bufferData) || instancesLength * vertexSizeInFloats > bufferData.length) {\r\n        bufferData = new Float32Array(instancesLength * vertexSizeInFloats);\r\n    }\r\n\r\n    // Hold onto the buffer data so we don't have to allocate new memory every frame.\r\n    collection._vertexBufferTypedArray = bufferData;\r\n\r\n    for (var i = 0; i < instancesLength; ++i) {\r\n\r\n        var modelMatrix = instances[i].modelMatrix;\r\n\r\n        // Instance matrix is relative to center\r\n        var instanceMatrix = Matrix4.clone(modelMatrix, scratchMatrix);\r\n        instanceMatrix[12] -= collectionCenter.x;\r\n        instanceMatrix[13] -= collectionCenter.y;\r\n        instanceMatrix[14] -= collectionCenter.z;\r\n\r\n        var offset = i * vertexSizeInFloats;\r\n\r\n        // First three rows of the model matrix\r\n        bufferData[offset + 0] = instanceMatrix[0];\r\n        bufferData[offset + 1] = instanceMatrix[4];\r\n        bufferData[offset + 2] = instanceMatrix[8];\r\n        bufferData[offset + 3] = instanceMatrix[12];\r\n        bufferData[offset + 4] = instanceMatrix[1];\r\n        bufferData[offset + 5] = instanceMatrix[5];\r\n        bufferData[offset + 6] = instanceMatrix[9];\r\n        bufferData[offset + 7] = instanceMatrix[13];\r\n        bufferData[offset + 8] = instanceMatrix[2];\r\n        bufferData[offset + 9] = instanceMatrix[6];\r\n        bufferData[offset + 10] = instanceMatrix[10];\r\n        bufferData[offset + 11] = instanceMatrix[14];\r\n    }\r\n\r\n    return bufferData;\r\n}\r\n\r\nfunction getPickIdBufferTypedArray(collection, context) {\r\n    var i;\r\n    var instances = collection._availableInstances;\r\n    var instancesLength = instances.length\r\n\r\n    var pickIdBuffer = collection._pickIdBufferTypedArray;\r\n    if (!pickIdBuffer || instancesLength * 4 > pickIdBuffer.length) {\r\n        pickIdBuffer = new Uint8Array(instancesLength * 4);\r\n    }\r\n    collection._pickIdBufferTypedArray = pickIdBuffer;\r\n\r\n    for (i = 0; i < instancesLength; ++i) {\r\n        var instance = instances[i];\r\n        var pickId = collection._pickIds[instance.instanceId];\r\n        if (!pickId) {\r\n            pickId = context.createPickId(instance);\r\n            collection._pickIds[instance.instanceId] = pickId;\r\n        }\r\n        var pickColor = pickId.color;\r\n        var offset = i * 4;\r\n        pickIdBuffer[offset] = Color.floatToByte(pickColor.red);\r\n        pickIdBuffer[offset + 1] = Color.floatToByte(pickColor.green);\r\n        pickIdBuffer[offset + 2] = Color.floatToByte(pickColor.blue);\r\n        pickIdBuffer[offset + 3] = Color.floatToByte(pickColor.alpha);\r\n    }\r\n    return pickIdBuffer;\r\n}\r\n\r\nfunction getInstancedAttribTypedArray(collection, instancedAttribute) {\r\n    var i;\r\n    var instances = collection._availableInstances;\r\n    var instancesLength = instances.length;\r\n    var name = instancedAttribute.name;\r\n    var componentsPerAttribute;\r\n    var isColorValue = instancedAttribute.default instanceof Color\r\n    if (typeof instancedAttribute.default == 'number') {\r\n        componentsPerAttribute = 1;\r\n    }\r\n    else if (instancedAttribute.default instanceof Cartesian2) {\r\n        componentsPerAttribute = 2;\r\n    }\r\n    else if (instancedAttribute.default instanceof Cartesian3) {\r\n        componentsPerAttribute = 3;\r\n    }\r\n    else if (instancedAttribute.default instanceof Cartesian4) {\r\n        componentsPerAttribute = 4;\r\n    } else if (isColorValue) {\r\n        componentsPerAttribute = 4;\r\n    }\r\n\r\n    var bufferData = collection['_' + name + 'BufferTypedArray'];\r\n    if (!bufferData || instancesLength * componentsPerAttribute > bufferData.length) {\r\n        if (isColorValue) {\r\n            bufferData = new Uint8Array(instancesLength * componentsPerAttribute);\r\n        }\r\n        else {\r\n            bufferData = new Float32Array(instancesLength * componentsPerAttribute);\r\n        }\r\n    }\r\n    collection['_' + name + 'BufferTypedArray'] = bufferData;\r\n\r\n    if (isColorValue) {\r\n        for (i = 0; i < instancesLength; ++i) {\r\n            var instance = instances[i];\r\n            var val = instance[name];\r\n            var offset = i * componentsPerAttribute;\r\n\r\n            bufferData[offset] = Color.floatToByte(val.red);\r\n            bufferData[offset + 1] = Color.floatToByte(val.green);\r\n            bufferData[offset + 2] = Color.floatToByte(val.blue);\r\n            bufferData[offset + 3] = Color.floatToByte(val.alpha);\r\n        }\r\n    } else if (typeof instancedAttribute.default == 'number') {\r\n        for (i = 0; i < instancesLength; ++i) {\r\n            var instance = instances[i];\r\n            var val = instance[name];\r\n            bufferData[i] = val;\r\n        }\r\n    }\r\n    else if (instancedAttribute.default instanceof Cartesian2) {\r\n\r\n        for (i = 0; i < instancesLength; ++i) {\r\n            var instance = instances[i];\r\n            var val = instance[name];\r\n            var offset = i * componentsPerAttribute;\r\n            bufferData[offset] = val.x;\r\n            bufferData[offset + 1] = val.y;\r\n        }\r\n    }\r\n    else if (instancedAttribute.default instanceof Cartesian3) {\r\n\r\n        for (i = 0; i < instancesLength; ++i) {\r\n            var instance = instances[i];\r\n            var val = instance[name];\r\n            var offset = i * componentsPerAttribute;\r\n            bufferData[offset] = val.x;\r\n            bufferData[offset + 1] = val.y;\r\n            bufferData[offset + 2] = val.z;\r\n        }\r\n    }\r\n    else if (instancedAttribute.default instanceof Cartesian4) {\r\n        for (i = 0; i < instancesLength; ++i) {\r\n            var instance = instances[i];\r\n            var val = instance[name];\r\n            var offset = i * componentsPerAttribute;\r\n            bufferData[offset] = val.x;\r\n            bufferData[offset + 1] = val.y;\r\n            bufferData[offset + 2] = val.z;\r\n            bufferData[offset + 3] = val.w;\r\n        }\r\n    }\r\n    return bufferData;\r\n\r\n}\r\n\r\nfunction createInstancedAttributes(collection, context, vertexArrayAttributes, attributeLocations, maxAttribLocation) {\r\n    var instancedAttributes = collection.instancedAttributes;\r\n    instancedAttributes.forEach(function (instancedAttribute) {\r\n\r\n        var name = instancedAttribute.name\r\n        attributeLocations[name] = ++maxAttribLocation\r\n\r\n        var buffer = Buffer.createVertexBuffer({\r\n            context: context,\r\n            typedArray: getInstancedAttribTypedArray(collection, instancedAttribute),\r\n            usage: BufferUsage.STATIC_DRAW\r\n        });\r\n        instancedAttribute._buffer = buffer;\r\n\r\n        var attribute = {\r\n            index: attributeLocations[instancedAttribute.name],\r\n            vertexBuffer: buffer,\r\n            componentsPerAttribute: 4,\r\n            componentDatatype: ComponentDatatype.FLOAT,\r\n            normalize: false,\r\n            offsetInBytes: 0,\r\n            strideInBytes: 0,\r\n            instanceDivisor: 1\r\n        }\r\n        if (typeof instancedAttribute.default == 'number') {\r\n            attribute.componentsPerAttribute = 1;\r\n        }\r\n        else if (instancedAttribute.default instanceof Cartesian2) {\r\n            attribute.componentsPerAttribute = 2;\r\n        }\r\n        else if (instancedAttribute.default instanceof Cartesian3) {\r\n            attribute.componentsPerAttribute = 3;\r\n        }\r\n        else if (instancedAttribute.default instanceof Cartesian4) {\r\n            attribute.componentsPerAttribute = 4;\r\n        } else if (instancedAttribute.default instanceof Color) {\r\n            attribute.componentDatatype = ComponentDatatype.UNSIGNED_BYTE;\r\n            attribute.normalize = true;\r\n            attribute.componentsPerAttribute = 4;\r\n        }\r\n\r\n        vertexArrayAttributes.push(attribute);\r\n\r\n    })\r\n\r\n    return maxAttribLocation;\r\n\r\n}\r\n\r\nfunction createVertexBuffer(collection, context) {\r\n    var pickIdBuffer = getPickIdBufferTypedArray(collection, context);\r\n    collection._pickIdBuffer = Buffer.createVertexBuffer({\r\n        context: context,\r\n        typedArray: pickIdBuffer,\r\n        usage: BufferUsage.STATIC_DRAW\r\n    });\r\n    var vertexBufferTypedArray = getVertexBufferTypedArray(collection);\r\n    collection._vertexBuffer = Buffer.createVertexBuffer({\r\n        context: context,\r\n        typedArray: vertexBufferTypedArray,\r\n        usage: BufferUsage.STATIC_DRAW\r\n    });\r\n}\r\n\r\nfunction copyFromBufferView(vertexBuffer, arrayView, offsetInBytes) {\r\n    offsetInBytes = offsetInBytes || 0;\r\n    var gl = vertexBuffer._gl;\r\n    var target = vertexBuffer._bufferTarget;\r\n    gl.bindBuffer(target, vertexBuffer._buffer);\r\n    gl.bufferData(target, arrayView, gl.DYNAMIC_DRAW);\r\n    gl.bindBuffer(target, null);\r\n\r\n}\r\nfunction updateVertexBuffer(collection, context) {\r\n    var vertexBufferTypedArray = getVertexBufferTypedArray(collection);\r\n    copyFromBufferView(collection._vertexBuffer, vertexBufferTypedArray);\r\n\r\n    var pickIdBufferTypedArray = getPickIdBufferTypedArray(collection, context);\r\n    copyFromBufferView(collection._pickIdBuffer, pickIdBufferTypedArray);\r\n\r\n    var instancedAttributes = collection.instancedAttributes;\r\n    instancedAttributes.forEach(function (instancedAttribute) {\r\n        var bufferTypedArray = getInstancedAttribTypedArray(collection, instancedAttribute);\r\n        copyFromBufferView(instancedAttribute._buffer, bufferTypedArray);\r\n    })\r\n}\r\n\r\nfunction createPickIds(collection, context) {\r\n    // PERFORMANCE_IDEA: we could skip the pick buffer completely by allocating\r\n    // a continuous range of pickIds and then converting the base pickId + batchId\r\n    // to RGBA in the shader.  The only consider is precision issues, which might\r\n    // not be an issue in WebGL 2.\r\n    var instances = collection._instances;\r\n    var instancesLength = instances.length;\r\n    var pickIds = new Array(instancesLength);\r\n    for (var i = 0; i < instancesLength; ++i) {\r\n        pickIds[i] = context.createPickId(instances[i]);\r\n    }\r\n    return pickIds;\r\n}\r\n\r\n/**\r\n*\r\n*\r\n*@param {Object}options\r\n*@param {Cesium.Matrix4}[options.modelMatrix=Cesium.Matrix4.IDENTITY]\r\n*@param {Cesium.Cartesian3}[options.up=Cesium.Cartesian3.UNIT_Z]\r\n*@param {Cesium.Cartesian3}[options.position=Cesium.Cartesian3.ZERO]\r\n*@param {Cesium.Cartesian3}[options.scale=new Cartesian3(1, 1, 1)]\r\n*@param {Cesium.Rotation}[options.rotation]\r\n*@param {Boolean}[options.show=true]\r\n*@param {Boolean}[options.showReference=true]\r\n*@param {Cesium.ArrowGeometry}[options.referenceAxisParameter]\r\n*\r\n*@property {Cesium.Matrix4}modelMatrix \r\n*@property {Cesium.Cartesian3}up \r\n*@property {Cesium.Cartesian3}position \r\n*@property {Cesium.Cartesian3}scale \r\n*@property {Cesium.Rotation}rotation \r\n*@property {Boolean}show \r\n*@property {Boolean}showReference\r\n*@property {Boolean}modelMatrixNeedsUpdate\r\n*@property {Cesium.Event}beforeUpdate  \r\n*\r\n*@constructor\r\n*@memberof Cesium\r\n*@extends Cesium.Primitive\r\n*\r\n*@example \r\n \r\n    MeshVisualizer = Cesium.MeshVisualizer;\r\n    Mesh = Cesium.Mesh;\r\n    MeshMaterial = Cesium.MeshMaterial; \r\n    FramebufferTexture = Cesium.FramebufferTexture;\r\n\r\n    var center = Cesium.Cartesian3.fromDegrees(homePosition[0], homePosition[1], 50000);\r\n    var modelMatrix = Cesium.Transforms.eastNorthUpToFixedFrame(center);\r\n\r\n    var meshVisualizer = new MeshVisualizer({\r\n        modelMatrix: modelMatrix,\r\n    });\r\n    viewer.scene.primitives.add(meshVisualizer);\r\n\r\n\r\n    //示例1：Cesium.Geometry+Cesium.MeshMaterial组合\r\n    var box = Cesium.BoxGeometry.createGeometry(Cesium.BoxGeometry.fromDimensions({\r\n        dimensions: new Cesium.Cartesian3(100000, 50000, 50000),\r\n        vertexFormat: Cesium.VertexFormat.POSITION_ONLY\r\n    }));\r\n    \r\n    var material = new MeshMaterial({\r\n        defaultColor: \"rgba(255,0,0,1.0)\",\r\n        wireframe: false,\r\n        side: MeshMaterial.Sides.DOUBLE\r\n    });\r\n    var boxMesh = new Mesh(box, material);\r\n\r\n    meshVisualizer.add(boxMesh);\r\n\r\n    //示例2：Cesium.CSG+Cesium.MeshMaterial组合，可以用Cesium.CSG做布尔运算并渲染运算结果\r\n\r\n    //首先使用Cesium创建球体\r\n     var sphere = new Cesium.SphereGeometry({\r\n         radius: 50000.0,\r\n         vertexFormat: Cesium.VertexFormat.POSITION_ONLY\r\n     });\r\n     sphere = Cesium.SphereGeometry.createGeometry(sphere);\r\n    \r\n     var sphereMesh = new Mesh(sphere, material);\r\n     sphereMesh.position = new Cesium.Cartesian3(100000, 0, 0)\r\n     meshVisualizer.add(sphereMesh);\r\n\r\n     //将球体对象Cesium.SphereGeometry转成Cesium.CSG实例\r\n     sphere = CSG.toCSG(sphere);\r\n     //将盒子对象转成Cesium.CSG实例\r\n     box = CSG.toCSG(box);\r\n\r\n      //做布尔运算\r\n      var subResult = sphere.subtract(box);\r\n      //渲染运算结果\r\n      var subResultMesh = new Mesh(subResult, material);\r\n      subResultMesh.position = new Cesium.Cartesian3(700000, 0, 0)\r\n      meshVisualizer.add(subResultMesh);\r\n\r\n      //示例3：使用帧缓存作纹理,实际应用中如体绘制，风场流场绘制等等都可以运用此技术\r\n\r\n      function createGeometry() {\r\n        var p1 = new Cesium.Cartesian3(-50000, 50000, 100);\r\n        var p2 = new Cesium.Cartesian3(-50000, -50000, 100);\r\n        var p3 = new Cesium.Cartesian3(50000, -50000, 100);\r\n        var p4 = new Cesium.Cartesian3(50000, 50000, 100);\r\n\r\n        var positions = new Float64Array([\r\n          p1.x, p1.y, p1.z,\r\n          p2.x, p2.y, p2.z,\r\n          p3.x, p3.y, p3.z,\r\n          p4.x, p4.y, p4.z\r\n        ]);\r\n        var indices = new Uint16Array([\r\n          0, 1, 3,\r\n          1, 2, 3,\r\n        ]);\r\n        var sts = new Float32Array([\r\n          1, 1,\r\n          1, 0,\r\n          0, 0,\r\n          0, 1\r\n        ]);\r\n        var geometry = new Cesium.Geometry({\r\n            attributes: {\r\n                position: new Cesium.GeometryAttribute({\r\n                    componentDatatype: Cesium.ComponentDatatype.DOUBLE,\r\n                    componentsPerAttribute: 3,\r\n                    values: positions\r\n                }),\r\n                st: new Cesium.GeometryAttribute({\r\n                    componentDatatype: Cesium.ComponentDatatype.FLOAT,\r\n                    componentsPerAttribute: 2,\r\n                    values: sts\r\n                })\r\n            },\r\n            indices: indices,\r\n            primitiveType: Cesium.PrimitiveType.TRIANGLES,\r\n            boundingSphere: Cesium.BoundingSphere.fromVertices(positions)\r\n        });\r\n\r\n        return geometry;\r\n    }\r\n    //将上文中的盒子渲染到缓存，作为纹理参与createGeometry（）方法创建的几何体渲染过程\r\n    var framebufferTex = new FramebufferTexture(boxMesh);\r\n    var geometry = createGeometry();\r\n    var customMesh = new Mesh(geometry, new MeshMaterial({\r\n\r\n        uniforms: {\r\n            u_textureMap: framebufferTex//Cesium.buildModuleUrl('Widgets/Images/TerrainProviders/STK.png')\r\n        },\r\n        side: MeshMaterial.Sides.DOUBLE,\r\n        vertexShader : \"\\n\\\r\n            \\n\\\r\n            varying vec3 v_position;\\n\\\r\n            varying vec2 v_st;\\n\\\r\n            \\n\\\r\n            void main(void) \\n\\\r\n            {\\n\\\r\n            vec4 pos = u_modelViewMatrix * vec4(position,1.0);\\n\\\r\n            v_position = pos.xyz;\\n\\\r\n            v_st=st;\\n\\\r\n            gl_Position = u_projectionMatrix * pos;\\n\\\r\n            }\",\r\n        fragmentShader : \"varying vec2 v_st;\\\r\n            uniform sampler2D u_textureMap;\\\r\n            void main()\\\r\n            {\\\r\n            gl_FragColor = texture2D(u_textureMap,v_st);\\n\\\r\n            \\\r\n            }\\\r\n            \"\r\n    }));\r\n    customMesh.position = new Cesium.Cartesian3(100000, 0, 0);\r\n    meshVisualizer.add(customMesh);\r\n*/\r\nfunction MeshVisualizer(options) {\r\n    initConstants();\r\n    options = options || {};\r\n    this._modelMatrix = defaultValue(options.modelMatrix, Matrix4.IDENTITY);\r\n    this._actualModelMatrix = Matrix4.clone(this._modelMatrix);\r\n    this._ready = true;\r\n    this._modelMatrixNeedsUpdate = true;\r\n\r\n    this._isWireframe = false;\r\n    this._up = defaultValue(options.up, new Cartesian3(0, 0, 1));\r\n    this._position = defaultValue(options.position, new Cartesian3(0, 0, 0));\r\n    this._scale = defaultValue(options.scale, new Cartesian3(1, 1, 1));\r\n    this._rotation = defaultValue(options.rotation, { axis: new Cartesian3(0, 0, 1), angle: 0 });\r\n    this._rotation = new Rotation(this._rotation.axis, this._rotation.angle);\r\n    this._rotation.paramChanged.addEventListener(this.onModelMatrixNeedUpdate, this);\r\n\r\n\r\n    this._chidren = [];\r\n    this._debug = false;\r\n    this._show = defaultValue(options.show, true);\r\n\r\n    this._center = new Cartesian3();\r\n    Cesium.Matrix4.getTranslation(this._modelMatrix, this._center);\r\n    this._framebufferTextures = {};\r\n    this._uniformValueCache = {};\r\n    this._textureCache = {};\r\n    this._uniformMaps = {};\r\n    this.referenceMesh = new ReferenceMesh({\r\n        axisParameter: defaultValue(options.referenceAxisParameter, { length: 50000 * 2 }),\r\n        show: defaultValue(options.showReference, false)\r\n    });\r\n    this.add(this.referenceMesh);\r\n    this._pickIds = [];\r\n    this.beforeUpdate = new Cesium.Event();\r\n    this._scene = options.scene;\r\n}\r\n\r\nMeshVisualizer.prototype = {\r\n    /**\r\n     * 移除mesh，释放由MeshVisualizer创建的内部资源\r\n    *@param {Cesium.Mesh}mesh\r\n    */\r\n    remove: function (mesh) {\r\n\r\n        for (var i = 0; i < this._chidren.length; i++) {\r\n            if (this._chidren[i] == mesh) {\r\n\r\n                this._chidren.splice(i, 1);\r\n            }\r\n        }\r\n\r\n        function freeDrawCommand(cmd) {\r\n            if (!cmd) return;\r\n            cmd.vertexArray = cmd.vertexArray.destroy();\r\n            cmd.shaderProgram = cmd.shaderProgram.destroy();\r\n            Cesium.destroyObject(cmd);\r\n        }\r\n\r\n        function freeMesh(mesh) {\r\n            mesh._drawCommand = freeDrawCommand(mesh._drawCommand);\r\n            mesh._pickCommand = freeDrawCommand(mesh._pickCommand);\r\n            mesh._textureCommand = freeDrawCommand(mesh._textureCommand);\r\n        }\r\n\r\n        MeshVisualizer.traverse(mesh, function () {\r\n            freeMesh(mesh);\r\n\r\n            if (mesh._actualMesh && mesh._actualMesh._drawCommand) {\r\n\r\n                var actualMesh = mesh._actualMesh;\r\n                freeMesh(actualMesh);\r\n                Cesium.destroyObject(actualMesh.geometry);\r\n                mesh._actualMesh = actualMesh && actualMesh.destroy();\r\n                Cesium.destroyObject(actualMesh);\r\n            }\r\n        }, false);\r\n    },\r\n    /**\r\n    *\r\n    *拾取点，用局部坐标系表达。内部使用Cesium.Scene.pickPosition和MeshVisualizer.worldCoordinatesToLocal实现。\r\n    *@param {Cesium.Cartesian2}windowPosition\r\n    *@param {Cesium.Cartesian3}[result]\r\n    *@return {Cesium.Cartesian3}\r\n    */\r\n    pickPosition: function (windowPosition, result) {\r\n        if (!this._scene) {\r\n            return undefined;\r\n        }\r\n        this._scene.pickPosition(windowPosition, surfacePointLocal);\r\n\r\n        if (!surfacePointLocal) {\r\n            return undefined;\r\n        }\r\n\r\n        this.worldCoordinatesToLocal(surfacePointLocal, surfacePointLocal);\r\n        Cesium.Cartesian3.clone(surfacePointLocal, result);\r\n        return result;\r\n    },\r\n    /**\r\n    *\r\n    *创建一条射线，用局部坐标系表达\r\n    *@param {Cesium.Cartesian2}windowPosition\r\n    *@param {Cesium.Ray}[result]\r\n    *@return {Cesium.Ray}\r\n    */\r\n    getPickRay: function (windowPosition, result) {\r\n        if (!this._scene) {\r\n            return undefined;\r\n        }\r\n        if (!result) {\r\n            result = Cesium.Ray();\r\n        }\r\n        this._scene.camera.getPickRay(windowPosition, scratchRay);//ray用于计算小球发射点位置，这里射线的起始点是世界坐标，不能像Threejs那样直接拿来计算，需要转成局部坐标\r\n        this._scene.pickPosition(windowPosition, surfacePointLocal);//射线和局部场景的交点\r\n\r\n        if (!surfacePointLocal) {\r\n            return undefined;\r\n        }\r\n\r\n        Cesium.Cartesian3.clone(scratchRay.direction, rayDir);\r\n\r\n        //世界坐标转局部坐标\r\n        this.worldCoordinatesToLocal(scratchRay.origin, rayOriginLocal);\r\n        this.worldCoordinatesToLocal(surfacePointLocal, surfacePointLocal);\r\n\r\n        Cesium.Cartesian3.add(rayOriginLocal, rayDir, pos);\r\n        //计算发射方向\r\n        Cesium.Cartesian3.subtract(surfacePointLocal, pos, rayDir);\r\n        Cesium.Cartesian3.clone(surfacePointLocal, result.origin);\r\n        Cesium.Cartesian3.clone(rayDir, result.direction);\r\n        return result;\r\n    },\r\n    /**\r\n    *世界坐标到局部坐标\r\n    *@param {Cesium.Cartesian3}worldCoordinates\r\n    *@param {Cesium.Cartesian3}[result]\r\n    *@return {Cesium.Cartesian3}\r\n    */\r\n    worldCoordinatesToLocal: function (worldCoordinates, result) {\r\n        if (!result) {\r\n            result = new Cartesian3();\r\n        }\r\n        Cesium.Matrix4.inverseTransformation(this._actualModelMatrix, world2localMatrix)\r\n        Cesium.Matrix4.multiplyByPoint(world2localMatrix, worldCoordinates, result);\r\n        return result;\r\n    },\r\n    /**\r\n   *局部坐标到世界坐标\r\n   *@param {Cesium.Cartesian3}localCoordinates\r\n   *@param {Cesium.Cartesian3}[result]\r\n   *@return {Cesium.Cartesian3}\r\n   */\r\n    localToWorldCoordinates: function (localCoordinates, result) {\r\n        if (!result) {\r\n            result = new Cartesian3();\r\n        }\r\n        Cesium.Matrix4.multiplyByPoint(this._actualModelMatrix, localCoordinates, result);\r\n        return result;\r\n    },\r\n    onModelMatrixNeedUpdate: function () {\r\n        this._modelMatrixNeedsUpdate = true;\r\n    },\r\n    /**\r\n     *\r\n     *@param {Number}x\r\n     *@param {Number}y\r\n     *@param {Number}z\r\n     */\r\n    setPosition: function (x, y, z) {\r\n        var changed = false;\r\n        if (arguments.length == 1) {\r\n            if (typeof x == 'number') {\r\n                if (x != this._position.x) changed = true;\r\n                this._position.x = x;\r\n            } else if (x instanceof Cesium.Cartesian3) {\r\n                if (x != this._position.x\r\n                    || y != this._position.y\r\n                    || z != this._position.z) {\r\n                    changed = true;\r\n                }\r\n\r\n                this._position.x = x.x;\r\n                this._position.y = x.y;\r\n                this._position.z = x.z;\r\n            }\r\n        }\r\n        if (arguments.length == 2 && typeof y == 'number') {\r\n            if (y != this._position.y) changed = true;\r\n            this._position.y = y;\r\n        }\r\n        if (arguments.length == 3 && typeof z == 'number') {\r\n            if (z != this._position.z) changed = true;\r\n            this._position.z = z;\r\n        }\r\n        if (changed) {\r\n            this._modelMatrixNeedsUpdate = true;\r\n        }\r\n    },\r\n    /**\r\n     *\r\n     *@param {Number}x\r\n     *@param {Number}y\r\n     *@param {Number}z\r\n     */\r\n    setScale: function (x, y, z) {\r\n        var changed = false;\r\n        if (arguments.length == 1) {\r\n            if (typeof x == 'number') {\r\n                if (x != this._scale.x) changed = true;\r\n                this._scale.x = x;\r\n            } else if (x instanceof Cesium.Cartesian3) {\r\n                if (x != this._scale.x\r\n                    || y != this._scale.y\r\n                    || z != this._scale.z) {\r\n                    changed = true;\r\n                }\r\n\r\n                this._scale.x = x.x;\r\n                this._scale.y = x.y;\r\n                this._scale.z = x.z;\r\n            }\r\n        }\r\n        if (arguments.length == 2 && typeof y == 'number') {\r\n            if (y != this._scale.y) changed = true;\r\n            this._scale.y = y;\r\n        }\r\n        if (arguments.length == 3 && typeof z == 'number') {\r\n            if (z != this._scale.z) changed = true;\r\n            this._scale.z = z;\r\n        }\r\n        if (changed) {\r\n            this._modelMatrixNeedsUpdate = true;\r\n        }\r\n    },\r\n\r\n    toWireframe: function (geometry) {\r\n        if (geometry.primitiveType !== Cesium.PrimitiveType.TRIANGLES\r\n            && geometry.primitiveType !== Cesium.PrimitiveType.TRIANGLE_FAN\r\n            && geometry.primitiveType !== Cesium.PrimitiveType.TRIANGLE_STRIP) {\r\n            return geometry;\r\n        }\r\n        if (!geometry.triangleIndices) {\r\n            geometry.triangleIndices = geometry.indices;\r\n        }\r\n        //if (geometry.lineIndices) {\r\n        //    geometry.indices = geometry.lineIndices;\r\n        //    return geometry;\r\n        //}\r\n        geometry = GeometryPipeline.toWireframe(geometry);\r\n        //geometry.lineIndices = geometry.indices;\r\n        return geometry;\r\n    },\r\n\r\n    restoreFromWireframe: function (geometry) {\r\n        if (geometry.primitiveType == Cesium.PrimitiveType.POINTS) {\r\n            return geometry;\r\n        }\r\n        if (geometry.triangleIndices) {\r\n            geometry.indices = geometry.triangleIndices;\r\n        }\r\n        geometry.primitiveType = Cesium.PrimitiveType.TRIANGLES;\r\n        return geometry;\r\n    },\r\n    createBoundingSphere: function (mesh) {\r\n        var instancesLength = mesh._instances.length;\r\n        var points = new Array(instancesLength);\r\n        for (var i = 0; i < instancesLength; ++i) {\r\n            points[i] = Matrix4.getTranslation(mesh._instances[i].modelMatrix, new Cartesian3());\r\n        }\r\n\r\n        mesh._boundingSphere = Cesium.BoundingSphere.fromPoints(points);\r\n        Cartesian3.clone(mesh._boundingSphere.center, mesh._center);\r\n    },\r\n    /**\r\n    * \r\n    *@param {Cesium.Mesh} mesh\r\n    *@param {Cesium.FrameState} frameState\r\n    *@return {Cesium.DrawCommand} \r\n    *@private\r\n    */\r\n    createDrawCommand: function (mesh, frameState) {\r\n        var that = this;\r\n        var context = frameState.context;\r\n        var geometry = mesh.geometry;\r\n        var material = mesh.material;\r\n\r\n        var pickObject = {\r\n            primitive: this,\r\n            id: mesh\r\n        };\r\n        var pickId = context.createPickId(pickObject);\r\n        that._pickIds.push(pickId);\r\n\r\n        var command = new Cesium.DrawCommand({\r\n            // pickId: mesh.material.allowPick ? pickId : undefined,\r\n            modelMatrix: mesh._instances && mesh._instances.length > 0 ? undefined : Matrix4.clone(this.modelMatrix),\r\n            owner: mesh,\r\n            primitiveType: geometry.primitiveType,\r\n            cull: false,// material.cullFrustum,\r\n            instanceCount: mesh._instances && mesh._instances.length > 0 ? mesh._availableInstances.length : undefined,\r\n            pass: material.translucent ? Cesium.Pass.TRANSLUCENT : Cesium.Pass.OPAQUE\r\n            // , boundingVolume: geometry.boundingSphere\r\n        });\r\n\r\n        var attributeLocations = GeometryPipeline.createAttributeLocations(geometry);\r\n        var vertexArrayAttributes;\r\n        if (mesh._instances && mesh._instances.length) {\r\n            this.createBoundingSphere(mesh);\r\n\r\n            vertexArrayAttributes = []\r\n            var maxAttribLocation = 0;\r\n            for (var location in attributeLocations) {\r\n                if (attributeLocations.hasOwnProperty(location)) {\r\n                    maxAttribLocation = Math.max(maxAttribLocation, attributeLocations[location])\r\n                }\r\n            }\r\n            // command.instanceCount = mesh._instances.length;\r\n            var collection = mesh;\r\n\r\n            collection._pickIds = createPickIds(collection, frameState.context);\r\n\r\n            createVertexBuffer(collection, frameState.context);\r\n\r\n            var vertexSizeInFloats = 12;\r\n            var componentSizeInBytes = ComponentDatatype.getSizeInBytes(ComponentDatatype.FLOAT);\r\n\r\n            var instancedAttributes = {\r\n                czm_modelMatrixRow0: {\r\n                    index: maxAttribLocation + 1,\r\n                    vertexBuffer: collection._vertexBuffer,\r\n                    componentsPerAttribute: 4,\r\n                    componentDatatype: ComponentDatatype.FLOAT,\r\n                    normalize: false,\r\n                    offsetInBytes: 0,\r\n                    strideInBytes: componentSizeInBytes * vertexSizeInFloats,\r\n                    instanceDivisor: 1\r\n                },\r\n                czm_modelMatrixRow1: {\r\n                    index: maxAttribLocation + 2,\r\n                    vertexBuffer: collection._vertexBuffer,\r\n                    componentsPerAttribute: 4,\r\n                    componentDatatype: ComponentDatatype.FLOAT,\r\n                    normalize: false,\r\n                    offsetInBytes: componentSizeInBytes * 4,\r\n                    strideInBytes: componentSizeInBytes * vertexSizeInFloats,\r\n                    instanceDivisor: 1\r\n                },\r\n                czm_modelMatrixRow2: {\r\n                    index: maxAttribLocation + 3,\r\n                    vertexBuffer: collection._vertexBuffer,\r\n                    componentsPerAttribute: 4,\r\n                    componentDatatype: ComponentDatatype.FLOAT,\r\n                    normalize: false,\r\n                    offsetInBytes: componentSizeInBytes * 8,\r\n                    strideInBytes: componentSizeInBytes * vertexSizeInFloats,\r\n                    instanceDivisor: 1\r\n                }\r\n            };\r\n\r\n            instancedAttributes.a_pickColor = {\r\n                index: maxAttribLocation + 4,\r\n                vertexBuffer: collection._pickIdBuffer,\r\n                componentsPerAttribute: 4,\r\n                componentDatatype: ComponentDatatype.UNSIGNED_BYTE,\r\n                normalize: true,\r\n                offsetInBytes: 0,\r\n                strideInBytes: 0,\r\n                instanceDivisor: 1\r\n            };\r\n\r\n            for (var location in instancedAttributes) {\r\n                if (instancedAttributes.hasOwnProperty(location)) {\r\n                    attributeLocations[location] = ++maxAttribLocation;\r\n                    vertexArrayAttributes.push(instancedAttributes[location])\r\n                }\r\n            }\r\n\r\n            maxAttribLocation = createInstancedAttributes(mesh, frameState.context, vertexArrayAttributes, attributeLocations, maxAttribLocation);\r\n        }\r\n\r\n        command.vertexArray = VertexArray.fromGeometry({\r\n            context: context,\r\n            geometry: geometry,\r\n            attributeLocations: attributeLocations,\r\n            bufferUsage: BufferUsage.STATIC_DRAW,\r\n\r\n            vertexArrayAttributes: vertexArrayAttributes\r\n        });\r\n        if (vertexArrayAttributes && vertexArrayAttributes.length) {\r\n            command._cacehVertexArrayAttributes = vertexArrayAttributes.map(function (a) {\r\n                return a;\r\n            })\r\n        }\r\n        command.vertexArray._attributeLocations = attributeLocations;\r\n\r\n        var pickColor = pickId.color;\r\n\r\n        var shader = {\r\n            fragmentShader: this.getFragmentShaderSource(material),\r\n            vertexShader: this.getVertexShaderSource(mesh, material)\r\n        };\r\n        if (material.material3js) {\r\n            shader = ShaderUtils.processShader3js(material.material3js, shader);\r\n        }\r\n\r\n        if (mesh._instances && mesh._instances.length) {\r\n\r\n            var vs = shader.vertexShader;\r\n            var renamedSource = Cesium.ShaderSource.replaceMain(vs, 'czm_instancing_main');\r\n\r\n            var pickAttribute = 'attribute vec4 a_pickColor;\\n' +\r\n                'varying vec4 czm_pickColor;\\n';\r\n            var pickVarying = '    czm_pickColor = a_pickColor;\\n';\r\n\r\n            vs = //'mat4 czm_instanced_modelView;\\n' +\r\n                'attribute vec4 czm_modelMatrixRow0;\\n' +\r\n                'attribute vec4 czm_modelMatrixRow1;\\n' +\r\n                'attribute vec4 czm_modelMatrixRow2;\\n' +\r\n                'uniform mat4 czm_instanced_modifiedModelView;\\n' +\r\n                // batchIdAttribute +\r\n                pickAttribute +\r\n                renamedSource +\r\n                'void main()\\n' +\r\n                '{\\n' +\r\n                '    modelMatrix = mat4(czm_modelMatrixRow0.x, czm_modelMatrixRow1.x, czm_modelMatrixRow2.x, 0.0, czm_modelMatrixRow0.y, czm_modelMatrixRow1.y, czm_modelMatrixRow2.y, 0.0, czm_modelMatrixRow0.z, czm_modelMatrixRow1.z, czm_modelMatrixRow2.z, 0.0, czm_modelMatrixRow0.w, czm_modelMatrixRow1.w, czm_modelMatrixRow2.w, 1.0);\\n' +\r\n                '    modelViewMatrix = czm_instanced_modifiedModelView * modelMatrix;\\n' +\r\n                '    u_modelMatrix =modelMatrix;\\n' +\r\n                '    u_modelViewMatrix = modelViewMatrix ;\\n' +\r\n                // globalVarsMain +\r\n                '    czm_instancing_main();\\n' +\r\n                pickVarying +\r\n                '}\\n';\r\n            shader.vertexShader = vs;\r\n        }\r\n\r\n\r\n        var vs = new Cesium.ShaderSource({\r\n            sources: [shader.vertexShader]\r\n        });\r\n        var fs = new Cesium.ShaderSource({\r\n            sources: [shader.fragmentShader]\r\n        });\r\n        // if (this.onlySunLighting) {\r\n        //fs.defines.push('ONLY_SUN_LIGHTING');\r\n        // }\r\n        var translucent = material.translucent;\r\n        if (!translucent && context.fragmentDepth) {\r\n            fs.defines.push('WRITE_DEPTH');\r\n        }\r\n        var logDepthExtension =\r\n            '#ifdef GL_EXT_frag_depth \\n' +\r\n            '#extension GL_EXT_frag_depth : enable \\n' +\r\n            '#endif \\n\\n';\r\n\r\n        // if (this._useLogDepth) {\r\n        vs.defines.push('LOG_DEPTH');\r\n        fs.defines.push('LOG_DEPTH');\r\n        //fs.sources.push(logDepthExtension);\r\n        // }\r\n\r\n\r\n        command._sp = ShaderProgram.fromCache({\r\n            context: context,\r\n            fragmentShaderSource: fs,//shader.fragmentShader,//this.getFragmentShaderSource(material),\r\n            vertexShaderSource: vs,//shader.vertexShader,//this.getVertexShaderSource(geometry, material),\r\n            attributeLocations: attributeLocations\r\n        });\r\n        if (!Cesium.defined(mesh.material.allowPick)) {\r\n            mesh.material.allowPick = true;\r\n        }\r\n        if (mesh.material.allowPick) {\r\n\r\n\r\n        }\r\n        command.shaderProgram = command._sp;\r\n        command.renderState = this.getRenderState(material);\r\n\r\n        command._renderStateOptions = material._renderStateOptions;\r\n\r\n        command.uniformMap = this.getUniformMap(material, frameState);\r\n        command.uniformMap.czm_pickColor = function () {\r\n            return pickId.color;\r\n        }\r\n        command.uniformMap.czm_instanced_modifiedModelView = this.getModifiedModelViewCallback(context, mesh);\r\n\r\n        var pickCommand = new Cesium.DrawCommand({\r\n            owner: mesh,\r\n            pickOnly: true,\r\n            instanceCount: mesh._instances && mesh._instances.length > 0 ? mesh._availableInstances.length : undefined,\r\n            modelMatrix: mesh._instances && mesh._instances.length > 0 ? undefined : Matrix4.clone(this.modelMatrix),\r\n            primitiveType: geometry.primitiveType,\r\n            cull: material.cullFrustum,\r\n            pass: material.translucent ? Cesium.Pass.TRANSLUCENT : Cesium.Pass.OPAQUE\r\n        });\r\n        // Recompile shader when material changes\r\n\r\n\r\n\r\n        vs = new Cesium.ShaderSource({\r\n            sources: [shader.vertexShader]\r\n        });\r\n        fs = new Cesium.ShaderSource({\r\n            sources: [shader.fragmentShader],\r\n            pickColorQualifier: mesh._instances && mesh._instances.length ? 'varying' : (material.pickColorQualifier || 'uniform')\r\n        });\r\n        // if (this.onlySunLighting) {\r\n        fs.defines.push('ONLY_SUN_LIGHTING');\r\n        // }\r\n        translucent = material.translucent;\r\n        if (!translucent && context.fragmentDepth) {\r\n            fs.defines.push('WRITE_DEPTH');\r\n        }\r\n\r\n\r\n        // if (this._useLogDepth) {\r\n        vs.defines.push('LOG_DEPTH');\r\n        fs.defines.push('LOG_DEPTH');\r\n        fs.sources.push(logDepthExtension);\r\n        // }\r\n\r\n\r\n\r\n        var _pickSP = ShaderProgram.replaceCache({\r\n            context: context,\r\n            shaderProgram: _pickSP,\r\n            vertexShaderSource: vs,\r\n            fragmentShaderSource: fs,\r\n            attributeLocations: attributeLocations\r\n        });\r\n\r\n        pickCommand.vertexArray = command.vertexArray;\r\n        pickCommand.renderState = this.getRenderState(material);\r\n        pickCommand.shaderProgram = _pickSP;\r\n        pickCommand.uniformMap = command.uniformMap;\r\n        pickCommand.executeInClosestFrustum = translucent;\r\n        mesh._pickCommand = pickCommand;\r\n\r\n        return command;\r\n    },\r\n\r\n    getModifiedModelViewCallback: function (context, mesh) {\r\n        return function () {\r\n            if (!mesh._rtcTransform) {\r\n                mesh._rtcTransform = new Matrix4()\r\n            }\r\n            if (!mesh._rtcModelView) {\r\n                mesh._rtcModelView = new Matrix4()\r\n            }\r\n            Matrix4.multiplyByTranslation(mesh.modelMatrix, mesh._center, mesh._rtcTransform);\r\n\r\n            return Matrix4.multiply(context.uniformState.view, mesh._rtcTransform, mesh._rtcModelView);\r\n        }\r\n    },\r\n    /**\r\n    *\r\n    *\r\n    *@param {THREE.Material}material \r\n    *@return {Cesium.RenderState}frameState\r\n    *@private\r\n    */\r\n    getRenderState_old: function (material) {\r\n        var renderState = {\r\n            blending: material.blending ? BlendingState.ALPHA_BLEND : BlendingState.DISABLED,\r\n            depthTest: {\r\n                enabled: material.depthTest,\r\n                func: DepthFunction.GREATER//LESS\r\n            },\r\n            cull: {\r\n                enabled: true,\r\n                face: CullFace.FRONT\r\n            },\r\n            depthRange: {\r\n                near: 0,\r\n                far: 1\r\n            },\r\n            colorMask: {\r\n                red: true,\r\n                green: true,\r\n                blue: true,\r\n                alpha: true\r\n            },\r\n            depthMask: material.depthMask\r\n        }\r\n        renderState.cull.enabled = true;\r\n        renderState.blending.color = {\r\n            red: 0.0,\r\n            green: 0.0,\r\n            blue: 0.0,\r\n            alpha: 0.0\r\n        };\r\n        switch (material.side) {\r\n            case MeshMaterial.Sides.FRONT:\r\n                renderState.cull.face = CullFace.BACK;\r\n                break;\r\n            case MeshMaterial.Sides.BACK:\r\n                renderState.cull.face = CullFace.FRONT;\r\n                break;\r\n            default:\r\n                renderState.cull.enabled = false;\r\n                break;\r\n        }\r\n\r\n        renderState = RenderState.fromCache(renderState);\r\n\r\n        return renderState;\r\n    },\r\n\r\n    /**\r\n    *\r\n    *\r\n    *@param {THREE.Material}material \r\n    *@return {Cesium.RenderState}frameState\r\n    *@private\r\n    */\r\n    getRenderState: function (material) {\r\n        var renderStateOpts = {\r\n            blending: material.blending ? BlendingState.ALPHA_BLEND : BlendingState.DISABLED,\r\n            depthTest: {\r\n                enabled: material.depthTest,\r\n                func: DepthFunction.LESS\r\n            },\r\n            cull: {\r\n                enabled: false,\r\n                face: CullFace.FRONT\r\n            },\r\n            depthRange: {\r\n                near: 0,\r\n                far: 1\r\n            },\r\n            colorMask: {\r\n                red: true,\r\n                green: true,\r\n                blue: true,\r\n                alpha: true\r\n            },\r\n            depthMask: material.depthMask\r\n        }\r\n        renderStateOpts.cull.enabled = true;\r\n\r\n        // renderStateOpts.blending.color = {\r\n        //     red: 0.0,\r\n        //     green: 0.0,\r\n        //     blue: 0.0,\r\n        //     alpha: 0.0\r\n        // };\r\n        switch (material.side) {\r\n            case MeshMaterial.Sides.FRONT:\r\n                renderStateOpts.cull.face = CullFace.BACK;\r\n                break;\r\n            case MeshMaterial.Sides.BACK:\r\n                renderStateOpts.cull.face = CullFace.FRONT;\r\n                break;\r\n            default:\r\n                renderStateOpts.cull.enabled = false;\r\n                break;\r\n        }\r\n\r\n        material._renderStateOptions = renderStateOpts;\r\n        var renderState = RenderState.fromCache(renderStateOpts);\r\n\r\n        return renderState;\r\n    },\r\n\r\n    /**\r\n    *\r\n    *\r\n    *@param {THREE.Material}material \r\n    *@param {Cesium.FrameState}frameState\r\n    *@private\r\n    */\r\n    getUniformMap: function (material, frameState) {\r\n        var uniformMaps = this._uniformMaps;\r\n        if (uniformMaps[material.uuid] && !material.needsUpdate) {\r\n            return uniformMaps[material.uuid];\r\n\r\n        }\r\n        var uniformMap = {};\r\n        uniformMaps[material.uuid] = uniformMap;\r\n\r\n        if (material.onDispose) {\r\n            material.onDispose(function () {\r\n                delete uniformMaps[material.uuid];\r\n            })\r\n        }\r\n        \r\n        material.needsUpdate = false;\r\n\r\n        uniformMap.cameraPosition = function () {\r\n            return frameState.camera.position;\r\n        }\r\n        uniformMap.u_cameraPosition = function () {\r\n            return frameState.camera.position;\r\n        }\r\n        //base matrix\r\n        uniformMap.u_normalMatrix = function () {\r\n            return frameState.context.uniformState.normal;\r\n        }\r\n        uniformMap.u_projectionMatrix = function () {\r\n            return frameState.context.uniformState.projection;\r\n        }\r\n\r\n        uniformMap.u_modelViewMatrix = function () {\r\n            return frameState.context.uniformState.modelView;\r\n        }\r\n        //base matrix for threejs\r\n        uniformMap.normalMatrix = function () {\r\n            return frameState.context.uniformState.normal;\r\n        }\r\n        uniformMap.projectionMatrix = function () {\r\n            return frameState.context.uniformState.projection;\r\n        }\r\n\r\n        uniformMap.modelViewMatrix = function () {\r\n            return frameState.context.uniformState.modelView;\r\n        }\r\n        uniformMap.modelMatrix = function () {\r\n            return frameState.context.uniformState.model;\r\n        }\r\n        uniformMap.u_modelMatrix = function () {\r\n            return frameState.context.uniformState.model;\r\n        }\r\n        uniformMap.u_viewMatrix = function () {\r\n            return frameState.context.uniformState.view;\r\n        }\r\n        uniformMap.viewMatrix = function () {\r\n            return frameState.context.uniformState.view;\r\n        }\r\n        uniformMap.logDepthBufFC = function () {\r\n            return 2.0 / (Math.log(frameState.camera.frustum.far + 1.0) / Math.LN2)\r\n        }\r\n\r\n        if (material.uniformStateUsed && material.uniformStateUsed.length) {\r\n            material.uniformStateUsed.forEach(function (item) {\r\n                if (!uniformMap[item.glslVarName]) {\r\n                    if (!frameState.context.uniformState[item.uniformStateName]) {\r\n                        throw new Error(item.uniformStateName + \"不是Cesium引擎的内置对象\");\r\n                    }\r\n                    uniformMap[item.glslVarName] = function () {\r\n                        return frameState.context.uniformState[item.uniformStateName];\r\n                    }\r\n                }\r\n            });\r\n        }\r\n        var that = this;\r\n\r\n        function getCubeTextureCallback(name, item, mtl) {\r\n            var callback = function () {\r\n                if (!that._textureCache[item.uuid] || item.needsUpdate) {\r\n                    if (!callback.allLoaded && !callback.isLoading) {\r\n                        var promises = [];\r\n                        for (var i = 0; i < item.value.length; i++) {\r\n                            if (item.value[i] instanceof HTMLCanvasElement\r\n                                || item.value[i] instanceof HTMLVideoElement\r\n                                || item.value[i] instanceof HTMLImageElement\r\n                            ) {\r\n                                var deferred = Cesium.when.defer();\r\n                                requestAnimationFrame(function () {\r\n                                    deferred.resolve(item.value[i]);\r\n                                });\r\n                                promises.push(deferred);\r\n                            } else if (typeof item.value[i] === 'string') {\r\n                                promises.push(loadImage(item.value[i]));\r\n                            } else {\r\n                                throw Error(name + \"\" + i + \"给定值“ \" + item[i] + \"” 不是有效的纹理图片\");\r\n                            }\r\n                        }\r\n                        callback.isLoading = true;\r\n                        item.needsUpdate = false;\r\n                        Cesium.when.all(promises, function (images) {\r\n\r\n                            that._textureCache[item.uuid] = new Cesium.CubeMap({\r\n                                context: frameState.context,\r\n                                source: {\r\n                                    positiveX: images[0],\r\n                                    negativeX: images[1],\r\n                                    positiveY: images[2],\r\n                                    negativeY: images[3],\r\n                                    positiveZ: images[4],\r\n                                    negativeZ: images[5]\r\n                                }\r\n                            });\r\n                            if (item.onDispose) {\r\n                                item.onDispose(function () {\r\n                                    if (that._textureCache[item.uuid]) {\r\n                                        that._textureCache[item.uuid].destroy();\r\n                                        delete that._textureCache[item.uuid];\r\n                                    }\r\n                                })\r\n                            }\r\n                            callback.allLoaded = true;\r\n                            callback.isLoading = false;\r\n                        });\r\n                    }\r\n                }\r\n                if (callback.allLoaded) {\r\n                    return that._textureCache[item.uuid];\r\n                }\r\n                else {\r\n                    if (!that.defaultCubeMap) {\r\n\r\n                        if (!that.defaultTextureImage) {\r\n                            that.defaultTextureImage = document.createElement(\"canvas\");\r\n                            that.defaultTextureImage.width = 1;\r\n                            that.defaultTextureImage.height = 1;\r\n                        }\r\n\r\n                        that.defaultCubeMap = new Cesium.CubeMap({\r\n                            context: frameState.context,\r\n                            source: {\r\n                                positiveX: that.defaultTextureImage,\r\n                                negativeX: that.defaultTextureImage,\r\n                                positiveY: that.defaultTextureImage,\r\n                                negativeY: that.defaultTextureImage,\r\n                                positiveZ: that.defaultTextureImage,\r\n                                negativeZ: that.defaultTextureImage\r\n                            }\r\n                        });\r\n                    }\r\n                    return that.defaultCubeMap;\r\n                }\r\n            }\r\n            if (callback.allLoaded) {\r\n                callback.allLoaded = false;\r\n                callback.isLoading = false;\r\n            }\r\n            return callback;\r\n        }\r\n\r\n        function createTexture(texture, context) {\r\n\r\n            var TextureMinificationFilter = Cesium.TextureMinificationFilter;\r\n            var TextureWrap = Cesium.TextureWrap;\r\n\r\n            var sampler = texture.sampler;\r\n\r\n            var mipmap =\r\n                (sampler.minificationFilter === TextureMinificationFilter.NEAREST_MIPMAP_NEAREST) ||\r\n                (sampler.minificationFilter === TextureMinificationFilter.NEAREST_MIPMAP_LINEAR) ||\r\n                (sampler.minificationFilter === TextureMinificationFilter.LINEAR_MIPMAP_NEAREST) ||\r\n                (sampler.minificationFilter === TextureMinificationFilter.LINEAR_MIPMAP_LINEAR);\r\n            var requiresNpot = mipmap ||\r\n                (sampler.wrapS === TextureWrap.REPEAT) ||\r\n                (sampler.wrapS === TextureWrap.MIRRORED_REPEAT) ||\r\n                (sampler.wrapT === TextureWrap.REPEAT) ||\r\n                (sampler.wrapT === TextureWrap.MIRRORED_REPEAT);\r\n\r\n            var source = texture.source;\r\n            var npot = !CesiumMath.isPowerOfTwo(source.width) || !CesiumMath.isPowerOfTwo(source.height);\r\n\r\n            if (requiresNpot && npot) {\r\n                // WebGL requires power-of-two texture dimensions for mipmapping and REPEAT/MIRRORED_REPEAT wrap modes.\r\n                var canvas = document.createElement('canvas');\r\n                canvas.width = CesiumMath.nextPowerOfTwo(source.width);\r\n                canvas.height = CesiumMath.nextPowerOfTwo(source.height);\r\n                var canvasContext = canvas.getContext('2d');\r\n                canvasContext.drawImage(source, 0, 0, source.width, source.height, 0, 0, canvas.width, canvas.height);\r\n                source = canvas;\r\n            }\r\n\r\n            var tx;\r\n\r\n            if (texture.target === WebGLConstants.TEXTURE_2D) {\r\n                tx = new Texture({\r\n                    context: context,\r\n                    source: source,\r\n                    width: texture.width,\r\n                    height: texture.height,\r\n                    pixelFormat: texture.internalFormat,\r\n                    pixelDatatype: texture.type,\r\n                    sampler: sampler,\r\n                    flipY: texture.flipY\r\n                });\r\n            }\r\n            // GLTF_SPEC: Support TEXTURE_CUBE_MAP.  https://github.com/KhronosGroup/glTF/issues/40\r\n\r\n            if (mipmap) {\r\n                tx.generateMipmap();\r\n            }\r\n\r\n            return tx;\r\n        }\r\n        var WebGLConstants = Cesium.WebGLConstants;\r\n        function onTextureImageLoaded(image, item) {\r\n            var tex;\r\n            if (defined(image.internalFormat)) {\r\n                tex = new Texture({\r\n                    context: frameState.context,\r\n                    pixelFormat: image.internalFormat,\r\n                    width: image.width,\r\n                    height: image.height,\r\n                    source: {\r\n                        arrayBufferView: image.bufferView\r\n                    },\r\n                    flipY: item.flipY\r\n                });\r\n            } else {\r\n                var format = Cesium.WebGLConstants.RGB;\r\n                if (image instanceof HTMLCanvasElement\r\n                    || image instanceof HTMLVideoElement\r\n                    || (image.src && image.src.toLocaleLowerCase().indexOf(\".png\") >= 0)\r\n                ) {\r\n                    format = Cesium.WebGLConstants.RGBA;\r\n                }\r\n                if (item.sampler) {\r\n                    tex = createTexture({\r\n                        context: frameState.context,\r\n                        source: image,\r\n                        target: WebGLConstants.TEXTURE_2D,\r\n                        width: item.width,\r\n                        height: item.height,\r\n                        pixelFormat: format,\r\n                        flipY: item.flipY,\r\n                        sampler: new Cesium.Sampler(item.sampler)\r\n                    }, frameState.context);\r\n                } else {\r\n                    tex = new Texture({\r\n                        context: frameState.context,\r\n                        source: image,\r\n                        target: WebGLConstants.TEXTURE_2D,\r\n                        width: item.width,\r\n                        height: item.height,\r\n                        pixelFormat: format,\r\n                        flipY: Cesium.defined(item.flipY) ? item.flipY : true\r\n                    });\r\n                }\r\n            }\r\n            return tex;\r\n        }\r\n\r\n        function getTextureCallback(item) {\r\n\r\n            var callback = function () {\r\n\r\n                var cacheKey = typeof item.value == 'string' ? item.value : null;\r\n                if (!cacheKey) {\r\n                    if (item.value instanceof HTMLImageElement\r\n                        || item.value instanceof HTMLCanvasElement\r\n                        || item.value instanceof HTMLVideoElement\r\n                    ) {\r\n                        if (!item.value.uuid) {\r\n                            item.value.uuid = item.uuid;\r\n                        }\r\n                        cacheKey = item.value.uuid;\r\n                    }\r\n                }\r\n\r\n                if (!that._textureCache[cacheKey] || item.needsUpdate) {\r\n\r\n                    if (item.value instanceof HTMLImageElement\r\n                        || item.value instanceof HTMLCanvasElement\r\n                        || item.value instanceof HTMLVideoElement\r\n                    ) {\r\n                        var image = item.value;\r\n                        if (!item.value.id) {\r\n                            item.value.id = item.uuid;\r\n                        }\r\n                        that._textureCache[cacheKey] = onTextureImageLoaded(image, item);\r\n\r\n                        if (item.onDispose) {\r\n                            item.onDispose(function () {\r\n                                if (that._textureCache[cacheKey]) {\r\n                                    that._textureCache[cacheKey].destroy();\r\n                                    delete that._textureCache[cacheKey];\r\n                                }\r\n                            })\r\n                        }\r\n                        item.needsUpdate = false;\r\n                        return that._textureCache[cacheKey];\r\n\r\n                    } else {\r\n                        if (typeof item.value === \"string\" && !callback.isLoading) {\r\n                            callback.isLoading = true;\r\n                            item.needsUpdate = false;\r\n                            var url = item.value.toLocaleLowerCase();\r\n\r\n                            var extension = Path.GetExtension(url).slice(1);\r\n                            if (extension == 'tif') {//处理tif纹理\r\n\r\n                                loadArrayBuffer(url).then(function (imageArrayBuffer) {\r\n                                    var tiffParser = new TIFFParser();\r\n                                    var tiffCanvas = tiffParser.parseTIFF(imageArrayBuffer);\r\n                                    if (that._textureCache[cacheKey]) {\r\n                                        that._textureCache[cacheKey].destroy && that._textureCache[cacheKey].destroy();\r\n                                    }\r\n                                    that._textureCache[cacheKey] = onTextureImageLoaded(tiffCanvas, item);\r\n                                    if (item.onDispose) {\r\n                                        item.onDispose(function () {\r\n                                            if (that._textureCache[cacheKey]) {\r\n                                                that._textureCache[cacheKey].destroy();\r\n                                                delete that._textureCache[cacheKey];\r\n                                            }\r\n                                        })\r\n                                    }\r\n                                    callback.isLoading = false;\r\n\r\n                                }).otherwise(function (err) {\r\n                                    console.log(err);\r\n                                })\r\n\r\n                            } else {\r\n                                loadImage(item.value).then(function (image) {\r\n                                    if (that._textureCache[cacheKey]) {\r\n                                        that._textureCache[cacheKey].destroy && that._textureCache[cacheKey].destroy();\r\n                                    }\r\n                                    that._textureCache[cacheKey] = onTextureImageLoaded(image, item);\r\n                                    if (item.onDispose) {\r\n                                        item.onDispose(function () {\r\n                                            if (that._textureCache[cacheKey]) {\r\n                                                that._textureCache[cacheKey].destroy();\r\n                                                delete that._textureCache[cacheKey];\r\n                                            }\r\n                                        })\r\n                                    }\r\n                                    callback.isLoading = false;\r\n                                }).otherwise(function (err) {\r\n                                    console.log(err);\r\n                                })\r\n                            }\r\n                        }\r\n\r\n                        if (!that.defaultTextureImage) {\r\n                            that.defaultTextureImage = document.createElement(\"canvas\");\r\n                            that.defaultTextureImage.width = 1;\r\n                            that.defaultTextureImage.height = 1;\r\n                        }\r\n                        if (!that.defaultTexture) {\r\n                            that.defaultTexture = new Texture({\r\n                                context: frameState.context,\r\n                                source: that.defaultTextureImage\r\n                            });\r\n                        }\r\n\r\n                        return that.defaultTexture;\r\n                    }\r\n\r\n                } else {\r\n                    return that._textureCache[cacheKey];\r\n                }\r\n\r\n            }\r\n\r\n            return callback;\r\n        }\r\n\r\n        if (material.uniforms) {\r\n\r\n            function setUniformCallbackFunc(name, item) {\r\n\r\n                if (item !== undefined && item !== null) {//item may be 0\r\n                    var isImageUrl = typeof item.value === \"string\";\r\n                    var isCssColorString = typeof item.value === \"string\";\r\n                    if (typeof item.value === \"string\") {\r\n                        var itemLowerCase = item.value.toLocaleLowerCase();\r\n                        if (itemLowerCase.endsWith(\".png\")\r\n                            || itemLowerCase.endsWith(\".jpg\")\r\n                            || itemLowerCase.endsWith(\".bmp\")\r\n                            || itemLowerCase.endsWith(\".gif\")\r\n                            || itemLowerCase.endsWith(\".tif\")\r\n                            || itemLowerCase.endsWith(\".tiff\")\r\n                            || itemLowerCase.startsWith(\"data:\")\r\n                        ) {\r\n                            isImageUrl = true;\r\n                            isCssColorString = false;\r\n                        } else {\r\n                            try {\r\n                                Cesium.Color.fromCssColorString(item.value);\r\n                                isImageUrl = true;\r\n                                isCssColorString = false;\r\n                            } catch (e) {\r\n                                isImageUrl = false;\r\n                                isCssColorString = false;\r\n                            }\r\n                        }\r\n                    }\r\n\r\n                    if (item.value instanceof Cesium.Cartesian2\r\n                        || item.value instanceof Cesium.Cartesian3\r\n                        || item.value instanceof Cesium.Cartesian4\r\n                        || item.value instanceof Cesium.Color\r\n                        || item.value instanceof Cesium.Matrix4\r\n                        || item.value instanceof Cesium.Matrix3\r\n                        || item.value instanceof Cesium.Matrix2\r\n                        || item.value instanceof Cesium.Texture\r\n                        || typeof item.value === \"number\"\r\n                        || typeof item.value === \"boolean\"\r\n                        || isCssColorString\r\n                        || item.isColor\r\n                        || item.isCartesian2\r\n                        || item.isCartesian3\r\n                        || item.isCartesian4\r\n                        || item.value instanceof Cesium.Texture\r\n                        || (item.value instanceof Array && (typeof item.value[0] === 'number'\r\n                            || item.value[0] instanceof Cesium.Cartesian2\r\n                            || item.value[0] instanceof Cesium.Cartesian3\r\n                            || item.value[0] instanceof Cesium.Cartesian4))\r\n                    ) {\r\n                        if (!that._uniformValueCache) {\r\n                            that._uniformValueCache = {};\r\n                        }\r\n                        that._uniformValueCache[item.uuid] = item;\r\n                        if (isCssColorString) {\r\n                            item.value = Cesium.Color.fromCssColorString(item.value);\r\n                        }\r\n                        uniformMap[name] = function () {\r\n                            return that._uniformValueCache[item.uuid].value;\r\n                        }\r\n                        if (item.onDispose) {\r\n                            item.onDispose(function () {\r\n                                if (that._uniformValueCache[item.uuid]) {\r\n                                    delete that._uniformValueCache[item.uuid];\r\n                                }\r\n                            })\r\n                        }\r\n                    } else if (item.value instanceof Array && item.value.length == 6) {\r\n                        uniformMap[name] = getCubeTextureCallback(name, item);\r\n                    } else if (isImageUrl\r\n                        || item.value instanceof HTMLImageElement\r\n                        || item.value instanceof HTMLCanvasElement\r\n                        || item.value instanceof HTMLVideoElement\r\n                    ) {\r\n                        uniformMap[name] = getTextureCallback(item, material);\r\n                    } else if (item.value instanceof FramebufferTexture) {\r\n                        if (!that._renderToTextureCommands) {\r\n                            that._renderToTextureCommands = [];\r\n                        }\r\n                        if (!that._framebufferTextures[item.uuid]) {\r\n                            that._framebufferTextures[item.uuid] = item;\r\n                        }\r\n                        uniformMap[name] = function () {\r\n                            if (!that._framebufferTextures[item.uuid]\r\n                                || !that._framebufferTextures[item.uuid].value.texture) {\r\n                                return frameState.context.defaultTexture;\r\n                            }\r\n                            return that._framebufferTextures[item.uuid].value.texture;\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n\r\n            var uniforms = material.uniforms;\r\n            for (var name in uniforms) {\r\n\r\n                if (uniforms.hasOwnProperty(name) && Cesium.defined(uniforms[name].value) && uniforms[name].value != null) {\r\n                    if (Array.isArray(uniforms[name].value) && uniforms[name].value.length == 0) {\r\n                        continue;\r\n                    }\r\n                    var item = uniforms[name];\r\n                    if (item == undefined || item == null) {\r\n                        continue;\r\n                    }\r\n                    setUniformCallbackFunc(name, item);\r\n                }\r\n            }\r\n        }\r\n\r\n        return this._uniformMaps[material.uuid];\r\n    },\r\n    /**\r\n    *\r\n    *@param {Cesium.Geometry} geometry\r\n    *@param {Cesium.Material} material\r\n    *@return {String}\r\n    *@private  \r\n    */\r\n    getVertexShaderSource: function (mesh, material) {\r\n        var geometry = mesh.geometry;\r\n        function getAttributeDefineBlok(userDefine) {\r\n            var glsl = \"\";\r\n\r\n            var attrs = geometry.attributes;\r\n            for (var name in attrs) {\r\n\r\n                if (attrs.hasOwnProperty(name)) {\r\n                    var attr = attrs[name]\r\n                    if (attr) {\r\n\r\n                        var type = null;\r\n                        switch (attr.componentsPerAttribute) {\r\n                            case 1:\r\n                                type = \"float\";\r\n                                break;\r\n                            case 2:\r\n                                type = \"vec2\";\r\n                                break;\r\n                            case 3:\r\n                                type = \"vec3\";\r\n                                break;\r\n                            case 4:\r\n                                type = \"vec4\";\r\n                                break;\r\n                            default:\r\n                        }\r\n\r\n                        if (type) {\r\n                            if (userDefine.indexOf(\"attribute \" + type + \" \" + name) >= 0) {\r\n                                continue;\r\n                            }\r\n                            glsl += \"attribute \" + type + \" \" + name + \";\\n\";\r\n                        }\r\n\r\n                    }\r\n                }\r\n            }\r\n            return glsl;\r\n        }\r\n\r\n        var uniforms = \"\\n\\\r\n        uniform mat4 modelViewMatrix;\\n\\\r\n        uniform mat4 viewMatrix;\\n\\\r\n        uniform mat4 modelMatrix;\\n\\\r\n        uniform mat4 projectionMatrix;\\n\\\r\n        uniform mat3 normalMatrix;\\n\\\r\n        uniform mat4 u_modelViewMatrix;\\n\\\r\n        uniform mat4 u_viewMatrix;\\n\\\r\n        uniform mat4 u_modelMatrix;\\n\\\r\n        uniform mat4 u_projectionMatrix;\\n\\\r\n        uniform mat3 u_normalMatrix;\\n\\\r\n        uniform vec3 cameraPosition;\\n\\\r\n        uniform vec3 u_cameraPosition;\\n\";\r\n\r\n        var innerUniforms = [\r\n\r\n            mesh._instances && mesh._instances.length > 0 ? 'mat4 modelViewMatrix' : \"uniform mat4 modelViewMatrix\",\r\n            mesh._instances && mesh._instances.length > 0 ? 'mat4 modelMatrix' : \"uniform mat4 modelMatrix\",\r\n            \"uniform mat4 projectionMatrix\",\r\n            \"uniform mat3 normalMatrix\",\r\n            mesh._instances && mesh._instances.length > 0 ? 'mat4 u_modelViewMatrix' : \"uniform mat4 u_modelViewMatrix\",\r\n            mesh._instances && mesh._instances.length > 0 ? 'mat4 u_modelMatrix' : \"uniform mat4 u_modelMatrix\",\r\n            \"uniform mat4 u_projectionMatrix\",\r\n            \"uniform mat3 u_normalMatrix\",\r\n            \"uniform mat4 u_viewMatrix\",\r\n            \"uniform mat4 viewMatrix\",\r\n            \"uniform vec3 cameraPosition\",\r\n            \"uniform vec3 u_cameraPosition\"\r\n        ];\r\n        if (material.vertexShader) {\r\n            uniforms = \"\";\r\n            innerUniforms.forEach(function (item) {\r\n                if (material.vertexShader.indexOf(item) < 0) {\r\n                    uniforms += item + \";\\n\";\r\n                }\r\n            });\r\n            var vs = getAttributeDefineBlok(material.vertexShader) + uniforms +\r\n                material.vertexShader;\r\n\r\n            vs = ShaderChunk.parseIncludes(vs);\r\n\r\n            return vs;\r\n        }\r\n        else {\r\n            throw new Error(\"material.vertexShader 是必须参数\");\r\n        }\r\n    },\r\n    /**\r\n     * \r\n     *@param {Cesium.Material} material\r\n     *@return {String} \r\n     *@private\r\n     */\r\n    getFragmentShaderSource: function (material) {\r\n\r\n        if (material.fragmentShader) {\r\n            var fs = ShaderChunk.parseIncludes(material.fragmentShader);\r\n            return fs;\r\n        } else {\r\n            throw new Error(\"material.fragmentShader 是必须参数\");\r\n        }\r\n    }\r\n}\r\n\r\nMeshVisualizer.prototype._computeModelMatrix = function (mesh, frameState) {\r\n    if (mesh._actualMesh) {\r\n        mesh = mesh._actualMesh;\r\n    }\r\n    var that = this;\r\n    if (mesh instanceof LOD || mesh instanceof ReferenceMesh || typeof mesh.update === 'function') {\r\n        if (mesh.parent) {\r\n            if (mesh.parent == that) {\r\n                mesh.update(that._actualModelMatrix, frameState);\r\n\r\n            } else if (mesh.parent.modelMatrix) {\r\n                mesh.update(mesh.parent.modelMatrix, frameState);\r\n            } else {\r\n                mesh.update(that._actualModelMatrix, frameState);\r\n            }\r\n        } else {\r\n            mesh.update(that._actualModelMatrix, frameState);\r\n        }\r\n    } else {\r\n        var position = mesh.position;\r\n        if (mesh.parent instanceof LOD) {\r\n            Matrix4.clone(mesh.parent.modelMatrix, mesh.modelMatrix);\r\n\r\n        } else if (mesh._modelMatrixNeedsUpdate) {\r\n            var rotation = mesh.quaternion ? mesh.quaternion : mesh.rotation;\r\n\r\n            if (mesh.parent && mesh.parent.modelMatrix) {\r\n\r\n                var actualModelMatrix = mesh.parent.modelMatrix ? mesh.parent.modelMatrix : mesh._drawCommand.modelMatrix;\r\n                RendererUtils.computeModelMatrix(\r\n                    actualModelMatrix,\r\n                    mesh.position,\r\n                    rotation,\r\n                    mesh.scale,\r\n                    mesh.modelMatrix\r\n                );\r\n\r\n            } else {\r\n                RendererUtils.computeModelMatrix(\r\n                    that._actualModelMatrix,\r\n                    mesh.position,\r\n                    rotation,\r\n                    mesh.scale,\r\n                    mesh.modelMatrix\r\n                );\r\n            }\r\n\r\n            mesh._modelMatrixNeedsUpdate = false;\r\n        }\r\n    }\r\n}\r\n/**\r\n*\r\n*@param {Cesium.FrameState}frameState\r\n*/\r\nMeshVisualizer.prototype.update = function (frameState) {\r\n    if (!this._scene) {\r\n        this._scene = frameState.camera._scene;\r\n    }\r\n    if (!this._ready || !this.show && this._chidren.length > 0) {//如果未准备好则不加入渲染队列\r\n        return;\r\n    }\r\n    this.beforeUpdate.raiseEvent(frameState);\r\n\r\n    var that = this;\r\n    var wireframeChanged = false;\r\n    var sysWireframe = frameState.camera._scene._globe._surface.tileProvider._debug.wireframe;\r\n    if (this.debug) {\r\n        sysWireframe = true;\r\n    }\r\n\r\n    if (sysWireframe != this._isWireframe) {\r\n        wireframeChanged = true;\r\n    }\r\n    if (this._modelMatrixNeedsUpdate) {\r\n        this._actualModelMatrix = RendererUtils.computeModelMatrix(\r\n            this._modelMatrix,\r\n            this._position,\r\n            this._rotation,\r\n            this._scale,\r\n            this._actualModelMatrix\r\n        );\r\n        if (this._up && this._up.y) {\r\n            this._actualModelMatrix = RendererUtils.yUp2Zup(this._actualModelMatrix, this._actualModelMatrix);\r\n        }\r\n        Cesium.Cartesian3.clone(this._scale, this._oldScale);\r\n        Cesium.Cartesian3.clone(this._position, this._oldPosition);\r\n        this._modelMatrixNeedsUpdate = false;\r\n    }\r\n\r\n    MeshVisualizer.traverse(this, function (mesh) {\r\n        if (!mesh.show) return;\r\n\r\n        if (mesh._instances && mesh._instances.length) {\r\n            mesh._availableInstances = mesh._availableInstances || [];\r\n            mesh._availableInstances.splice(0);\r\n\r\n            if (!mesh.geometry.boundingSphere) {\r\n                mesh.geometry.boundingSphere = Cesium.BoundingSphere.fromVertices(mesh.geometry.attributes.position.values);\r\n            }\r\n\r\n            mesh._instances.forEach(function (instance) {\r\n                if (!instance.show) return;\r\n                Matrix4.getTranslation(instance.modelMatrix, instance.boundingSphere.center);\r\n                instance.boundingSphere.radius = mesh.geometry.boundingSphere.radius;\r\n                var intersect = frameState.cullingVolume.computeVisibility(instance.boundingSphere)\r\n                if (intersect != Cesium.Intersect.OUTSIDE) {\r\n                    mesh._availableInstances.push(instance)\r\n                }\r\n            });\r\n            if (mesh._availableInstances.length == 0) return;\r\n        }\r\n\r\n        if (MeshUtils.isMesh3js(mesh)) {\r\n            var needsUpdate = !mesh._actualMesh\r\n                || mesh.needsUpdate\r\n                || mesh.geometry.needsUpdate;\r\n\r\n            if (needsUpdate) {\r\n                mesh._actualMesh = MeshUtils.fromMesh3js(mesh);\r\n                mesh.modelMatrixNeedsUpdate = true;\r\n            }\r\n            else {\r\n                for (var pn in mesh.geometry.attributes) {\r\n                    if (mesh.geometry.attributes.hasOwnProperty(pn)) {\r\n                        mesh._actualMesh.geometry.attributes[pn].needsUpdate = mesh.geometry.attributes[pn].needsUpdate;\r\n                    }\r\n                }\r\n                var index = mesh.geometry.index;\r\n                if (index && index.needsUpdate) {\r\n                    mesh._actualMesh.geometry.needsUpdate = true;\r\n                }\r\n            }\r\n\r\n            mesh._actualMesh.quaternion = Cesium.Quaternion.clone(mesh.quaternion);\r\n            mesh._actualMesh.position = mesh.position;\r\n            mesh._actualMesh.scale = mesh.scale;\r\n            mesh._actualMesh.modelMatrixNeedsUpdate = mesh.modelMatrixNeedsUpdate;\r\n            mesh = mesh._actualMesh;\r\n            MaterialUtils.updateMaterialFrom3js(mesh.material);\r\n        }\r\n\r\n        that._computeModelMatrix(mesh, frameState);\r\n\r\n        if (typeof mesh.update !== 'function') {\r\n            if (frameState.passes.pick && !mesh.material.allowPick) {\r\n                return;\r\n            }\r\n\r\n            if (!mesh._drawCommand\r\n                || mesh.needsUpdate\r\n                || mesh.geometry.needsUpdate\r\n                || wireframeChanged\r\n            ) {//重新构建绘图命令，比如geometry完全不同于之前一帧 或者顶点和索引数量都发生改变等时，执行这段\r\n\r\n                if (sysWireframe || mesh.material.wireframe) {\r\n                    that.toWireframe(mesh.geometry);\r\n                } else {\r\n                    that.restoreFromWireframe(mesh.geometry);\r\n                }\r\n\r\n                if (mesh._drawCommand) mesh._drawCommand.destroy();\r\n                mesh._drawCommand = that.createDrawCommand(mesh, frameState);\r\n\r\n                mesh.needsUpdate = false;\r\n                mesh.geometry.needsUpdate = false;\r\n            } else {//在不需要重新构建绘图命令时，检查各个属性和索引是否需要更新，需要则将更新相应的缓冲区\r\n\r\n                //更新属性缓冲区\r\n                for (var name in mesh.geometry.attributes) {\r\n                    if (mesh.geometry.attributes.hasOwnProperty(name)) {\r\n                        if (mesh.geometry.attributes[name] && mesh.geometry.attributes[name].needsUpdate) {\r\n                            var attrLocation = mesh._drawCommand.vertexArray._attributeLocations[name]\r\n                            var vb = mesh._drawCommand.vertexArray._attributes[attrLocation].vertexBuffer;\r\n                            var arrayView = mesh.geometry.attributes[name].values;\r\n                            var gl = vb._gl;\r\n                            var target = vb._bufferTarget;\r\n                            gl.bindBuffer(target, vb._buffer);\r\n                            gl.bufferData(target, arrayView, BufferUsage.STATIC_DRAW);\r\n                            gl.bindBuffer(target, null);\r\n\r\n                            // vb.copyFromArrayView(mesh.geometry.attributes[name].values, 0);\r\n                        }\r\n                    }\r\n                }\r\n                //更新索引缓冲区\r\n                if (mesh.geometry.indexNeedsUpdate) {\r\n                    var vb = mesh._drawCommand.vertexArray.indexBuffer;\r\n                    var gl = vb._gl;\r\n                    var target = vb._bufferTarget;\r\n                    gl.bindBuffer(target, vb._buffer);\r\n                    gl.bufferData(target, mesh.geometry.indices, BufferUsage.STATIC_DRAW);\r\n                    gl.bindBuffer(target, null);\r\n                    mesh.geometry.indexNeedsUpdate = false;\r\n                    // vb.copyFromArrayView(mesh.geometry.indices, 0);\r\n                }\r\n\r\n                if (mesh._instances && mesh._instances.length) {\r\n                    updateVertexBuffer(mesh, frameState.context);\r\n                }\r\n            }\r\n\r\n            mesh._drawCommand.modelMatrix = mesh.modelMatrix;\r\n\r\n            if (mesh._instances && mesh._instances.length) {\r\n                mesh._drawCommand.boundingVolume = mesh._boundingSphere;\r\n                mesh._drawCommand.instanceCount = mesh._availableInstances.length;\r\n                mesh._pickCommand && (mesh._pickCommand.instanceCount = mesh._availableInstances.length);\r\n            }\r\n            else {\r\n                if (!mesh._drawCommand.boundingVolume) {\r\n                    if (!mesh.geometry.boundingSphere) {\r\n                        mesh.geometry.boundingSphere = Cesium.BoundingSphere.fromVertices(mesh.geometry.attributes.position.values);\r\n                    }\r\n                    mesh._drawCommand.boundingVolume = Cesium.BoundingSphere.clone(mesh.geometry.boundingSphere);\r\n                }\r\n                Cesium.Matrix4.getTranslation(mesh.modelMatrix, mesh._drawCommand.boundingVolume.center);\r\n            }\r\n            mesh._pickCommand.boundingVolume = mesh._drawCommand.boundingVolume;\r\n\r\n            mesh._drawCommand.uniformMap = that.getUniformMap(mesh.material, frameState);\r\n            if (frameState.passes.pick) {\r\n\r\n                var command = mesh._pickCommand;\r\n                frameState.commandList.push(command);\r\n\r\n            } else {\r\n                mesh.material._renderStateOptions.depthTest.enabled = mesh.material.depthTest;\r\n                mesh._drawCommand.renderState = RenderState.fromCache(mesh.material._renderStateOptions);\r\n                // mesh._drawCommand.renderState.depthTest.enabled = mesh.material.depthTest;\r\n\r\n                mesh._drawCommand.shaderProgram = mesh._drawCommand._sp;\r\n                frameState.commandList.push(mesh._drawCommand);\r\n            }\r\n\r\n        } else {\r\n            mesh.needsUpdate = false;\r\n        }\r\n\r\n    }, true);\r\n\r\n    //执行帧缓冲绘图命令\r\n    for (var i in that._framebufferTextures) {\r\n        if (that._framebufferTextures.hasOwnProperty(i)) {\r\n            var item = that._framebufferTextures[i].value;\r\n            that.updateFrameBufferTexture(frameState, item);\r\n        }\r\n    }\r\n\r\n    this._isWireframe = sysWireframe;\r\n    wireframeChanged = false;\r\n    this._modelMatrixNeedsUpdate = false;\r\n    this._geometryChanged = false;\r\n\r\n}\r\n\r\n///////2020.04.20  --start\r\n\r\n\r\n/**\r\n*单独渲染frameBufferTexture中的mesh，最终更新frameBufferTexture中的texture\r\n*@param {Cesium.FrameState}frameState\r\n*@param {Cesium.FramebufferTexture}frameBufferTexture\r\n@param {{x:number,y:number,width:number,height:number}}viewport\r\n*/\r\nMeshVisualizer.prototype.initFrameBufferTexture = function (frameState, frameBufferTexture, viewport) {\r\n    var that = this;\r\n\r\n    var item = frameBufferTexture;\r\n    if (item instanceof FramebufferTexture) {\r\n\r\n        item.drawCommands = [];\r\n        MeshVisualizer.traverse(item.mesh, function (mesh) {\r\n            if (MeshUtils.isMesh3js(mesh)) {\r\n                var needsUpdate = !mesh._actualMesh\r\n                    || mesh.needsUpdate\r\n                    || mesh.geometry.needsUpdate;\r\n\r\n                if (needsUpdate) {\r\n                    mesh._actualMesh = MeshUtils.fromMesh3js(mesh);\r\n                }\r\n                if (!needsUpdate) {\r\n                    for (var pn in mesh.geometry.attributes) {\r\n                        if (mesh.geometry.attributes.hasOwnProperty(pn)) {\r\n                            mesh._actualMesh.geometry[pn].needsUpdate = mesh.geometry.attributes[pn].needsUpdate;\r\n                        }\r\n                    }\r\n                    var index = mesh.geometry.getIndex();\r\n                    if (index && index.needsUpdate) {\r\n                        mesh._actualMesh.geometry.needsUpdate = true;\r\n                    }\r\n                }\r\n\r\n                mesh._actualMesh.quaternion = Cesium.Quaternion.clone(mesh.quaternion);\r\n                mesh._actualMesh.position = mesh.position;\r\n                mesh._actualMesh.scale = mesh.scale;\r\n                mesh._actualMesh.modelMatrixNeedsUpdate = mesh.modelMatrixNeedsUpdate;\r\n                mesh = mesh._actualMesh;\r\n                MaterialUtils.updateMaterialFrom3js(mesh.material);\r\n            }\r\n            that._computeModelMatrix(mesh, frameState);\r\n\r\n            if (!mesh._textureCommand\r\n                || mesh.needsUpdate\r\n                || mesh.geometry.needsUpdate\r\n            ) {\r\n                if (mesh.material.wireframe) {\r\n                    that.toWireframe(mesh.geometry);\r\n                } else {\r\n                    that.restoreFromWireframe(mesh.geometry);\r\n                }\r\n\r\n                mesh._textureCommand = that.createDrawCommand(mesh, frameState);\r\n                //mesh._textureCommand.boundingVolume = mesh.geometry.boundingSphere;\r\n                mesh.needsUpdate = false;\r\n                mesh.material.needsUpdate = false;\r\n\r\n            } else {//在不需要重新构建绘图命令时，检查各个属性和索引是否需要更新，需要则将更新相应的缓冲区\r\n\r\n                var vaNeedsUpdate = false\r\n                //更新属性缓冲区\r\n                for (var name in mesh.geometry.attributes) {\r\n                    if (mesh.geometry.attributes.hasOwnProperty(name)\r\n                        && mesh.geometry.attributes[name]) {\r\n\r\n                        if (mesh.geometry.attributes[name] && mesh.geometry.attributes[name].needsUpdate) {\r\n                            var attrLocation = mesh._textureCommand.vertexArray._attributeLocations[name]\r\n                            var vb = mesh._textureCommand.vertexArray._attributes[attrLocation].vertexBuffer;\r\n                            var arrayView = mesh.geometry.attributes[name].values;\r\n                            var gl = vb._gl;\r\n                            if (vb._sizeInBytes == arrayView * arrayView.constructor.BYTES_PER_ELEMENT) {\r\n                                var target = vb._bufferTarget;\r\n                                gl.bindBuffer(target, vb._buffer);\r\n                                gl.bufferData(target, arrayView, BufferUsage.STATIC_DRAW);\r\n                                gl.bindBuffer(target, null);\r\n                            } else {\r\n                                vaNeedsUpdate = true;\r\n                                break;\r\n                            }\r\n\r\n                            //vb.copyFromArrayView(mesh.geometry.attributes[name].values, 0);\r\n                        }\r\n                    }\r\n                }\r\n\r\n                //更新索引缓冲区\r\n                if (!vaNeedsUpdate && mesh.geometry.indexNeedsUpdate) {\r\n\r\n                    var arrayBufferView = mesh.geometry.indices;\r\n\r\n                    var vb = mesh._textureCommand.vertexArray.indexBuffer;\r\n                    if (vb._sizeInBytes != arrayBufferView.length * arrayBufferView.constructor.BYTES_PER_ELEMENT) {\r\n                        vb.destroy();\r\n                        var buffer = Buffer.createIndexBuffer({\r\n                            context: frameState.context,\r\n                            typedArray: arrayBufferView,\r\n                            usage: BufferUsage.STATIC_DRAW,\r\n                            indexDatatype: arrayBufferView instanceof Uint16Array ? Cesium.IndexDatatype.UNSIGNED_SHORT : Cesium.IndexDatatype.UNSIGNED_INT\r\n                        });\r\n                        mesh._textureCommand.vertexArray._indexBuffer = buffer;\r\n                    } else {\r\n                        var gl = vb._gl;\r\n                        var target = vb._bufferTarget;\r\n                        gl.bindBuffer(target, vb._buffer);\r\n                        gl.bufferData(target, arrayBufferView, BufferUsage.STATIC_DRAW);\r\n                        gl.bindBuffer(target, null);\r\n                    }\r\n\r\n                    mesh.geometry.indexNeedsUpdate = false;\r\n                }\r\n\r\n                if (vaNeedsUpdate) {\r\n                    var command = mesh._textureCommand\r\n                    var attributeLocations = command.vertexArray._attributeLocations\r\n                    var vertexArrayAttributes = command._cacehVertexArrayAttributes\r\n                    command.vertexArray.destroy();\r\n                    command.vertexArray = VertexArray.fromGeometry({\r\n                        context: frameState.context,\r\n                        geometry: mesh.geometry,\r\n                        attributeLocations: attributeLocations,\r\n                        bufferUsage: BufferUsage.STATIC_DRAW,\r\n\r\n                        vertexArrayAttributes: vertexArrayAttributes\r\n                    });\r\n                    if (vertexArrayAttributes && vertexArrayAttributes.length) {\r\n                        command._cacehVertexArrayAttributes = vertexArrayAttributes.map(function (a) {\r\n                            return a;\r\n                        })\r\n                    }\r\n                    command.vertexArray._attributeLocations = attributeLocations;\r\n\r\n                    for (var name in mesh.geometry.attributes) {\r\n                        if (mesh.geometry.attributes.hasOwnProperty(name)\r\n                            && mesh.geometry.attributes[name]) {\r\n                            mesh.geometry.attributes[name].needsUpdate = false;\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n\r\n            mesh._textureCommand.modelMatrix = mesh.modelMatrix;\r\n\r\n            var context = frameState.context;\r\n            var drawingBufferWidth = context.drawingBufferWidth;\r\n            var drawingBufferHeight = context.drawingBufferHeight;\r\n            var fbNeedsUpdate = false;\r\n\r\n            if (!item.texture\r\n                || item.texture.width != drawingBufferWidth\r\n                || item.texture.height != drawingBufferHeight\r\n            ) {\r\n                var notFullScreen = item._notFullScreen || Cesium.defined(item.texture);\r\n                if (!notFullScreen) {\r\n                    item.texture = new Texture({\r\n                        context: context,\r\n                        width: drawingBufferWidth,\r\n                        height: drawingBufferHeight,\r\n                        pixelFormat: PixelFormat.RGBA\r\n                        // ,pixelDatatype:PixelDatatype.FLOAT\r\n                    });\r\n                    fbNeedsUpdate = true;\r\n                }\r\n                item._notFullScreen = notFullScreen;\r\n\r\n            }\r\n            if (!item.depthTexture\r\n                || item.depthTexture.width != item.texture.width\r\n                || item.depthTexture.height != item.texture.height\r\n            ) {\r\n                item.depthTexture = new Cesium.Texture({\r\n                    context: context,\r\n                    width: item.texture.width,\r\n                    height: item.texture.height,\r\n                    pixelFormat: Cesium.PixelFormat.DEPTH_COMPONENT,\r\n                    pixelDatatype: Cesium.PixelDatatype.UNSIGNED_SHORT\r\n                });\r\n                fbNeedsUpdate = true;\r\n            }\r\n            if (!item.framebuffer || fbNeedsUpdate) {\r\n                item.framebuffer = new Cesium.Framebuffer({\r\n                    context: context,\r\n                    colorTextures: [item.texture],\r\n                    destroyAttachments: false,\r\n                    depthTexture: item.depthTexture\r\n                });\r\n            }\r\n\r\n            mesh.material._renderStateOptions.depthTest.enabled = mesh.material.depthTest;\r\n            //mesh._textureCommand.renderState.depthTest.enabled = mesh.depthTest;\r\n            if (viewport) {\r\n                mesh.material._renderStateOptions.viewport = viewport;\r\n            }\r\n            mesh._textureCommand.renderState = RenderState.fromCache(mesh.material._renderStateOptions);\r\n\r\n            item.drawCommands.push(mesh._textureCommand);\r\n\r\n        }, true);\r\n\r\n    }\r\n}\r\n\r\n/**\r\n*单独渲染frameBufferTexture中的mesh，最终更新frameBufferTexture中的texture\r\n*@param {Cesium.FrameState}frameState\r\n*@param {Cesium.FramebufferTexture}frameBufferTexture\r\n@param {{x:number,y:number,width:number,height:number}}viewport\r\n*/\r\nMeshVisualizer.prototype.updateFrameBufferTexture = function (frameState, frameBufferTexture, viewport) {\r\n    this.initFrameBufferTexture(frameState, frameBufferTexture, viewport);\r\n    var item = frameBufferTexture;\r\n    if (item.drawCommands && item.drawCommands.length > 0) {\r\n        // item.depthTexture = RendererUtils.renderToTexture(item.drawCommands, frameState, item.texture, item.depthTexture);\r\n        RendererUtils.renderToTexture(item.drawCommands, frameState, item.framebuffer);\r\n\r\n        for (var i = 0; i < item.drawCommands.length; i++) {\r\n\r\n            item.drawCommands[i]._renderStateOptions.viewport = void (0);\r\n            item.drawCommands[i].renderState = RenderState.fromCache(item.drawCommands[i]._renderStateOptions);\r\n\r\n        }\r\n    }\r\n    if (!frameBufferTexture.ready) {\r\n        frameBufferTexture.ready = true;\r\n        frameBufferTexture.readyPromise.resolve(frameBufferTexture);\r\n    }\r\n}\r\n\r\n\r\n/**\r\n*单独渲染frameBufferTexture中的mesh，最终更新frameBufferTexture中的texture，并读取缓冲区的像素,可以用于实现并行计算(参看MeshVisualizer.prototype.compute)\r\n*@param {Cesium.FrameState}frameState\r\n*@param {Cesium.FramebufferTexture}frameBufferTexture\r\n*@param {Object}[viewport] 可选，视口设置\r\n*@param {Number}viewport.x 视口位置x坐标（屏幕坐标系，左上角为原点）\r\n*@param {Number}viewport.y 视口位置y坐标（屏幕坐标系，左上角为原点）\r\n*@param {Number}viewport.width 视口宽度\r\n*@param {Number}viewport.height 视口高度\r\n*@param {Cesium.PixelDatatype}[viewport.pixelDatatype=Cesium.PixelDatatype.UNSIGNED_BYTE] 输出数据中像素值的rgba各项的数据类型，注意：有的移动设备不支持浮点型 \r\n*@param {Object}[readState] 可选，读取设置\r\n*@param {Number}readState.x 读取区域位置x坐标（屏幕坐标系，左上角为原点）\r\n*@param {Number}readState.y 读取区域位置y坐标（屏幕坐标系，左上角为原点）\r\n*@param {Number}readState.width 读取区域宽度\r\n*@param {Number}readState.height 读取区域高度\r\n*@param {Cesium.PixelDatatype}[readState.pixelDatatype=Cesium.PixelDatatype.UNSIGNED_BYTE] 输出数据中像素值的rgba各项的数据类型，注意：有的移动设备不支持浮点型 \r\n*@param {Array.<Number>}outputPixels \r\n*@return {Array.<Number>}outputPixels  输出的像素\r\n*/\r\nMeshVisualizer.prototype.getPixels = function (frameState, frameBufferTexture, viewport, readState, pixels) {\r\n    viewport = viewport ? viewport : {};\r\n    viewport.x = viewport.x ? viewport.x : 0;\r\n    viewport.y = viewport.y ? viewport.y : 0;\r\n    if (!viewport.width) {\r\n        viewport.width = frameState.context._canvas.width;\r\n    }\r\n    if (!viewport.height) {\r\n        viewport.height = frameState.context._canvas.height;\r\n    }\r\n\r\n    this.initFrameBufferTexture(frameState, frameBufferTexture, viewport)\r\n    var item = frameBufferTexture;\r\n    if (item.drawCommands && item.drawCommands.length > 0) {\r\n        if (!item._computeTexture\r\n            || (item._computeTexture\r\n                && (item._computeTexture.width != viewport.width\r\n                    || item._computeTexture.height != viewport.height)\r\n            )) {\r\n            var pixelDatatype = viewport.pixelDatatype;\r\n            var pixelFormat = viewport.pixelFormat;\r\n            if (pixelDatatype == Cesium.PixelDatatype.FLOAT && !frameState.context._gl.getExtension('OES_texture_float')) {\r\n                throw new Cesium.DeveloperError(\"此设备不支持浮点型纹理\");\r\n            }\r\n            if (item._computeTexture) {\r\n                item._computeTexture.destroy();\r\n                item._computeTexture = null;\r\n            }\r\n            item._computeTexture = new Cesium.Texture({\r\n                context: frameState.context,\r\n                width: viewport.width,\r\n                height: viewport.height,\r\n                pixelFormat: pixelFormat,//PixelFormat.RGBA,\r\n                pixelDatatype: pixelDatatype\r\n            });\r\n        }\r\n\r\n        pixels = RendererUtils.renderToPixels(item.drawCommands, frameState, item._computeTexture, readState ? readState : viewport, pixels);\r\n        for (var i = 0; i < item.drawCommands.length; i++) {\r\n            item.drawCommands[i].renderState.viewport = void (0);\r\n        }\r\n        return pixels;\r\n    }\r\n    else {\r\n        return null;\r\n    }\r\n}\r\n///////2020.04.20  --end\r\n\r\n/**\r\n*\r\n*@param {Cesium.Mesh}mesh\r\n*/\r\nMeshVisualizer.prototype.add = function (mesh) {\r\n    this._chidren.push(mesh);\r\n}\r\n\r\n/**\r\n*\r\n*/\r\nMeshVisualizer.prototype.destroy = function () {\r\n    this._ready = false;\r\n    MeshVisualizer.traverse(this, function (mesh) {\r\n        if (mesh._drawCommand) {\r\n            delete mesh._drawCommand;\r\n        }\r\n    }, false);\r\n    for (var i in this._uniformValueCache) {\r\n        if (this._uniformValueCache.hasOwnProperty(i)) {\r\n            delete this._uniformValueCache[i];\r\n        }\r\n    }\r\n    for (var i in this._textureCache) {\r\n        if (this._textureCache.hasOwnProperty(i)) {\r\n            delete this._textureCache[i];\r\n        }\r\n    }\r\n    for (var i in this._uniformMaps) {\r\n        if (this._uniformMaps.hasOwnProperty(i)) {\r\n            delete this._uniformMaps[i];\r\n        }\r\n    }\r\n    for (var i in this._framebufferTextures) {\r\n        if (this._framebufferTextures.hasOwnProperty(i)) {\r\n            delete this._framebufferTextures[i];\r\n        }\r\n    }\r\n    this._uniformValueCache = {};\r\n    this._textureCache = {};\r\n    this._uniformMaps = {};\r\n    this._framebufferTextures = {};\r\n    if (this._pickIds) {\r\n        for (i = 0; i < this._pickIds.length; ++i) {\r\n            this._pickIds[i].destroy && this._pickIds[i].destroy();\r\n        }\r\n    }\r\n}\r\n\r\n/**\r\n*\r\n*遍历节点\r\n*@param {Cesium.MeshVisualizer|Cesium.Mesh}root\r\n*@param {Cesium.MeshVisualizer~TraverseCallback}traverseFunc 访问每个节点时回调该函数，进行相关操作。回调函数包含一个参数，traverseArgs，其中封装了一个属性cancelCurrent，可以通过改变此属性达到终止遍历当前节点的子节点\r\n*@param {Boolean}visibleOnly visibleOnly为true时仅遍历可见的节点，如果父级节点不可见则不再访问其子节点\r\n*/\r\nMeshVisualizer.traverse = function (node, traverseFunc, visibleOnly, scratchTraverseArgs) {\r\n    if (!node) {\r\n        return;\r\n    }\r\n    if (!scratchTraverseArgs) {\r\n        scratchTraverseArgs = {\r\n            cancelCurrent: false,\r\n            cancelAll: false\r\n        };\r\n    }\r\n    scratchTraverseArgs.cancelCurrent = false;\r\n    if (visibleOnly && (!node.show && !node.visible)) {\r\n        return;\r\n    }\r\n    if ((node.geometry && node.material) || node instanceof LOD || node instanceof ReferenceMesh) {\r\n        traverseFunc(node, scratchTraverseArgs);\r\n    }\r\n\r\n    if (node.children) {\r\n        for (var i = 0; i < node.children.length; i++) {\r\n            if (scratchTraverseArgs.cancelCurrent) {\r\n                continue;\r\n            }\r\n            if (scratchTraverseArgs.cancelAll) {\r\n                break;\r\n            }\r\n            MeshVisualizer.traverse(node.children[i], traverseFunc, visibleOnly, scratchTraverseArgs);\r\n        }\r\n    }\r\n}\r\n\r\n/**\r\n*\r\n*@Cesium.MeshVisualizer~TraverseCallback\r\n*@param {Cesium.Mesh|Cesium.LOD|Cesium.MeshVisualizer|Object}node\r\n*@param {Object}traverseArgs\r\n*@param {Boolean}traverseArgs.cancelCurrent 为true时终止遍历当前节点的子节点\r\n*@param {Boolean}traverseArgs.cancelAll 为true时终止遍历，退出遍历循环\r\n*/\r\n\r\n\r\nObject.defineProperties(MeshVisualizer.prototype, {\r\n    scene: {\r\n        set: function (val) {\r\n            this._scene = val;\r\n        },\r\n        get: function () {\r\n            return this._scene;\r\n        }\r\n    },\r\n    frameState: {\r\n        get: function () {\r\n            if (!this._scene) {\r\n                return undefined;\r\n            }\r\n            return this._scene.frameState;\r\n        }\r\n    },\r\n    modelMatrixNeedsUpdate: {\r\n        get: function () {\r\n            return this._modelMatrixNeedsUpdate;\r\n        },\r\n        set: function (val) {\r\n            this._modelMatrixNeedsUpdate = val;\r\n            if (val) {\r\n                MeshVisualizer.traverse(this, function (child) {\r\n                    child._modelMatrixNeedsUpdate = val;\r\n                }, false);\r\n            }\r\n        }\r\n    },\r\n    showReference: {\r\n        get: function () {\r\n            return this.referenceMesh.show;\r\n        },\r\n        set: function (val) {\r\n            this.referenceMesh.show = val;\r\n        }\r\n    },\r\n    children: {\r\n        get: function () {\r\n            return this._chidren;\r\n        },\r\n        set: function (val) {\r\n            this._chidren = val;\r\n        }\r\n    },\r\n    show: {\r\n        get: function () {\r\n            return this._show;\r\n        },\r\n        set: function (val) {\r\n            this._show = val;\r\n        }\r\n    },\r\n    debug: {\r\n        get: function () {\r\n            return this._debug;\r\n        },\r\n        set: function (val) {\r\n            this._debug = val;\r\n        }\r\n    },\r\n    ready: {\r\n        get: function () {\r\n            return this._ready;\r\n        }\r\n    },\r\n    modelMatrix: {\r\n        get: function () {\r\n            return this._modelMatrix;\r\n        },\r\n        set: function (val) {\r\n            this._modelMatrix = val;\r\n            this._modelMatrixNeedsUpdate = true;\r\n        }\r\n    },\r\n    rotation: {\r\n        get: function () {\r\n            return this._rotation;\r\n        },\r\n        set: function (val) {\r\n            if (val != this._rotation) {\r\n                this._rotation = val;\r\n                this._needUpdate = true;\r\n            }\r\n            this._rotation.paramChanged.removeEventListener(this._onNeedUpdateChanged);\r\n            this._rotation = val;\r\n            this._rotation.paramChanged.addEventListener(this._onNeedUpdateChanged);\r\n        }\r\n    },\r\n    position: {\r\n        get: function () {\r\n            return this._position;\r\n        },\r\n        set: function (val) {\r\n            if (val.x != this._position.x || val.y != this._position.y || val.z != this._position.z) {\r\n                this._position = val;\r\n                this._modelMatrixNeedsUpdate = true;\r\n            }\r\n            this._position = val;\r\n        }\r\n    },\r\n    scale: {\r\n        get: function () {\r\n            return this._scale;\r\n        },\r\n        set: function (val) {\r\n            if (val.x != this._scale.x || val.y != this._scale.y || val.z != this._scale.z) {\r\n                this._scale = val;\r\n                this._modelMatrixNeedsUpdate = true;\r\n            }\r\n            this._scale = val;\r\n        }\r\n    }\r\n});\r\nexport default MeshVisualizer;","﻿\r\nimport BasicGeometry from './BasicGeometry.js';\r\n\r\n/**\r\n*\r\n* :\r\n*\r\n*                       -----width----+(width/2,height/2)\r\n*                       |             |\r\n*                       |    (0,0)    |\r\n*                       |      +    height\r\n*                       |             |\r\n*                       |             |\r\n*                        +----width-----\r\n*        (-width/2,-height/2)\r\n*    \r\n*@param {Number}width\r\n*@param {Number}height\r\n*@param {Number}widthSegments\r\n*@param {Number}heightSegments\r\n*@constructor\r\n*@memberof Cesium\r\n*/\r\nfunction PlaneBufferGeometry(width, height, widthSegments, heightSegments) {\r\n    this.width = width;\r\n    this.height = height;\r\n    this.widthSegments = widthSegments;\r\n    this.heightSegments = heightSegments;\r\n\r\n}\r\n\r\n/**\r\n*\r\n*@param {}\r\n*/\r\nPlaneBufferGeometry.createGeometry = function (planeBufferGeometry) {\r\n\r\n    var width = planeBufferGeometry.width,\r\n        height = planeBufferGeometry.height,\r\n        widthSegments = planeBufferGeometry.widthSegments,\r\n        heightSegments = planeBufferGeometry.heightSegments;\r\n\r\n\r\n    width = width || 1;\r\n    height = height || 1;\r\n\r\n    var width_half = width / 2;\r\n    var height_half = height / 2;\r\n\r\n    var gridX = Math.floor(widthSegments) || 1;\r\n    var gridY = Math.floor(heightSegments) || 1;\r\n\r\n    var gridX1 = gridX + 1;\r\n    var gridY1 = gridY + 1;\r\n\r\n    var segment_width = width / gridX;\r\n    var segment_height = height / gridY;\r\n\r\n    var ix, iy;\r\n\r\n    // buffers\r\n\r\n    var indices = [];\r\n    var vertices = [];\r\n    var normals = [];\r\n    var uvs = [];\r\n\r\n    // generate vertices, normals and uvs\r\n\r\n    for (iy = 0; iy < gridY1; iy++) {\r\n\r\n        var y = iy * segment_height - height_half;\r\n\r\n        for (ix = 0; ix < gridX1; ix++) {\r\n\r\n            var x = ix * segment_width - width_half;\r\n\r\n            vertices.push(x, -y, 0);\r\n\r\n            normals.push(0, 0, 1);\r\n\r\n            uvs.push(ix / gridX);\r\n            uvs.push(1 - (iy / gridY));\r\n\r\n        }\r\n\r\n    }\r\n\r\n    // indices\r\n\r\n    for (iy = 0; iy < gridY; iy++) {\r\n\r\n        for (ix = 0; ix < gridX; ix++) {\r\n\r\n            var a = ix + gridX1 * iy;\r\n            var b = ix + gridX1 * (iy + 1);\r\n            var c = (ix + 1) + gridX1 * (iy + 1);\r\n            var d = (ix + 1) + gridX1 * iy;\r\n\r\n            // faces\r\n\r\n            indices.push(a, b, d);\r\n            indices.push(b, c, d);\r\n\r\n        }\r\n\r\n    }\r\n\r\n    var geom = BasicGeometry.createGeometry({\r\n        positions: new Float32Array(vertices),\r\n        normals: new Float32Array(normals),\r\n        uvs: new Float32Array(uvs),\r\n        indices: new Int32Array(indices)\r\n    })\r\n\r\n    return geom;\r\n}\r\n\r\nexport default PlaneBufferGeometry; ","﻿/**\r\n *:\r\n *\r\n*       p1------------p4\r\n*       |          +  |\r\n*       |       +     |\r\n*       |     +       |\r\n*       |   +         |\r\n*       | +           |\r\n*       p2------------p3\r\n*    \r\n*@param {Object}options \r\n*@param {Array<Number|Cesium.Cartesian3>}options.positions [p1,p2,p3,p4]或者[p1.x,p1.y,p1.z,p2.x,...,p4.z] \r\n*\r\n*@property {Array<Number|Cesium.Cartesian3>}positions \r\n*\r\n*@constructor\r\n*@memberof Cesium\r\n*/\r\nfunction PlaneGeometry(options) {//positions, widthSegments, heightSegments) {\r\n    this.type = 'PlaneGeometry';\r\n    if (!options || !options.positions) {\r\n        throw new Error(\"缺少positions参数\");\r\n    }\r\n    if (options.positions.length != 4 && options.positions.length / 3 != 4) {\r\n        throw new Error(\"positions参数必须包含四个顶点的位置坐标\");\r\n    }\r\n    this.positions = options.positions;\r\n\r\n}\r\n/**\r\n*\r\n*@param {Cesium.PlaneGeometry}\r\n*@return {Cesium.Geometry}\r\n*/\r\nPlaneGeometry.createGeometry = function (planeGeometry) {\r\n    var positions = planeGeometry.positions;\r\n\r\n    var positionsVal;\r\n    if (Array.isArray(positions)) {\r\n        if (positions[0] instanceof Cesium.Cartesian3) {\r\n            positionsVal = new Float32Array(12);\r\n            for (var i = 0; i < positions.length; i++) {\r\n                var p = positions[i];\r\n                positionsVal[i * 3] = p.x;\r\n                positionsVal[i * 3 + 1] = p.y;\r\n                positionsVal[i * 3 + 2] = p.z;\r\n            }\r\n        } else if (typeof positions[0] === 'number') {\r\n            positionsVal = new Float32Array(positionsVal);\r\n        } else {\r\n            throw new Error(\"positions参数有误\");\r\n        }\r\n    } else {\r\n        throw new Error(\"positions参数必须是数组类型\");\r\n    }\r\n    var indices = new Int32Array([0, 1, 3, 1, 2, 3]);\r\n    var attributes = {\r\n        position: new Cesium.GeometryAttribute({\r\n            componentDatatype: Cesium.ComponentDatatype.DOUBLE,\r\n            componentsPerAttribute: 3,\r\n            values: positions\r\n        })\r\n    };\r\n    var bs = Cesium.BoundingSphere.fromVertices(positions);\r\n    var geo = new Cesium.Geometry({\r\n        attributes: attributes,\r\n        indices: new Int32Array(indices),\r\n        primitiveType: Cesium.PrimitiveType.TRIANGLES,\r\n        boundingSphere: bs\r\n    });\r\n    return geo;\r\n}\r\nexport default PlaneGeometry;","﻿\r\nimport ArrowGeometry from './ArrowGeometry.js';\r\nimport Mesh from './Mesh.js';\r\nimport MeshMaterial from './MeshMaterial.js';\r\nimport Rotation from './Rotation.js';\r\nimport RendererUtils from './RendererUtils.js';\r\n\r\nvar defaultValue;\r\n/**\r\n*\r\n*@param {Object}[options]   \r\n*@param {Cesium.ArrowGeometry}[options.axisParameter]\r\n*@param {Boolean}[options.show=true]  \r\n*@param {Cesium.Cartesian3}[options.position]\r\n*@param {Cesium.VolumeRendering.Rotation}[options.rotation]\r\n*@param {Cesium.Cartesian3}[options.scale]    \r\n* \r\n*@property {Boolean}show  \r\n*@property {Cesium.Cartesian3}position\r\n*@property {Cesium.Rotation}rotation\r\n*@property {Cesium.Cartesian3}scale   \r\n*@property {Boolean}needUpdate\r\n*\r\n*@constructor\r\n*@memberof Cesium \r\n*/\r\nfunction ReferenceMesh(options) {\r\n    defaultValue = defaultValue || Cesium.defaultValue;\r\n    options = Cesium.defaultValue(options, {});\r\n    this._axisParameter = new ArrowGeometry(options.axisParameter);\r\n    this._axisParameterY = new ArrowGeometry(options.axisParameter);\r\n    this._axisParameterY.reverse = true;\r\n\r\n    var materialZ = new MeshMaterial({\r\n        defaultColor: \"rgba(255,0,0,1)\",\r\n        wireframe: false,\r\n        side: MeshMaterial.Sides.DOUBLE,\r\n        translucent: false,\r\n\r\n    });\r\n    var materialY = new MeshMaterial({\r\n        defaultColor: \"rgba(0,255,0,1)\",\r\n        wireframe: false,\r\n        side: MeshMaterial.Sides.DOUBLE,\r\n        translucent: true,\r\n\r\n    });\r\n    var materialX = new MeshMaterial({\r\n        defaultColor: \"rgba(0,0,255,1)\",\r\n        wireframe: false,\r\n        side: MeshMaterial.Sides.DOUBLE,\r\n        translucent: false,\r\n\r\n    });\r\n\r\n    var axisLine = ArrowGeometry.createGeometry(new ArrowGeometry(this._axisParameter));\r\n    var axisLineY = ArrowGeometry.createGeometry(new ArrowGeometry(this._axisParameterY));\r\n\r\n    var meshZ = new Mesh(axisLine, materialZ);\r\n    var meshY = new Mesh(axisLineY, materialY);\r\n    var meshX = new Mesh(axisLine, materialX);\r\n    meshZ.position.z = this._axisParameter.length / 2;\r\n\r\n    meshY.position.y = -this._axisParameter.length / 2;\r\n    meshY.rotation.axis.y = 1;\r\n    meshY.rotation.angle = -180;\r\n\r\n    meshX.position.x = this._axisParameter.length / 2;\r\n    meshX.rotation.axis.x = 1;\r\n    meshX.rotation.angle = -180;\r\n\r\n    meshX.parent = this;\r\n    meshY.parent = this;\r\n    meshZ.parent = this;\r\n\r\n    this._children = [meshX, meshY, meshZ];\r\n    this.x = meshX;\r\n    this.y = meshY;\r\n    this.z = meshZ;\r\n\r\n    this.uuid = Cesium.createGuid();\r\n    this.show = defaultValue(options.show, true);\r\n    this._position = defaultValue(options.position, new Cesium.Cartesian3(0, 0, 0));\r\n    this._scale = defaultValue(options.scale, new Cesium.Cartesian3(1, 1, 1));\r\n    this._rotation = defaultValue(options.rotation, { axis: new Cesium.Cartesian3(0, 0, 1), angle: 0 });\r\n    this._rotation = new Rotation(this._rotation.axis, this._rotation.angle);\r\n    this._needsUpdate = true;\r\n    this._modelMatrixNeedsUpdate = true;\r\n    this._modelMatrix = new Cesium.Matrix4();\r\n    Cesium.Matrix4.clone(Cesium.Matrix4.IDENTITY, this._modelMatrix);\r\n\r\n    this._onNeedUpdateChanged = function () {\r\n        this._modelMatrixNeedsUpdate = true;\r\n    };\r\n    this._rotation.paramChanged.removeEventListener(this._onNeedUpdateChanged);\r\n    this._parent = null;\r\n\r\n}\r\nfunction removeByValue(arr, val) {\r\n    for (var i = 0; i < arr.length; i++) {\r\n        if (arr[i] == val) {\r\n            arr.splice(i, 1);\r\n            break;\r\n        }\r\n    }\r\n}\r\nObject.defineProperties(ReferenceMesh.prototype, {\r\n    modelMatrix: {\r\n        get: function () {\r\n            return this._modelMatrix;\r\n        }\r\n    },\r\n    parent: {\r\n        get: function () {\r\n            return this._parent;\r\n        },\r\n        set: function (val) {\r\n            if (val && ((val._children && Array.isArray(val._children)) || (val.children && Array.isArray(val.children)))) {\r\n\r\n                if (this._parent && this._parent != val) {\r\n                    var children = this._parent._children ? this._parent._children : this._parent.children;\r\n                    if (Array.isArray(children)) {\r\n                        removeByValue(children, this);\r\n                    }\r\n                }\r\n                this._parent = val;\r\n                if (typeof this._parent.add === 'function') {\r\n                    this._parent.add(this);\r\n                } else {\r\n                    var children = val._children ? val._children : val.children;\r\n                    children.push(this);\r\n                }\r\n            }\r\n            this.modelMatrixNeedsUpdate = true;\r\n        }\r\n    },\r\n    modelMatrixNeedsUpdate: {\r\n        get: function () {\r\n            return this._modelMatrixNeedsUpdate;\r\n        },\r\n        set: function (val) {\r\n            this._modelMatrixNeedsUpdate = val;\r\n            if (this._modelMatrixNeedsUpdate) {\r\n                Mesh.traverse(this, function (mesh) {\r\n                    mesh._modelMatrixNeedsUpdate = val;\r\n                });\r\n            }\r\n        }\r\n    },\r\n    children: {\r\n        get: function () {\r\n            return this._children;\r\n        }\r\n    },\r\n    needsUpdate: {\r\n        get: function () {\r\n            return this._needsUpdate;\r\n        },\r\n        set: function (val) {\r\n            this._needsUpdate = val;\r\n        }\r\n    },\r\n    rotation: {\r\n        get: function () {\r\n            return this._rotation;\r\n        },\r\n        set: function (val) {\r\n            if (val != this._rotation) {\r\n                this._rotation = val;\r\n                this.modelMatrixNeedsUpdate = true;\r\n            }\r\n            this._rotation.paramChanged.removeEventListener(this._onNeedUpdateChanged);\r\n            this._rotation = val;\r\n            this._rotation.paramChanged.addEventListener(this._onNeedUpdateChanged);\r\n        }\r\n    },\r\n    position: {\r\n        get: function () {\r\n            return this._position;\r\n        },\r\n        set: function (val) {\r\n            if (val.x != this._position.x || val.y != this._position.y || val.z != this._position.z) {\r\n                this._position = val;\r\n                this.modelMatrixNeedsUpdate = true;\r\n            }\r\n            this._position = val;\r\n        }\r\n    },\r\n    scale: {\r\n        get: function () {\r\n            return this._scale;\r\n        },\r\n        set: function (val) {\r\n            if (val.x != this._scale.x || val.y != this._scale.y || val.z != this._scale.z) {\r\n                this._scale = val;\r\n                this.modelMatrixNeedsUpdate = true;\r\n            }\r\n            this._scale = val;\r\n        }\r\n    }\r\n});\r\n\r\n/**\r\n*\r\n*@param {Cesium.Matrix4}meshVisulizerModelMatrix\r\n*@param {Cesium.FrameState}frameState\r\n*/\r\nReferenceMesh.prototype.update = function (parentModelMatrix, frameState) {\r\n\r\n    if (this._modelMatrixNeedsUpdate || this._needsUpdate) {\r\n\r\n        RendererUtils.computeModelMatrix(\r\n            parentModelMatrix,\r\n            this.position,\r\n            this.rotation,\r\n            this.scale,\r\n            this.modelMatrix\r\n        );\r\n\r\n        this._modelMatrixNeedsUpdate = false;\r\n    }\r\n}\r\n\r\nexport default ReferenceMesh;","﻿\r\n\r\nvar yUpToZUp, scratchTranslation, scratchQuaternion, scratchScale, scratchTranslationQuaternionRotationScale, clearCommandScratch;\r\n\r\n/**\r\n*\r\n*@constructor\r\n*@memberof Cesium\r\n*/\r\nfunction RendererUtils() { }\r\n/**\r\n*使用帧缓冲技术，执行渲染命令，渲染到纹理  \r\n*@param {Cesium.DrawCommand|Array<Cesium.DrawCommand>}drawCommand 渲染命令（集合）\r\n*@param {Cesium.FrameState}frameState 帧状态对象，可以从Cesium.Scene中获取\r\n*@param {Cesium.Texture}outpuTexture 将渲染到的目标纹理对象\r\n*@param {Cesium.Texture}[outputDepthTexture] 可选，输出的深度纹理\r\n*/\r\nRendererUtils.renderToTexture = function (drawCommand, frameState, outputTexture, outputDepthTexture) {\r\n    var drawCommands = Array.isArray(drawCommand) ? drawCommand : [drawCommand];\r\n    var context = frameState.context;\r\n\r\n    var framebuffer = null, destroy = false;\r\n    if (outputTexture instanceof Cesium.Framebuffer) {\r\n        framebuffer = outputTexture;\r\n    }\r\n    if (!framebuffer) {\r\n        if (!outputDepthTexture\r\n            || outputDepthTexture.width != outputTexture.width\r\n            || outputDepthTexture.height != outputTexture.height) {\r\n            outputDepthTexture = new Cesium.Texture({\r\n                context: context,\r\n                width: outputTexture.width,\r\n                height: outputTexture.height,\r\n                pixelFormat: Cesium.PixelFormat.DEPTH_COMPONENT,\r\n                pixelDatatype: Cesium.PixelDatatype.UNSIGNED_SHORT\r\n            })\r\n\r\n        }\r\n        framebuffer = new Cesium.Framebuffer({\r\n            context: context,\r\n            colorTextures: [outputTexture],\r\n            destroyAttachments: false,\r\n            depthTexture: outputDepthTexture\r\n        });\r\n        destroy = true;\r\n    }\r\n    if (!clearCommandScratch) {\r\n        clearCommandScratch = new Cesium.ClearCommand({\r\n            color: new Cesium.Color(0.0, 0.0, 0.0, 0.0)\r\n        });\r\n    }\r\n    var clearCommand = clearCommandScratch;\r\n    clearCommand.framebuffer = framebuffer;\r\n    clearCommand.renderState = frameState.renderState;\r\n    clearCommand.execute(context);\r\n\r\n    drawCommands.forEach(function (drawCommand) {\r\n        drawCommand.framebuffer = framebuffer;\r\n        drawCommand.execute(context);\r\n    });\r\n    if (destroy) {\r\n        framebuffer.destroy();\r\n    }\r\n}\r\n\r\n/**\r\n*使用帧缓冲技术，执行渲染命令，渲染到纹理并读取像素值，可以用于实现并行计算  \r\n*@param {Cesium.DrawCommand|Array<Cesium.DrawCommand>}drawCommand 渲染命令（集合）\r\n*@param {Cesium.FrameState}frameState 帧状态对象，可以从Cesium.Scene中获取\r\n*@param {Cesium.Texture}outpuTexture 将渲染到的目标纹理对象\r\n*@param {Object}[options] \r\n*@param {Array.<Number>}outputPixels \r\n*@return {Array.<Number>}outputPixels  输出的像素\r\n*/\r\nRendererUtils.renderToPixels = function (drawCommand, frameState, outputTexture, options, pixels) {\r\n    var drawCommands = Array.isArray(drawCommand) ? drawCommand : [drawCommand];\r\n    var context = frameState.context;\r\n\r\n    var framebuffer = null, destroy = false;\r\n    if (outputTexture instanceof Cesium.Framebuffer) {\r\n        framebuffer = outputTexture;\r\n    }\r\n\r\n    if (!framebuffer) {\r\n\r\n        var outputDepthTexture = new Cesium.Texture({\r\n            context: context,\r\n            width: outputTexture.width,\r\n            height: outputTexture.height,\r\n            pixelFormat: Cesium.PixelFormat.DEPTH_COMPONENT,\r\n            pixelDatatype: Cesium.PixelDatatype.UNSIGNED_SHORT\r\n        })\r\n\r\n        framebuffer = new Cesium.Framebuffer({\r\n            context: context,\r\n            colorTextures: [outputTexture],\r\n            depthTexture: context.depthTexture ? outputDepthTexture : undefined,\r\n            destroyAttachments: false\r\n        });\r\n        destroy = true;\r\n    }\r\n    if (!clearCommandScratch) {\r\n        clearCommandScratch = new Cesium.ClearCommand({\r\n            color: new Cesium.Color(0.0, 0.0, 0.0, 0.0)\r\n        });\r\n    }\r\n    var clearCommand = clearCommandScratch;\r\n    clearCommand.framebuffer = framebuffer;\r\n    clearCommand.renderState = frameState.renderState;\r\n    clearCommand.execute(context);\r\n\r\n    drawCommands.forEach(function (drawCommand) {\r\n        drawCommand.framebuffer = framebuffer;\r\n        drawCommand.execute(context);\r\n    });\r\n    options = options ? options : {};\r\n\r\n    pixels = RendererUtils.readPixels(frameState, Object.assign(options, {\r\n        framebuffer: framebuffer\r\n    }), pixels);\r\n    delete options.framebuffer;\r\n    if (destroy) {\r\n        framebuffer.destroy();\r\n    }\r\n    return pixels;\r\n}\r\n\r\nvar scratchBackBufferArray;\r\n\r\n/**\r\n * Validates a framebuffer.\r\n * Available in debug builds only.\r\n * @private\r\n */\r\nfunction validateFramebuffer(context) {\r\n    //>>includeStart('debug', pragmas.debug);\r\n    if (context.validateFramebuffer) {\r\n        var gl = context._gl;\r\n        var status = gl.checkFramebufferStatus(gl.FRAMEBUFFER);\r\n\r\n        if (status !== gl.FRAMEBUFFER_COMPLETE) {\r\n            var message;\r\n\r\n            switch (status) {\r\n                case gl.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:\r\n                    message = 'Framebuffer is not complete.  Incomplete attachment: at least one attachment point with a renderbuffer or texture attached has its attached object no longer in existence or has an attached image with a width or height of zero, or the color attachment point has a non-color-renderable image attached, or the depth attachment point has a non-depth-renderable image attached, or the stencil attachment point has a non-stencil-renderable image attached.  Color-renderable formats include GL_RGBA4, GL_RGB5_A1, and GL_RGB565. GL_DEPTH_COMPONENT16 is the only depth-renderable format. GL_STENCIL_INDEX8 is the only stencil-renderable format.';\r\n                    break;\r\n                case gl.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:\r\n                    message = 'Framebuffer is not complete.  Incomplete dimensions: not all attached images have the same width and height.';\r\n                    break;\r\n                case gl.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:\r\n                    message = 'Framebuffer is not complete.  Missing attachment: no images are attached to the framebuffer.';\r\n                    break;\r\n                case gl.FRAMEBUFFER_UNSUPPORTED:\r\n                    message = 'Framebuffer is not complete.  Unsupported: the combination of internal formats of the attached images violates an implementation-dependent set of restrictions.';\r\n                    break;\r\n            }\r\n\r\n            throw new DeveloperError(message);\r\n        }\r\n    }\r\n    //>>includeEnd('debug');\r\n}\r\nfunction bindFramebuffer(context, framebuffer) {\r\n    if (framebuffer !== context._currentFramebuffer) {\r\n        // this check must use typeof, not defined, because defined doesn't work with undeclared variables.\r\n        if (typeof WebGLRenderingContext !== 'undefined') {\r\n            scratchBackBufferArray = [Cesium.WebGLConstants.BACK];\r\n        }\r\n        context._currentFramebuffer = framebuffer;\r\n        var buffers = scratchBackBufferArray;\r\n\r\n        if (Cesium.defined(framebuffer)) {\r\n            framebuffer._bind();\r\n            validateFramebuffer(context);\r\n\r\n            // TODO: Need a way for a command to give what draw buffers are active.\r\n            buffers = framebuffer._getActiveColorAttachments();\r\n        } else {\r\n            var gl = context._gl;\r\n            gl.bindFramebuffer(gl.FRAMEBUFFER, null);\r\n        }\r\n\r\n        if (context.drawBuffers) {\r\n            context.glDrawBuffers(buffers);\r\n        }\r\n    }\r\n}\r\n//var pixels;\r\nvar scratchPixelFormat;\r\nvar scratchPixelDatatype;\r\n/**\r\n * @param {Cesium.FrameState}frameState\r\n * @param {Object}[readState]\r\n * @param {number}readState.x\r\n * @param {number}readState.y\r\n * @param {number}readState.width\r\n * @param {number}readState.height\r\n * @param {Cesium.PixelDatatype}readState.pixelDatatype\r\n * @param {Cesium.PixelFormat}readState.pixelFormat\r\n * @param {ArrayBufferView}pixels\r\n * @return {ArrayBufferView}\r\n */\r\nRendererUtils.readPixels = function (frameState, readState, pixels) {\r\n    var gl = frameState.context._gl;\r\n\r\n    readState = readState || {};\r\n    var x = Math.max(readState.x || 0, 0);\r\n    var y = Math.max(readState.y || 0, 0);\r\n    var width = readState.width || gl.drawingBufferWidth;\r\n    var height = readState.height || gl.drawingBufferHeight;\r\n    var pixelDatatype = readState.pixelDatatype || Cesium.PixelDatatype.UNSIGNED_BYTE;\r\n    var pixelFormat = readState.pixelFormat || Cesium.PixelFormat.RGBA;\r\n    var framebuffer = readState.framebuffer;\r\n\r\n    if (width <= 0) {\r\n        throw new Cesium.DeveloperError('readState.width must be greater than zero.');\r\n    }\r\n\r\n    if (height <= 0) {\r\n        throw new Cesium.DeveloperError('readState.height must be greater than zero.');\r\n    }\r\n\r\n    bindFramebuffer(this, framebuffer);\r\n    var size = 4;\r\n    if (pixelFormat == Cesium.PixelFormat.RGB) {\r\n        size = 3;\r\n    } else if (pixelFormat == Cesium.PixelFormat.ALPHA) {\r\n        size = 1;\r\n    }\r\n\r\n    if (!pixels) {//|| pixels.length !== size * width * height\r\n        //|| scratchPixelFormat != pixelFormat || scratchPixelDatatype != pixelDatatype) {\r\n\r\n        if (pixelDatatype == Cesium.PixelDatatype.FLOAT) {\r\n            pixelDatatype = gl.FLOAT;\r\n            pixels = new Float32Array(size * width * height);\r\n        } else if (pixelDatatype == Cesium.PixelDatatype.UNSIGNED_BYTE) {\r\n            pixels = new Uint8Array(size * width * height);\r\n        } else {\r\n            pixels = new Uint16Array(size * width * height);\r\n        }\r\n    }\r\n    gl.readPixels(x, y, width, height, pixelFormat, pixelDatatype, pixels);\r\n    scratchPixelFormat = pixelFormat;\r\n    scratchPixelDatatype = pixelDatatype;\r\n    return pixels;\r\n};\r\n\r\n/**\r\n*\r\n*@param {Cesium.Matrix4}srcMatrix\r\n*@param {Cesium.Matrix4}dstMatrix\r\n*@return {Cesium.Matrix4}\r\n*/\r\nRendererUtils.yUp2Zup = function (srcMatrix, dstMatrix) {\r\n    if (!yUpToZUp) {\r\n        yUpToZUp = Cesium.Matrix4.fromRotationTranslation(Cesium.Matrix3.fromRotationX(Cesium.Math.PI_OVER_TWO));\r\n    }\r\n    return Cesium.Matrix4.multiplyTransformation(srcMatrix, yUpToZUp, dstMatrix);\r\n}\r\n/**\r\n*平移、旋转或缩放，返回计算之后的模型转换矩阵\r\n*@param {Cesium.Cartesian3}[translation=undefined]\r\n*@param {Object}[rotation=undefined] 旋转参数\r\n*@param {Cesium.Cartesian3}[rotation.axis] 旋转轴\r\n*@param {Number}[rotation.angle] 旋转角度\r\n*@param {Cesium.Cartesian3}[rotation.scale] 缩放\r\n*@param {Cesium.Matrix4}[outModelMatrix] 计算结果矩阵，和返回值一样，但是传递此参数时则返回值不是新创建的Cesium.Matrix4实例\r\n*@return {Cesium.Matrix4}\r\n*/\r\nRendererUtils.computeModelMatrix = function (srcModelMatrix, translation, rotation, scale, outModelMatrix) {\r\n    if (arguments.length == 0) {\r\n        return srcModelMatrix;\r\n    }\r\n    if (!scratchTranslation) scratchTranslation = new Cesium.Cartesian3();\r\n    if (!scratchQuaternion) scratchQuaternion = new Cesium.Quaternion();\r\n    if (!scratchScale) scratchScale = new Cesium.Cartesian3();\r\n    if (!scratchTranslationQuaternionRotationScale) scratchTranslationQuaternionRotationScale = new Cesium.Matrix4()\r\n\r\n    var Matrix4 = Cesium.Matrix4;\r\n    if (!outModelMatrix) {\r\n        outModelMatrix = new Matrix4();\r\n    }\r\n    Matrix4.clone(srcModelMatrix, outModelMatrix);\r\n\r\n    if (!translation) {\r\n        scratchTranslation.x = 0;\r\n        scratchTranslation.y = 0;\r\n        scratchTranslation.z = 0;\r\n    }\r\n    scratchTranslation.x = translation.x;\r\n    scratchTranslation.y = translation.y;\r\n    scratchTranslation.z = translation.z;\r\n\r\n    if (!scale) {\r\n        scratchScale.x = 0;\r\n        scratchScale.y = 0;\r\n        scratchScale.z = 0;\r\n    }\r\n    scratchScale.x = scale.x;\r\n    scratchScale.y = scale.y;\r\n    scratchScale.z = scale.z;\r\n\r\n    if (rotation instanceof Cesium.Quaternion) {\r\n        Cesium.Quaternion.clone(rotation, scratchQuaternion);\r\n    } else {\r\n        var axis = rotation.axis;\r\n        var angle = rotation.angle;\r\n        Cesium.Quaternion.fromAxisAngle(\r\n            new Cesium.Cartesian3(axis.x, axis.y, axis.z),//axis.y=1 y是旋转轴\r\n            Cesium.Math.toRadians(angle),\r\n            scratchQuaternion\r\n        );\r\n    }\r\n\r\n    //translate,rotate,scale\r\n\r\n    Matrix4.fromTranslationQuaternionRotationScale(\r\n        scratchTranslation, scratchQuaternion,\r\n        scratchScale, scratchTranslationQuaternionRotationScale);\r\n\r\n    Matrix4.multiplyTransformation(\r\n        outModelMatrix,\r\n        scratchTranslationQuaternionRotationScale,\r\n        outModelMatrix);\r\n    return outModelMatrix;\r\n}\r\n\r\nexport default RendererUtils; ","﻿ \r\n/**\r\n*\r\n*@param {Cesium.Cartesian3}axis 旋转轴\r\n*@param {Number}angle 旋转角度\r\n*\r\n*@property {Cesium.Cartesian3}axis 旋转轴\r\n*@property {Number}angle 旋转角度\r\n*@property {Cesium.Event}paramChanged  \r\n*@constructor\r\n*@memberof Cesium\r\n*/\r\nfunction Rotation(axis, angle) {\r\n    this._axis = axis;\r\n    this._angle = angle;\r\n    this.paramChanged = new Cesium.Event();\r\n}\r\nObject.defineProperties(Rotation.prototype, {\r\n    axis: {\r\n        set: function (val) {\r\n            if (val.x != this._axis.x\r\n                || val.y != this._axis.y\r\n                || val.z != this._axis.z) {\r\n                this._axis = val;\r\n                this.paramChanged.raiseEvent();\r\n            }\r\n            this._axis = val;\r\n        },\r\n        get: function () {\r\n            return this._axis;\r\n        }\r\n    },\r\n    angle: {\r\n        set: function (val) {\r\n            if (val != this._angle) {\r\n                this._angle = val;\r\n                this.paramChanged.raiseEvent();\r\n            }\r\n            this._angle = val;\r\n        },\r\n        get: function () {\r\n            return this._angle;\r\n        }\r\n    }\r\n})\r\n\r\nexport default Rotation;","﻿\r\n/**\r\n*\r\n*@memberof Cesium\r\n*@constructor\r\n*/\r\nfunction ShaderUtils() {\r\n\r\n}\r\n\r\n/**\r\n*\r\n*\r\n*/\r\nShaderUtils.processShader3js = function (material3js, shader) {\r\n    var program = new WebGLProgram(material3js, shader);\r\n    return program;\r\n\r\n}\r\n\r\nif (typeof THREE != 'undefined') {\r\n \r\n    var shaderIDs = {\r\n        MeshDepthMaterial: 'depth',\r\n        MeshNormalMaterial: 'normal',\r\n        MeshBasicMaterial: 'basic',\r\n        MeshLambertMaterial: 'lambert',\r\n        MeshPhongMaterial: 'phong',\r\n        MeshToonMaterial: 'phong',\r\n        MeshStandardMaterial: 'physical',\r\n        MeshPhysicalMaterial: 'physical',\r\n        LineBasicMaterial: 'basic',\r\n        LineDashedMaterial: 'dashed',\r\n        PointsMaterial: 'points'\r\n    };\r\n\r\n    var parameterNames = [\r\n        \"precision\", \"supportsVertexTextures\", \"map\", \"mapEncoding\", \"envMap\", \"envMapMode\", \"envMapEncoding\",\r\n        \"lightMap\", \"aoMap\", \"emissiveMap\", \"emissiveMapEncoding\", \"bumpMap\", \"normalMap\", \"displacementMap\", \"specularMap\",\r\n        \"roughnessMap\", \"metalnessMap\", \"gradientMap\",\r\n        \"alphaMap\", \"combine\", \"vertexColors\", \"fog\", \"useFog\", \"fogExp\",\r\n        \"flatShading\", \"sizeAttenuation\", \"logarithmicDepthBuffer\", \"skinning\",\r\n        \"maxBones\", \"useVertexTexture\", \"morphTargets\", \"morphNormals\",\r\n        \"maxMorphTargets\", \"maxMorphNormals\", \"premultipliedAlpha\",\r\n        \"numDirLights\", \"numPointLights\", \"numSpotLights\", \"numHemiLights\", \"numRectAreaLights\",\r\n        \"shadowMapEnabled\", \"shadowMapType\", \"toneMapping\", 'physicallyCorrectLights',\r\n        \"alphaTest\", \"doubleSided\", \"flipSided\", \"numClippingPlanes\", \"numClipIntersection\", \"depthPacking\"\r\n    ];\r\n    var ShaderChunk = THREE.ShaderChunk;\r\n    var ShaderLib = THREE.ShaderLib;\r\n    var BackSide = THREE.BackSide,\r\n        DoubleSide = THREE.DoubleSide,\r\n        FlatShading = THREE.FlatShading,\r\n        CubeUVRefractionMapping = THREE.CubeUVRefractionMapping,\r\n        CubeUVReflectionMapping = THREE.CubeUVReflectionMapping,\r\n        GammaEncoding = THREE.GammaEncoding,\r\n        LinearEncoding = THREE.LinearEncoding,\r\n        NoToneMapping = THREE.NoToneMapping,\r\n        AddOperation = THREE.AddOperation,\r\n        MixOperation = THREE.MixOperation,\r\n        MultiplyOperation = THREE.MultiplyOperation,\r\n        EquirectangularRefractionMapping = THREE.EquirectangularRefractionMapping,\r\n        CubeRefractionMapping = THREE.CubeRefractionMapping,\r\n        SphericalReflectionMapping = THREE.SphericalReflectionMapping,\r\n        EquirectangularReflectionMapping = THREE.EquirectangularReflectionMapping,\r\n        CubeReflectionMapping = THREE.CubeReflectionMapping,\r\n        PCFSoftShadowMap = THREE.PCFSoftShadowMap,\r\n        PCFShadowMap = THREE.PCFShadowMap,\r\n        CineonToneMapping = THREE.CineonToneMapping,\r\n        Uncharted2ToneMapping = THREE.Uncharted2ToneMapping,\r\n        ReinhardToneMapping = THREE.ReinhardToneMapping,\r\n        LinearToneMapping = THREE.LinearToneMapping,\r\n        GammaEncoding = THREE.GammaEncoding,\r\n        RGBDEncoding = THREE.RGBDEncoding,\r\n        RGBM16Encoding = THREE.RGBM16Encoding,\r\n        RGBM7Encoding = THREE.RGBM7Encoding,\r\n        RGBEEncoding = THREE.RGBEEncoding,\r\n        sRGBEncoding = THREE.sRGBEncoding;\r\n\r\n    function getTextureEncodingFromMap(map, gammaOverrideLinear) {\r\n\r\n        var encoding;\r\n\r\n        if (!map) {\r\n\r\n            encoding = LinearEncoding;\r\n\r\n        } else if (map.isTexture) {\r\n\r\n            encoding = map.encoding;\r\n\r\n        } else if (map.isWebGLRenderTarget) {\r\n\r\n            console.warn(\"THREE.WebGLPrograms.getTextureEncodingFromMap: don't use render targets as textures. Use their .texture property instead.\");\r\n            encoding = map.texture.encoding;\r\n\r\n        }\r\n\r\n        // add backwards compatibility for WebGLRenderer.gammaInput/gammaOutput parameter, should probably be removed at some point.\r\n        if (encoding === LinearEncoding && gammaOverrideLinear) {\r\n\r\n            encoding = GammaEncoding;\r\n\r\n        }\r\n\r\n        return encoding;\r\n\r\n    }\r\n\r\n    function getParameters(material) {//, lights, fog, nClipPlanes, nClipIntersection, object) {\r\n\r\n        var shaderID = shaderIDs[material.type];\r\n\r\n        // heuristics to create shader parameters according to lights in the scene\r\n        // (not to blow over maxLights budget)\r\n\r\n        //var maxBones = allocateBones(object);\r\n        //var precision = renderer.getPrecision();\r\n\r\n        //if (material.precision !== null) {\r\n\r\n        //    precision = capabilities.getMaxPrecision(material.precision);\r\n\r\n        //    if (precision !== material.precision) {\r\n\r\n        //        console.warn('THREE.WebGLProgram.getParameters:', material.precision, 'not supported, using', precision, 'instead.');\r\n\r\n        //    }\r\n\r\n        //}\r\n\r\n        var currentRenderTarget = null;// renderer.getCurrentRenderTarget();\r\n        var renderer = {};\r\n        var parameters = {\r\n\r\n            shaderID: shaderID,\r\n\r\n            precision: \"high\",//precision,\r\n            supportsVertexTextures: true,// capabilities.vertexTextures,\r\n            outputEncoding: getTextureEncodingFromMap((!currentRenderTarget) ? null : currentRenderTarget.texture, renderer.gammaOutput),\r\n            map: !!material.map,\r\n            mapEncoding: getTextureEncodingFromMap(material.map, renderer.gammaInput),\r\n            envMap: !!material.envMap,\r\n            envMapMode: material.envMap && material.envMap.mapping,\r\n            envMapEncoding: getTextureEncodingFromMap(material.envMap, renderer.gammaInput),\r\n            envMapCubeUV: (!!material.envMap) && ((material.envMap.mapping === CubeUVReflectionMapping) || (material.envMap.mapping === CubeUVRefractionMapping)),\r\n            lightMap: !!material.lightMap,\r\n            aoMap: !!material.aoMap,\r\n            emissiveMap: !!material.emissiveMap,\r\n            emissiveMapEncoding: getTextureEncodingFromMap(material.emissiveMap, renderer.gammaInput),\r\n            bumpMap: !!material.bumpMap,\r\n            normalMap: !!material.normalMap,\r\n            displacementMap: !!material.displacementMap,\r\n            roughnessMap: !!material.roughnessMap,\r\n            metalnessMap: !!material.metalnessMap,\r\n            specularMap: !!material.specularMap,\r\n            alphaMap: !!material.alphaMap,\r\n\r\n            gradientMap: !!material.gradientMap,\r\n\r\n            combine: material.combine,\r\n\r\n            vertexColors: material.vertexColors,\r\n\r\n            fog: false,//!!fog,\r\n            useFog: material.fog,\r\n            fogExp: false,//(fog && fog.isFogExp2),\r\n\r\n            flatShading: material.shading === FlatShading,\r\n\r\n            sizeAttenuation: material.sizeAttenuation,\r\n            logarithmicDepthBuffer: false,// capabilities.logarithmicDepthBuffer,\r\n\r\n            skinning: material.skinning,\r\n            //maxBones: maxBones,\r\n            //useVertexTexture: capabilities.floatVertexTextures && object && object.skeleton && object.skeleton.useVertexTexture,\r\n\r\n            morphTargets: material.morphTargets,\r\n            morphNormals: material.morphNormals,\r\n            //maxMorphTargets: renderer.maxMorphTargets,\r\n            //maxMorphNormals: renderer.maxMorphNormals,\r\n\r\n            numDirLights: 0,// lights.directional.length,\r\n            numPointLights: 0,// lights.point.length,\r\n            numSpotLights: 0,// lights.spot.length,\r\n            numRectAreaLights: 0,// lights.rectArea.length,\r\n            numHemiLights: 0,// lights.hemi.length,\r\n\r\n            numClippingPlanes: 0,//nClipPlanes,\r\n            numClipIntersection: 0,//nClipIntersection,\r\n\r\n            //shadowMapEnabled:  renderer.shadowMap.enabled && object.receiveShadow && lights.shadows.length > 0,\r\n            //shadowMapType: renderer.shadowMap.type,\r\n\r\n            //toneMapping: renderer.toneMapping,\r\n            //physicallyCorrectLights: renderer.physicallyCorrectLights,\r\n\r\n            premultipliedAlpha: material.premultipliedAlpha,\r\n\r\n            alphaTest: material.alphaTest,\r\n            doubleSided: material.side === DoubleSide,\r\n            flipSided: material.side === BackSide,\r\n\r\n            depthPacking: (material.depthPacking !== undefined) ? material.depthPacking : false\r\n\r\n        };\r\n\r\n        return parameters;\r\n\r\n    };\r\n\r\n    /**\r\n     * @author mrdoob / http://mrdoob.com/\r\n     */\r\n\r\n    var programIdCount = 0;\r\n\r\n    function getEncodingComponents(encoding) {\r\n\r\n        switch (encoding) {\r\n\r\n            case LinearEncoding:\r\n                return ['Linear', '( value )'];\r\n            case sRGBEncoding:\r\n                return ['sRGB', '( value )'];\r\n            case RGBEEncoding:\r\n                return ['RGBE', '( value )'];\r\n            case RGBM7Encoding:\r\n                return ['RGBM', '( value, 7.0 )'];\r\n            case RGBM16Encoding:\r\n                return ['RGBM', '( value, 16.0 )'];\r\n            case RGBDEncoding:\r\n                return ['RGBD', '( value, 256.0 )'];\r\n            case GammaEncoding:\r\n                return ['Gamma', '( value, float( GAMMA_FACTOR ) )'];\r\n            default:\r\n                throw new Error('unsupported encoding: ' + encoding);\r\n\r\n        }\r\n\r\n    }\r\n\r\n    function getTexelDecodingFunction(functionName, encoding) {\r\n\r\n        var components = getEncodingComponents(encoding);\r\n        return \"vec4 \" + functionName + \"( vec4 value ) {  return \" + components[0] + \"ToLinear\" + components[1] + \" ; }\";\r\n\r\n    }\r\n\r\n    function getTexelEncodingFunction(functionName, encoding) {\r\n\r\n        var components = getEncodingComponents(encoding);\r\n        return \"vec4 \" + functionName + \"( vec4 value ) { return LinearTo\" + components[0] + components[1] + \" ; }\";\r\n\r\n    }\r\n\r\n    function getToneMappingFunction(functionName, toneMapping) {\r\n\r\n        var toneMappingName;\r\n\r\n        switch (toneMapping) {\r\n\r\n            case LinearToneMapping:\r\n                toneMappingName = \"Linear\";\r\n                break;\r\n\r\n            case ReinhardToneMapping:\r\n                toneMappingName = \"Reinhard\";\r\n                break;\r\n\r\n            case Uncharted2ToneMapping:\r\n                toneMappingName = \"Uncharted2\";\r\n                break;\r\n\r\n            case CineonToneMapping:\r\n                toneMappingName = \"OptimizedCineon\";\r\n                break;\r\n\r\n            default:\r\n                throw new Error('unsupported toneMapping: ' + toneMapping);\r\n\r\n        }\r\n\r\n        return \"vec3 \" + functionName + \"( vec3 color ) {  return \" + toneMappingName + \"ToneMapping( color );  }\";\r\n\r\n    }\r\n\r\n    function generateExtensions(extensions, parameters, rendererExtensions) {\r\n\r\n        extensions = extensions || {};\r\n\r\n        var chunks = [\r\n            (extensions.derivatives || parameters.envMapCubeUV || parameters.bumpMap || parameters.normalMap || parameters.flatShading) ? '#extension GL_OES_standard_derivatives : enable' : '',\r\n            (extensions.fragDepth || parameters.logarithmicDepthBuffer) && rendererExtensions.get('EXT_frag_depth') ? '#extension GL_EXT_frag_depth : enable' : '',\r\n            (extensions.drawBuffers) && rendererExtensions.get('WEBGL_draw_buffers') ? '#extension GL_EXT_draw_buffers : require' : '',\r\n            (extensions.shaderTextureLOD || parameters.envMap) && rendererExtensions.get('EXT_shader_texture_lod') ? '#extension GL_EXT_shader_texture_lod : enable' : ''\r\n        ];\r\n\r\n        return chunks.filter(filterEmptyLine).join('\\n');\r\n\r\n    }\r\n\r\n    function generateDefines(defines) {\r\n\r\n        var chunks = [];\r\n\r\n        for (var name in defines) {\r\n\r\n            var value = defines[name];\r\n\r\n            if (value === false) continue;\r\n\r\n            chunks.push('#define ' + name + ' ' + value);\r\n\r\n        }\r\n\r\n        return chunks.join('\\n');\r\n\r\n    }\r\n\r\n    function filterEmptyLine(string) {\r\n\r\n        return string !== '';\r\n\r\n    }\r\n\r\n    function replaceLightNums(string, parameters) {\r\n\r\n        return string\r\n            .replace(/NUM_DIR_LIGHTS/g, parameters.numDirLights)\r\n            .replace(/NUM_SPOT_LIGHTS/g, parameters.numSpotLights)\r\n            .replace(/NUM_RECT_AREA_LIGHTS/g, parameters.numRectAreaLights)\r\n            .replace(/NUM_POINT_LIGHTS/g, parameters.numPointLights)\r\n            .replace(/NUM_HEMI_LIGHTS/g, parameters.numHemiLights);\r\n\r\n    }\r\n\r\n    function parseIncludes(string) {\r\n\r\n        var pattern = /^[ \\t]*#include +<([\\w\\d.]+)>/gm;\r\n\r\n        function replace(match, include) {\r\n\r\n            var replace = ShaderChunk[include];\r\n\r\n            if (replace === undefined) {\r\n\r\n                throw new Error('Can not resolve #include <' + include + '>');\r\n\r\n            }\r\n\r\n            return parseIncludes(replace);\r\n\r\n        }\r\n\r\n        return string.replace(pattern, replace);\r\n\r\n    }\r\n\r\n    function unrollLoops(string) {\r\n\r\n        var pattern = /for \\( int i \\= (\\d+)\\; i < (\\d+)\\; i \\+\\+ \\) \\{([\\s\\S]+?)(?=\\})\\}/g;\r\n\r\n        function replace(match, start, end, snippet) {\r\n\r\n            var unroll = '';\r\n\r\n            for (var i = parseInt(start); i < parseInt(end); i++) {\r\n\r\n                unroll += snippet.replace(/\\[ i \\]/g, '[ ' + i + ' ]');\r\n\r\n            }\r\n\r\n            return unroll;\r\n\r\n        }\r\n\r\n        return string.replace(pattern, replace);\r\n\r\n    }\r\n\r\n    function WebGLProgram(material, shader) {//, parameters) {\r\n\r\n        var parameters = getParameters(material);\r\n        //var shader = ShaderLib[parameters.shaderID];\r\n\r\n        //var extensions = material.extensions;\r\n        var defines = material.defines;\r\n\r\n        var vertexShader = shader.vertexShader;\r\n        var fragmentShader = shader.fragmentShader;\r\n\r\n        var shadowMapTypeDefine = 'SHADOWMAP_TYPE_BASIC';\r\n\r\n        if (parameters.shadowMapType === THREE.PCFShadowMap) {\r\n\r\n            shadowMapTypeDefine = 'SHADOWMAP_TYPE_PCF';\r\n\r\n        } else if (parameters.shadowMapType === THREE.PCFSoftShadowMap) {\r\n\r\n            shadowMapTypeDefine = 'SHADOWMAP_TYPE_PCF_SOFT';\r\n\r\n        }\r\n\r\n        var envMapTypeDefine = 'ENVMAP_TYPE_CUBE';\r\n        var envMapModeDefine = 'ENVMAP_MODE_REFLECTION';\r\n        var envMapBlendingDefine = 'ENVMAP_BLENDING_MULTIPLY';\r\n\r\n        if (parameters.envMap) {\r\n\r\n            switch (material.envMap.mapping) {\r\n\r\n                case CubeReflectionMapping:\r\n                case CubeRefractionMapping:\r\n                    envMapTypeDefine = 'ENVMAP_TYPE_CUBE';\r\n                    break;\r\n\r\n                case CubeUVReflectionMapping:\r\n                case CubeUVRefractionMapping:\r\n                    envMapTypeDefine = 'ENVMAP_TYPE_CUBE_UV';\r\n                    break;\r\n\r\n                case EquirectangularReflectionMapping:\r\n                case EquirectangularRefractionMapping:\r\n                    envMapTypeDefine = 'ENVMAP_TYPE_EQUIREC';\r\n                    break;\r\n\r\n                case SphericalReflectionMapping:\r\n                    envMapTypeDefine = 'ENVMAP_TYPE_SPHERE';\r\n                    break;\r\n\r\n            }\r\n\r\n            switch (material.envMap.mapping) {\r\n\r\n                case CubeRefractionMapping:\r\n                case EquirectangularRefractionMapping:\r\n                    envMapModeDefine = 'ENVMAP_MODE_REFRACTION';\r\n                    break;\r\n\r\n            }\r\n\r\n            switch (material.combine) {\r\n\r\n                case MultiplyOperation:\r\n                    envMapBlendingDefine = 'ENVMAP_BLENDING_MULTIPLY';\r\n                    break;\r\n\r\n                case MixOperation:\r\n                    envMapBlendingDefine = 'ENVMAP_BLENDING_MIX';\r\n                    break;\r\n\r\n                case AddOperation:\r\n                    envMapBlendingDefine = 'ENVMAP_BLENDING_ADD';\r\n                    break;\r\n\r\n            }\r\n\r\n        }\r\n\r\n        var gammaFactorDefine = 1.0;// (renderer.gammaFactor > 0) ? renderer.gammaFactor : 1.0;\r\n\r\n\r\n        // var customExtensions = generateExtensions(extensions, parameters, renderer.extensions);\r\n\r\n        var customDefines = generateDefines(defines);\r\n\r\n\r\n        var prefixVertex, prefixFragment;\r\n\r\n        if (material.isRawShaderMaterial) {\r\n\r\n            prefixVertex = [\r\n\r\n                customDefines,\r\n\r\n                '\\n'\r\n\r\n            ].filter(filterEmptyLine).join('\\n');\r\n\r\n            prefixFragment = [\r\n\r\n                //customExtensions,\r\n                customDefines,\r\n\r\n                '\\n'\r\n\r\n            ].filter(filterEmptyLine).join('\\n');\r\n\r\n        } else {\r\n\r\n            prefixVertex = [\r\n\r\n                //'precision ' + parameters.precision + ' float;',\r\n                //'precision ' + parameters.precision + ' int;',\r\n\r\n                '#define SHADER_NAME ' + shader.name,\r\n\r\n                //customDefines,\r\n\r\n                parameters.supportsVertexTextures ? '#define VERTEX_TEXTURES' : '',\r\n\r\n                '#define GAMMA_FACTOR ' + gammaFactorDefine,\r\n\r\n                '#define MAX_BONES ' + parameters.maxBones,\r\n                //(parameters.useFog && parameters.fog) ? '#define USE_FOG' : '',\r\n                //(parameters.useFog && parameters.fogExp) ? '#define FOG_EXP2' : '',\r\n\r\n                parameters.map ? '#define USE_MAP' : '',\r\n                parameters.envMap ? '#define USE_ENVMAP' : '',\r\n                parameters.envMap ? '#define ' + envMapModeDefine : '',\r\n                parameters.lightMap ? '#define USE_LIGHTMAP' : '',\r\n                parameters.aoMap ? '#define USE_AOMAP' : '',\r\n                parameters.emissiveMap ? '#define USE_EMISSIVEMAP' : '',\r\n                parameters.bumpMap ? '#define USE_BUMPMAP' : '',\r\n                parameters.normalMap ? '#define USE_NORMALMAP' : '',\r\n                parameters.displacementMap && parameters.supportsVertexTextures ? '#define USE_DISPLACEMENTMAP' : '',\r\n                parameters.specularMap ? '#define USE_SPECULARMAP' : '',\r\n                parameters.roughnessMap ? '#define USE_ROUGHNESSMAP' : '',\r\n                parameters.metalnessMap ? '#define USE_METALNESSMAP' : '',\r\n                parameters.alphaMap ? '#define USE_ALPHAMAP' : '',\r\n                parameters.vertexColors ? '#define USE_COLOR' : '',\r\n\r\n                parameters.flatShading ? '#define FLAT_SHADED' : '',\r\n\r\n                parameters.skinning ? '#define USE_SKINNING' : '',\r\n                parameters.useVertexTexture ? '#define BONE_TEXTURE' : '',\r\n\r\n                parameters.morphTargets ? '#define USE_MORPHTARGETS' : '',\r\n                parameters.morphNormals && parameters.flatShading === false ? '#define USE_MORPHNORMALS' : '',\r\n                parameters.doubleSided ? '#define DOUBLE_SIDED' : '',\r\n                parameters.flipSided ? '#define FLIP_SIDED' : '',\r\n\r\n                '#define NUM_CLIPPING_PLANES ' + parameters.numClippingPlanes,\r\n\r\n                parameters.shadowMapEnabled ? '#define USE_SHADOWMAP' : '',\r\n                parameters.shadowMapEnabled ? '#define ' + shadowMapTypeDefine : '',\r\n\r\n                parameters.sizeAttenuation ? '#define USE_SIZEATTENUATION' : '',\r\n\r\n                parameters.logarithmicDepthBuffer ? '#define USE_LOGDEPTHBUF' : '',\r\n                //parameters.logarithmicDepthBuffer && renderer.extensions.get('EXT_frag_depth') ? '#define USE_LOGDEPTHBUF_EXT' : '',\r\n\r\n                //'uniform mat4 modelMatrix;',\r\n                //'uniform mat4 modelViewMatrix;',\r\n                //'uniform mat4 projectionMatrix;',\r\n                //'uniform mat4 viewMatrix;',\r\n                //'uniform mat3 normalMatrix;',\r\n                //'uniform vec3 cameraPosition;',\r\n\r\n                //'attribute vec3 position;',\r\n                //'attribute vec3 normal;',\r\n                //'attribute vec2 uv;',\r\n\r\n                '#ifdef USE_COLOR',\r\n\r\n                '\tattribute vec3 color;',\r\n\r\n                '#endif',\r\n\r\n                '#ifdef USE_MORPHTARGETS',\r\n\r\n                '\tattribute vec3 morphTarget0;',\r\n                '\tattribute vec3 morphTarget1;',\r\n                '\tattribute vec3 morphTarget2;',\r\n                '\tattribute vec3 morphTarget3;',\r\n\r\n                '\t#ifdef USE_MORPHNORMALS',\r\n\r\n                '\t\tattribute vec3 morphNormal0;',\r\n                '\t\tattribute vec3 morphNormal1;',\r\n                '\t\tattribute vec3 morphNormal2;',\r\n                '\t\tattribute vec3 morphNormal3;',\r\n\r\n                '\t#else',\r\n\r\n                '\t\tattribute vec3 morphTarget4;',\r\n                '\t\tattribute vec3 morphTarget5;',\r\n                '\t\tattribute vec3 morphTarget6;',\r\n                '\t\tattribute vec3 morphTarget7;',\r\n\r\n                '\t#endif',\r\n\r\n                '#endif',\r\n\r\n                '#ifdef USE_SKINNING',\r\n\r\n                '\tattribute vec4 skinIndex;',\r\n                '\tattribute vec4 skinWeight;',\r\n\r\n                '#endif',\r\n\r\n                '\\n'\r\n\r\n            ].filter(filterEmptyLine).join('\\n');\r\n\r\n            prefixFragment = [\r\n\r\n                //customExtensions,\r\n\r\n                //'precision ' + parameters.precision + ' float;',\r\n                //'precision ' + parameters.precision + ' int;',\r\n\r\n                '#define SHADER_NAME ' + shader.name,\r\n\r\n                customDefines,\r\n\r\n                parameters.alphaTest ? '#define ALPHATEST ' + parameters.alphaTest : '',\r\n\r\n                '#define GAMMA_FACTOR ' + gammaFactorDefine,\r\n\r\n                (parameters.useFog && parameters.fog) ? '#define USE_FOG' : '',\r\n                (parameters.useFog && parameters.fogExp) ? '#define FOG_EXP2' : '',\r\n\r\n                parameters.map ? '#define USE_MAP' : '',\r\n                parameters.envMap ? '#define USE_ENVMAP' : '',\r\n                parameters.envMap ? '#define ' + envMapTypeDefine : '',\r\n                parameters.envMap ? '#define ' + envMapModeDefine : '',\r\n                parameters.envMap ? '#define ' + envMapBlendingDefine : '',\r\n                parameters.lightMap ? '#define USE_LIGHTMAP' : '',\r\n                parameters.aoMap ? '#define USE_AOMAP' : '',\r\n                parameters.emissiveMap ? '#define USE_EMISSIVEMAP' : '',\r\n                parameters.bumpMap ? '#define USE_BUMPMAP' : '',\r\n                parameters.normalMap ? '#define USE_NORMALMAP' : '',\r\n                parameters.specularMap ? '#define USE_SPECULARMAP' : '',\r\n                parameters.roughnessMap ? '#define USE_ROUGHNESSMAP' : '',\r\n                parameters.metalnessMap ? '#define USE_METALNESSMAP' : '',\r\n                parameters.alphaMap ? '#define USE_ALPHAMAP' : '',\r\n                parameters.vertexColors ? '#define USE_COLOR' : '',\r\n\r\n                parameters.gradientMap ? '#define USE_GRADIENTMAP' : '',\r\n\r\n                parameters.flatShading ? '#define FLAT_SHADED' : '',\r\n\r\n                parameters.doubleSided ? '#define DOUBLE_SIDED' : '',\r\n                parameters.flipSided ? '#define FLIP_SIDED' : '',\r\n\r\n                '#define NUM_CLIPPING_PLANES ' + parameters.numClippingPlanes,\r\n                '#define UNION_CLIPPING_PLANES ' + (parameters.numClippingPlanes - parameters.numClipIntersection),\r\n\r\n                parameters.shadowMapEnabled ? '#define USE_SHADOWMAP' : '',\r\n                parameters.shadowMapEnabled ? '#define ' + shadowMapTypeDefine : '',\r\n\r\n                parameters.premultipliedAlpha ? \"#define PREMULTIPLIED_ALPHA\" : '',\r\n\r\n                parameters.physicallyCorrectLights ? \"#define PHYSICALLY_CORRECT_LIGHTS\" : '',\r\n\r\n                parameters.logarithmicDepthBuffer ? '#define USE_LOGDEPTHBUF' : '',\r\n                //parameters.logarithmicDepthBuffer && renderer.extensions.get('EXT_frag_depth') ? '#define USE_LOGDEPTHBUF_EXT' : '',\r\n\r\n                //parameters.envMap && renderer.extensions.get('EXT_shader_texture_lod') ? '#define TEXTURE_LOD_EXT' : '',\r\n\r\n                'uniform mat4 viewMatrix;',\r\n                'uniform vec3 cameraPosition;',\r\n\r\n                //(parameters.toneMapping !== THREE.NoToneMapping) ? \"#define TONE_MAPPING\" : '',\r\n                //(parameters.toneMapping !== THREE.NoToneMapping) ? ShaderChunk['tonemapping_pars_fragment'] : '',  // this code is required here because it is used by the toneMapping() function defined below\r\n                //(parameters.toneMapping !== THREE.NoToneMapping) ? getToneMappingFunction(\"toneMapping\", parameters.toneMapping) : '',\r\n\r\n                parameters.dithering ? '#define DITHERING' : '',\r\n\r\n                (parameters.outputEncoding || parameters.mapEncoding || parameters.envMapEncoding || parameters.emissiveMapEncoding) ? ShaderChunk['encodings_pars_fragment'] : '', // this code is required here because it is used by the various encoding/decoding function defined below\r\n                parameters.mapEncoding ? getTexelDecodingFunction('mapTexelToLinear', parameters.mapEncoding) : '',\r\n                parameters.envMapEncoding ? getTexelDecodingFunction('envMapTexelToLinear', parameters.envMapEncoding) : '',\r\n                parameters.emissiveMapEncoding ? getTexelDecodingFunction('emissiveMapTexelToLinear', parameters.emissiveMapEncoding) : '',\r\n                parameters.outputEncoding ? getTexelEncodingFunction(\"linearToOutputTexel\", parameters.outputEncoding) : '',\r\n\r\n                parameters.depthPacking ? \"#define DEPTH_PACKING \" + material.depthPacking : '',\r\n\r\n                '\\n'\r\n\r\n            ].filter(filterEmptyLine).join('\\n');\r\n\r\n        }\r\n\r\n        vertexShader = parseIncludes(vertexShader);\r\n        vertexShader = replaceLightNums(vertexShader, parameters);\r\n\r\n        fragmentShader = parseIncludes(fragmentShader);\r\n        fragmentShader = replaceLightNums(fragmentShader, parameters);\r\n\r\n        if (!material.isShaderMaterial) {\r\n\r\n            vertexShader = unrollLoops(vertexShader);\r\n            fragmentShader = unrollLoops(fragmentShader);\r\n\r\n        }\r\n\r\n        var vertexGlsl = prefixVertex + vertexShader;\r\n        var fragmentGlsl = prefixFragment + fragmentShader;\r\n\r\n\r\n        this.id = programIdCount++;\r\n        this.usedTimes = 1;\r\n        this.vertexShader = vertexGlsl;\r\n        this.fragmentShader = fragmentGlsl;\r\n\r\n        return this;\r\n\r\n    }\r\n\r\n}\r\nexport default ShaderUtils;","﻿\r\nimport none_frag from './none_frag.js';\r\nimport none_vert from './none_vert.js';\r\nimport normals_frag from './normals_frag.js';\r\nimport normals_vert from './normals_vert.js';\r\nimport texture_frag from './texture_frag.js';\r\nimport texture_vert from './texture_vert.js';\r\nimport texture_normals_frag from './texture_normals_frag.js';\r\nimport texture_normals_vert from './texture_normals_vert.js';\r\n\r\nvar alphamap_fragment = \"#ifdef USE_ALPHAMAP\\n\\tdiffuseColor.a *= texture2D( alphaMap, vUv ).g;\\n#endif\\n\";\r\n\r\nvar alphamap_pars_fragment = \"#ifdef USE_ALPHAMAP\\n\\tuniform sampler2D alphaMap;\\n#endif\\n\";\r\n\r\nvar alphatest_fragment = \"#ifdef ALPHATEST\\n\\tif ( diffuseColor.a < ALPHATEST ) discard;\\n#endif\\n\";\r\n\r\nvar aomap_fragment = \"#ifdef USE_AOMAP\\n\\tfloat ambientOcclusion = ( texture2D( aoMap, vUv2 ).r - 1.0 ) * aoMapIntensity + 1.0;\\n\\treflectedLight.indirectDiffuse *= ambientOcclusion;\\n\\t#if defined( USE_ENVMAP ) && defined( PHYSICAL )\\n\\t\\tfloat dotNV = saturate( dot( geometry.normal, geometry.viewDir ) );\\n\\t\\treflectedLight.indirectSpecular *= computeSpecularOcclusion( dotNV, ambientOcclusion, material.specularRoughness );\\n\\t#endif\\n#endif\\n\";\r\n\r\nvar aomap_pars_fragment = \"#ifdef USE_AOMAP\\n\\tuniform sampler2D aoMap;\\n\\tuniform float aoMapIntensity;\\n#endif\";\r\n\r\nvar begin_vertex = \"\\nvec3 transformed = vec3( position );\\n\";\r\n\r\nvar beginnormal_vertex = \"\\nvec3 objectNormal = vec3( normal );\\n\";\r\n\r\nvar bsdfs = \"float punctualLightIntensityToIrradianceFactor( const in float lightDistance, const in float cutoffDistance, const in float decayExponent ) {\\n\\tif( decayExponent > 0.0 ) {\\n#if defined ( PHYSICALLY_CORRECT_LIGHTS )\\n\\t\\tfloat distanceFalloff = 1.0 / max( pow( lightDistance, decayExponent ), 0.01 );\\n\\t\\tfloat maxDistanceCutoffFactor = pow2( saturate( 1.0 - pow4( lightDistance / cutoffDistance ) ) );\\n\\t\\treturn distanceFalloff * maxDistanceCutoffFactor;\\n#else\\n\\t\\treturn pow( saturate( -lightDistance / cutoffDistance + 1.0 ), decayExponent );\\n#endif\\n\\t}\\n\\treturn 1.0;\\n}\\nvec3 BRDF_Diffuse_Lambert( const in vec3 diffuseColor ) {\\n\\treturn RECIPROCAL_PI * diffuseColor;\\n}\\nvec3 F_Schlick( const in vec3 specularColor, const in float dotLH ) {\\n\\tfloat fresnel = exp2( ( -5.55473 * dotLH - 6.98316 ) * dotLH );\\n\\treturn ( 1.0 - specularColor ) * fresnel + specularColor;\\n}\\nfloat G_GGX_Smith( const in float alpha, const in float dotNL, const in float dotNV ) {\\n\\tfloat a2 = pow2( alpha );\\n\\tfloat gl = dotNL + sqrt( a2 + ( 1.0 - a2 ) * pow2( dotNL ) );\\n\\tfloat gv = dotNV + sqrt( a2 + ( 1.0 - a2 ) * pow2( dotNV ) );\\n\\treturn 1.0 / ( gl * gv );\\n}\\nfloat G_GGX_SmithCorrelated( const in float alpha, const in float dotNL, const in float dotNV ) {\\n\\tfloat a2 = pow2( alpha );\\n\\tfloat gv = dotNL * sqrt( a2 + ( 1.0 - a2 ) * pow2( dotNV ) );\\n\\tfloat gl = dotNV * sqrt( a2 + ( 1.0 - a2 ) * pow2( dotNL ) );\\n\\treturn 0.5 / max( gv + gl, EPSILON );\\n}\\nfloat D_GGX( const in float alpha, const in float dotNH ) {\\n\\tfloat a2 = pow2( alpha );\\n\\tfloat denom = pow2( dotNH ) * ( a2 - 1.0 ) + 1.0;\\n\\treturn RECIPROCAL_PI * a2 / pow2( denom );\\n}\\nvec3 BRDF_Specular_GGX( const in IncidentLight incidentLight, const in GeometricContext geometry, const in vec3 specularColor, const in float roughness ) {\\n\\tfloat alpha = pow2( roughness );\\n\\tvec3 halfDir = normalize( incidentLight.direction + geometry.viewDir );\\n\\tfloat dotNL = saturate( dot( geometry.normal, incidentLight.direction ) );\\n\\tfloat dotNV = saturate( dot( geometry.normal, geometry.viewDir ) );\\n\\tfloat dotNH = saturate( dot( geometry.normal, halfDir ) );\\n\\tfloat dotLH = saturate( dot( incidentLight.direction, halfDir ) );\\n\\tvec3 F = F_Schlick( specularColor, dotLH );\\n\\tfloat G = G_GGX_SmithCorrelated( alpha, dotNL, dotNV );\\n\\tfloat D = D_GGX( alpha, dotNH );\\n\\treturn F * ( G * D );\\n}\\nvec2 LTC_Uv( const in vec3 N, const in vec3 V, const in float roughness ) {\\n\\tconst float LUT_SIZE  = 64.0;\\n\\tconst float LUT_SCALE = ( LUT_SIZE - 1.0 ) / LUT_SIZE;\\n\\tconst float LUT_BIAS  = 0.5 / LUT_SIZE;\\n\\tfloat theta = acos( dot( N, V ) );\\n\\tvec2 uv = vec2(\\n\\t\\tsqrt( saturate( roughness ) ),\\n\\t\\tsaturate( theta / ( 0.5 * PI ) ) );\\n\\tuv = uv * LUT_SCALE + LUT_BIAS;\\n\\treturn uv;\\n}\\nfloat LTC_ClippedSphereFormFactor( const in vec3 f ) {\\n\\tfloat l = length( f );\\n\\treturn max( ( l * l + f.z ) / ( l + 1.0 ), 0.0 );\\n}\\nvec3 LTC_EdgeVectorFormFactor( const in vec3 v1, const in vec3 v2 ) {\\n\\tfloat x = dot( v1, v2 );\\n\\tfloat y = abs( x );\\n\\tfloat a = 0.86267 + (0.49788 + 0.01436 * y ) * y;\\n\\tfloat b = 3.45068 + (4.18814 + y) * y;\\n\\tfloat v = a / b;\\n\\tfloat theta_sintheta = (x > 0.0) ? v : 0.5 * inversesqrt( 1.0 - x * x ) - v;\\n\\treturn cross( v1, v2 ) * theta_sintheta;\\n}\\nvec3 LTC_Evaluate( const in vec3 N, const in vec3 V, const in vec3 P, const in mat3 mInv, const in vec3 rectCoords[ 4 ] ) {\\n\\tvec3 v1 = rectCoords[ 1 ] - rectCoords[ 0 ];\\n\\tvec3 v2 = rectCoords[ 3 ] - rectCoords[ 0 ];\\n\\tvec3 lightNormal = cross( v1, v2 );\\n\\tif( dot( lightNormal, P - rectCoords[ 0 ] ) < 0.0 ) return vec3( 0.0 );\\n\\tvec3 T1, T2;\\n\\tT1 = normalize( V - N * dot( V, N ) );\\n\\tT2 = - cross( N, T1 );\\n\\tmat3 mat = mInv * transpose( mat3( T1, T2, N ) );\\n\\tvec3 coords[ 4 ];\\n\\tcoords[ 0 ] = mat * ( rectCoords[ 0 ] - P );\\n\\tcoords[ 1 ] = mat * ( rectCoords[ 1 ] - P );\\n\\tcoords[ 2 ] = mat * ( rectCoords[ 2 ] - P );\\n\\tcoords[ 3 ] = mat * ( rectCoords[ 3 ] - P );\\n\\tcoords[ 0 ] = normalize( coords[ 0 ] );\\n\\tcoords[ 1 ] = normalize( coords[ 1 ] );\\n\\tcoords[ 2 ] = normalize( coords[ 2 ] );\\n\\tcoords[ 3 ] = normalize( coords[ 3 ] );\\n\\tvec3 vectorFormFactor = vec3( 0.0 );\\n\\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 0 ], coords[ 1 ] );\\n\\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 1 ], coords[ 2 ] );\\n\\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 2 ], coords[ 3 ] );\\n\\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 3 ], coords[ 0 ] );\\n\\tvec3 result = vec3( LTC_ClippedSphereFormFactor( vectorFormFactor ) );\\n\\treturn result;\\n}\\nvec3 BRDF_Specular_GGX_Environment( const in GeometricContext geometry, const in vec3 specularColor, const in float roughness ) {\\n\\tfloat dotNV = saturate( dot( geometry.normal, geometry.viewDir ) );\\n\\tconst vec4 c0 = vec4( - 1, - 0.0275, - 0.572, 0.022 );\\n\\tconst vec4 c1 = vec4( 1, 0.0425, 1.04, - 0.04 );\\n\\tvec4 r = roughness * c0 + c1;\\n\\tfloat a004 = min( r.x * r.x, exp2( - 9.28 * dotNV ) ) * r.x + r.y;\\n\\tvec2 AB = vec2( -1.04, 1.04 ) * a004 + r.zw;\\n\\treturn specularColor * AB.x + AB.y;\\n}\\nfloat G_BlinnPhong_Implicit( ) {\\n\\treturn 0.25;\\n}\\nfloat D_BlinnPhong( const in float shininess, const in float dotNH ) {\\n\\treturn RECIPROCAL_PI * ( shininess * 0.5 + 1.0 ) * pow( dotNH, shininess );\\n}\\nvec3 BRDF_Specular_BlinnPhong( const in IncidentLight incidentLight, const in GeometricContext geometry, const in vec3 specularColor, const in float shininess ) {\\n\\tvec3 halfDir = normalize( incidentLight.direction + geometry.viewDir );\\n\\tfloat dotNH = saturate( dot( geometry.normal, halfDir ) );\\n\\tfloat dotLH = saturate( dot( incidentLight.direction, halfDir ) );\\n\\tvec3 F = F_Schlick( specularColor, dotLH );\\n\\tfloat G = G_BlinnPhong_Implicit( );\\n\\tfloat D = D_BlinnPhong( shininess, dotNH );\\n\\treturn F * ( G * D );\\n}\\nfloat GGXRoughnessToBlinnExponent( const in float ggxRoughness ) {\\n\\treturn ( 2.0 / pow2( ggxRoughness + 0.0001 ) - 2.0 );\\n}\\nfloat BlinnExponentToGGXRoughness( const in float blinnExponent ) {\\n\\treturn sqrt( 2.0 / ( blinnExponent + 2.0 ) );\\n}\\n\";\r\n\r\nvar bumpmap_pars_fragment = \"#ifdef USE_BUMPMAP\\n\\tuniform sampler2D bumpMap;\\n\\tuniform float bumpScale;\\n\\tvec2 dHdxy_fwd() {\\n\\t\\tvec2 dSTdx = dFdx( vUv );\\n\\t\\tvec2 dSTdy = dFdy( vUv );\\n\\t\\tfloat Hll = bumpScale * texture2D( bumpMap, vUv ).x;\\n\\t\\tfloat dBx = bumpScale * texture2D( bumpMap, vUv + dSTdx ).x - Hll;\\n\\t\\tfloat dBy = bumpScale * texture2D( bumpMap, vUv + dSTdy ).x - Hll;\\n\\t\\treturn vec2( dBx, dBy );\\n\\t}\\n\\tvec3 perturbNormalArb( vec3 surf_pos, vec3 surf_norm, vec2 dHdxy ) {\\n\\t\\tvec3 vSigmaX = vec3( dFdx( surf_pos.x ), dFdx( surf_pos.y ), dFdx( surf_pos.z ) );\\n\\t\\tvec3 vSigmaY = vec3( dFdy( surf_pos.x ), dFdy( surf_pos.y ), dFdy( surf_pos.z ) );\\n\\t\\tvec3 vN = surf_norm;\\n\\t\\tvec3 R1 = cross( vSigmaY, vN );\\n\\t\\tvec3 R2 = cross( vN, vSigmaX );\\n\\t\\tfloat fDet = dot( vSigmaX, R1 );\\n\\t\\tvec3 vGrad = sign( fDet ) * ( dHdxy.x * R1 + dHdxy.y * R2 );\\n\\t\\treturn normalize( abs( fDet ) * surf_norm - vGrad );\\n\\t}\\n#endif\\n\";\r\n\r\nvar clipping_planes_fragment = \"#if NUM_CLIPPING_PLANES > 0\\n\\tfor ( int i = 0; i < UNION_CLIPPING_PLANES; ++ i ) {\\n\\t\\tvec4 plane = clippingPlanes[ i ];\\n\\t\\tif ( dot( vViewPosition, plane.xyz ) > plane.w ) discard;\\n\\t}\\n\\t\\t\\n\\t#if UNION_CLIPPING_PLANES < NUM_CLIPPING_PLANES\\n\\t\\tbool clipped = true;\\n\\t\\tfor ( int i = UNION_CLIPPING_PLANES; i < NUM_CLIPPING_PLANES; ++ i ) {\\n\\t\\t\\tvec4 plane = clippingPlanes[ i ];\\n\\t\\t\\tclipped = ( dot( vViewPosition, plane.xyz ) > plane.w ) && clipped;\\n\\t\\t}\\n\\t\\tif ( clipped ) discard;\\n\\t\\n\\t#endif\\n#endif\\n\";\r\n\r\nvar clipping_planes_pars_fragment = \"#if NUM_CLIPPING_PLANES > 0\\n\\t#if ! defined( PHYSICAL ) && ! defined( PHONG )\\n\\t\\tvarying vec3 vViewPosition;\\n\\t#endif\\n\\tuniform vec4 clippingPlanes[ NUM_CLIPPING_PLANES ];\\n#endif\\n\";\r\n\r\nvar clipping_planes_pars_vertex = \"#if NUM_CLIPPING_PLANES > 0 && ! defined( PHYSICAL ) && ! defined( PHONG )\\n\\tvarying vec3 vViewPosition;\\n#endif\\n\";\r\n\r\nvar clipping_planes_vertex = \"#if NUM_CLIPPING_PLANES > 0 && ! defined( PHYSICAL ) && ! defined( PHONG )\\n\\tvViewPosition = - mvPosition.xyz;\\n#endif\\n\";\r\n\r\nvar color_fragment = \"#ifdef USE_COLOR\\n\\tdiffuseColor.rgb *= vColor;\\n#endif\";\r\n\r\nvar color_pars_fragment = \"#ifdef USE_COLOR\\n\\tvarying vec3 vColor;\\n#endif\\n\";\r\n\r\nvar color_pars_vertex = \"#ifdef USE_COLOR\\n\\tvarying vec3 vColor;\\n#endif\";\r\n\r\nvar color_vertex = \"#ifdef USE_COLOR\\n\\tvColor.xyz = color.xyz;\\n#endif\";\r\n\r\nvar common = \"#define PI 3.14159265359\\n#define PI2 6.28318530718\\n#define PI_HALF 1.5707963267949\\n#define RECIPROCAL_PI 0.31830988618\\n#define RECIPROCAL_PI2 0.15915494\\n#define LOG2 1.442695\\n#define EPSILON 1e-6\\n#define saturate(a) clamp( a, 0.0, 1.0 )\\n#define whiteCompliment(a) ( 1.0 - saturate( a ) )\\nfloat pow2( const in float x ) { return x*x; }\\nfloat pow3( const in float x ) { return x*x*x; }\\nfloat pow4( const in float x ) { float x2 = x*x; return x2*x2; }\\nfloat average( const in vec3 color ) { return dot( color, vec3( 0.3333 ) ); }\\nhighp float rand( const in vec2 uv ) {\\n\\tconst highp float a = 12.9898, b = 78.233, c = 43758.5453;\\n\\thighp float dt = dot( uv.xy, vec2( a,b ) ), sn = mod( dt, PI );\\n\\treturn fract(sin(sn) * c);\\n}\\nstruct IncidentLight {\\n\\tvec3 color;\\n\\tvec3 direction;\\n\\tbool visible;\\n};\\nstruct ReflectedLight {\\n\\tvec3 directDiffuse;\\n\\tvec3 directSpecular;\\n\\tvec3 indirectDiffuse;\\n\\tvec3 indirectSpecular;\\n};\\nstruct GeometricContext {\\n\\tvec3 position;\\n\\tvec3 normal;\\n\\tvec3 viewDir;\\n};\\nvec3 transformDirection( in vec3 dir, in mat4 matrix ) {\\n\\treturn normalize( ( matrix * vec4( dir, 0.0 ) ).xyz );\\n}\\nvec3 inverseTransformDirection( in vec3 dir, in mat4 matrix ) {\\n\\treturn normalize( ( vec4( dir, 0.0 ) * matrix ).xyz );\\n}\\nvec3 projectOnPlane(in vec3 point, in vec3 pointOnPlane, in vec3 planeNormal ) {\\n\\tfloat distance = dot( planeNormal, point - pointOnPlane );\\n\\treturn - distance * planeNormal + point;\\n}\\nfloat sideOfPlane( in vec3 point, in vec3 pointOnPlane, in vec3 planeNormal ) {\\n\\treturn sign( dot( point - pointOnPlane, planeNormal ) );\\n}\\nvec3 linePlaneIntersect( in vec3 pointOnLine, in vec3 lineDirection, in vec3 pointOnPlane, in vec3 planeNormal ) {\\n\\treturn lineDirection * ( dot( planeNormal, pointOnPlane - pointOnLine ) / dot( planeNormal, lineDirection ) ) + pointOnLine;\\n}\\nmat3 transpose( const in mat3 v ) {\\n\\tmat3 tmp;\\n\\ttmp[0] = vec3(v[0].x, v[1].x, v[2].x);\\n\\ttmp[1] = vec3(v[0].y, v[1].y, v[2].y);\\n\\ttmp[2] = vec3(v[0].z, v[1].z, v[2].z);\\n\\treturn tmp;\\n}\\n\";\r\n\r\nvar cube_uv_reflection_fragment = \"#ifdef ENVMAP_TYPE_CUBE_UV\\n#define cubeUV_textureSize (1024.0)\\nint getFaceFromDirection(vec3 direction) {\\n\\tvec3 absDirection = abs(direction);\\n\\tint face = -1;\\n\\tif( absDirection.x > absDirection.z ) {\\n\\t\\tif(absDirection.x > absDirection.y )\\n\\t\\t\\tface = direction.x > 0.0 ? 0 : 3;\\n\\t\\telse\\n\\t\\t\\tface = direction.y > 0.0 ? 1 : 4;\\n\\t}\\n\\telse {\\n\\t\\tif(absDirection.z > absDirection.y )\\n\\t\\t\\tface = direction.z > 0.0 ? 2 : 5;\\n\\t\\telse\\n\\t\\t\\tface = direction.y > 0.0 ? 1 : 4;\\n\\t}\\n\\treturn face;\\n}\\n#define cubeUV_maxLods1  (log2(cubeUV_textureSize*0.25) - 1.0)\\n#define cubeUV_rangeClamp (exp2((6.0 - 1.0) * 2.0))\\nvec2 MipLevelInfo( vec3 vec, float roughnessLevel, float roughness ) {\\n\\tfloat scale = exp2(cubeUV_maxLods1 - roughnessLevel);\\n\\tfloat dxRoughness = dFdx(roughness);\\n\\tfloat dyRoughness = dFdy(roughness);\\n\\tvec3 dx = dFdx( vec * scale * dxRoughness );\\n\\tvec3 dy = dFdy( vec * scale * dyRoughness );\\n\\tfloat d = max( dot( dx, dx ), dot( dy, dy ) );\\n\\td = clamp(d, 1.0, cubeUV_rangeClamp);\\n\\tfloat mipLevel = 0.5 * log2(d);\\n\\treturn vec2(floor(mipLevel), fract(mipLevel));\\n}\\n#define cubeUV_maxLods2 (log2(cubeUV_textureSize*0.25) - 2.0)\\n#define cubeUV_rcpTextureSize (1.0 / cubeUV_textureSize)\\nvec2 getCubeUV(vec3 direction, float roughnessLevel, float mipLevel) {\\n\\tmipLevel = roughnessLevel > cubeUV_maxLods2 - 3.0 ? 0.0 : mipLevel;\\n\\tfloat a = 16.0 * cubeUV_rcpTextureSize;\\n\\tvec2 exp2_packed = exp2( vec2( roughnessLevel, mipLevel ) );\\n\\tvec2 rcp_exp2_packed = vec2( 1.0 ) / exp2_packed;\\n\\tfloat powScale = exp2_packed.x * exp2_packed.y;\\n\\tfloat scale = rcp_exp2_packed.x * rcp_exp2_packed.y * 0.25;\\n\\tfloat mipOffset = 0.75*(1.0 - rcp_exp2_packed.y) * rcp_exp2_packed.x;\\n\\tbool bRes = mipLevel == 0.0;\\n\\tscale =  bRes && (scale < a) ? a : scale;\\n\\tvec3 r;\\n\\tvec2 offset;\\n\\tint face = getFaceFromDirection(direction);\\n\\tfloat rcpPowScale = 1.0 / powScale;\\n\\tif( face == 0) {\\n\\t\\tr = vec3(direction.x, -direction.z, direction.y);\\n\\t\\toffset = vec2(0.0+mipOffset,0.75 * rcpPowScale);\\n\\t\\toffset.y = bRes && (offset.y < 2.0*a) ? a : offset.y;\\n\\t}\\n\\telse if( face == 1) {\\n\\t\\tr = vec3(direction.y, direction.x, direction.z);\\n\\t\\toffset = vec2(scale+mipOffset, 0.75 * rcpPowScale);\\n\\t\\toffset.y = bRes && (offset.y < 2.0*a) ? a : offset.y;\\n\\t}\\n\\telse if( face == 2) {\\n\\t\\tr = vec3(direction.z, direction.x, direction.y);\\n\\t\\toffset = vec2(2.0*scale+mipOffset, 0.75 * rcpPowScale);\\n\\t\\toffset.y = bRes && (offset.y < 2.0*a) ? a : offset.y;\\n\\t}\\n\\telse if( face == 3) {\\n\\t\\tr = vec3(direction.x, direction.z, direction.y);\\n\\t\\toffset = vec2(0.0+mipOffset,0.5 * rcpPowScale);\\n\\t\\toffset.y = bRes && (offset.y < 2.0*a) ? 0.0 : offset.y;\\n\\t}\\n\\telse if( face == 4) {\\n\\t\\tr = vec3(direction.y, direction.x, -direction.z);\\n\\t\\toffset = vec2(scale+mipOffset, 0.5 * rcpPowScale);\\n\\t\\toffset.y = bRes && (offset.y < 2.0*a) ? 0.0 : offset.y;\\n\\t}\\n\\telse {\\n\\t\\tr = vec3(direction.z, -direction.x, direction.y);\\n\\t\\toffset = vec2(2.0*scale+mipOffset, 0.5 * rcpPowScale);\\n\\t\\toffset.y = bRes && (offset.y < 2.0*a) ? 0.0 : offset.y;\\n\\t}\\n\\tr = normalize(r);\\n\\tfloat texelOffset = 0.5 * cubeUV_rcpTextureSize;\\n\\tvec2 s = ( r.yz / abs( r.x ) + vec2( 1.0 ) ) * 0.5;\\n\\tvec2 base = offset + vec2( texelOffset );\\n\\treturn base + s * ( scale - 2.0 * texelOffset );\\n}\\n#define cubeUV_maxLods3 (log2(cubeUV_textureSize*0.25) - 3.0)\\nvec4 textureCubeUV(vec3 reflectedDirection, float roughness ) {\\n\\tfloat roughnessVal = roughness* cubeUV_maxLods3;\\n\\tfloat r1 = floor(roughnessVal);\\n\\tfloat r2 = r1 + 1.0;\\n\\tfloat t = fract(roughnessVal);\\n\\tvec2 mipInfo = MipLevelInfo(reflectedDirection, r1, roughness);\\n\\tfloat s = mipInfo.y;\\n\\tfloat level0 = mipInfo.x;\\n\\tfloat level1 = level0 + 1.0;\\n\\tlevel1 = level1 > 5.0 ? 5.0 : level1;\\n\\tlevel0 += min( floor( s + 0.5 ), 5.0 );\\n\\tvec2 uv_10 = getCubeUV(reflectedDirection, r1, level0);\\n\\tvec4 color10 = envMapTexelToLinear(texture2D(envMap, uv_10));\\n\\tvec2 uv_20 = getCubeUV(reflectedDirection, r2, level0);\\n\\tvec4 color20 = envMapTexelToLinear(texture2D(envMap, uv_20));\\n\\tvec4 result = mix(color10, color20, t);\\n\\treturn vec4(result.rgb, 1.0);\\n}\\n#endif\\n\";\r\n\r\nvar defaultnormal_vertex = \"vec3 transformedNormal = normalMatrix * objectNormal;\\n#ifdef FLIP_SIDED\\n\\ttransformedNormal = - transformedNormal;\\n#endif\\n\";\r\n\r\nvar displacementmap_pars_vertex = \"#ifdef USE_DISPLACEMENTMAP\\n\\tuniform sampler2D displacementMap;\\n\\tuniform float displacementScale;\\n\\tuniform float displacementBias;\\n#endif\\n\";\r\n\r\nvar displacementmap_vertex = \"#ifdef USE_DISPLACEMENTMAP\\n\\ttransformed += normalize( objectNormal ) * ( texture2D( displacementMap, uv ).x * displacementScale + displacementBias );\\n#endif\\n\";\r\n\r\nvar emissivemap_fragment = \"#ifdef USE_EMISSIVEMAP\\n\\tvec4 emissiveColor = texture2D( emissiveMap, vUv );\\n\\temissiveColor.rgb = emissiveMapTexelToLinear( emissiveColor ).rgb;\\n\\ttotalEmissiveRadiance *= emissiveColor.rgb;\\n#endif\\n\";\r\n\r\nvar emissivemap_pars_fragment = \"#ifdef USE_EMISSIVEMAP\\n\\tuniform sampler2D emissiveMap;\\n#endif\\n\";\r\n\r\nvar encodings_fragment = \"  gl_FragColor = linearToOutputTexel( gl_FragColor );\\n\";\r\n\r\nvar encodings_pars_fragment = \"\\nvec4 LinearToLinear( in vec4 value ) {\\n\\treturn value;\\n}\\nvec4 GammaToLinear( in vec4 value, in float gammaFactor ) {\\n\\treturn vec4( pow( value.xyz, vec3( gammaFactor ) ), value.w );\\n}\\nvec4 LinearToGamma( in vec4 value, in float gammaFactor ) {\\n\\treturn vec4( pow( value.xyz, vec3( 1.0 / gammaFactor ) ), value.w );\\n}\\nvec4 sRGBToLinear( in vec4 value ) {\\n\\treturn vec4( mix( pow( value.rgb * 0.9478672986 + vec3( 0.0521327014 ), vec3( 2.4 ) ), value.rgb * 0.0773993808, vec3( lessThanEqual( value.rgb, vec3( 0.04045 ) ) ) ), value.w );\\n}\\nvec4 LinearTosRGB( in vec4 value ) {\\n\\treturn vec4( mix( pow( value.rgb, vec3( 0.41666 ) ) * 1.055 - vec3( 0.055 ), value.rgb * 12.92, vec3( lessThanEqual( value.rgb, vec3( 0.0031308 ) ) ) ), value.w );\\n}\\nvec4 RGBEToLinear( in vec4 value ) {\\n\\treturn vec4( value.rgb * exp2( value.a * 255.0 - 128.0 ), 1.0 );\\n}\\nvec4 LinearToRGBE( in vec4 value ) {\\n\\tfloat maxComponent = max( max( value.r, value.g ), value.b );\\n\\tfloat fExp = clamp( ceil( log2( maxComponent ) ), -128.0, 127.0 );\\n\\treturn vec4( value.rgb / exp2( fExp ), ( fExp + 128.0 ) / 255.0 );\\n}\\nvec4 RGBMToLinear( in vec4 value, in float maxRange ) {\\n\\treturn vec4( value.xyz * value.w * maxRange, 1.0 );\\n}\\nvec4 LinearToRGBM( in vec4 value, in float maxRange ) {\\n\\tfloat maxRGB = max( value.x, max( value.g, value.b ) );\\n\\tfloat M      = clamp( maxRGB / maxRange, 0.0, 1.0 );\\n\\tM            = ceil( M * 255.0 ) / 255.0;\\n\\treturn vec4( value.rgb / ( M * maxRange ), M );\\n}\\nvec4 RGBDToLinear( in vec4 value, in float maxRange ) {\\n\\treturn vec4( value.rgb * ( ( maxRange / 255.0 ) / value.a ), 1.0 );\\n}\\nvec4 LinearToRGBD( in vec4 value, in float maxRange ) {\\n\\tfloat maxRGB = max( value.x, max( value.g, value.b ) );\\n\\tfloat D      = max( maxRange / maxRGB, 1.0 );\\n\\tD            = min( floor( D ) / 255.0, 1.0 );\\n\\treturn vec4( value.rgb * ( D * ( 255.0 / maxRange ) ), D );\\n}\\nconst mat3 cLogLuvM = mat3( 0.2209, 0.3390, 0.4184, 0.1138, 0.6780, 0.7319, 0.0102, 0.1130, 0.2969 );\\nvec4 LinearToLogLuv( in vec4 value )  {\\n\\tvec3 Xp_Y_XYZp = value.rgb * cLogLuvM;\\n\\tXp_Y_XYZp = max(Xp_Y_XYZp, vec3(1e-6, 1e-6, 1e-6));\\n\\tvec4 vResult;\\n\\tvResult.xy = Xp_Y_XYZp.xy / Xp_Y_XYZp.z;\\n\\tfloat Le = 2.0 * log2(Xp_Y_XYZp.y) + 127.0;\\n\\tvResult.w = fract(Le);\\n\\tvResult.z = (Le - (floor(vResult.w*255.0))/255.0)/255.0;\\n\\treturn vResult;\\n}\\nconst mat3 cLogLuvInverseM = mat3( 6.0014, -2.7008, -1.7996, -1.3320, 3.1029, -5.7721, 0.3008, -1.0882, 5.6268 );\\nvec4 LogLuvToLinear( in vec4 value ) {\\n\\tfloat Le = value.z * 255.0 + value.w;\\n\\tvec3 Xp_Y_XYZp;\\n\\tXp_Y_XYZp.y = exp2((Le - 127.0) / 2.0);\\n\\tXp_Y_XYZp.z = Xp_Y_XYZp.y / value.y;\\n\\tXp_Y_XYZp.x = value.x * Xp_Y_XYZp.z;\\n\\tvec3 vRGB = Xp_Y_XYZp.rgb * cLogLuvInverseM;\\n\\treturn vec4( max(vRGB, 0.0), 1.0 );\\n}\\n\";\r\n\r\nvar envmap_fragment = \"#ifdef USE_ENVMAP\\n\\t#if defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( PHONG )\\n\\t\\tvec3 cameraToVertex = normalize( vWorldPosition - cameraPosition );\\n\\t\\tvec3 worldNormal = inverseTransformDirection( normal, viewMatrix );\\n\\t\\t#ifdef ENVMAP_MODE_REFLECTION\\n\\t\\t\\tvec3 reflectVec = reflect( cameraToVertex, worldNormal );\\n\\t\\t#else\\n\\t\\t\\tvec3 reflectVec = refract( cameraToVertex, worldNormal, refractionRatio );\\n\\t\\t#endif\\n\\t#else\\n\\t\\tvec3 reflectVec = vReflect;\\n\\t#endif\\n\\t#ifdef ENVMAP_TYPE_CUBE\\n\\t\\tvec4 envColor = textureCube( envMap, flipNormal * vec3( flipEnvMap * reflectVec.x, reflectVec.yz ) );\\n\\t#elif defined( ENVMAP_TYPE_EQUIREC )\\n\\t\\tvec2 sampleUV;\\n\\t\\tsampleUV.y = asin( flipNormal * reflectVec.y ) * RECIPROCAL_PI + 0.5;\\n\\t\\tsampleUV.x = atan( flipNormal * reflectVec.z, flipNormal * reflectVec.x ) * RECIPROCAL_PI2 + 0.5;\\n\\t\\tvec4 envColor = texture2D( envMap, sampleUV );\\n\\t#elif defined( ENVMAP_TYPE_SPHERE )\\n\\t\\tvec3 reflectView = flipNormal * normalize( ( viewMatrix * vec4( reflectVec, 0.0 ) ).xyz + vec3( 0.0, 0.0, 1.0 ) );\\n\\t\\tvec4 envColor = texture2D( envMap, reflectView.xy * 0.5 + 0.5 );\\n\\t#else\\n\\t\\tvec4 envColor = vec4( 0.0 );\\n\\t#endif\\n\\tenvColor = envMapTexelToLinear( envColor );\\n\\t#ifdef ENVMAP_BLENDING_MULTIPLY\\n\\t\\toutgoingLight = mix( outgoingLight, outgoingLight * envColor.xyz, specularStrength * reflectivity );\\n\\t#elif defined( ENVMAP_BLENDING_MIX )\\n\\t\\toutgoingLight = mix( outgoingLight, envColor.xyz, specularStrength * reflectivity );\\n\\t#elif defined( ENVMAP_BLENDING_ADD )\\n\\t\\toutgoingLight += envColor.xyz * specularStrength * reflectivity;\\n\\t#endif\\n#endif\\n\";\r\n\r\nvar envmap_pars_fragment = \"#if defined( USE_ENVMAP ) || defined( PHYSICAL )\\n\\tuniform float reflectivity;\\n\\tuniform float envMapIntensity;\\n#endif\\n#ifdef USE_ENVMAP\\n\\t#if ! defined( PHYSICAL ) && ( defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( PHONG ) )\\n\\t\\tvarying vec3 vWorldPosition;\\n\\t#endif\\n\\t#ifdef ENVMAP_TYPE_CUBE\\n\\t\\tuniform samplerCube envMap;\\n\\t#else\\n\\t\\tuniform sampler2D envMap;\\n\\t#endif\\n\\tuniform float flipEnvMap;\\n\\t#if defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( PHONG ) || defined( PHYSICAL )\\n\\t\\tuniform float refractionRatio;\\n\\t#else\\n\\t\\tvarying vec3 vReflect;\\n\\t#endif\\n#endif\\n\";\r\n\r\nvar envmap_pars_vertex = \"#ifdef USE_ENVMAP\\n\\t#if defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( PHONG )\\n\\t\\tvarying vec3 vWorldPosition;\\n\\t#else\\n\\t\\tvarying vec3 vReflect;\\n\\t\\tuniform float refractionRatio;\\n\\t#endif\\n#endif\\n\";\r\n\r\nvar envmap_vertex = \"#ifdef USE_ENVMAP\\n\\t#if defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( PHONG )\\n\\t\\tvWorldPosition = worldPosition.xyz;\\n\\t#else\\n\\t\\tvec3 cameraToVertex = normalize( worldPosition.xyz - cameraPosition );\\n\\t\\tvec3 worldNormal = inverseTransformDirection( transformedNormal, viewMatrix );\\n\\t\\t#ifdef ENVMAP_MODE_REFLECTION\\n\\t\\t\\tvReflect = reflect( cameraToVertex, worldNormal );\\n\\t\\t#else\\n\\t\\t\\tvReflect = refract( cameraToVertex, worldNormal, refractionRatio );\\n\\t\\t#endif\\n\\t#endif\\n#endif\\n\";\r\n\r\nvar fog_vertex = \"\\n#ifdef USE_FOG\\nfogDepth = -mvPosition.z;\\n#endif\";\r\n\r\nvar fog_pars_vertex = \"#ifdef USE_FOG\\n  varying float fogDepth;\\n#endif\\n\";\r\n\r\nvar fog_fragment = \"#ifdef USE_FOG\\n\\t#ifdef FOG_EXP2\\n\\t\\tfloat fogFactor = whiteCompliment( exp2( - fogDensity * fogDensity * fogDepth * fogDepth * LOG2 ) );\\n\\t#else\\n\\t\\tfloat fogFactor = smoothstep( fogNear, fogFar, fogDepth );\\n\\t#endif\\n\\tgl_FragColor.rgb = mix( gl_FragColor.rgb, fogColor, fogFactor );\\n#endif\\n\";\r\n\r\nvar fog_pars_fragment = \"#ifdef USE_FOG\\n\\tuniform vec3 fogColor;\\n\\tvarying float fogDepth;\\n\\t#ifdef FOG_EXP2\\n\\t\\tuniform float fogDensity;\\n\\t#else\\n\\t\\tuniform float fogNear;\\n\\t\\tuniform float fogFar;\\n\\t#endif\\n#endif\\n\";\r\n\r\nvar gradientmap_pars_fragment = \"#ifdef TOON\\n\\tuniform sampler2D gradientMap;\\n\\tvec3 getGradientIrradiance( vec3 normal, vec3 lightDirection ) {\\n\\t\\tfloat dotNL = dot( normal, lightDirection );\\n\\t\\tvec2 coord = vec2( dotNL * 0.5 + 0.5, 0.0 );\\n\\t\\t#ifdef USE_GRADIENTMAP\\n\\t\\t\\treturn texture2D( gradientMap, coord ).rgb;\\n\\t\\t#else\\n\\t\\t\\treturn ( coord.x < 0.7 ) ? vec3( 0.7 ) : vec3( 1.0 );\\n\\t\\t#endif\\n\\t}\\n#endif\\n\";\r\n\r\nvar lightmap_fragment = \"#ifdef USE_LIGHTMAP\\n\\treflectedLight.indirectDiffuse += PI * texture2D( lightMap, vUv2 ).xyz * lightMapIntensity;\\n#endif\\n\";\r\n\r\nvar lightmap_pars_fragment = \"#ifdef USE_LIGHTMAP\\n\\tuniform sampler2D lightMap;\\n\\tuniform float lightMapIntensity;\\n#endif\";\r\n\r\nvar lights_lambert_vertex = \"vec3 diffuse = vec3( 1.0 );\\nGeometricContext geometry;\\ngeometry.position = mvPosition.xyz;\\ngeometry.normal = normalize( transformedNormal );\\ngeometry.viewDir = normalize( -mvPosition.xyz );\\nGeometricContext backGeometry;\\nbackGeometry.position = geometry.position;\\nbackGeometry.normal = -geometry.normal;\\nbackGeometry.viewDir = geometry.viewDir;\\nvLightFront = vec3( 0.0 );\\n#ifdef DOUBLE_SIDED\\n\\tvLightBack = vec3( 0.0 );\\n#endif\\nIncidentLight directLight;\\nfloat dotNL;\\nvec3 directLightColor_Diffuse;\\n#if NUM_POINT_LIGHTS > 0\\n\\tfor ( int i = 0; i < NUM_POINT_LIGHTS; i ++ ) {\\n\\t\\tgetPointDirectLightIrradiance( pointLights[ i ], geometry, directLight );\\n\\t\\tdotNL = dot( geometry.normal, directLight.direction );\\n\\t\\tdirectLightColor_Diffuse = PI * directLight.color;\\n\\t\\tvLightFront += saturate( dotNL ) * directLightColor_Diffuse;\\n\\t\\t#ifdef DOUBLE_SIDED\\n\\t\\t\\tvLightBack += saturate( -dotNL ) * directLightColor_Diffuse;\\n\\t\\t#endif\\n\\t}\\n#endif\\n#if NUM_SPOT_LIGHTS > 0\\n\\tfor ( int i = 0; i < NUM_SPOT_LIGHTS; i ++ ) {\\n\\t\\tgetSpotDirectLightIrradiance( spotLights[ i ], geometry, directLight );\\n\\t\\tdotNL = dot( geometry.normal, directLight.direction );\\n\\t\\tdirectLightColor_Diffuse = PI * directLight.color;\\n\\t\\tvLightFront += saturate( dotNL ) * directLightColor_Diffuse;\\n\\t\\t#ifdef DOUBLE_SIDED\\n\\t\\t\\tvLightBack += saturate( -dotNL ) * directLightColor_Diffuse;\\n\\t\\t#endif\\n\\t}\\n#endif\\n#if NUM_DIR_LIGHTS > 0\\n\\tfor ( int i = 0; i < NUM_DIR_LIGHTS; i ++ ) {\\n\\t\\tgetDirectionalDirectLightIrradiance( directionalLights[ i ], geometry, directLight );\\n\\t\\tdotNL = dot( geometry.normal, directLight.direction );\\n\\t\\tdirectLightColor_Diffuse = PI * directLight.color;\\n\\t\\tvLightFront += saturate( dotNL ) * directLightColor_Diffuse;\\n\\t\\t#ifdef DOUBLE_SIDED\\n\\t\\t\\tvLightBack += saturate( -dotNL ) * directLightColor_Diffuse;\\n\\t\\t#endif\\n\\t}\\n#endif\\n#if NUM_HEMI_LIGHTS > 0\\n\\tfor ( int i = 0; i < NUM_HEMI_LIGHTS; i ++ ) {\\n\\t\\tvLightFront += getHemisphereLightIrradiance( hemisphereLights[ i ], geometry );\\n\\t\\t#ifdef DOUBLE_SIDED\\n\\t\\t\\tvLightBack += getHemisphereLightIrradiance( hemisphereLights[ i ], backGeometry );\\n\\t\\t#endif\\n\\t}\\n#endif\\n\";\r\n\r\nvar lights_pars = \"uniform vec3 ambientLightColor;\\nvec3 getAmbientLightIrradiance( const in vec3 ambientLightColor ) {\\n\\tvec3 irradiance = ambientLightColor;\\n\\t#ifndef PHYSICALLY_CORRECT_LIGHTS\\n\\t\\tirradiance *= PI;\\n\\t#endif\\n\\treturn irradiance;\\n}\\n#if NUM_DIR_LIGHTS > 0\\n\\tstruct DirectionalLight {\\n\\t\\tvec3 direction;\\n\\t\\tvec3 color;\\n\\t\\tint shadow;\\n\\t\\tfloat shadowBias;\\n\\t\\tfloat shadowRadius;\\n\\t\\tvec2 shadowMapSize;\\n\\t};\\n\\tuniform DirectionalLight directionalLights[ NUM_DIR_LIGHTS ];\\n\\tvoid getDirectionalDirectLightIrradiance( const in DirectionalLight directionalLight, const in GeometricContext geometry, out IncidentLight directLight ) {\\n\\t\\tdirectLight.color = directionalLight.color;\\n\\t\\tdirectLight.direction = directionalLight.direction;\\n\\t\\tdirectLight.visible = true;\\n\\t}\\n#endif\\n#if NUM_POINT_LIGHTS > 0\\n\\tstruct PointLight {\\n\\t\\tvec3 position;\\n\\t\\tvec3 color;\\n\\t\\tfloat distance;\\n\\t\\tfloat decay;\\n\\t\\tint shadow;\\n\\t\\tfloat shadowBias;\\n\\t\\tfloat shadowRadius;\\n\\t\\tvec2 shadowMapSize;\\n\\t};\\n\\tuniform PointLight pointLights[ NUM_POINT_LIGHTS ];\\n\\tvoid getPointDirectLightIrradiance( const in PointLight pointLight, const in GeometricContext geometry, out IncidentLight directLight ) {\\n\\t\\tvec3 lVector = pointLight.position - geometry.position;\\n\\t\\tdirectLight.direction = normalize( lVector );\\n\\t\\tfloat lightDistance = length( lVector );\\n\\t\\tdirectLight.color = pointLight.color;\\n\\t\\tdirectLight.color *= punctualLightIntensityToIrradianceFactor( lightDistance, pointLight.distance, pointLight.decay );\\n\\t\\tdirectLight.visible = ( directLight.color != vec3( 0.0 ) );\\n\\t}\\n#endif\\n#if NUM_SPOT_LIGHTS > 0\\n\\tstruct SpotLight {\\n\\t\\tvec3 position;\\n\\t\\tvec3 direction;\\n\\t\\tvec3 color;\\n\\t\\tfloat distance;\\n\\t\\tfloat decay;\\n\\t\\tfloat coneCos;\\n\\t\\tfloat penumbraCos;\\n\\t\\tint shadow;\\n\\t\\tfloat shadowBias;\\n\\t\\tfloat shadowRadius;\\n\\t\\tvec2 shadowMapSize;\\n\\t};\\n\\tuniform SpotLight spotLights[ NUM_SPOT_LIGHTS ];\\n\\tvoid getSpotDirectLightIrradiance( const in SpotLight spotLight, const in GeometricContext geometry, out IncidentLight directLight  ) {\\n\\t\\tvec3 lVector = spotLight.position - geometry.position;\\n\\t\\tdirectLight.direction = normalize( lVector );\\n\\t\\tfloat lightDistance = length( lVector );\\n\\t\\tfloat angleCos = dot( directLight.direction, spotLight.direction );\\n\\t\\tif ( angleCos > spotLight.coneCos ) {\\n\\t\\t\\tfloat spotEffect = smoothstep( spotLight.coneCos, spotLight.penumbraCos, angleCos );\\n\\t\\t\\tdirectLight.color = spotLight.color;\\n\\t\\t\\tdirectLight.color *= spotEffect * punctualLightIntensityToIrradianceFactor( lightDistance, spotLight.distance, spotLight.decay );\\n\\t\\t\\tdirectLight.visible = true;\\n\\t\\t} else {\\n\\t\\t\\tdirectLight.color = vec3( 0.0 );\\n\\t\\t\\tdirectLight.visible = false;\\n\\t\\t}\\n\\t}\\n#endif\\n#if NUM_RECT_AREA_LIGHTS > 0\\n\\tstruct RectAreaLight {\\n\\t\\tvec3 color;\\n\\t\\tvec3 position;\\n\\t\\tvec3 halfWidth;\\n\\t\\tvec3 halfHeight;\\n\\t};\\n\\tuniform sampler2D ltcMat;\\tuniform sampler2D ltcMag;\\n\\tuniform RectAreaLight rectAreaLights[ NUM_RECT_AREA_LIGHTS ];\\n#endif\\n#if NUM_HEMI_LIGHTS > 0\\n\\tstruct HemisphereLight {\\n\\t\\tvec3 direction;\\n\\t\\tvec3 skyColor;\\n\\t\\tvec3 groundColor;\\n\\t};\\n\\tuniform HemisphereLight hemisphereLights[ NUM_HEMI_LIGHTS ];\\n\\tvec3 getHemisphereLightIrradiance( const in HemisphereLight hemiLight, const in GeometricContext geometry ) {\\n\\t\\tfloat dotNL = dot( geometry.normal, hemiLight.direction );\\n\\t\\tfloat hemiDiffuseWeight = 0.5 * dotNL + 0.5;\\n\\t\\tvec3 irradiance = mix( hemiLight.groundColor, hemiLight.skyColor, hemiDiffuseWeight );\\n\\t\\t#ifndef PHYSICALLY_CORRECT_LIGHTS\\n\\t\\t\\tirradiance *= PI;\\n\\t\\t#endif\\n\\t\\treturn irradiance;\\n\\t}\\n#endif\\n#if defined( USE_ENVMAP ) && defined( PHYSICAL )\\n\\tvec3 getLightProbeIndirectIrradiance( const in GeometricContext geometry, const in int maxMIPLevel ) {\\n\\t\\tvec3 worldNormal = inverseTransformDirection( geometry.normal, viewMatrix );\\n\\t\\t#ifdef ENVMAP_TYPE_CUBE\\n\\t\\t\\tvec3 queryVec = vec3( flipEnvMap * worldNormal.x, worldNormal.yz );\\n\\t\\t\\t#ifdef TEXTURE_LOD_EXT\\n\\t\\t\\t\\tvec4 envMapColor = textureCubeLodEXT( envMap, queryVec, float( maxMIPLevel ) );\\n\\t\\t\\t#else\\n\\t\\t\\t\\tvec4 envMapColor = textureCube( envMap, queryVec, float( maxMIPLevel ) );\\n\\t\\t\\t#endif\\n\\t\\t\\tenvMapColor.rgb = envMapTexelToLinear( envMapColor ).rgb;\\n\\t\\t#elif defined( ENVMAP_TYPE_CUBE_UV )\\n\\t\\t\\tvec3 queryVec = vec3( flipEnvMap * worldNormal.x, worldNormal.yz );\\n\\t\\t\\tvec4 envMapColor = textureCubeUV( queryVec, 1.0 );\\n\\t\\t#else\\n\\t\\t\\tvec4 envMapColor = vec4( 0.0 );\\n\\t\\t#endif\\n\\t\\treturn PI * envMapColor.rgb * envMapIntensity;\\n\\t}\\n\\tfloat getSpecularMIPLevel( const in float blinnShininessExponent, const in int maxMIPLevel ) {\\n\\t\\tfloat maxMIPLevelScalar = float( maxMIPLevel );\\n\\t\\tfloat desiredMIPLevel = maxMIPLevelScalar - 0.79248 - 0.5 * log2( pow2( blinnShininessExponent ) + 1.0 );\\n\\t\\treturn clamp( desiredMIPLevel, 0.0, maxMIPLevelScalar );\\n\\t}\\n\\tvec3 getLightProbeIndirectRadiance( const in GeometricContext geometry, const in float blinnShininessExponent, const in int maxMIPLevel ) {\\n\\t\\t#ifdef ENVMAP_MODE_REFLECTION\\n\\t\\t\\tvec3 reflectVec = reflect( -geometry.viewDir, geometry.normal );\\n\\t\\t#else\\n\\t\\t\\tvec3 reflectVec = refract( -geometry.viewDir, geometry.normal, refractionRatio );\\n\\t\\t#endif\\n\\t\\treflectVec = inverseTransformDirection( reflectVec, viewMatrix );\\n\\t\\tfloat specularMIPLevel = getSpecularMIPLevel( blinnShininessExponent, maxMIPLevel );\\n\\t\\t#ifdef ENVMAP_TYPE_CUBE\\n\\t\\t\\tvec3 queryReflectVec = vec3( flipEnvMap * reflectVec.x, reflectVec.yz );\\n\\t\\t\\t#ifdef TEXTURE_LOD_EXT\\n\\t\\t\\t\\tvec4 envMapColor = textureCubeLodEXT( envMap, queryReflectVec, specularMIPLevel );\\n\\t\\t\\t#else\\n\\t\\t\\t\\tvec4 envMapColor = textureCube( envMap, queryReflectVec, specularMIPLevel );\\n\\t\\t\\t#endif\\n\\t\\t\\tenvMapColor.rgb = envMapTexelToLinear( envMapColor ).rgb;\\n\\t\\t#elif defined( ENVMAP_TYPE_CUBE_UV )\\n\\t\\t\\tvec3 queryReflectVec = vec3( flipEnvMap * reflectVec.x, reflectVec.yz );\\n\\t\\t\\tvec4 envMapColor = textureCubeUV(queryReflectVec, BlinnExponentToGGXRoughness(blinnShininessExponent));\\n\\t\\t#elif defined( ENVMAP_TYPE_EQUIREC )\\n\\t\\t\\tvec2 sampleUV;\\n\\t\\t\\tsampleUV.y = saturate( reflectVec.y * 0.5 + 0.5 );\\n\\t\\t\\tsampleUV.x = atan( reflectVec.z, reflectVec.x ) * RECIPROCAL_PI2 + 0.5;\\n\\t\\t\\t#ifdef TEXTURE_LOD_EXT\\n\\t\\t\\t\\tvec4 envMapColor = texture2DLodEXT( envMap, sampleUV, specularMIPLevel );\\n\\t\\t\\t#else\\n\\t\\t\\t\\tvec4 envMapColor = texture2D( envMap, sampleUV, specularMIPLevel );\\n\\t\\t\\t#endif\\n\\t\\t\\tenvMapColor.rgb = envMapTexelToLinear( envMapColor ).rgb;\\n\\t\\t#elif defined( ENVMAP_TYPE_SPHERE )\\n\\t\\t\\tvec3 reflectView = normalize( ( viewMatrix * vec4( reflectVec, 0.0 ) ).xyz + vec3( 0.0,0.0,1.0 ) );\\n\\t\\t\\t#ifdef TEXTURE_LOD_EXT\\n\\t\\t\\t\\tvec4 envMapColor = texture2DLodEXT( envMap, reflectView.xy * 0.5 + 0.5, specularMIPLevel );\\n\\t\\t\\t#else\\n\\t\\t\\t\\tvec4 envMapColor = texture2D( envMap, reflectView.xy * 0.5 + 0.5, specularMIPLevel );\\n\\t\\t\\t#endif\\n\\t\\t\\tenvMapColor.rgb = envMapTexelToLinear( envMapColor ).rgb;\\n\\t\\t#endif\\n\\t\\treturn envMapColor.rgb * envMapIntensity;\\n\\t}\\n#endif\\n\";\r\n\r\nvar lights_phong_fragment = \"BlinnPhongMaterial material;\\nmaterial.diffuseColor = diffuseColor.rgb;\\nmaterial.specularColor = specular;\\nmaterial.specularShininess = shininess;\\nmaterial.specularStrength = specularStrength;\\n\";\r\n\r\nvar lights_phong_pars_fragment = \"varying vec3 vViewPosition;\\n#ifndef FLAT_SHADED\\n\\tvarying vec3 vNormal;\\n#endif\\nstruct BlinnPhongMaterial {\\n\\tvec3\\tdiffuseColor;\\n\\tvec3\\tspecularColor;\\n\\tfloat\\tspecularShininess;\\n\\tfloat\\tspecularStrength;\\n};\\nvoid RE_Direct_BlinnPhong( const in IncidentLight directLight, const in GeometricContext geometry, const in BlinnPhongMaterial material, inout ReflectedLight reflectedLight ) {\\n\\t#ifdef TOON\\n\\t\\tvec3 irradiance = getGradientIrradiance( geometry.normal, directLight.direction ) * directLight.color;\\n\\t#else\\n\\t\\tfloat dotNL = saturate( dot( geometry.normal, directLight.direction ) );\\n\\t\\tvec3 irradiance = dotNL * directLight.color;\\n\\t#endif\\n\\t#ifndef PHYSICALLY_CORRECT_LIGHTS\\n\\t\\tirradiance *= PI;\\n\\t#endif\\n\\treflectedLight.directDiffuse += irradiance * BRDF_Diffuse_Lambert( material.diffuseColor );\\n\\treflectedLight.directSpecular += irradiance * BRDF_Specular_BlinnPhong( directLight, geometry, material.specularColor, material.specularShininess ) * material.specularStrength;\\n}\\nvoid RE_IndirectDiffuse_BlinnPhong( const in vec3 irradiance, const in GeometricContext geometry, const in BlinnPhongMaterial material, inout ReflectedLight reflectedLight ) {\\n\\treflectedLight.indirectDiffuse += irradiance * BRDF_Diffuse_Lambert( material.diffuseColor );\\n}\\n#define RE_Direct\\t\\t\\t\\tRE_Direct_BlinnPhong\\n#define RE_IndirectDiffuse\\t\\tRE_IndirectDiffuse_BlinnPhong\\n#define Material_LightProbeLOD( material )\\t(0)\\n\";\r\n\r\nvar lights_physical_fragment = \"PhysicalMaterial material;\\nmaterial.diffuseColor = diffuseColor.rgb * ( 1.0 - metalnessFactor );\\nmaterial.specularRoughness = clamp( roughnessFactor, 0.04, 1.0 );\\n#ifdef STANDARD\\n\\tmaterial.specularColor = mix( vec3( DEFAULT_SPECULAR_COEFFICIENT ), diffuseColor.rgb, metalnessFactor );\\n#else\\n\\tmaterial.specularColor = mix( vec3( MAXIMUM_SPECULAR_COEFFICIENT * pow2( reflectivity ) ), diffuseColor.rgb, metalnessFactor );\\n\\tmaterial.clearCoat = saturate( clearCoat );\\tmaterial.clearCoatRoughness = clamp( clearCoatRoughness, 0.04, 1.0 );\\n#endif\\n\";\r\n\r\nvar lights_physical_pars_fragment = \"struct PhysicalMaterial {\\n\\tvec3\\tdiffuseColor;\\n\\tfloat\\tspecularRoughness;\\n\\tvec3\\tspecularColor;\\n\\t#ifndef STANDARD\\n\\t\\tfloat clearCoat;\\n\\t\\tfloat clearCoatRoughness;\\n\\t#endif\\n};\\n#define MAXIMUM_SPECULAR_COEFFICIENT 0.16\\n#define DEFAULT_SPECULAR_COEFFICIENT 0.04\\nfloat clearCoatDHRApprox( const in float roughness, const in float dotNL ) {\\n\\treturn DEFAULT_SPECULAR_COEFFICIENT + ( 1.0 - DEFAULT_SPECULAR_COEFFICIENT ) * ( pow( 1.0 - dotNL, 5.0 ) * pow( 1.0 - roughness, 2.0 ) );\\n}\\n#if NUM_RECT_AREA_LIGHTS > 0\\n\\tvoid RE_Direct_RectArea_Physical( const in RectAreaLight rectAreaLight, const in GeometricContext geometry, const in PhysicalMaterial material, inout ReflectedLight reflectedLight ) {\\n\\t\\tvec3 normal = geometry.normal;\\n\\t\\tvec3 viewDir = geometry.viewDir;\\n\\t\\tvec3 position = geometry.position;\\n\\t\\tvec3 lightPos = rectAreaLight.position;\\n\\t\\tvec3 halfWidth = rectAreaLight.halfWidth;\\n\\t\\tvec3 halfHeight = rectAreaLight.halfHeight;\\n\\t\\tvec3 lightColor = rectAreaLight.color;\\n\\t\\tfloat roughness = material.specularRoughness;\\n\\t\\tvec3 rectCoords[ 4 ];\\n\\t\\trectCoords[ 0 ] = lightPos - halfWidth - halfHeight;\\t\\trectCoords[ 1 ] = lightPos + halfWidth - halfHeight;\\n\\t\\trectCoords[ 2 ] = lightPos + halfWidth + halfHeight;\\n\\t\\trectCoords[ 3 ] = lightPos - halfWidth + halfHeight;\\n\\t\\tvec2 uv = LTC_Uv( normal, viewDir, roughness );\\n\\t\\tfloat norm = texture2D( ltcMag, uv ).a;\\n\\t\\tvec4 t = texture2D( ltcMat, uv );\\n\\t\\tmat3 mInv = mat3(\\n\\t\\t\\tvec3(   1,   0, t.y ),\\n\\t\\t\\tvec3(   0, t.z,   0 ),\\n\\t\\t\\tvec3( t.w,   0, t.x )\\n\\t\\t);\\n\\t\\treflectedLight.directSpecular += lightColor * material.specularColor * norm * LTC_Evaluate( normal, viewDir, position, mInv, rectCoords );\\n\\t\\treflectedLight.directDiffuse += lightColor * material.diffuseColor * LTC_Evaluate( normal, viewDir, position, mat3( 1 ), rectCoords );\\n\\t}\\n#endif\\nvoid RE_Direct_Physical( const in IncidentLight directLight, const in GeometricContext geometry, const in PhysicalMaterial material, inout ReflectedLight reflectedLight ) {\\n\\tfloat dotNL = saturate( dot( geometry.normal, directLight.direction ) );\\n\\tvec3 irradiance = dotNL * directLight.color;\\n\\t#ifndef PHYSICALLY_CORRECT_LIGHTS\\n\\t\\tirradiance *= PI;\\n\\t#endif\\n\\t#ifndef STANDARD\\n\\t\\tfloat clearCoatDHR = material.clearCoat * clearCoatDHRApprox( material.clearCoatRoughness, dotNL );\\n\\t#else\\n\\t\\tfloat clearCoatDHR = 0.0;\\n\\t#endif\\n\\treflectedLight.directSpecular += ( 1.0 - clearCoatDHR ) * irradiance * BRDF_Specular_GGX( directLight, geometry, material.specularColor, material.specularRoughness );\\n\\treflectedLight.directDiffuse += ( 1.0 - clearCoatDHR ) * irradiance * BRDF_Diffuse_Lambert( material.diffuseColor );\\n\\t#ifndef STANDARD\\n\\t\\treflectedLight.directSpecular += irradiance * material.clearCoat * BRDF_Specular_GGX( directLight, geometry, vec3( DEFAULT_SPECULAR_COEFFICIENT ), material.clearCoatRoughness );\\n\\t#endif\\n}\\nvoid RE_IndirectDiffuse_Physical( const in vec3 irradiance, const in GeometricContext geometry, const in PhysicalMaterial material, inout ReflectedLight reflectedLight ) {\\n\\treflectedLight.indirectDiffuse += irradiance * BRDF_Diffuse_Lambert( material.diffuseColor );\\n}\\nvoid RE_IndirectSpecular_Physical( const in vec3 radiance, const in vec3 clearCoatRadiance, const in GeometricContext geometry, const in PhysicalMaterial material, inout ReflectedLight reflectedLight ) {\\n\\t#ifndef STANDARD\\n\\t\\tfloat dotNV = saturate( dot( geometry.normal, geometry.viewDir ) );\\n\\t\\tfloat dotNL = dotNV;\\n\\t\\tfloat clearCoatDHR = material.clearCoat * clearCoatDHRApprox( material.clearCoatRoughness, dotNL );\\n\\t#else\\n\\t\\tfloat clearCoatDHR = 0.0;\\n\\t#endif\\n\\treflectedLight.indirectSpecular += ( 1.0 - clearCoatDHR ) * radiance * BRDF_Specular_GGX_Environment( geometry, material.specularColor, material.specularRoughness );\\n\\t#ifndef STANDARD\\n\\t\\treflectedLight.indirectSpecular += clearCoatRadiance * material.clearCoat * BRDF_Specular_GGX_Environment( geometry, vec3( DEFAULT_SPECULAR_COEFFICIENT ), material.clearCoatRoughness );\\n\\t#endif\\n}\\n#define RE_Direct\\t\\t\\t\\tRE_Direct_Physical\\n#define RE_Direct_RectArea\\t\\tRE_Direct_RectArea_Physical\\n#define RE_IndirectDiffuse\\t\\tRE_IndirectDiffuse_Physical\\n#define RE_IndirectSpecular\\t\\tRE_IndirectSpecular_Physical\\n#define Material_BlinnShininessExponent( material )   GGXRoughnessToBlinnExponent( material.specularRoughness )\\n#define Material_ClearCoat_BlinnShininessExponent( material )   GGXRoughnessToBlinnExponent( material.clearCoatRoughness )\\nfloat computeSpecularOcclusion( const in float dotNV, const in float ambientOcclusion, const in float roughness ) {\\n\\treturn saturate( pow( dotNV + ambientOcclusion, exp2( - 16.0 * roughness - 1.0 ) ) - 1.0 + ambientOcclusion );\\n}\\n\";\r\n\r\nvar lights_template = \"\\nGeometricContext geometry;\\ngeometry.position = - vViewPosition;\\ngeometry.normal = normal;\\ngeometry.viewDir = normalize( vViewPosition );\\nIncidentLight directLight;\\n#if ( NUM_POINT_LIGHTS > 0 ) && defined( RE_Direct )\\n\\tPointLight pointLight;\\n\\tfor ( int i = 0; i < NUM_POINT_LIGHTS; i ++ ) {\\n\\t\\tpointLight = pointLights[ i ];\\n\\t\\tgetPointDirectLightIrradiance( pointLight, geometry, directLight );\\n\\t\\t#ifdef USE_SHADOWMAP\\n\\t\\tdirectLight.color *= all( bvec2( pointLight.shadow, directLight.visible ) ) ? getPointShadow( pointShadowMap[ i ], pointLight.shadowMapSize, pointLight.shadowBias, pointLight.shadowRadius, vPointShadowCoord[ i ] ) : 1.0;\\n\\t\\t#endif\\n\\t\\tRE_Direct( directLight, geometry, material, reflectedLight );\\n\\t}\\n#endif\\n#if ( NUM_SPOT_LIGHTS > 0 ) && defined( RE_Direct )\\n\\tSpotLight spotLight;\\n\\tfor ( int i = 0; i < NUM_SPOT_LIGHTS; i ++ ) {\\n\\t\\tspotLight = spotLights[ i ];\\n\\t\\tgetSpotDirectLightIrradiance( spotLight, geometry, directLight );\\n\\t\\t#ifdef USE_SHADOWMAP\\n\\t\\tdirectLight.color *= all( bvec2( spotLight.shadow, directLight.visible ) ) ? getShadow( spotShadowMap[ i ], spotLight.shadowMapSize, spotLight.shadowBias, spotLight.shadowRadius, vSpotShadowCoord[ i ] ) : 1.0;\\n\\t\\t#endif\\n\\t\\tRE_Direct( directLight, geometry, material, reflectedLight );\\n\\t}\\n#endif\\n#if ( NUM_DIR_LIGHTS > 0 ) && defined( RE_Direct )\\n\\tDirectionalLight directionalLight;\\n\\tfor ( int i = 0; i < NUM_DIR_LIGHTS; i ++ ) {\\n\\t\\tdirectionalLight = directionalLights[ i ];\\n\\t\\tgetDirectionalDirectLightIrradiance( directionalLight, geometry, directLight );\\n\\t\\t#ifdef USE_SHADOWMAP\\n\\t\\tdirectLight.color *= all( bvec2( directionalLight.shadow, directLight.visible ) ) ? getShadow( directionalShadowMap[ i ], directionalLight.shadowMapSize, directionalLight.shadowBias, directionalLight.shadowRadius, vDirectionalShadowCoord[ i ] ) : 1.0;\\n\\t\\t#endif\\n\\t\\tRE_Direct( directLight, geometry, material, reflectedLight );\\n\\t}\\n#endif\\n#if ( NUM_RECT_AREA_LIGHTS > 0 ) && defined( RE_Direct_RectArea )\\n\\tRectAreaLight rectAreaLight;\\n\\tfor ( int i = 0; i < NUM_RECT_AREA_LIGHTS; i ++ ) {\\n\\t\\trectAreaLight = rectAreaLights[ i ];\\n\\t\\tRE_Direct_RectArea( rectAreaLight, geometry, material, reflectedLight );\\n\\t}\\n#endif\\n#if defined( RE_IndirectDiffuse )\\n\\tvec3 irradiance = getAmbientLightIrradiance( ambientLightColor );\\n\\t#ifdef USE_LIGHTMAP\\n\\t\\tvec3 lightMapIrradiance = texture2D( lightMap, vUv2 ).xyz * lightMapIntensity;\\n\\t\\t#ifndef PHYSICALLY_CORRECT_LIGHTS\\n\\t\\t\\tlightMapIrradiance *= PI;\\n\\t\\t#endif\\n\\t\\tirradiance += lightMapIrradiance;\\n\\t#endif\\n\\t#if ( NUM_HEMI_LIGHTS > 0 )\\n\\t\\tfor ( int i = 0; i < NUM_HEMI_LIGHTS; i ++ ) {\\n\\t\\t\\tirradiance += getHemisphereLightIrradiance( hemisphereLights[ i ], geometry );\\n\\t\\t}\\n\\t#endif\\n\\t#if defined( USE_ENVMAP ) && defined( PHYSICAL ) && defined( ENVMAP_TYPE_CUBE_UV )\\n\\t\\tirradiance += getLightProbeIndirectIrradiance( geometry, 8 );\\n\\t#endif\\n\\tRE_IndirectDiffuse( irradiance, geometry, material, reflectedLight );\\n#endif\\n#if defined( USE_ENVMAP ) && defined( RE_IndirectSpecular )\\n\\tvec3 radiance = getLightProbeIndirectRadiance( geometry, Material_BlinnShininessExponent( material ), 8 );\\n\\t#ifndef STANDARD\\n\\t\\tvec3 clearCoatRadiance = getLightProbeIndirectRadiance( geometry, Material_ClearCoat_BlinnShininessExponent( material ), 8 );\\n\\t#else\\n\\t\\tvec3 clearCoatRadiance = vec3( 0.0 );\\n\\t#endif\\n\\tRE_IndirectSpecular( radiance, clearCoatRadiance, geometry, material, reflectedLight );\\n#endif\\n\";\r\n\r\nvar logdepthbuf_fragment = \"#if defined(USE_LOGDEPTHBUF) && defined(USE_LOGDEPTHBUF_EXT)\\n\\tgl_FragDepthEXT = log2(vFragDepth) * logDepthBufFC * 0.5;\\n#endif\";\r\n\r\nvar logdepthbuf_pars_fragment = \"#ifdef USE_LOGDEPTHBUF\\n\\tuniform float logDepthBufFC;\\n\\t#ifdef USE_LOGDEPTHBUF_EXT\\n\\t\\tvarying float vFragDepth;\\n\\t#endif\\n#endif\\n\";\r\n\r\nvar logdepthbuf_pars_vertex = \"#ifdef USE_LOGDEPTHBUF\\n\\t#ifdef USE_LOGDEPTHBUF_EXT\\n\\t\\tvarying float vFragDepth;\\n\\t#endif\\n\\tuniform float logDepthBufFC;\\n#endif\";\r\n\r\nvar logdepthbuf_vertex = \"#ifdef USE_LOGDEPTHBUF\\n\\tgl_Position.z = log2(max( EPSILON, gl_Position.w + 1.0 )) * logDepthBufFC;\\n\\t#ifdef USE_LOGDEPTHBUF_EXT\\n\\t\\tvFragDepth = 1.0 + gl_Position.w;\\n\\t#else\\n\\t\\tgl_Position.z = (gl_Position.z - 1.0) * gl_Position.w;\\n\\t#endif\\n#endif\\n\";\r\n\r\nvar map_fragment = \"#ifdef USE_MAP\\n\\tvec4 texelColor = texture2D( map, vUv );\\n\\ttexelColor = mapTexelToLinear( texelColor );\\n\\tdiffuseColor *= texelColor;\\n#endif\\n\";\r\n\r\nvar map_pars_fragment = \"#ifdef USE_MAP\\n\\tuniform sampler2D map;\\n#endif\\n\";\r\n\r\nvar map_particle_fragment = \"#ifdef USE_MAP\\n\\tvec4 mapTexel = texture2D( map, vec2( gl_PointCoord.x, 1.0 - gl_PointCoord.y ) * offsetRepeat.zw + offsetRepeat.xy );\\n\\tdiffuseColor *= mapTexelToLinear( mapTexel );\\n#endif\\n\";\r\n\r\nvar map_particle_pars_fragment = \"#ifdef USE_MAP\\n\\tuniform vec4 offsetRepeat;\\n\\tuniform sampler2D map;\\n#endif\\n\";\r\n\r\nvar metalnessmap_fragment = \"float metalnessFactor = metalness;\\n#ifdef USE_METALNESSMAP\\n\\tvec4 texelMetalness = texture2D( metalnessMap, vUv );\\n\\tmetalnessFactor *= texelMetalness.b;\\n#endif\\n\";\r\n\r\nvar metalnessmap_pars_fragment = \"#ifdef USE_METALNESSMAP\\n\\tuniform sampler2D metalnessMap;\\n#endif\";\r\n\r\nvar morphnormal_vertex = \"#ifdef USE_MORPHNORMALS\\n\\tobjectNormal += ( morphNormal0 - normal ) * morphTargetInfluences[ 0 ];\\n\\tobjectNormal += ( morphNormal1 - normal ) * morphTargetInfluences[ 1 ];\\n\\tobjectNormal += ( morphNormal2 - normal ) * morphTargetInfluences[ 2 ];\\n\\tobjectNormal += ( morphNormal3 - normal ) * morphTargetInfluences[ 3 ];\\n#endif\\n\";\r\n\r\nvar morphtarget_pars_vertex = \"#ifdef USE_MORPHTARGETS\\n\\t#ifndef USE_MORPHNORMALS\\n\\tuniform float morphTargetInfluences[ 8 ];\\n\\t#else\\n\\tuniform float morphTargetInfluences[ 4 ];\\n\\t#endif\\n#endif\";\r\n\r\nvar morphtarget_vertex = \"#ifdef USE_MORPHTARGETS\\n\\ttransformed += ( morphTarget0 - position ) * morphTargetInfluences[ 0 ];\\n\\ttransformed += ( morphTarget1 - position ) * morphTargetInfluences[ 1 ];\\n\\ttransformed += ( morphTarget2 - position ) * morphTargetInfluences[ 2 ];\\n\\ttransformed += ( morphTarget3 - position ) * morphTargetInfluences[ 3 ];\\n\\t#ifndef USE_MORPHNORMALS\\n\\ttransformed += ( morphTarget4 - position ) * morphTargetInfluences[ 4 ];\\n\\ttransformed += ( morphTarget5 - position ) * morphTargetInfluences[ 5 ];\\n\\ttransformed += ( morphTarget6 - position ) * morphTargetInfluences[ 6 ];\\n\\ttransformed += ( morphTarget7 - position ) * morphTargetInfluences[ 7 ];\\n\\t#endif\\n#endif\\n\";\r\n\r\nvar normal_flip = \"#ifdef DOUBLE_SIDED\\n\\tfloat flipNormal = ( float( gl_FrontFacing ) * 2.0 - 1.0 );\\n#else\\n\\tfloat flipNormal = 1.0;\\n#endif\\n\";\r\n\r\nvar normal_fragment = \"#ifdef FLAT_SHADED\\n\\tvec3 fdx = vec3( dFdx( vViewPosition.x ), dFdx( vViewPosition.y ), dFdx( vViewPosition.z ) );\\n\\tvec3 fdy = vec3( dFdy( vViewPosition.x ), dFdy( vViewPosition.y ), dFdy( vViewPosition.z ) );\\n\\tvec3 normal = normalize( cross( fdx, fdy ) );\\n#else\\n\\tvec3 normal = normalize( vNormal ) * flipNormal;\\n#endif\\n#ifdef USE_NORMALMAP\\n\\tnormal = perturbNormal2Arb( -vViewPosition, normal );\\n#elif defined( USE_BUMPMAP )\\n\\tnormal = perturbNormalArb( -vViewPosition, normal, dHdxy_fwd() );\\n#endif\\n\";\r\n\r\nvar normalmap_pars_fragment = \"#ifdef USE_NORMALMAP\\n\\tuniform sampler2D normalMap;\\n\\tuniform vec2 normalScale;\\n\\tvec3 perturbNormal2Arb( vec3 eye_pos, vec3 surf_norm ) {\\n\\t\\tvec3 q0 = vec3( dFdx( eye_pos.x ), dFdx( eye_pos.y ), dFdx( eye_pos.z ) );\\n\\t\\tvec3 q1 = vec3( dFdy( eye_pos.x ), dFdy( eye_pos.y ), dFdy( eye_pos.z ) );\\n\\t\\tvec2 st0 = dFdx( vUv.st );\\n\\t\\tvec2 st1 = dFdy( vUv.st );\\n\\t\\tvec3 S = normalize( q0 * st1.t - q1 * st0.t );\\n\\t\\tvec3 T = normalize( -q0 * st1.s + q1 * st0.s );\\n\\t\\tvec3 N = normalize( surf_norm );\\n\\t\\tvec3 mapN = texture2D( normalMap, vUv ).xyz * 2.0 - 1.0;\\n\\t\\tmapN.xy = normalScale * mapN.xy;\\n\\t\\tmat3 tsn = mat3( S, T, N );\\n\\t\\treturn normalize( tsn * mapN );\\n\\t}\\n#endif\\n\";\r\n\r\nvar packing = \"vec3 packNormalToRGB( const in vec3 normal ) {\\n\\treturn normalize( normal ) * 0.5 + 0.5;\\n}\\nvec3 unpackRGBToNormal( const in vec3 rgb ) {\\n\\treturn 1.0 - 2.0 * rgb.xyz;\\n}\\nconst float PackUpscale = 256. / 255.;const float UnpackDownscale = 255. / 256.;\\nconst vec3 PackFactors = vec3( 256. * 256. * 256., 256. * 256.,  256. );\\nconst vec4 UnpackFactors = UnpackDownscale / vec4( PackFactors, 1. );\\nconst float ShiftRight8 = 1. / 256.;\\nvec4 packDepthToRGBA( const in float v ) {\\n\\tvec4 r = vec4( fract( v * PackFactors ), v );\\n\\tr.yzw -= r.xyz * ShiftRight8;\\treturn r * PackUpscale;\\n}\\nfloat unpackRGBAToDepth( const in vec4 v ) {\\n\\treturn dot( v, UnpackFactors );\\n}\\nfloat viewZToOrthographicDepth( const in float viewZ, const in float near, const in float far ) {\\n\\treturn ( viewZ + near ) / ( near - far );\\n}\\nfloat orthographicDepthToViewZ( const in float linearClipZ, const in float near, const in float far ) {\\n\\treturn linearClipZ * ( near - far ) - near;\\n}\\nfloat viewZToPerspectiveDepth( const in float viewZ, const in float near, const in float far ) {\\n\\treturn (( near + viewZ ) * far ) / (( far - near ) * viewZ );\\n}\\nfloat perspectiveDepthToViewZ( const in float invClipZ, const in float near, const in float far ) {\\n\\treturn ( near * far ) / ( ( far - near ) * invClipZ - far );\\n}\\n\";\r\n\r\nvar premultiplied_alpha_fragment = \"#ifdef PREMULTIPLIED_ALPHA\\n\\tgl_FragColor.rgb *= gl_FragColor.a;\\n#endif\\n\";\r\n\r\nvar project_vertex = \"vec4 mvPosition = modelViewMatrix * vec4( transformed, 1.0 );\\ngl_Position = projectionMatrix * mvPosition;\\n\";\r\n\r\nvar dithering_fragment = \"#if defined( DITHERING )\\n  gl_FragColor.rgb = dithering( gl_FragColor.rgb );\\n#endif\\n\";\r\n\r\nvar dithering_pars_fragment = \"#if defined( DITHERING )\\n\\tvec3 dithering( vec3 color ) {\\n\\t\\tfloat grid_position = rand( gl_FragCoord.xy );\\n\\t\\tvec3 dither_shift_RGB = vec3( 0.25 / 255.0, -0.25 / 255.0, 0.25 / 255.0 );\\n\\t\\tdither_shift_RGB = mix( 2.0 * dither_shift_RGB, -2.0 * dither_shift_RGB, grid_position );\\n\\t\\treturn color + dither_shift_RGB;\\n\\t}\\n#endif\\n\";\r\n\r\nvar roughnessmap_fragment = \"float roughnessFactor = roughness;\\n#ifdef USE_ROUGHNESSMAP\\n\\tvec4 texelRoughness = texture2D( roughnessMap, vUv );\\n\\troughnessFactor *= texelRoughness.g;\\n#endif\\n\";\r\n\r\nvar roughnessmap_pars_fragment = \"#ifdef USE_ROUGHNESSMAP\\n\\tuniform sampler2D roughnessMap;\\n#endif\";\r\n\r\nvar shadowmap_pars_fragment = \"#ifdef USE_SHADOWMAP\\n\\t#if NUM_DIR_LIGHTS > 0\\n\\t\\tuniform sampler2D directionalShadowMap[ NUM_DIR_LIGHTS ];\\n\\t\\tvarying vec4 vDirectionalShadowCoord[ NUM_DIR_LIGHTS ];\\n\\t#endif\\n\\t#if NUM_SPOT_LIGHTS > 0\\n\\t\\tuniform sampler2D spotShadowMap[ NUM_SPOT_LIGHTS ];\\n\\t\\tvarying vec4 vSpotShadowCoord[ NUM_SPOT_LIGHTS ];\\n\\t#endif\\n\\t#if NUM_POINT_LIGHTS > 0\\n\\t\\tuniform sampler2D pointShadowMap[ NUM_POINT_LIGHTS ];\\n\\t\\tvarying vec4 vPointShadowCoord[ NUM_POINT_LIGHTS ];\\n\\t#endif\\n\\tfloat texture2DCompare( sampler2D depths, vec2 uv, float compare ) {\\n\\t\\treturn step( compare, unpackRGBAToDepth( texture2D( depths, uv ) ) );\\n\\t}\\n\\tfloat texture2DShadowLerp( sampler2D depths, vec2 size, vec2 uv, float compare ) {\\n\\t\\tconst vec2 offset = vec2( 0.0, 1.0 );\\n\\t\\tvec2 texelSize = vec2( 1.0 ) / size;\\n\\t\\tvec2 centroidUV = floor( uv * size + 0.5 ) / size;\\n\\t\\tfloat lb = texture2DCompare( depths, centroidUV + texelSize * offset.xx, compare );\\n\\t\\tfloat lt = texture2DCompare( depths, centroidUV + texelSize * offset.xy, compare );\\n\\t\\tfloat rb = texture2DCompare( depths, centroidUV + texelSize * offset.yx, compare );\\n\\t\\tfloat rt = texture2DCompare( depths, centroidUV + texelSize * offset.yy, compare );\\n\\t\\tvec2 f = fract( uv * size + 0.5 );\\n\\t\\tfloat a = mix( lb, lt, f.y );\\n\\t\\tfloat b = mix( rb, rt, f.y );\\n\\t\\tfloat c = mix( a, b, f.x );\\n\\t\\treturn c;\\n\\t}\\n\\tfloat getShadow( sampler2D shadowMap, vec2 shadowMapSize, float shadowBias, float shadowRadius, vec4 shadowCoord ) {\\n\\t\\tfloat shadow = 1.0;\\n\\t\\tshadowCoord.xyz /= shadowCoord.w;\\n\\t\\tshadowCoord.z += shadowBias;\\n\\t\\tbvec4 inFrustumVec = bvec4 ( shadowCoord.x >= 0.0, shadowCoord.x <= 1.0, shadowCoord.y >= 0.0, shadowCoord.y <= 1.0 );\\n\\t\\tbool inFrustum = all( inFrustumVec );\\n\\t\\tbvec2 frustumTestVec = bvec2( inFrustum, shadowCoord.z <= 1.0 );\\n\\t\\tbool frustumTest = all( frustumTestVec );\\n\\t\\tif ( frustumTest ) {\\n\\t\\t#if defined( SHADOWMAP_TYPE_PCF )\\n\\t\\t\\tvec2 texelSize = vec2( 1.0 ) / shadowMapSize;\\n\\t\\t\\tfloat dx0 = - texelSize.x * shadowRadius;\\n\\t\\t\\tfloat dy0 = - texelSize.y * shadowRadius;\\n\\t\\t\\tfloat dx1 = + texelSize.x * shadowRadius;\\n\\t\\t\\tfloat dy1 = + texelSize.y * shadowRadius;\\n\\t\\t\\tshadow = (\\n\\t\\t\\t\\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx0, dy0 ), shadowCoord.z ) +\\n\\t\\t\\t\\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( 0.0, dy0 ), shadowCoord.z ) +\\n\\t\\t\\t\\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx1, dy0 ), shadowCoord.z ) +\\n\\t\\t\\t\\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx0, 0.0 ), shadowCoord.z ) +\\n\\t\\t\\t\\ttexture2DCompare( shadowMap, shadowCoord.xy, shadowCoord.z ) +\\n\\t\\t\\t\\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx1, 0.0 ), shadowCoord.z ) +\\n\\t\\t\\t\\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx0, dy1 ), shadowCoord.z ) +\\n\\t\\t\\t\\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( 0.0, dy1 ), shadowCoord.z ) +\\n\\t\\t\\t\\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx1, dy1 ), shadowCoord.z )\\n\\t\\t\\t) * ( 1.0 / 9.0 );\\n\\t\\t#elif defined( SHADOWMAP_TYPE_PCF_SOFT )\\n\\t\\t\\tvec2 texelSize = vec2( 1.0 ) / shadowMapSize;\\n\\t\\t\\tfloat dx0 = - texelSize.x * shadowRadius;\\n\\t\\t\\tfloat dy0 = - texelSize.y * shadowRadius;\\n\\t\\t\\tfloat dx1 = + texelSize.x * shadowRadius;\\n\\t\\t\\tfloat dy1 = + texelSize.y * shadowRadius;\\n\\t\\t\\tshadow = (\\n\\t\\t\\t\\ttexture2DShadowLerp( shadowMap, shadowMapSize, shadowCoord.xy + vec2( dx0, dy0 ), shadowCoord.z ) +\\n\\t\\t\\t\\ttexture2DShadowLerp( shadowMap, shadowMapSize, shadowCoord.xy + vec2( 0.0, dy0 ), shadowCoord.z ) +\\n\\t\\t\\t\\ttexture2DShadowLerp( shadowMap, shadowMapSize, shadowCoord.xy + vec2( dx1, dy0 ), shadowCoord.z ) +\\n\\t\\t\\t\\ttexture2DShadowLerp( shadowMap, shadowMapSize, shadowCoord.xy + vec2( dx0, 0.0 ), shadowCoord.z ) +\\n\\t\\t\\t\\ttexture2DShadowLerp( shadowMap, shadowMapSize, shadowCoord.xy, shadowCoord.z ) +\\n\\t\\t\\t\\ttexture2DShadowLerp( shadowMap, shadowMapSize, shadowCoord.xy + vec2( dx1, 0.0 ), shadowCoord.z ) +\\n\\t\\t\\t\\ttexture2DShadowLerp( shadowMap, shadowMapSize, shadowCoord.xy + vec2( dx0, dy1 ), shadowCoord.z ) +\\n\\t\\t\\t\\ttexture2DShadowLerp( shadowMap, shadowMapSize, shadowCoord.xy + vec2( 0.0, dy1 ), shadowCoord.z ) +\\n\\t\\t\\t\\ttexture2DShadowLerp( shadowMap, shadowMapSize, shadowCoord.xy + vec2( dx1, dy1 ), shadowCoord.z )\\n\\t\\t\\t) * ( 1.0 / 9.0 );\\n\\t\\t#else\\n\\t\\t\\tshadow = texture2DCompare( shadowMap, shadowCoord.xy, shadowCoord.z );\\n\\t\\t#endif\\n\\t\\t}\\n\\t\\treturn shadow;\\n\\t}\\n\\tvec2 cubeToUV( vec3 v, float texelSizeY ) {\\n\\t\\tvec3 absV = abs( v );\\n\\t\\tfloat scaleToCube = 1.0 / max( absV.x, max( absV.y, absV.z ) );\\n\\t\\tabsV *= scaleToCube;\\n\\t\\tv *= scaleToCube * ( 1.0 - 2.0 * texelSizeY );\\n\\t\\tvec2 planar = v.xy;\\n\\t\\tfloat almostATexel = 1.5 * texelSizeY;\\n\\t\\tfloat almostOne = 1.0 - almostATexel;\\n\\t\\tif ( absV.z >= almostOne ) {\\n\\t\\t\\tif ( v.z > 0.0 )\\n\\t\\t\\t\\tplanar.x = 4.0 - v.x;\\n\\t\\t} else if ( absV.x >= almostOne ) {\\n\\t\\t\\tfloat signX = sign( v.x );\\n\\t\\t\\tplanar.x = v.z * signX + 2.0 * signX;\\n\\t\\t} else if ( absV.y >= almostOne ) {\\n\\t\\t\\tfloat signY = sign( v.y );\\n\\t\\t\\tplanar.x = v.x + 2.0 * signY + 2.0;\\n\\t\\t\\tplanar.y = v.z * signY - 2.0;\\n\\t\\t}\\n\\t\\treturn vec2( 0.125, 0.25 ) * planar + vec2( 0.375, 0.75 );\\n\\t}\\n\\tfloat getPointShadow( sampler2D shadowMap, vec2 shadowMapSize, float shadowBias, float shadowRadius, vec4 shadowCoord ) {\\n\\t\\tvec2 texelSize = vec2( 1.0 ) / ( shadowMapSize * vec2( 4.0, 2.0 ) );\\n\\t\\tvec3 lightToPosition = shadowCoord.xyz;\\n\\t\\tvec3 bd3D = normalize( lightToPosition );\\n\\t\\tfloat dp = ( length( lightToPosition ) - shadowBias ) / 1000.0;\\n\\t\\t#if defined( SHADOWMAP_TYPE_PCF ) || defined( SHADOWMAP_TYPE_PCF_SOFT )\\n\\t\\t\\tvec2 offset = vec2( - 1, 1 ) * shadowRadius * texelSize.y;\\n\\t\\t\\treturn (\\n\\t\\t\\t\\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.xyy, texelSize.y ), dp ) +\\n\\t\\t\\t\\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.yyy, texelSize.y ), dp ) +\\n\\t\\t\\t\\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.xyx, texelSize.y ), dp ) +\\n\\t\\t\\t\\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.yyx, texelSize.y ), dp ) +\\n\\t\\t\\t\\ttexture2DCompare( shadowMap, cubeToUV( bd3D, texelSize.y ), dp ) +\\n\\t\\t\\t\\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.xxy, texelSize.y ), dp ) +\\n\\t\\t\\t\\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.yxy, texelSize.y ), dp ) +\\n\\t\\t\\t\\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.xxx, texelSize.y ), dp ) +\\n\\t\\t\\t\\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.yxx, texelSize.y ), dp )\\n\\t\\t\\t) * ( 1.0 / 9.0 );\\n\\t\\t#else\\n\\t\\t\\treturn texture2DCompare( shadowMap, cubeToUV( bd3D, texelSize.y ), dp );\\n\\t\\t#endif\\n\\t}\\n#endif\\n\";\r\n\r\nvar shadowmap_pars_vertex = \"#ifdef USE_SHADOWMAP\\n\\t#if NUM_DIR_LIGHTS > 0\\n\\t\\tuniform mat4 directionalShadowMatrix[ NUM_DIR_LIGHTS ];\\n\\t\\tvarying vec4 vDirectionalShadowCoord[ NUM_DIR_LIGHTS ];\\n\\t#endif\\n\\t#if NUM_SPOT_LIGHTS > 0\\n\\t\\tuniform mat4 spotShadowMatrix[ NUM_SPOT_LIGHTS ];\\n\\t\\tvarying vec4 vSpotShadowCoord[ NUM_SPOT_LIGHTS ];\\n\\t#endif\\n\\t#if NUM_POINT_LIGHTS > 0\\n\\t\\tuniform mat4 pointShadowMatrix[ NUM_POINT_LIGHTS ];\\n\\t\\tvarying vec4 vPointShadowCoord[ NUM_POINT_LIGHTS ];\\n\\t#endif\\n#endif\\n\";\r\n\r\nvar shadowmap_vertex = \"#ifdef USE_SHADOWMAP\\n\\t#if NUM_DIR_LIGHTS > 0\\n\\tfor ( int i = 0; i < NUM_DIR_LIGHTS; i ++ ) {\\n\\t\\tvDirectionalShadowCoord[ i ] = directionalShadowMatrix[ i ] * worldPosition;\\n\\t}\\n\\t#endif\\n\\t#if NUM_SPOT_LIGHTS > 0\\n\\tfor ( int i = 0; i < NUM_SPOT_LIGHTS; i ++ ) {\\n\\t\\tvSpotShadowCoord[ i ] = spotShadowMatrix[ i ] * worldPosition;\\n\\t}\\n\\t#endif\\n\\t#if NUM_POINT_LIGHTS > 0\\n\\tfor ( int i = 0; i < NUM_POINT_LIGHTS; i ++ ) {\\n\\t\\tvPointShadowCoord[ i ] = pointShadowMatrix[ i ] * worldPosition;\\n\\t}\\n\\t#endif\\n#endif\\n\";\r\n\r\nvar shadowmask_pars_fragment = \"float getShadowMask() {\\n\\tfloat shadow = 1.0;\\n\\t#ifdef USE_SHADOWMAP\\n\\t#if NUM_DIR_LIGHTS > 0\\n\\tDirectionalLight directionalLight;\\n\\tfor ( int i = 0; i < NUM_DIR_LIGHTS; i ++ ) {\\n\\t\\tdirectionalLight = directionalLights[ i ];\\n\\t\\tshadow *= bool( directionalLight.shadow ) ? getShadow( directionalShadowMap[ i ], directionalLight.shadowMapSize, directionalLight.shadowBias, directionalLight.shadowRadius, vDirectionalShadowCoord[ i ] ) : 1.0;\\n\\t}\\n\\t#endif\\n\\t#if NUM_SPOT_LIGHTS > 0\\n\\tSpotLight spotLight;\\n\\tfor ( int i = 0; i < NUM_SPOT_LIGHTS; i ++ ) {\\n\\t\\tspotLight = spotLights[ i ];\\n\\t\\tshadow *= bool( spotLight.shadow ) ? getShadow( spotShadowMap[ i ], spotLight.shadowMapSize, spotLight.shadowBias, spotLight.shadowRadius, vSpotShadowCoord[ i ] ) : 1.0;\\n\\t}\\n\\t#endif\\n\\t#if NUM_POINT_LIGHTS > 0\\n\\tPointLight pointLight;\\n\\tfor ( int i = 0; i < NUM_POINT_LIGHTS; i ++ ) {\\n\\t\\tpointLight = pointLights[ i ];\\n\\t\\tshadow *= bool( pointLight.shadow ) ? getPointShadow( pointShadowMap[ i ], pointLight.shadowMapSize, pointLight.shadowBias, pointLight.shadowRadius, vPointShadowCoord[ i ] ) : 1.0;\\n\\t}\\n\\t#endif\\n\\t#endif\\n\\treturn shadow;\\n}\\n\";\r\n\r\nvar skinbase_vertex = \"#ifdef USE_SKINNING\\n\\tmat4 boneMatX = getBoneMatrix( skinIndex.x );\\n\\tmat4 boneMatY = getBoneMatrix( skinIndex.y );\\n\\tmat4 boneMatZ = getBoneMatrix( skinIndex.z );\\n\\tmat4 boneMatW = getBoneMatrix( skinIndex.w );\\n#endif\";\r\n\r\nvar skinning_pars_vertex = \"#ifdef USE_SKINNING\\n\\tuniform mat4 bindMatrix;\\n\\tuniform mat4 bindMatrixInverse;\\n\\t#ifdef BONE_TEXTURE\\n\\t\\tuniform sampler2D boneTexture;\\n\\t\\tuniform int boneTextureSize;\\n\\t\\tmat4 getBoneMatrix( const in float i ) {\\n\\t\\t\\tfloat j = i * 4.0;\\n\\t\\t\\tfloat x = mod( j, float( boneTextureSize ) );\\n\\t\\t\\tfloat y = floor( j / float( boneTextureSize ) );\\n\\t\\t\\tfloat dx = 1.0 / float( boneTextureSize );\\n\\t\\t\\tfloat dy = 1.0 / float( boneTextureSize );\\n\\t\\t\\ty = dy * ( y + 0.5 );\\n\\t\\t\\tvec4 v1 = texture2D( boneTexture, vec2( dx * ( x + 0.5 ), y ) );\\n\\t\\t\\tvec4 v2 = texture2D( boneTexture, vec2( dx * ( x + 1.5 ), y ) );\\n\\t\\t\\tvec4 v3 = texture2D( boneTexture, vec2( dx * ( x + 2.5 ), y ) );\\n\\t\\t\\tvec4 v4 = texture2D( boneTexture, vec2( dx * ( x + 3.5 ), y ) );\\n\\t\\t\\tmat4 bone = mat4( v1, v2, v3, v4 );\\n\\t\\t\\treturn bone;\\n\\t\\t}\\n\\t#else\\n\\t\\tuniform mat4 boneMatrices[ MAX_BONES ];\\n\\t\\tmat4 getBoneMatrix( const in float i ) {\\n\\t\\t\\tmat4 bone = boneMatrices[ int(i) ];\\n\\t\\t\\treturn bone;\\n\\t\\t}\\n\\t#endif\\n#endif\\n\";\r\n\r\nvar skinning_vertex = \"#ifdef USE_SKINNING\\n\\tvec4 skinVertex = bindMatrix * vec4( transformed, 1.0 );\\n\\tvec4 skinned = vec4( 0.0 );\\n\\tskinned += boneMatX * skinVertex * skinWeight.x;\\n\\tskinned += boneMatY * skinVertex * skinWeight.y;\\n\\tskinned += boneMatZ * skinVertex * skinWeight.z;\\n\\tskinned += boneMatW * skinVertex * skinWeight.w;\\n\\ttransformed = ( bindMatrixInverse * skinned ).xyz;\\n#endif\\n\";\r\n\r\nvar skinnormal_vertex = \"#ifdef USE_SKINNING\\n\\tmat4 skinMatrix = mat4( 0.0 );\\n\\tskinMatrix += skinWeight.x * boneMatX;\\n\\tskinMatrix += skinWeight.y * boneMatY;\\n\\tskinMatrix += skinWeight.z * boneMatZ;\\n\\tskinMatrix += skinWeight.w * boneMatW;\\n\\tskinMatrix  = bindMatrixInverse * skinMatrix * bindMatrix;\\n\\tobjectNormal = vec4( skinMatrix * vec4( objectNormal, 0.0 ) ).xyz;\\n#endif\\n\";\r\n\r\nvar specularmap_fragment = \"float specularStrength;\\n#ifdef USE_SPECULARMAP\\n\\tvec4 texelSpecular = texture2D( specularMap, vUv );\\n\\tspecularStrength = texelSpecular.r;\\n#else\\n\\tspecularStrength = 1.0;\\n#endif\";\r\n\r\nvar specularmap_pars_fragment = \"#ifdef USE_SPECULARMAP\\n\\tuniform sampler2D specularMap;\\n#endif\";\r\n\r\nvar tonemapping_fragment = \"#if defined( TONE_MAPPING )\\n  gl_FragColor.rgb = toneMapping( gl_FragColor.rgb );\\n#endif\\n\";\r\n\r\nvar tonemapping_pars_fragment = \"#define saturate(a) clamp( a, 0.0, 1.0 )\\nuniform float toneMappingExposure;\\nuniform float toneMappingWhitePoint;\\nvec3 LinearToneMapping( vec3 color ) {\\n\\treturn toneMappingExposure * color;\\n}\\nvec3 ReinhardToneMapping( vec3 color ) {\\n\\tcolor *= toneMappingExposure;\\n\\treturn saturate( color / ( vec3( 1.0 ) + color ) );\\n}\\n#define Uncharted2Helper( x ) max( ( ( x * ( 0.15 * x + 0.10 * 0.50 ) + 0.20 * 0.02 ) / ( x * ( 0.15 * x + 0.50 ) + 0.20 * 0.30 ) ) - 0.02 / 0.30, vec3( 0.0 ) )\\nvec3 Uncharted2ToneMapping( vec3 color ) {\\n\\tcolor *= toneMappingExposure;\\n\\treturn saturate( Uncharted2Helper( color ) / Uncharted2Helper( vec3( toneMappingWhitePoint ) ) );\\n}\\nvec3 OptimizedCineonToneMapping( vec3 color ) {\\n\\tcolor *= toneMappingExposure;\\n\\tcolor = max( vec3( 0.0 ), color - 0.004 );\\n\\treturn pow( ( color * ( 6.2 * color + 0.5 ) ) / ( color * ( 6.2 * color + 1.7 ) + 0.06 ), vec3( 2.2 ) );\\n}\\n\";\r\n\r\nvar uv_pars_fragment = \"#if defined( USE_MAP ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( USE_SPECULARMAP ) || defined( USE_ALPHAMAP ) || defined( USE_EMISSIVEMAP ) || defined( USE_ROUGHNESSMAP ) || defined( USE_METALNESSMAP )\\n\\tvarying vec2 vUv;\\n#endif\";\r\n\r\nvar uv_pars_vertex = \"#if defined( USE_MAP ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( USE_SPECULARMAP ) || defined( USE_ALPHAMAP ) || defined( USE_EMISSIVEMAP ) || defined( USE_ROUGHNESSMAP ) || defined( USE_METALNESSMAP )\\n\\tvarying vec2 vUv;\\n\\tuniform vec4 offsetRepeat;\\n#endif\\n\";\r\n\r\nvar uv_vertex = \"#if defined( USE_MAP ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( USE_SPECULARMAP ) || defined( USE_ALPHAMAP ) || defined( USE_EMISSIVEMAP ) || defined( USE_ROUGHNESSMAP ) || defined( USE_METALNESSMAP )\\n\\tvUv = uv * offsetRepeat.zw + offsetRepeat.xy;\\n#endif\";\r\n\r\nvar uv2_pars_fragment = \"#if defined( USE_LIGHTMAP ) || defined( USE_AOMAP )\\n\\tvarying vec2 vUv2;\\n#endif\";\r\n\r\nvar uv2_pars_vertex = \"#if defined( USE_LIGHTMAP ) || defined( USE_AOMAP )\\n\\tattribute vec2 uv2;\\n\\tvarying vec2 vUv2;\\n#endif\";\r\n\r\nvar uv2_vertex = \"#if defined( USE_LIGHTMAP ) || defined( USE_AOMAP )\\n\\tvUv2 = uv2;\\n#endif\";\r\n\r\nvar worldpos_vertex = \"#if defined( USE_ENVMAP ) || defined( PHONG ) || defined( PHYSICAL ) || defined( LAMBERT ) || defined ( USE_SHADOWMAP )\\n\\tvec4 worldPosition = modelMatrix * vec4( transformed, 1.0 );\\n#endif\\n\";\r\n\r\nvar cube_frag = \"uniform samplerCube tCube;\\nuniform float tFlip;\\nuniform float opacity;\\nvarying vec3 vWorldPosition;\\n#include <common>\\nvoid main() {\\n\\tgl_FragColor = textureCube( tCube, vec3( tFlip * vWorldPosition.x, vWorldPosition.yz ) );\\n\\tgl_FragColor.a *= opacity;\\n}\\n\";\r\n\r\nvar cube_vert = \"varying vec3 vWorldPosition;\\n#include <common>\\nvoid main() {\\n\\tvWorldPosition = transformDirection( position, modelMatrix );\\n\\t#include <begin_vertex>\\n\\t#include <project_vertex>\\n}\\n\";\r\n\r\nvar depth_frag = \"#if DEPTH_PACKING == 3200\\n\\tuniform float opacity;\\n#endif\\n#include <common>\\n#include <packing>\\n#include <uv_pars_fragment>\\n#include <map_pars_fragment>\\n#include <alphamap_pars_fragment>\\n#include <logdepthbuf_pars_fragment>\\n#include <clipping_planes_pars_fragment>\\nvoid main() {\\n\\t#include <clipping_planes_fragment>\\n\\tvec4 diffuseColor = vec4( 1.0 );\\n\\t#if DEPTH_PACKING == 3200\\n\\t\\tdiffuseColor.a = opacity;\\n\\t#endif\\n\\t#include <map_fragment>\\n\\t#include <alphamap_fragment>\\n\\t#include <alphatest_fragment>\\n\\t#include <logdepthbuf_fragment>\\n\\t#if DEPTH_PACKING == 3200\\n\\t\\tgl_FragColor = vec4( vec3( gl_FragCoord.z ), opacity );\\n\\t#elif DEPTH_PACKING == 3201\\n\\t\\tgl_FragColor = packDepthToRGBA( gl_FragCoord.z );\\n\\t#endif\\n}\\n\";\r\n\r\nvar depth_vert = \"#include <common>\\n#include <uv_pars_vertex>\\n#include <displacementmap_pars_vertex>\\n#include <morphtarget_pars_vertex>\\n#include <skinning_pars_vertex>\\n#include <logdepthbuf_pars_vertex>\\n#include <clipping_planes_pars_vertex>\\nvoid main() {\\n\\t#include <uv_vertex>\\n\\t#include <skinbase_vertex>\\n\\t#ifdef USE_DISPLACEMENTMAP\\n\\t\\t#include <beginnormal_vertex>\\n\\t\\t#include <morphnormal_vertex>\\n\\t\\t#include <skinnormal_vertex>\\n\\t#endif\\n\\t#include <begin_vertex>\\n\\t#include <morphtarget_vertex>\\n\\t#include <skinning_vertex>\\n\\t#include <displacementmap_vertex>\\n\\t#include <project_vertex>\\n\\t#include <logdepthbuf_vertex>\\n\\t#include <clipping_planes_vertex>\\n}\\n\";\r\n\r\nvar distanceRGBA_frag = \"uniform vec3 lightPos;\\nvarying vec4 vWorldPosition;\\n#include <common>\\n#include <packing>\\n#include <clipping_planes_pars_fragment>\\nvoid main () {\\n\\t#include <clipping_planes_fragment>\\n\\tgl_FragColor = packDepthToRGBA( length( vWorldPosition.xyz - lightPos.xyz ) / 1000.0 );\\n}\\n\";\r\n\r\nvar distanceRGBA_vert = \"varying vec4 vWorldPosition;\\n#include <common>\\n#include <morphtarget_pars_vertex>\\n#include <skinning_pars_vertex>\\n#include <clipping_planes_pars_vertex>\\nvoid main() {\\n\\t#include <skinbase_vertex>\\n\\t#include <begin_vertex>\\n\\t#include <morphtarget_vertex>\\n\\t#include <skinning_vertex>\\n\\t#include <project_vertex>\\n\\t#include <worldpos_vertex>\\n\\t#include <clipping_planes_vertex>\\n\\tvWorldPosition = worldPosition;\\n}\\n\";\r\n\r\nvar equirect_frag = \"uniform sampler2D tEquirect;\\nuniform float tFlip;\\nvarying vec3 vWorldPosition;\\n#include <common>\\nvoid main() {\\n\\tvec3 direction = normalize( vWorldPosition );\\n\\tvec2 sampleUV;\\n\\tsampleUV.y = saturate( tFlip * direction.y * -0.5 + 0.5 );\\n\\tsampleUV.x = atan( direction.z, direction.x ) * RECIPROCAL_PI2 + 0.5;\\n\\tgl_FragColor = texture2D( tEquirect, sampleUV );\\n}\\n\";\r\n\r\nvar equirect_vert = \"varying vec3 vWorldPosition;\\n#include <common>\\nvoid main() {\\n\\tvWorldPosition = transformDirection( position, modelMatrix );\\n\\t#include <begin_vertex>\\n\\t#include <project_vertex>\\n}\\n\";\r\n\r\nvar linedashed_frag = \"uniform vec3 diffuse;\\nuniform float opacity;\\nuniform float dashSize;\\nuniform float totalSize;\\nvarying float vLineDistance;\\n#include <common>\\n#include <color_pars_fragment>\\n#include <fog_pars_fragment>\\n#include <logdepthbuf_pars_fragment>\\n#include <clipping_planes_pars_fragment>\\nvoid main() {\\n\\t#include <clipping_planes_fragment>\\n\\tif ( mod( vLineDistance, totalSize ) > dashSize ) {\\n\\t\\tdiscard;\\n\\t}\\n\\tvec3 outgoingLight = vec3( 0.0 );\\n\\tvec4 diffuseColor = vec4( diffuse, opacity );\\n\\t#include <logdepthbuf_fragment>\\n\\t#include <color_fragment>\\n\\toutgoingLight = diffuseColor.rgb;\\n\\tgl_FragColor = vec4( outgoingLight, diffuseColor.a );\\n\\t#include <premultiplied_alpha_fragment>\\n\\t#include <tonemapping_fragment>\\n\\t#include <encodings_fragment>\\n\\t#include <fog_fragment>\\n}\\n\";\r\n\r\nvar linedashed_vert = \"uniform float scale;\\nattribute float lineDistance;\\nvarying float vLineDistance;\\n#include <common>\\n#include <color_pars_vertex>\\n#include <fog_pars_vertex>\\n#include <logdepthbuf_pars_vertex>\\n#include <clipping_planes_pars_vertex>\\nvoid main() {\\n\\t#include <color_vertex>\\n\\tvLineDistance = scale * lineDistance;\\n\\tvec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );\\n\\tgl_Position = projectionMatrix * mvPosition;\\n\\t#include <logdepthbuf_vertex>\\n\\t#include <clipping_planes_vertex>\\n\\t#include <fog_vertex>\\n}\\n\";\r\n\r\nvar meshbasic_frag = \"uniform vec3 diffuse;\\nuniform float opacity;\\n#ifndef FLAT_SHADED\\n\\tvarying vec3 vNormal;\\n#endif\\n#include <common>\\n#include <color_pars_fragment>\\n#include <uv_pars_fragment>\\n#include <uv2_pars_fragment>\\n#include <map_pars_fragment>\\n#include <alphamap_pars_fragment>\\n#include <aomap_pars_fragment>\\n#include <lightmap_pars_fragment>\\n#include <envmap_pars_fragment>\\n#include <fog_pars_fragment>\\n#include <specularmap_pars_fragment>\\n#include <logdepthbuf_pars_fragment>\\n#include <clipping_planes_pars_fragment>\\nvoid main() {\\n\\t#include <clipping_planes_fragment>\\n\\tvec4 diffuseColor = vec4( diffuse, opacity );\\n\\t#include <logdepthbuf_fragment>\\n\\t#include <map_fragment>\\n\\t#include <color_fragment>\\n\\t#include <alphamap_fragment>\\n\\t#include <alphatest_fragment>\\n\\t#include <specularmap_fragment>\\n\\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\\n\\t#ifdef USE_LIGHTMAP\\n\\t\\treflectedLight.indirectDiffuse += texture2D( lightMap, vUv2 ).xyz * lightMapIntensity;\\n\\t#else\\n\\t\\treflectedLight.indirectDiffuse += vec3( 1.0 );\\n\\t#endif\\n\\t#include <aomap_fragment>\\n\\treflectedLight.indirectDiffuse *= diffuseColor.rgb;\\n\\tvec3 outgoingLight = reflectedLight.indirectDiffuse;\\n\\t#include <normal_flip>\\n\\t#include <envmap_fragment>\\n\\tgl_FragColor = vec4( outgoingLight, diffuseColor.a );\\n\\t#include <premultiplied_alpha_fragment>\\n\\t#include <tonemapping_fragment>\\n\\t#include <encodings_fragment>\\n\\t#include <fog_fragment>\\n}\\n\";\r\n\r\nvar meshbasic_vert = \"#include <common>\\n#include <uv_pars_vertex>\\n#include <uv2_pars_vertex>\\n#include <envmap_pars_vertex>\\n#include <color_pars_vertex>\\n#include <fog_pars_vertex>\\n#include <morphtarget_pars_vertex>\\n#include <skinning_pars_vertex>\\n#include <logdepthbuf_pars_vertex>\\n#include <clipping_planes_pars_vertex>\\nvoid main() {\\n\\t#include <uv_vertex>\\n\\t#include <uv2_vertex>\\n\\t#include <color_vertex>\\n\\t#include <skinbase_vertex>\\n\\t#ifdef USE_ENVMAP\\n\\t#include <beginnormal_vertex>\\n\\t#include <morphnormal_vertex>\\n\\t#include <skinnormal_vertex>\\n\\t#include <defaultnormal_vertex>\\n\\t#endif\\n\\t#include <begin_vertex>\\n\\t#include <morphtarget_vertex>\\n\\t#include <skinning_vertex>\\n\\t#include <project_vertex>\\n\\t#include <logdepthbuf_vertex>\\n\\t#include <worldpos_vertex>\\n\\t#include <clipping_planes_vertex>\\n\\t#include <envmap_vertex>\\n\\t#include <fog_vertex>\\n}\\n\";\r\n\r\nvar meshlambert_frag = \"uniform vec3 diffuse;\\nuniform vec3 emissive;\\nuniform float opacity;\\nvarying vec3 vLightFront;\\n#ifdef DOUBLE_SIDED\\n\\tvarying vec3 vLightBack;\\n#endif\\n#include <common>\\n#include <packing>\\n#include <dithering_pars_fragment>\\n#include <color_pars_fragment>\\n#include <uv_pars_fragment>\\n#include <uv2_pars_fragment>\\n#include <map_pars_fragment>\\n#include <alphamap_pars_fragment>\\n#include <aomap_pars_fragment>\\n#include <lightmap_pars_fragment>\\n#include <emissivemap_pars_fragment>\\n#include <envmap_pars_fragment>\\n#include <bsdfs>\\n#include <lights_pars>\\n#include <fog_pars_fragment>\\n#include <shadowmap_pars_fragment>\\n#include <shadowmask_pars_fragment>\\n#include <specularmap_pars_fragment>\\n#include <logdepthbuf_pars_fragment>\\n#include <clipping_planes_pars_fragment>\\nvoid main() {\\n\\t#include <clipping_planes_fragment>\\n\\tvec4 diffuseColor = vec4( diffuse, opacity );\\n\\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\\n\\tvec3 totalEmissiveRadiance = emissive;\\n\\t#include <logdepthbuf_fragment>\\n\\t#include <map_fragment>\\n\\t#include <color_fragment>\\n\\t#include <alphamap_fragment>\\n\\t#include <alphatest_fragment>\\n\\t#include <specularmap_fragment>\\n\\t#include <emissivemap_fragment>\\n\\treflectedLight.indirectDiffuse = getAmbientLightIrradiance( ambientLightColor );\\n\\t#include <lightmap_fragment>\\n\\treflectedLight.indirectDiffuse *= BRDF_Diffuse_Lambert( diffuseColor.rgb );\\n\\t#ifdef DOUBLE_SIDED\\n\\t\\treflectedLight.directDiffuse = ( gl_FrontFacing ) ? vLightFront : vLightBack;\\n\\t#else\\n\\t\\treflectedLight.directDiffuse = vLightFront;\\n\\t#endif\\n\\treflectedLight.directDiffuse *= BRDF_Diffuse_Lambert( diffuseColor.rgb ) * getShadowMask();\\n\\t#include <aomap_fragment>\\n\\tvec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + totalEmissiveRadiance;\\n\\t#include <normal_flip>\\n\\t#include <envmap_fragment>\\n\\tgl_FragColor = vec4( outgoingLight, diffuseColor.a );\\n\\t#include <tonemapping_fragment>\\n\\t#include <encodings_fragment>\\n\\t#include <fog_fragment>\\n\\t#include <premultiplied_alpha_fragment>\\n\\t#include <dithering_fragment>\\n}\\n\";\r\n\r\nvar meshlambert_vert = \"#define LAMBERT\\nvarying vec3 vLightFront;\\n#ifdef DOUBLE_SIDED\\n\\tvarying vec3 vLightBack;\\n#endif\\n#include <common>\\n#include <uv_pars_vertex>\\n#include <uv2_pars_vertex>\\n#include <envmap_pars_vertex>\\n#include <bsdfs>\\n#include <lights_pars>\\n#include <color_pars_vertex>\\n#include <fog_pars_vertex>\\n#include <morphtarget_pars_vertex>\\n#include <skinning_pars_vertex>\\n#include <shadowmap_pars_vertex>\\n#include <logdepthbuf_pars_vertex>\\n#include <clipping_planes_pars_vertex>\\nvoid main() {\\n\\t#include <uv_vertex>\\n\\t#include <uv2_vertex>\\n\\t#include <color_vertex>\\n\\t#include <beginnormal_vertex>\\n\\t#include <morphnormal_vertex>\\n\\t#include <skinbase_vertex>\\n\\t#include <skinnormal_vertex>\\n\\t#include <defaultnormal_vertex>\\n\\t#include <begin_vertex>\\n\\t#include <morphtarget_vertex>\\n\\t#include <skinning_vertex>\\n\\t#include <project_vertex>\\n\\t#include <logdepthbuf_vertex>\\n\\t#include <clipping_planes_vertex>\\n\\t#include <worldpos_vertex>\\n\\t#include <envmap_vertex>\\n\\t#include <lights_lambert_vertex>\\n\\t#include <shadowmap_vertex>\\n\\t#include <fog_vertex>\\n}\\n\";\r\n\r\nvar meshphong_frag = \"#define PHONG\\nuniform vec3 diffuse;\\nuniform vec3 emissive;\\nuniform vec3 specular;\\nuniform float shininess;\\nuniform float opacity;\\n#include <common>\\n#include <packing>\\n#include <dithering_pars_fragment>\\n#include <color_pars_fragment>\\n#include <uv_pars_fragment>\\n#include <uv2_pars_fragment>\\n#include <map_pars_fragment>\\n#include <alphamap_pars_fragment>\\n#include <aomap_pars_fragment>\\n#include <lightmap_pars_fragment>\\n#include <emissivemap_pars_fragment>\\n#include <envmap_pars_fragment>\\n#include <gradientmap_pars_fragment>\\n#include <fog_pars_fragment>\\n#include <bsdfs>\\n#include <lights_pars>\\n#include <lights_phong_pars_fragment>\\n#include <shadowmap_pars_fragment>\\n#include <bumpmap_pars_fragment>\\n#include <normalmap_pars_fragment>\\n#include <specularmap_pars_fragment>\\n#include <logdepthbuf_pars_fragment>\\n#include <clipping_planes_pars_fragment>\\nvoid main() {\\n\\t#include <clipping_planes_fragment>\\n\\tvec4 diffuseColor = vec4( diffuse, opacity );\\n\\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\\n\\tvec3 totalEmissiveRadiance = emissive;\\n\\t#include <logdepthbuf_fragment>\\n\\t#include <map_fragment>\\n\\t#include <color_fragment>\\n\\t#include <alphamap_fragment>\\n\\t#include <alphatest_fragment>\\n\\t#include <specularmap_fragment>\\n\\t#include <normal_flip>\\n\\t#include <normal_fragment>\\n\\t#include <emissivemap_fragment>\\n\\t#include <lights_phong_fragment>\\n\\t#include <lights_template>\\n\\t#include <aomap_fragment>\\n\\tvec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + reflectedLight.directSpecular + reflectedLight.indirectSpecular + totalEmissiveRadiance;\\n\\t#include <envmap_fragment>\\n\\tgl_FragColor = vec4( outgoingLight, diffuseColor.a );\\n\\t#include <tonemapping_fragment>\\n\\t#include <encodings_fragment>\\n\\t#include <fog_fragment>\\n\\t#include <premultiplied_alpha_fragment>\\n\\t#include <dithering_fragment>\\n}\\n\";\r\n\r\nvar meshphong_vert = \"#define PHONG\\nvarying vec3 vViewPosition;\\n#ifndef FLAT_SHADED\\n\\tvarying vec3 vNormal;\\n#endif\\n#include <common>\\n#include <uv_pars_vertex>\\n#include <uv2_pars_vertex>\\n#include <displacementmap_pars_vertex>\\n#include <envmap_pars_vertex>\\n#include <color_pars_vertex>\\n#include <fog_pars_vertex>\\n#include <morphtarget_pars_vertex>\\n#include <skinning_pars_vertex>\\n#include <shadowmap_pars_vertex>\\n#include <logdepthbuf_pars_vertex>\\n#include <clipping_planes_pars_vertex>\\nvoid main() {\\n\\t#include <uv_vertex>\\n\\t#include <uv2_vertex>\\n\\t#include <color_vertex>\\n\\t#include <beginnormal_vertex>\\n\\t#include <morphnormal_vertex>\\n\\t#include <skinbase_vertex>\\n\\t#include <skinnormal_vertex>\\n\\t#include <defaultnormal_vertex>\\n#ifndef FLAT_SHADED\\n\\tvNormal = normalize( transformedNormal );\\n#endif\\n\\t#include <begin_vertex>\\n\\t#include <morphtarget_vertex>\\n\\t#include <skinning_vertex>\\n\\t#include <displacementmap_vertex>\\n\\t#include <project_vertex>\\n\\t#include <logdepthbuf_vertex>\\n\\t#include <clipping_planes_vertex>\\n\\tvViewPosition = - mvPosition.xyz;\\n\\t#include <worldpos_vertex>\\n\\t#include <envmap_vertex>\\n\\t#include <shadowmap_vertex>\\n\\t#include <fog_vertex>\\n}\\n\";\r\n\r\nvar meshphysical_frag = \"#define PHYSICAL\\nuniform vec3 diffuse;\\nuniform vec3 emissive;\\nuniform float roughness;\\nuniform float metalness;\\nuniform float opacity;\\n#ifndef STANDARD\\n\\tuniform float clearCoat;\\n\\tuniform float clearCoatRoughness;\\n#endif\\nvarying vec3 vViewPosition;\\n#ifndef FLAT_SHADED\\n\\tvarying vec3 vNormal;\\n#endif\\n#include <common>\\n#include <packing>\\n#include <dithering_pars_fragment>\\n#include <color_pars_fragment>\\n#include <uv_pars_fragment>\\n#include <uv2_pars_fragment>\\n#include <map_pars_fragment>\\n#include <alphamap_pars_fragment>\\n#include <aomap_pars_fragment>\\n#include <lightmap_pars_fragment>\\n#include <emissivemap_pars_fragment>\\n#include <envmap_pars_fragment>\\n#include <fog_pars_fragment>\\n#include <bsdfs>\\n#include <cube_uv_reflection_fragment>\\n#include <lights_pars>\\n#include <lights_physical_pars_fragment>\\n#include <shadowmap_pars_fragment>\\n#include <bumpmap_pars_fragment>\\n#include <normalmap_pars_fragment>\\n#include <roughnessmap_pars_fragment>\\n#include <metalnessmap_pars_fragment>\\n#include <logdepthbuf_pars_fragment>\\n#include <clipping_planes_pars_fragment>\\nvoid main() {\\n\\t#include <clipping_planes_fragment>\\n\\tvec4 diffuseColor = vec4( diffuse, opacity );\\n\\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\\n\\tvec3 totalEmissiveRadiance = emissive;\\n\\t#include <logdepthbuf_fragment>\\n\\t#include <map_fragment>\\n\\t#include <color_fragment>\\n\\t#include <alphamap_fragment>\\n\\t#include <alphatest_fragment>\\n\\t#include <roughnessmap_fragment>\\n\\t#include <metalnessmap_fragment>\\n\\t#include <normal_flip>\\n\\t#include <normal_fragment>\\n\\t#include <emissivemap_fragment>\\n\\t#include <lights_physical_fragment>\\n\\t#include <lights_template>\\n\\t#include <aomap_fragment>\\n\\tvec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + reflectedLight.directSpecular + reflectedLight.indirectSpecular + totalEmissiveRadiance;\\n\\tgl_FragColor = vec4( outgoingLight, diffuseColor.a );\\n\\t#include <tonemapping_fragment>\\n\\t#include <encodings_fragment>\\n\\t#include <fog_fragment>\\n\\t#include <premultiplied_alpha_fragment>\\n\\t#include <dithering_fragment>\\n}\\n\";\r\n\r\nvar meshphysical_vert = \"#define PHYSICAL\\nvarying vec3 vViewPosition;\\n#ifndef FLAT_SHADED\\n\\tvarying vec3 vNormal;\\n#endif\\n#include <common>\\n#include <uv_pars_vertex>\\n#include <uv2_pars_vertex>\\n#include <displacementmap_pars_vertex>\\n#include <color_pars_vertex>\\n#include <fog_pars_vertex>\\n#include <morphtarget_pars_vertex>\\n#include <skinning_pars_vertex>\\n#include <shadowmap_pars_vertex>\\n#include <logdepthbuf_pars_vertex>\\n#include <clipping_planes_pars_vertex>\\nvoid main() {\\n\\t#include <uv_vertex>\\n\\t#include <uv2_vertex>\\n\\t#include <color_vertex>\\n\\t#include <beginnormal_vertex>\\n\\t#include <morphnormal_vertex>\\n\\t#include <skinbase_vertex>\\n\\t#include <skinnormal_vertex>\\n\\t#include <defaultnormal_vertex>\\n#ifndef FLAT_SHADED\\n\\tvNormal = normalize( transformedNormal );\\n#endif\\n\\t#include <begin_vertex>\\n\\t#include <morphtarget_vertex>\\n\\t#include <skinning_vertex>\\n\\t#include <displacementmap_vertex>\\n\\t#include <project_vertex>\\n\\t#include <logdepthbuf_vertex>\\n\\t#include <clipping_planes_vertex>\\n\\tvViewPosition = - mvPosition.xyz;\\n\\t#include <worldpos_vertex>\\n\\t#include <shadowmap_vertex>\\n\\t#include <fog_vertex>\\n}\\n\";\r\n\r\nvar normal_frag = \"#define NORMAL\\nuniform float opacity;\\n#if defined( FLAT_SHADED ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP )\\n\\tvarying vec3 vViewPosition;\\n#endif\\n#ifndef FLAT_SHADED\\n\\tvarying vec3 vNormal;\\n#endif\\n#include <packing>\\n#include <uv_pars_fragment>\\n#include <bumpmap_pars_fragment>\\n#include <normalmap_pars_fragment>\\n#include <logdepthbuf_pars_fragment>\\nvoid main() {\\n\\t#include <logdepthbuf_fragment>\\n\\t#include <normal_flip>\\n\\t#include <normal_fragment>\\n\\tgl_FragColor = vec4( packNormalToRGB( normal ), opacity );\\n}\\n\";\r\n\r\nvar normal_vert = \"#define NORMAL\\n#if defined( FLAT_SHADED ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP )\\n\\tvarying vec3 vViewPosition;\\n#endif\\n#ifndef FLAT_SHADED\\n\\tvarying vec3 vNormal;\\n#endif\\n#include <uv_pars_vertex>\\n#include <displacementmap_pars_vertex>\\n#include <morphtarget_pars_vertex>\\n#include <skinning_pars_vertex>\\n#include <logdepthbuf_pars_vertex>\\nvoid main() {\\n\\t#include <uv_vertex>\\n\\t#include <beginnormal_vertex>\\n\\t#include <morphnormal_vertex>\\n\\t#include <skinbase_vertex>\\n\\t#include <skinnormal_vertex>\\n\\t#include <defaultnormal_vertex>\\n#ifndef FLAT_SHADED\\n\\tvNormal = normalize( transformedNormal );\\n#endif\\n\\t#include <begin_vertex>\\n\\t#include <morphtarget_vertex>\\n\\t#include <skinning_vertex>\\n\\t#include <displacementmap_vertex>\\n\\t#include <project_vertex>\\n\\t#include <logdepthbuf_vertex>\\n#if defined( FLAT_SHADED ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP )\\n\\tvViewPosition = - mvPosition.xyz;\\n#endif\\n}\\n\";\r\n\r\nvar points_frag = \"uniform vec3 diffuse;\\nuniform float opacity;\\n#include <common>\\n#include <packing>\\n#include <color_pars_fragment>\\n#include <map_particle_pars_fragment>\\n#include <fog_pars_fragment>\\n#include <shadowmap_pars_fragment>\\n#include <logdepthbuf_pars_fragment>\\n#include <clipping_planes_pars_fragment>\\nvoid main() {\\n\\t#include <clipping_planes_fragment>\\n\\tvec3 outgoingLight = vec3( 0.0 );\\n\\tvec4 diffuseColor = vec4( diffuse, opacity );\\n\\t#include <logdepthbuf_fragment>\\n\\t#include <map_particle_fragment>\\n\\t#include <color_fragment>\\n\\t#include <alphatest_fragment>\\n\\toutgoingLight = diffuseColor.rgb;\\n\\tgl_FragColor = vec4( outgoingLight, diffuseColor.a );\\n\\t#include <premultiplied_alpha_fragment>\\n\\t#include <tonemapping_fragment>\\n\\t#include <encodings_fragment>\\n\\t#include <fog_fragment>\\n}\\n\";\r\n\r\nvar points_vert = \"uniform float size;\\nuniform float scale;\\n#include <common>\\n#include <color_pars_vertex>\\n#include <fog_pars_vertex>\\n#include <shadowmap_pars_vertex>\\n#include <logdepthbuf_pars_vertex>\\n#include <clipping_planes_pars_vertex>\\nvoid main() {\\n\\t#include <color_vertex>\\n\\t#include <begin_vertex>\\n\\t#include <project_vertex>\\n\\t#ifdef USE_SIZEATTENUATION\\n\\t\\tgl_PointSize = size * ( scale / - mvPosition.z );\\n\\t#else\\n\\t\\tgl_PointSize = size;\\n\\t#endif\\n\\t#include <logdepthbuf_vertex>\\n\\t#include <clipping_planes_vertex>\\n\\t#include <worldpos_vertex>\\n\\t#include <shadowmap_vertex>\\n\\t#include <fog_vertex>\\n}\\n\";\r\n\r\nvar shadow_frag = \"uniform float opacity;\\n#include <common>\\n#include <packing>\\n#include <bsdfs>\\n#include <lights_pars>\\n#include <shadowmap_pars_fragment>\\n#include <shadowmask_pars_fragment>\\nvoid main() {\\n\\tgl_FragColor = vec4( 0.0, 0.0, 0.0, opacity * ( 1.0 - getShadowMask() ) );\\n}\\n\";\r\n\r\nvar shadow_vert = \"#include <shadowmap_pars_vertex>\\nvoid main() {\\n\\t#include <begin_vertex>\\n\\t#include <project_vertex>\\n\\t#include <worldpos_vertex>\\n\\t#include <shadowmap_vertex>\\n}\\n\";\r\n\r\nvar ShaderChunk = {\r\n    alphamap_fragment: alphamap_fragment,\r\n    alphamap_pars_fragment: alphamap_pars_fragment,\r\n    alphatest_fragment: alphatest_fragment,\r\n    aomap_fragment: aomap_fragment,\r\n    aomap_pars_fragment: aomap_pars_fragment,\r\n    begin_vertex: begin_vertex,\r\n    beginnormal_vertex: beginnormal_vertex,\r\n    bsdfs: bsdfs,\r\n    bumpmap_pars_fragment: bumpmap_pars_fragment,\r\n    clipping_planes_fragment: clipping_planes_fragment,\r\n    clipping_planes_pars_fragment: clipping_planes_pars_fragment,\r\n    clipping_planes_pars_vertex: clipping_planes_pars_vertex,\r\n    clipping_planes_vertex: clipping_planes_vertex,\r\n    color_fragment: color_fragment,\r\n    color_pars_fragment: color_pars_fragment,\r\n    color_pars_vertex: color_pars_vertex,\r\n    color_vertex: color_vertex,\r\n    common: common,\r\n    cube_uv_reflection_fragment: cube_uv_reflection_fragment,\r\n    defaultnormal_vertex: defaultnormal_vertex,\r\n    displacementmap_pars_vertex: displacementmap_pars_vertex,\r\n    displacementmap_vertex: displacementmap_vertex,\r\n    emissivemap_fragment: emissivemap_fragment,\r\n    emissivemap_pars_fragment: emissivemap_pars_fragment,\r\n    encodings_fragment: encodings_fragment,\r\n    encodings_pars_fragment: encodings_pars_fragment,\r\n    envmap_fragment: envmap_fragment,\r\n    envmap_pars_fragment: envmap_pars_fragment,\r\n    envmap_pars_vertex: envmap_pars_vertex,\r\n    envmap_vertex: envmap_vertex,\r\n    fog_vertex: fog_vertex,\r\n    fog_pars_vertex: fog_pars_vertex,\r\n    fog_fragment: fog_fragment,\r\n    fog_pars_fragment: fog_pars_fragment,\r\n    gradientmap_pars_fragment: gradientmap_pars_fragment,\r\n    lightmap_fragment: lightmap_fragment,\r\n    lightmap_pars_fragment: lightmap_pars_fragment,\r\n    lights_lambert_vertex: lights_lambert_vertex,\r\n    lights_pars: lights_pars,\r\n    lights_phong_fragment: lights_phong_fragment,\r\n    lights_phong_pars_fragment: lights_phong_pars_fragment,\r\n    lights_physical_fragment: lights_physical_fragment,\r\n    lights_physical_pars_fragment: lights_physical_pars_fragment,\r\n    lights_template: lights_template,\r\n    logdepthbuf_fragment: logdepthbuf_fragment,\r\n    logdepthbuf_pars_fragment: logdepthbuf_pars_fragment,\r\n    logdepthbuf_pars_vertex: logdepthbuf_pars_vertex,\r\n    logdepthbuf_vertex: logdepthbuf_vertex,\r\n    map_fragment: map_fragment,\r\n    map_pars_fragment: map_pars_fragment,\r\n    map_particle_fragment: map_particle_fragment,\r\n    map_particle_pars_fragment: map_particle_pars_fragment,\r\n    metalnessmap_fragment: metalnessmap_fragment,\r\n    metalnessmap_pars_fragment: metalnessmap_pars_fragment,\r\n    morphnormal_vertex: morphnormal_vertex,\r\n    morphtarget_pars_vertex: morphtarget_pars_vertex,\r\n    morphtarget_vertex: morphtarget_vertex,\r\n    normal_flip: normal_flip,\r\n    normal_fragment: normal_fragment,\r\n    normalmap_pars_fragment: normalmap_pars_fragment,\r\n    packing: packing,\r\n    premultiplied_alpha_fragment: premultiplied_alpha_fragment,\r\n    project_vertex: project_vertex,\r\n    dithering_fragment: dithering_fragment,\r\n    dithering_pars_fragment: dithering_pars_fragment,\r\n    roughnessmap_fragment: roughnessmap_fragment,\r\n    roughnessmap_pars_fragment: roughnessmap_pars_fragment,\r\n    shadowmap_pars_fragment: shadowmap_pars_fragment,\r\n    shadowmap_pars_vertex: shadowmap_pars_vertex,\r\n    shadowmap_vertex: shadowmap_vertex,\r\n    shadowmask_pars_fragment: shadowmask_pars_fragment,\r\n    skinbase_vertex: skinbase_vertex,\r\n    skinning_pars_vertex: skinning_pars_vertex,\r\n    skinning_vertex: skinning_vertex,\r\n    skinnormal_vertex: skinnormal_vertex,\r\n    specularmap_fragment: specularmap_fragment,\r\n    specularmap_pars_fragment: specularmap_pars_fragment,\r\n    tonemapping_fragment: tonemapping_fragment,\r\n    tonemapping_pars_fragment: tonemapping_pars_fragment,\r\n    uv_pars_fragment: uv_pars_fragment,\r\n    uv_pars_vertex: uv_pars_vertex,\r\n    uv_vertex: uv_vertex,\r\n    uv2_pars_fragment: uv2_pars_fragment,\r\n    uv2_pars_vertex: uv2_pars_vertex,\r\n    uv2_vertex: uv2_vertex,\r\n    worldpos_vertex: worldpos_vertex,\r\n\r\n    cube_frag: cube_frag,\r\n    cube_vert: cube_vert,\r\n    depth_frag: depth_frag,\r\n    depth_vert: depth_vert,\r\n    distanceRGBA_frag: distanceRGBA_frag,\r\n    distanceRGBA_vert: distanceRGBA_vert,\r\n    equirect_frag: equirect_frag,\r\n    equirect_vert: equirect_vert,\r\n    linedashed_frag: linedashed_frag,\r\n    linedashed_vert: linedashed_vert,\r\n    meshbasic_frag: meshbasic_frag,\r\n    meshbasic_vert: meshbasic_vert,\r\n    meshlambert_frag: meshlambert_frag,\r\n    meshlambert_vert: meshlambert_vert,\r\n    meshphong_frag: meshphong_frag,\r\n    meshphong_vert: meshphong_vert,\r\n    meshphysical_frag: meshphysical_frag,\r\n    meshphysical_vert: meshphysical_vert,\r\n    normal_frag: normal_frag,\r\n    normal_vert: normal_vert,\r\n    points_frag: points_frag,\r\n    points_vert: points_vert,\r\n    shadow_frag: shadow_frag,\r\n    shadow_vert: shadow_vert,\r\n\r\n    none_frag: none_frag,\r\n    none_vert: none_vert,\r\n    normals_frag: normals_frag,\r\n    normals_vert: normals_vert,\r\n    texture_frag: texture_frag,\r\n    texture_vert: texture_vert,\r\n    texture_normals_frag: texture_normals_frag,\r\n    texture_normals_vert: texture_normals_vert\r\n};\r\n\r\nShaderChunk.parseIncludes = function (string) {\r\n\r\n    var pattern = /#include +<([\\w\\d.]+)>/g;\r\n\r\n    function replace(match, include) {\r\n\r\n        var replace = ShaderChunk[include];\r\n\r\n        if (replace === undefined) {\r\n\r\n            throw new Error('Can not resolve #include <' + include + '>');\r\n\r\n        }\r\n\r\n        return ShaderChunk.parseIncludes(replace);\r\n\r\n    }\r\n\r\n    return string.replace(pattern, replace);\r\n\r\n}\r\nexport default ShaderChunk; ","﻿\r\nimport ShaderChunk from './ShaderChunk.js';\r\n\r\n\r\n/**\r\n * Uniforms library for shared webgl shaders\r\n */\r\n\r\nvar UniformsLib = {\r\n\r\n    common: {\r\n\r\n        diffuse: {\r\n            value: {\r\n                isColor: true,\r\n                red: 1, green: 1, blue: 1, alpha: 1\r\n            }\r\n            // new Cesium.Color(0xeeeeee)\r\n        },\r\n        opacity: { value: 1.0 },\r\n\r\n        map: { value: null },\r\n        offsetRepeat: {\r\n            value: {\r\n                isCartesian4: true,\r\n                x: 0, y: 0, z: 1, w: 1\r\n            }\r\n            //new Cesium.Cartesian4(0, 0, 1, 1) \r\n        },\r\n\r\n        specularMap: { value: null },\r\n        alphaMap: { value: null },\r\n\r\n        envMap: { value: null },\r\n        flipEnvMap: { value: -1 },\r\n        reflectivity: { value: 1.0 },\r\n        refractionRatio: { value: 0.98 }\r\n\r\n    },\r\n\r\n    aomap: {\r\n\r\n        aoMap: { value: null },\r\n        aoMapIntensity: { value: 1 }\r\n\r\n    },\r\n\r\n    lightmap: {\r\n\r\n        lightMap: { value: null },\r\n        lightMapIntensity: { value: 1 }\r\n\r\n    },\r\n\r\n    emissivemap: {\r\n\r\n        emissiveMap: { value: null }\r\n\r\n    },\r\n\r\n    bumpmap: {\r\n\r\n        bumpMap: { value: null },\r\n        bumpScale: { value: 1 }\r\n\r\n    },\r\n\r\n    normalmap: {\r\n\r\n        normalMap: { value: null },\r\n        normalScale: {\r\n            value: {\r\n                isCartesian2: true,\r\n                x: 1, y: 1\r\n            }\r\n            //new Cesium.Cartesian2(1, 1) \r\n        }\r\n\r\n    },\r\n\r\n    displacementmap: {\r\n\r\n        displacementMap: { value: null },\r\n        displacementScale: { value: 1 },\r\n        displacementBias: { value: 0 }\r\n\r\n    },\r\n\r\n    roughnessmap: {\r\n\r\n        roughnessMap: { value: null }\r\n\r\n    },\r\n\r\n    metalnessmap: {\r\n\r\n        metalnessMap: { value: null }\r\n\r\n    },\r\n\r\n    gradientmap: {\r\n\r\n        gradientMap: { value: null }\r\n\r\n    },\r\n\r\n    fog: {\r\n\r\n        fogDensity: { value: 0.00025 },\r\n        fogNear: { value: 1 },\r\n        fogFar: { value: 2000 },\r\n        fogColor: {\r\n            value: {\r\n                isColor: true,\r\n                red: 0, green: 0, blue: 1, alpha: 1\r\n            }\r\n            // new Cesium.Color(0xffffff) \r\n        }\r\n\r\n    },\r\n\r\n    lights: {\r\n\r\n        ambientLightColor: { value: [] },\r\n\r\n        directionalLights: {\r\n            value: [], properties: {\r\n                direction: {},\r\n                color: {},\r\n\r\n                shadow: {},\r\n                shadowBias: {},\r\n                shadowRadius: {},\r\n                shadowMapSize: {}\r\n            }\r\n        },\r\n\r\n        directionalShadowMap: { value: [] },\r\n        directionalShadowMatrix: { value: [] },\r\n\r\n        spotLights: {\r\n            value: [], properties: {\r\n                color: {},\r\n                position: {},\r\n                direction: {},\r\n                distance: {},\r\n                coneCos: {},\r\n                penumbraCos: {},\r\n                decay: {},\r\n\r\n                shadow: {},\r\n                shadowBias: {},\r\n                shadowRadius: {},\r\n                shadowMapSize: {}\r\n            }\r\n        },\r\n\r\n        spotShadowMap: { value: [] },\r\n        spotShadowMatrix: { value: [] },\r\n\r\n        pointLights: {\r\n            value: [], properties: {\r\n                color: {},\r\n                position: {},\r\n                decay: {},\r\n                distance: {},\r\n\r\n                shadow: {},\r\n                shadowBias: {},\r\n                shadowRadius: {},\r\n                shadowMapSize: {}\r\n            }\r\n        },\r\n\r\n        pointShadowMap: { value: [] },\r\n        pointShadowMatrix: { value: [] },\r\n\r\n        hemisphereLights: {\r\n            value: [], properties: {\r\n                direction: {},\r\n                skyColor: {},\r\n                groundColor: {}\r\n            }\r\n        },\r\n\r\n        // TODO (abelnation): RectAreaLight BRDF data needs to be moved from example to main src\r\n        rectAreaLights: {\r\n            value: [], properties: {\r\n                color: {},\r\n                position: {},\r\n                width: {},\r\n                height: {}\r\n            }\r\n        }\r\n\r\n    },\r\n\r\n    points: {\r\n\r\n        diffuse: {\r\n            value: {\r\n                isColor: true,\r\n                red: 1, green: 1, blue: 1, alpha: 1\r\n            }\r\n            // new Cesium.Color(0xeeeeee) \r\n        },\r\n        opacity: { value: 1.0 },\r\n        size: { value: 1.0 },\r\n        scale: { value: 1.0 },\r\n        map: { value: null },\r\n        offsetRepeat: {\r\n            value: {\r\n                isCartesian4: true,\r\n                x: 0, y: 0, z: 1, w: 1\r\n            }\r\n            // new Cesium.Cartesian4(0, 0, 1, 1) \r\n        }\r\n\r\n    }\r\n\r\n};\r\n\r\n/**\r\n * Uniform Utilities\r\n */\r\n\r\nvar UniformsUtils = {\r\n\r\n    merge: function (uniforms) {\r\n\r\n        var merged = {};\r\n\r\n        for (var u = 0; u < uniforms.length; u++) {\r\n\r\n            var tmp = this.clone(uniforms[u]);\r\n\r\n            for (var p in tmp) {\r\n\r\n                merged[p] = tmp[p];\r\n\r\n            }\r\n\r\n        }\r\n\r\n        return merged;\r\n\r\n    },\r\n\r\n    clone: function (uniforms_src) {\r\n\r\n        var uniforms_dst = {};\r\n\r\n        for (var u in uniforms_src) {\r\n\r\n            uniforms_dst[u] = {};\r\n\r\n            for (var p in uniforms_src[u]) {\r\n\r\n                var parameter_src = uniforms_src[u][p];\r\n\r\n                if (typeof Cesium != 'undefined' && parameter_src && (parameter_src instanceof Cesium.Color ||\r\n                    parameter_src instanceof Cesium.Matrix3 || parameter_src instanceof Cesium.Matrix4 ||\r\n                    parameter_src instanceof Cesium.Cartesian2 || parameter_src instanceof Cesium.Cartesian3\r\n                    || parameter_src instanceof Cesium.Cartesian4\r\n                    //||parameter_src.isTexture\r\n                )) {\r\n\r\n                    uniforms_dst[u][p] = parameter_src.constructor.clone(parameter_src);//.clone();\r\n\r\n                } else if (Array.isArray(parameter_src)) {\r\n\r\n                    uniforms_dst[u][p] = parameter_src.slice();\r\n\r\n                } else if (typeof Cesium != 'undefined' && parameter_src) {\r\n                    if (parameter_src.isColor) {\r\n                        uniforms_dst[u][p] = Cesium.Color.clone(parameter_src);\r\n\r\n                    } else if (parameter_src.isCartesian2) {\r\n                        uniforms_dst[u][p] = Cesium.Cartesian2.clone(parameter_src);\r\n\r\n                    } else if (parameter_src.isCartesian3) {\r\n                        uniforms_dst[u][p] = Cesium.Cartesian3.clone(parameter_src);\r\n\r\n                    } else if (parameter_src.isCartesian4) {\r\n                        uniforms_dst[u][p] = Cesium.Cartesian4.clone(parameter_src);\r\n\r\n                    } else {\r\n\r\n                        uniforms_dst[u][p] = parameter_src;\r\n\r\n                    }\r\n                } else {\r\n\r\n                    uniforms_dst[u][p] = parameter_src;\r\n\r\n                }\r\n\r\n            }\r\n\r\n        }\r\n\r\n        return uniforms_dst;\r\n\r\n    }\r\n\r\n};\r\n\r\n/**\r\n * @author alteredq / http://alteredqualia.com/\r\n * @author mrdoob / http://mrdoob.com/\r\n * @author mikael emtinger / http://gomo.se/\r\n */\r\n\r\nvar ShaderLib = {\r\n\r\n    basic: {\r\n\r\n        uniforms: UniformsUtils.merge([\r\n            UniformsLib.common,\r\n            UniformsLib.aomap,\r\n            UniformsLib.lightmap,\r\n            UniformsLib.fog\r\n        ]),\r\n\r\n        vertexShader: ShaderChunk.meshbasic_vert,\r\n        fragmentShader: ShaderChunk.meshbasic_frag\r\n\r\n    },\r\n\r\n    lambert: {\r\n\r\n        uniforms: UniformsUtils.merge([\r\n            UniformsLib.common,\r\n            UniformsLib.aomap,\r\n            UniformsLib.lightmap,\r\n            UniformsLib.emissivemap,\r\n            UniformsLib.fog,\r\n            UniformsLib.lights,\r\n            {\r\n                emissive: {\r\n                    value: {\r\n                        isColor: true,\r\n                        red: 1, green: 1, blue: 1, alpha: 1\r\n                    }\r\n                    // new Cesium.Color(0x000000) \r\n                }\r\n            }\r\n        ]),\r\n\r\n        vertexShader: ShaderChunk.meshlambert_vert,\r\n        fragmentShader: ShaderChunk.meshlambert_frag\r\n\r\n    },\r\n\r\n    phong: {\r\n\r\n        uniforms: UniformsUtils.merge([\r\n            UniformsLib.common,\r\n            UniformsLib.aomap,\r\n            UniformsLib.lightmap,\r\n            UniformsLib.emissivemap,\r\n            UniformsLib.bumpmap,\r\n            UniformsLib.normalmap,\r\n            UniformsLib.displacementmap,\r\n            UniformsLib.gradientmap,\r\n            UniformsLib.fog,\r\n            UniformsLib.lights,\r\n            {\r\n                emissive: {\r\n                    value: {\r\n                        isColor: true,\r\n                        red: 1, green: 1, blue: 1, alpha: 1\r\n                    }\r\n                    // new Cesium.Color(0x000000) \r\n                },\r\n                specular: {\r\n                    value:\r\n                    {\r\n                        isColor: true,\r\n                        red: 1, green: 1, blue: 1, alpha: 1\r\n                    }\r\n                    // new Cesium.Color(0x111111) \r\n                },\r\n                shininess: { value: 30 }\r\n            }\r\n        ]),\r\n\r\n        vertexShader: ShaderChunk.meshphong_vert,\r\n        fragmentShader: ShaderChunk.meshphong_frag\r\n\r\n    },\r\n\r\n    standard: {\r\n\r\n        uniforms: UniformsUtils.merge([\r\n            UniformsLib.common,\r\n            UniformsLib.aomap,\r\n            UniformsLib.lightmap,\r\n            UniformsLib.emissivemap,\r\n            UniformsLib.bumpmap,\r\n            UniformsLib.normalmap,\r\n            UniformsLib.displacementmap,\r\n            UniformsLib.roughnessmap,\r\n            UniformsLib.metalnessmap,\r\n            UniformsLib.fog,\r\n            UniformsLib.lights,\r\n            {\r\n                emissive: {\r\n                    value: {\r\n                        isColor: true,\r\n                        red: 0, green: 0, blue: 0, alpha: 1\r\n                    }\r\n                    // new Cesium.Color(0x000000) \r\n                },\r\n                roughness: { value: 0.5 },\r\n                metalness: { value: 0.5 },\r\n                envMapIntensity: { value: 1 } // temporary\r\n            }\r\n        ]),\r\n\r\n        vertexShader: ShaderChunk.meshphysical_vert,\r\n        fragmentShader: ShaderChunk.meshphysical_frag\r\n\r\n    },\r\n\r\n    points: {\r\n\r\n        uniforms: UniformsUtils.merge([\r\n            UniformsLib.points,\r\n            UniformsLib.fog\r\n        ]),\r\n\r\n        vertexShader: ShaderChunk.points_vert,\r\n        fragmentShader: ShaderChunk.points_frag\r\n\r\n    },\r\n\r\n    dashed: {\r\n\r\n        uniforms: UniformsUtils.merge([\r\n            UniformsLib.common,\r\n            UniformsLib.fog,\r\n            {\r\n                scale: { value: 1 },\r\n                dashSize: { value: 1 },\r\n                totalSize: { value: 2 }\r\n            }\r\n        ]),\r\n\r\n        vertexShader: ShaderChunk.linedashed_vert,\r\n        fragmentShader: ShaderChunk.linedashed_frag\r\n\r\n    },\r\n\r\n    depth: {\r\n\r\n        uniforms: UniformsUtils.merge([\r\n            UniformsLib.common,\r\n            UniformsLib.displacementmap\r\n        ]),\r\n\r\n        vertexShader: ShaderChunk.depth_vert,\r\n        fragmentShader: ShaderChunk.depth_frag\r\n\r\n    },\r\n\r\n    normal: {\r\n\r\n        uniforms: UniformsUtils.merge([\r\n            UniformsLib.common,\r\n            UniformsLib.bumpmap,\r\n            UniformsLib.normalmap,\r\n            UniformsLib.displacementmap,\r\n            {\r\n                opacity: { value: 1.0 }\r\n            }\r\n        ]),\r\n\r\n        vertexShader: ShaderChunk.normal_vert,\r\n        fragmentShader: ShaderChunk.normal_frag\r\n\r\n    },\r\n\r\n    /* -------------------------------------------------------------------------\r\n    //\tCube map shader\r\n     ------------------------------------------------------------------------- */\r\n\r\n    cube: {\r\n\r\n        uniforms: {\r\n            tCube: { value: null },\r\n            tFlip: { value: -1 },\r\n            opacity: { value: 1.0 }\r\n        },\r\n\r\n        vertexShader: ShaderChunk.cube_vert,\r\n        fragmentShader: ShaderChunk.cube_frag\r\n\r\n    },\r\n\r\n    /* -------------------------------------------------------------------------\r\n    //\tCube map shader\r\n     ------------------------------------------------------------------------- */\r\n\r\n    equirect: {\r\n\r\n        uniforms: {\r\n            tEquirect: { value: null },\r\n            tFlip: { value: -1 }\r\n        },\r\n\r\n        vertexShader: ShaderChunk.equirect_vert,\r\n        fragmentShader: ShaderChunk.equirect_frag\r\n\r\n    },\r\n\r\n    distanceRGBA: {\r\n\r\n        uniforms: {\r\n            lightPos: { value: {\r\n                isCartesian3:true,\r\n                x:0,y:0,z:0\r\n            }\r\n                //new Cesium.Cartesian3() \r\n            }\r\n        },\r\n\r\n        vertexShader: ShaderChunk.distanceRGBA_vert,\r\n        fragmentShader: ShaderChunk.distanceRGBA_frag\r\n\r\n    }\r\n\r\n};\r\n\r\nShaderLib.physical = {\r\n\r\n    uniforms: UniformsUtils.merge([\r\n        ShaderLib.standard.uniforms,\r\n        {\r\n            clearCoat: { value: 0 },\r\n            clearCoatRoughness: { value: 0 }\r\n        }\r\n    ]),\r\n\r\n    vertexShader: ShaderChunk.meshphysical_vert,\r\n    fragmentShader: ShaderChunk.meshphysical_frag\r\n\r\n};\r\n\r\nexport default ShaderLib;","\r\nvar normals_frag = \"\\n\\\r\n#ifdef GL_ES\\n\\\r\n    precision highp float;\\n\\\r\n#endif\\n\\\r\n\\n\\\r\nvarying vec3 v_position;\\n\\\r\nvarying vec3 v_normal;\\n\\\r\n\\n\\\r\nuniform vec4 ambientColor;\\n\\\r\nuniform vec4 diffuseColor;\\n\\\r\nuniform vec4 specularColor;\\n\\\r\nuniform float specularShininess;\\n\\\r\nuniform float alpha;\\n\\\r\nuniform float picked;\\n\\\r\nuniform vec4  pickedColor;\\n\\\r\n\\n\\\r\nvarying vec3 v_light0Direction;\\n\\\r\n\\n\\\r\nvoid main(void) \\n\\\r\n{\\n\\\r\n    vec3 normal = normalize(v_normal);\\n\\\r\n    vec4 color = vec4(0.0, 0.0, 0.0, 0.0);\\n\\\r\n    vec3 diffuseLight = vec3(0.0, 0.0, 0.0);\\n\\\r\n    vec3 lightColor = vec3(1.0,1.0,1.0);\\n\\\r\nvec4 ambient = ambientColor;\\n\\\r\n    vec4 diffuse = diffuseColor;\\n\\\r\n    vec4 specular = specularColor;\\n\\\r\n\\n\\\r\n    vec3 specularLight = vec3(0.0, 0.0, 0.0);\\n\\\r\n    {\\n\\\r\n        float specularIntensity = 0.0;\\n\\\r\n        float attenuation = 1.0;\\n\\\r\n        vec3 l = normalize(v_light0Direction);\\n\\\r\n        vec3 viewDir = -normalize(v_position);\\n\\\r\n        vec3 h = normalize(l+viewDir);\\n\\\r\n        specularIntensity = max(0.0, pow(max(dot(normal,h), 0.0) , specularShininess)) * attenuation;\\n\\\r\n        specularLight += lightColor * specularIntensity;\\n\\\r\n        diffuseLight += lightColor * max(dot(normal,l), 0.0) * attenuation;\\n\\\r\n    }\\n\\\r\n    //specular.xyz *= specularLight;\\n\\\r\n    //diffuse.xyz *= diffuseLight;\\n\\\r\n    color.xyz += ambient.xyz;\\n\\\r\n    color.xyz += diffuse.xyz;\\n\\\r\n    color.xyz += specular.xyz;\\n\\\r\n    color = vec4(color.rgb * diffuse.a, diffuse.a*alpha);\\n\\\r\n    gl_FragColor = color;\\n\\\r\n    if(picked!=0.0){\\n\\\r\n        gl_FragColor =mix(color, pickedColor*0.5,1.0);\\n\\\r\n    }\\n\\\r\n}\";\r\nexport default normals_frag; ","\r\nvar texture_frag = \"\\n\\\r\n#ifdef GL_ES\\n\\\r\n    precision highp float;\\n\\\r\n#endif\\n\\\r\n\\n\\\r\nvarying vec3 v_position;\\n\\\r\nvarying vec2 v_texcoord0;\\n\\\r\n\\n\\\r\nuniform vec4 ambientColor;\\n\\\r\nuniform sampler2D diffuseColorMap;\\n\\\r\nuniform vec4 specularColor;\\n\\\r\nuniform float specularShininess;\\n\\\r\nuniform float picked;\\n\\\r\nuniform vec4  pickedColor;\\n\\\r\n\\n\\\r\nuniform float alpha;\\n\\\r\n\\n\\\r\nvoid main(void) \\n\\\r\n{\\n\\\r\n    vec4 color = vec4(0.0, 0.0, 0.0, 0.0);\\n\\\r\n    vec3 diffuseLight = vec3(0.0, 0.0, 0.0);\\n\\\r\n    vec3 lightColor = vec3(1.0,1.0,1.0);\\n\\\r\n    vec4 ambient = ambientColor;\\n\\\r\n    vec4 diffuse = texture2D(diffuseColorMap, v_texcoord0);\\n\\\r\n    vec4 specular = specularColor;\\n\\\r\n    color.xyz += ambient.xyz;\\n\\\r\n    color.xyz += diffuse.xyz;\\n\\\r\n    color.xyz += specular.xyz;\\n\\\r\n    color = vec4(diffuse.rgb * diffuse.a, diffuse.a*alpha);\\n\\\r\n    gl_FragColor = color;\\n\\\r\n    if(picked!=0.0){\\n\\\r\n        gl_FragColor =mix(color, pickedColor*0.5,1.0);\\n\\\r\n    }\\n\\\r\n}\";\r\nexport default texture_frag; \r\n","﻿\r\nimport RendererUtils from './Core/RendererUtils.js';\r\nimport Mesh from './Core/Mesh.js';\r\nimport MeshMaterial from './Core/MeshMaterial.js';\r\nimport ShaderChunk from './Core/Shaders/ShaderChunk.js';\r\nimport MeshVisualizer from './Core/MeshVisualizer.js';\r\nimport FramebufferTexture from './Core/FramebufferTexture.js';\r\nimport GeometryUtils from './Core/GeometryUtils.js';\r\nimport LOD from './Core/LOD.js';\r\nimport PlaneGeometry from './Core/PlaneGeometry.js';\r\nimport Rotation from './Core/Rotation.js';\r\nimport ReferenceMesh from './Core/ReferenceMesh.js';\r\nimport BasicMeshMaterial from './Core/BasicMeshMaterial.js';\r\nimport BasicGeometry from './Core/BasicGeometry.js';\r\nimport ShaderLib from './Core/Shaders/ShaderLib.js';\r\nimport PlaneBufferGeometry from './Core/PlaneBufferGeometry.js';\r\nimport CSG from './Util/CSG.js';\r\nimport MeshPhongMaterial from './Core/MeshPhongMaterial.js';\r\nimport MaterialUtils from './Core/MaterialUtils.js';\r\nimport ShaderUtils from './Core/ShaderUtils.js';\r\nimport defineProperty from './Util/defineProperty.js';\r\n\r\n// var g = typeof window != 'undefined' ? window : (typeof global != 'undefined' ? global : globalThis);\r\nvar CesiumMeshVisualizer = {};\r\nif (typeof Cesium !== 'undefined') {\r\n    //     g.Cesium = {};\r\n    // } else {\r\n    CesiumMeshVisualizer = Cesium;\r\n}\r\n\r\nCesiumMeshVisualizer.defineProperty = defineProperty;\r\nCesiumMeshVisualizer.RendererUtils = RendererUtils;\r\nCesiumMeshVisualizer.MaterialUtils = MaterialUtils;\r\nCesiumMeshVisualizer.ShaderUtils = ShaderUtils;\r\nCesiumMeshVisualizer.GeometryUtils = GeometryUtils;\r\n\r\nCesiumMeshVisualizer.Mesh = Mesh;\r\nCesiumMeshVisualizer.MeshMaterial = MeshMaterial;\r\nCesiumMeshVisualizer.ShaderChunk = ShaderChunk;\r\nCesiumMeshVisualizer.ShaderLib = ShaderLib;\r\nCesiumMeshVisualizer.MeshVisualizer = MeshVisualizer;\r\nCesiumMeshVisualizer.FramebufferTexture = FramebufferTexture;\r\nCesiumMeshVisualizer.LOD = LOD;\r\nCesiumMeshVisualizer.PlaneGeometry = PlaneGeometry;\r\nCesiumMeshVisualizer.Rotation = Rotation;\r\nCesiumMeshVisualizer.ReferenceMesh = ReferenceMesh;\r\nCesiumMeshVisualizer.BasicMeshMaterial = BasicMeshMaterial;\r\nCesiumMeshVisualizer.BasicGeometry = BasicGeometry;\r\nCesiumMeshVisualizer.PlaneBufferGeometry = PlaneBufferGeometry;\r\nCesiumMeshVisualizer.CSG = CSG;\r\nCesiumMeshVisualizer.MeshPhongMaterial = MeshPhongMaterial;\r\nCesiumMeshVisualizer.MeshVisualizerVERSION = '1.0.1';\r\n\r\n\r\nexport {\r\n    RendererUtils, Mesh, MeshMaterial, ShaderChunk, ShaderLib, MeshVisualizer,\r\n    FramebufferTexture, GeometryUtils, LOD, PlaneGeometry, Rotation, ReferenceMesh,\r\n    BasicMeshMaterial, BasicGeometry, PlaneBufferGeometry, CSG,\r\n    MeshPhongMaterial, MaterialUtils, ShaderUtils,defineProperty\r\n}\r\n\r\nexport default CesiumMeshVisualizer;\r\nif (typeof module != 'undefined') {\r\n    module.exports = CesiumMeshVisualizer;\r\n}","// Constructive Solid Geometry (CSG) is a modeling technique that uses Boolean\r\n// operations like union and intersection to combine 3D solids. This library\r\n// implements CSG operations on meshes elegantly and concisely using BSP trees,\r\n// and is meant to serve as an easily understandable implementation of the\r\n// algorithm. All edge cases involving overlapping coplanar polygons in both\r\n// solids are correctly handled.\r\n// \r\n// Example usage:\r\n// \r\n//     var cube = CSG.cube();\r\n//     var sphere = CSG.sphere({ radius: 1.3 });\r\n//     var polygons = cube.subtract(sphere).toPolygons();\r\n// \r\n// ## Implementation Details\r\n// \r\n// All CSG operations are implemented in terms of two functions, `clipTo()` and\r\n// `invert()`, which remove parts of a BSP tree inside another BSP tree and swap\r\n// solid and empty space, respectively. To find the union of `a` and `b`, we\r\n// want to remove everything in `a` inside `b` and everything in `b` inside `a`,\r\n// then combine polygons from `a` and `b` into one solid:\r\n// \r\n//     a.clipTo(b);\r\n//     b.clipTo(a);\r\n//     a.build(b.allPolygons());\r\n// \r\n// The only tricky part is handling overlapping coplanar polygons in both trees.\r\n// The code above keeps both copies, but we need to keep them in one tree and\r\n// remove them in the other tree. To remove them from `b` we can clip the\r\n// inverse of `b` against `a`. The code for union now looks like this:\r\n// \r\n//     a.clipTo(b);\r\n//     b.clipTo(a);\r\n//     b.invert();\r\n//     b.clipTo(a);\r\n//     b.invert();\r\n//     a.build(b.allPolygons());\r\n// \r\n// Subtraction and intersection naturally follow from set operations. If\r\n// union is `A | B`, subtraction is `A - B = ~(~A | B)` and intersection is\r\n// `A & B = ~(~A | ~B)` where `~` is the complement operator.\r\n// \r\n// ## License\r\n// \r\n// Copyright (c) 2011 Evan Wallace (http://madebyevan.com/), under the MIT license.\r\n\r\n// # class CSG\r\n\r\n// Holds a binary space partition tree representing a 3D solid. Two solids can\r\n// be combined using the `union()`, `subtract()`, and `intersect()` methods.\r\n\r\nfunction CSG() {\r\n  this.polygons = [];\r\n};\r\n\r\n// Construct a CSG solid from a list of `CSG.Polygon` instances.\r\nCSG.fromPolygons = function (polygons) {\r\n  var csg = new CSG();\r\n  csg.polygons = polygons;\r\n  return csg;\r\n};\r\n\r\nCSG.prototype = {\r\n  clone: function () {\r\n    var csg = new CSG();\r\n    csg.polygons = this.polygons.map(function (p) { return p.clone(); });\r\n    return csg;\r\n  },\r\n\r\n  toPolygons: function () {\r\n    return this.polygons;\r\n  },\r\n\r\n  // Return a new CSG solid representing space in either this solid or in the\r\n  // solid `csg`. Neither this solid nor the solid `csg` are modified.\r\n  // \r\n  //     A.union(B)\r\n  // \r\n  //     +-------+            +-------+\r\n  //     |       |            |       |\r\n  //     |   A   |            |       |\r\n  //     |    +--+----+   =   |       +----+\r\n  //     +----+--+    |       +----+       |\r\n  //          |   B   |            |       |\r\n  //          |       |            |       |\r\n  //          +-------+            +-------+\r\n  // \r\n  union: function (csg) {\r\n    var a = new CSG.Node(this.clone().polygons);\r\n    var b = new CSG.Node(csg.clone().polygons);\r\n    a.clipTo(b);\r\n    b.clipTo(a);\r\n    b.invert();\r\n    b.clipTo(a);\r\n    b.invert();\r\n    a.build(b.allPolygons());\r\n    return CSG.fromPolygons(a.allPolygons());\r\n  },\r\n\r\n  // Return a new CSG solid representing space in this solid but not in the\r\n  // solid `csg`. Neither this solid nor the solid `csg` are modified.\r\n  // \r\n  //     A.subtract(B)\r\n  // \r\n  //     +-------+            +-------+\r\n  //     |       |            |       |\r\n  //     |   A   |            |       |\r\n  //     |    +--+----+   =   |    +--+\r\n  //     +----+--+    |       +----+\r\n  //          |   B   |\r\n  //          |       |\r\n  //          +-------+\r\n  // \r\n  subtract: function (csg) {\r\n    var a = new CSG.Node(this.clone().polygons);\r\n    var b = new CSG.Node(csg.clone().polygons);\r\n    a.invert();\r\n    a.clipTo(b);\r\n    b.clipTo(a);\r\n    b.invert();\r\n    b.clipTo(a);\r\n    b.invert();\r\n    a.build(b.allPolygons());\r\n    a.invert();\r\n    return CSG.fromPolygons(a.allPolygons());\r\n  },\r\n\r\n  // Return a new CSG solid representing space both this solid and in the\r\n  // solid `csg`. Neither this solid nor the solid `csg` are modified.\r\n  // \r\n  //     A.intersect(B)\r\n  // \r\n  //     +-------+\r\n  //     |       |\r\n  //     |   A   |\r\n  //     |    +--+----+   =   +--+\r\n  //     +----+--+    |       +--+\r\n  //          |   B   |\r\n  //          |       |\r\n  //          +-------+\r\n  // \r\n  intersect: function (csg) {\r\n    var a = new CSG.Node(this.clone().polygons);\r\n    var b = new CSG.Node(csg.clone().polygons);\r\n    a.invert();\r\n    b.clipTo(a);\r\n    b.invert();\r\n    a.clipTo(b);\r\n    b.clipTo(a);\r\n    a.build(b.allPolygons());\r\n    a.invert();\r\n    return CSG.fromPolygons(a.allPolygons());\r\n  },\r\n\r\n  // Return a new CSG solid with solid and empty space switched. This solid is\r\n  // not modified.\r\n  inverse: function () {\r\n    var csg = this.clone();\r\n    csg.polygons.map(function (p) { p.flip(); });\r\n    return csg;\r\n  }\r\n};\r\n\r\n// Construct an axis-aligned solid cuboid. Optional parameters are `center` and\r\n// `radius`, which default to `[0, 0, 0]` and `[1, 1, 1]`. The radius can be\r\n// specified using a single number or a list of three numbers, one for each axis.\r\n// \r\n// Example code:\r\n// \r\n//     var cube = CSG.cube({\r\n//       center: [0, 0, 0],\r\n//       radius: 1\r\n//     });\r\nCSG.cube = function (options) {\r\n  options = options || {};\r\n  var c = new CSG.Vector(options.center || [0, 0, 0]);\r\n  var r = !options.radius ? [1, 1, 1] : options.radius.length ?\r\n    options.radius : [options.radius, options.radius, options.radius];\r\n  return CSG.fromPolygons([\r\n    [[0, 4, 6, 2], [-1, 0, 0]],\r\n    [[1, 3, 7, 5], [+1, 0, 0]],\r\n    [[0, 1, 5, 4], [0, -1, 0]],\r\n    [[2, 6, 7, 3], [0, +1, 0]],\r\n    [[0, 2, 3, 1], [0, 0, -1]],\r\n    [[4, 5, 7, 6], [0, 0, +1]]\r\n  ].map(function (info) {\r\n    return new CSG.Polygon(info[0].map(function (i) {\r\n      var pos = new CSG.Vector(\r\n        c.x + r[0] * (2 * !!(i & 1) - 1),\r\n        c.y + r[1] * (2 * !!(i & 2) - 1),\r\n        c.z + r[2] * (2 * !!(i & 4) - 1)\r\n      );\r\n      return new CSG.Vertex(pos, new CSG.Vector(info[1]));\r\n    }));\r\n  }));\r\n};\r\n\r\n// Construct a solid sphere. Optional parameters are `center`, `radius`,\r\n// `slices`, and `stacks`, which default to `[0, 0, 0]`, `1`, `16`, and `8`.\r\n// The `slices` and `stacks` parameters control the tessellation along the\r\n// longitude and latitude directions.\r\n// \r\n// Example usage:\r\n// \r\n//     var sphere = CSG.sphere({\r\n//       center: [0, 0, 0],\r\n//       radius: 1,\r\n//       slices: 16,\r\n//       stacks: 8\r\n//     });\r\nCSG.sphere = function (options) {\r\n  options = options || {};\r\n  var c = new CSG.Vector(options.center || [0, 0, 0]);\r\n  var r = options.radius || 1;\r\n  var slices = options.slices || 16;\r\n  var stacks = options.stacks || 8;\r\n  var polygons = [], vertices;\r\n  function vertex(theta, phi) {\r\n    theta *= Math.PI * 2;\r\n    phi *= Math.PI;\r\n    var dir = new CSG.Vector(\r\n      Math.cos(theta) * Math.sin(phi),\r\n      Math.cos(phi),\r\n      Math.sin(theta) * Math.sin(phi)\r\n    );\r\n    vertices.push(new CSG.Vertex(c.plus(dir.times(r)), dir));\r\n  }\r\n  for (var i = 0; i < slices; i++) {\r\n    for (var j = 0; j < stacks; j++) {\r\n      vertices = [];\r\n      vertex(i / slices, j / stacks);\r\n      if (j > 0) vertex((i + 1) / slices, j / stacks);\r\n      if (j < stacks - 1) vertex((i + 1) / slices, (j + 1) / stacks);\r\n      vertex(i / slices, (j + 1) / stacks);\r\n      polygons.push(new CSG.Polygon(vertices));\r\n    }\r\n  }\r\n  return CSG.fromPolygons(polygons);\r\n};\r\n\r\n// Construct a solid cylinder. Optional parameters are `start`, `end`,\r\n// `radius`, and `slices`, which default to `[0, -1, 0]`, `[0, 1, 0]`, `1`, and\r\n// `16`. The `slices` parameter controls the tessellation.\r\n// \r\n// Example usage:\r\n// \r\n//     var cylinder = CSG.cylinder({\r\n//       start: [0, -1, 0],\r\n//       end: [0, 1, 0],\r\n//       radius: 1,\r\n//       slices: 16\r\n//     });\r\nCSG.cylinder = function (options) {\r\n  options = options || {};\r\n  var s = new CSG.Vector(options.start || [0, -1, 0]);\r\n  var e = new CSG.Vector(options.end || [0, 1, 0]);\r\n  var ray = e.minus(s);\r\n  var r = options.radius || 1;\r\n  var slices = options.slices || 16;\r\n  var axisZ = ray.unit(), isY = (Math.abs(axisZ.y) > 0.5);\r\n  var axisX = new CSG.Vector(isY, !isY, 0).cross(axisZ).unit();\r\n  var axisY = axisX.cross(axisZ).unit();\r\n  var start = new CSG.Vertex(s, axisZ.negated());\r\n  var end = new CSG.Vertex(e, axisZ.unit());\r\n  var polygons = [];\r\n  function point(stack, slice, normalBlend) {\r\n    var angle = slice * Math.PI * 2;\r\n    var out = axisX.times(Math.cos(angle)).plus(axisY.times(Math.sin(angle)));\r\n    var pos = s.plus(ray.times(stack)).plus(out.times(r));\r\n    var normal = out.times(1 - Math.abs(normalBlend)).plus(axisZ.times(normalBlend));\r\n    return new CSG.Vertex(pos, normal);\r\n  }\r\n  for (var i = 0; i < slices; i++) {\r\n    var t0 = i / slices, t1 = (i + 1) / slices;\r\n    polygons.push(new CSG.Polygon([start, point(0, t0, -1), point(0, t1, -1)]));\r\n    polygons.push(new CSG.Polygon([point(0, t1, 0), point(0, t0, 0), point(1, t0, 0), point(1, t1, 0)]));\r\n    polygons.push(new CSG.Polygon([end, point(1, t1, 1), point(1, t0, 1)]));\r\n  }\r\n  return CSG.fromPolygons(polygons);\r\n};\r\n\r\n// # class Vector\r\n\r\n// Represents a 3D vector.\r\n// \r\n// Example usage:\r\n// \r\n//     new CSG.Vector(1, 2, 3);\r\n//     new CSG.Vector([1, 2, 3]);\r\n//     new CSG.Vector({ x: 1, y: 2, z: 3 });\r\n\r\nCSG.Vector = function (x, y, z) {\r\n  if (arguments.length == 3) {\r\n    this.x = x;\r\n    this.y = y;\r\n    this.z = z;\r\n  } else if ('x' in x) {\r\n    this.x = x.x;\r\n    this.y = x.y;\r\n    this.z = x.z;\r\n  } else {\r\n    this.x = x[0];\r\n    this.y = x[1];\r\n    this.z = x[2];\r\n  }\r\n};\r\n\r\nCSG.Vector.prototype = {\r\n  clone: function () {\r\n    return new CSG.Vector(this.x, this.y, this.z);\r\n  },\r\n\r\n  negated: function () {\r\n    return new CSG.Vector(-this.x, -this.y, -this.z);\r\n  },\r\n\r\n  plus: function (a) {\r\n    return new CSG.Vector(this.x + a.x, this.y + a.y, this.z + a.z);\r\n  },\r\n\r\n  minus: function (a) {\r\n    return new CSG.Vector(this.x - a.x, this.y - a.y, this.z - a.z);\r\n  },\r\n\r\n  times: function (a) {\r\n    return new CSG.Vector(this.x * a, this.y * a, this.z * a);\r\n  },\r\n\r\n  dividedBy: function (a) {\r\n    return new CSG.Vector(this.x / a, this.y / a, this.z / a);\r\n  },\r\n\r\n  dot: function (a) {\r\n    return this.x * a.x + this.y * a.y + this.z * a.z;\r\n  },\r\n\r\n  lerp: function (a, t) {\r\n    return this.plus(a.minus(this).times(t));\r\n  },\r\n\r\n  length: function () {\r\n    return Math.sqrt(this.dot(this));\r\n  },\r\n\r\n  unit: function () {\r\n    return this.dividedBy(this.length());\r\n  },\r\n\r\n  cross: function (a) {\r\n    return new CSG.Vector(\r\n      this.y * a.z - this.z * a.y,\r\n      this.z * a.x - this.x * a.z,\r\n      this.x * a.y - this.y * a.x\r\n    );\r\n  }\r\n};\r\n\r\n// # class Vertex\r\n\r\n// Represents a vertex of a polygon. Use your own vertex class instead of this\r\n// one to provide additional features like texture coordinates and vertex\r\n// colors. Custom vertex classes need to provide a `pos` property and `clone()`,\r\n// `flip()`, and `interpolate()` methods that behave analogous to the ones\r\n// defined by `CSG.Vertex`. This class provides `normal` so convenience\r\n// functions like `CSG.sphere()` can return a smooth vertex normal, but `normal`\r\n// is not used anywhere else.\r\n\r\nCSG.Vertex = function (pos, normal) {\r\n  this.pos = new CSG.Vector(pos);\r\n  this.normal = new CSG.Vector(normal);\r\n};\r\n\r\nCSG.Vertex.prototype = {\r\n  clone: function () {\r\n    return new CSG.Vertex(this.pos.clone(), this.normal.clone());\r\n  },\r\n\r\n  // Invert all orientation-specific data (e.g. vertex normal). Called when the\r\n  // orientation of a polygon is flipped.\r\n  flip: function () {\r\n    this.normal = this.normal.negated();\r\n  },\r\n\r\n  // Create a new vertex between this vertex and `other` by linearly\r\n  // interpolating all properties using a parameter of `t`. Subclasses should\r\n  // override this to interpolate additional properties.\r\n  interpolate: function (other, t) {\r\n    return new CSG.Vertex(\r\n      this.pos.lerp(other.pos, t),\r\n      this.normal.lerp(other.normal, t)\r\n    );\r\n  }\r\n};\r\n\r\n// # class Plane\r\n\r\n// Represents a plane in 3D space.\r\n\r\nCSG.Plane = function (normal, w) {\r\n  this.normal = normal;\r\n  this.w = w;\r\n};\r\n\r\n// `CSG.Plane.EPSILON` is the tolerance used by `splitPolygon()` to decide if a\r\n// point is on the plane.\r\nCSG.Plane.EPSILON = 1e-5;\r\n\r\nCSG.Plane.fromPoints = function (a, b, c) {\r\n  var n = b.minus(a).cross(c.minus(a)).unit();\r\n  return new CSG.Plane(n, n.dot(a));\r\n};\r\n\r\nCSG.Plane.prototype = {\r\n  clone: function () {\r\n    return new CSG.Plane(this.normal.clone(), this.w);\r\n  },\r\n\r\n  flip: function () {\r\n    this.normal = this.normal.negated();\r\n    this.w = -this.w;\r\n  },\r\n\r\n  // Split `polygon` by this plane if needed, then put the polygon or polygon\r\n  // fragments in the appropriate lists. Coplanar polygons go into either\r\n  // `coplanarFront` or `coplanarBack` depending on their orientation with\r\n  // respect to this plane. Polygons in front or in back of this plane go into\r\n  // either `front` or `back`.\r\n  splitPolygon: function (polygon, coplanarFront, coplanarBack, front, back) {\r\n    var COPLANAR = 0;\r\n    var FRONT = 1;\r\n    var BACK = 2;\r\n    var SPANNING = 3;\r\n\r\n    // Classify each point as well as the entire polygon into one of the above\r\n    // four classes.\r\n    var polygonType = 0;\r\n    var types = [];\r\n    for (var i = 0; i < polygon.vertices.length; i++) {\r\n      var t = this.normal.dot(polygon.vertices[i].pos) - this.w;\r\n      var type = (t < -CSG.Plane.EPSILON) ? BACK : (t > CSG.Plane.EPSILON) ? FRONT : COPLANAR;\r\n      polygonType |= type;\r\n      types.push(type);\r\n    }\r\n\r\n    // Put the polygon in the correct list, splitting it when necessary.\r\n    switch (polygonType) {\r\n      case COPLANAR:\r\n        (this.normal.dot(polygon.plane.normal) > 0 ? coplanarFront : coplanarBack).push(polygon);\r\n        break;\r\n      case FRONT:\r\n        front.push(polygon);\r\n        break;\r\n      case BACK:\r\n        back.push(polygon);\r\n        break;\r\n      case SPANNING:\r\n        var f = [], b = [];\r\n        for (var i = 0; i < polygon.vertices.length; i++) {\r\n          var j = (i + 1) % polygon.vertices.length;\r\n          var ti = types[i], tj = types[j];\r\n          var vi = polygon.vertices[i], vj = polygon.vertices[j];\r\n          if (ti != BACK) f.push(vi);\r\n          if (ti != FRONT) b.push(ti != BACK ? vi.clone() : vi);\r\n          if ((ti | tj) == SPANNING) {\r\n            var t = (this.w - this.normal.dot(vi.pos)) / this.normal.dot(vj.pos.minus(vi.pos));\r\n            var v = vi.interpolate(vj, t);\r\n            f.push(v);\r\n            b.push(v.clone());\r\n          }\r\n        }\r\n        if (f.length >= 3) front.push(new CSG.Polygon(f, polygon.shared));\r\n        if (b.length >= 3) back.push(new CSG.Polygon(b, polygon.shared));\r\n        break;\r\n    }\r\n  }\r\n};\r\n\r\n// # class Polygon\r\n\r\n// Represents a convex polygon. The vertices used to initialize a polygon must\r\n// be coplanar and form a convex loop. They do not have to be `CSG.Vertex`\r\n// instances but they must behave similarly (duck typing can be used for\r\n// customization).\r\n// \r\n// Each convex polygon has a `shared` property, which is shared between all\r\n// polygons that are clones of each other or were split from the same polygon.\r\n// This can be used to define per-polygon properties (such as surface color).\r\n\r\nCSG.Polygon = function (vertices, shared) {\r\n  this.vertices = vertices;\r\n  this.shared = shared;\r\n  this.plane = CSG.Plane.fromPoints(vertices[0].pos, vertices[1].pos, vertices[2].pos);\r\n};\r\n\r\nCSG.Polygon.prototype = {\r\n  clone: function () {\r\n    var vertices = this.vertices.map(function (v) { return v.clone(); });\r\n    return new CSG.Polygon(vertices, this.shared);\r\n  },\r\n\r\n  flip: function () {\r\n    this.vertices.reverse().map(function (v) { v.flip(); });\r\n    this.plane.flip();\r\n  }\r\n};\r\n\r\n// # class Node\r\n\r\n// Holds a node in a BSP tree. A BSP tree is built from a collection of polygons\r\n// by picking a polygon to split along. That polygon (and all other coplanar\r\n// polygons) are added directly to that node and the other polygons are added to\r\n// the front and/or back subtrees. This is not a leafy BSP tree since there is\r\n// no distinction between internal and leaf nodes.\r\n\r\nCSG.Node = function (polygons) {\r\n  this.plane = null;\r\n  this.front = null;\r\n  this.back = null;\r\n  this.polygons = [];\r\n  if (polygons) this.build(polygons);\r\n};\r\n\r\nCSG.Node.prototype = {\r\n  clone: function () {\r\n    var node = new CSG.Node();\r\n    node.plane = this.plane && this.plane.clone();\r\n    node.front = this.front && this.front.clone();\r\n    node.back = this.back && this.back.clone();\r\n    node.polygons = this.polygons.map(function (p) { return p.clone(); });\r\n    return node;\r\n  },\r\n\r\n  // Convert solid space to empty space and empty space to solid space.\r\n  invert: function () {\r\n    for (var i = 0; i < this.polygons.length; i++) {\r\n      this.polygons[i].flip();\r\n    }\r\n    this.plane.flip();\r\n    if (this.front) this.front.invert();\r\n    if (this.back) this.back.invert();\r\n    var temp = this.front;\r\n    this.front = this.back;\r\n    this.back = temp;\r\n  },\r\n\r\n  // Recursively remove all polygons in `polygons` that are inside this BSP\r\n  // tree.\r\n  clipPolygons: function (polygons) {\r\n    if (!this.plane) return polygons.slice();\r\n    var front = [], back = [];\r\n    for (var i = 0; i < polygons.length; i++) {\r\n      this.plane.splitPolygon(polygons[i], front, back, front, back);\r\n    }\r\n    if (this.front) front = this.front.clipPolygons(front);\r\n    if (this.back) back = this.back.clipPolygons(back);\r\n    else back = [];\r\n    return front.concat(back);\r\n  },\r\n\r\n  // Remove all polygons in this BSP tree that are inside the other BSP tree\r\n  // `bsp`.\r\n  clipTo: function (bsp) {\r\n    this.polygons = bsp.clipPolygons(this.polygons);\r\n    if (this.front) this.front.clipTo(bsp);\r\n    if (this.back) this.back.clipTo(bsp);\r\n  },\r\n\r\n  // Return a list of all polygons in this BSP tree.\r\n  allPolygons: function () {\r\n    var polygons = this.polygons.slice();\r\n    if (this.front) polygons = polygons.concat(this.front.allPolygons());\r\n    if (this.back) polygons = polygons.concat(this.back.allPolygons());\r\n    return polygons;\r\n  },\r\n\r\n  // Build a BSP tree out of `polygons`. When called on an existing tree, the\r\n  // new polygons are filtered down to the bottom of the tree and become new\r\n  // nodes there. Each set of polygons is partitioned using the first polygon\r\n  // (no heuristic is used to pick a good split).\r\n  build: function (polygons) {\r\n    if (!polygons.length) return;\r\n    if (!this.plane) this.plane = polygons[0].plane.clone();\r\n    var front = [], back = [];\r\n    for (var i = 0; i < polygons.length; i++) {\r\n      this.plane.splitPolygon(polygons[i], this.polygons, this.polygons, front, back);\r\n    }\r\n    if (front.length) {\r\n      if (!this.front) this.front = new CSG.Node();\r\n      this.front.build(front);\r\n    }\r\n    if (back.length) {\r\n      if (!this.back) this.back = new CSG.Node();\r\n      this.back.build(back);\r\n    }\r\n  }\r\n};\r\n\r\nexport default CSG;","/* This Source Code Form is subject to the terms of the Mozilla Public\r\n * License, v. 2.0. If a copy of the MPL was not distributed with this\r\n * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\r\n\r\n\"use strict\";\r\n\r\nfunction TIFFParser() {\r\n\tthis.tiffDataView = undefined;\r\n\tthis.littleEndian = undefined;\r\n\tthis.fileDirectories = [];\r\n};\r\n\r\nTIFFParser.prototype = {\r\n\tisLittleEndian: function () {\r\n\t\t// Get byte order mark.\r\n\t\tvar BOM = this.getBytes(2, 0);\r\n\r\n\t\t// Find out the endianness.\r\n\t\tif (BOM === 0x4949) {\r\n\t\t\tthis.littleEndian = true;\r\n\t\t} else if (BOM === 0x4D4D) {\r\n\t\t\tthis.littleEndian = false;\r\n\t\t} else {\r\n\t\t\tconsole.log( BOM );\r\n\t\t\tthrow TypeError(\"Invalid byte order value.\");\r\n\t\t}\r\n\r\n\t\treturn this.littleEndian;\r\n\t},\r\n\r\n\thasTowel: function () {\r\n\t\t// Check for towel.\r\n\t\tif (this.getBytes(2, 2) !== 42) {\r\n\t\t\tthrow RangeError(\"You forgot your towel!\");\r\n\t\t\treturn false;\r\n\t\t}\r\n\r\n\t\treturn true;\r\n\t},\r\n\r\n\tgetFieldTagName: function (fieldTag) {\r\n\t\t// See: http://www.digitizationguidelines.gov/guidelines/TIFF_Metadata_Final.pdf\r\n\t\t// See: http://www.digitalpreservation.gov/formats/content/tiff_tags.shtml\r\n\t\tvar fieldTagNames = {\r\n\t\t\t// TIFF Baseline\r\n\t\t\t0x013B: 'Artist',\r\n\t\t\t0x0102: 'BitsPerSample',\r\n\t\t\t0x0109: 'CellLength',\r\n\t\t\t0x0108: 'CellWidth',\r\n\t\t\t0x0140: 'ColorMap',\r\n\t\t\t0x0103: 'Compression',\r\n\t\t\t0x8298: 'Copyright',\r\n\t\t\t0x0132: 'DateTime',\r\n\t\t\t0x0152: 'ExtraSamples',\r\n\t\t\t0x010A: 'FillOrder',\r\n\t\t\t0x0121: 'FreeByteCounts',\r\n\t\t\t0x0120: 'FreeOffsets',\r\n\t\t\t0x0123: 'GrayResponseCurve',\r\n\t\t\t0x0122: 'GrayResponseUnit',\r\n\t\t\t0x013C: 'HostComputer',\r\n\t\t\t0x010E: 'ImageDescription',\r\n\t\t\t0x0101: 'ImageLength',\r\n\t\t\t0x0100: 'ImageWidth',\r\n\t\t\t0x010F: 'Make',\r\n\t\t\t0x0119: 'MaxSampleValue',\r\n\t\t\t0x0118: 'MinSampleValue',\r\n\t\t\t0x0110: 'Model',\r\n\t\t\t0x00FE: 'NewSubfileType',\r\n\t\t\t0x0112: 'Orientation',\r\n\t\t\t0x0106: 'PhotometricInterpretation',\r\n\t\t\t0x011C: 'PlanarConfiguration',\r\n\t\t\t0x0128: 'ResolutionUnit',\r\n\t\t\t0x0116: 'RowsPerStrip',\r\n\t\t\t0x0115: 'SamplesPerPixel',\r\n\t\t\t0x0131: 'Software',\r\n\t\t\t0x0117: 'StripByteCounts',\r\n\t\t\t0x0111: 'StripOffsets',\r\n\t\t\t0x00FF: 'SubfileType',\r\n\t\t\t0x0107: 'Threshholding',\r\n\t\t\t0x011A: 'XResolution',\r\n\t\t\t0x011B: 'YResolution',\r\n\r\n\t\t\t// TIFF Extended\r\n\t\t\t0x0146: 'BadFaxLines',\r\n\t\t\t0x0147: 'CleanFaxData',\r\n\t\t\t0x0157: 'ClipPath',\r\n\t\t\t0x0148: 'ConsecutiveBadFaxLines',\r\n\t\t\t0x01B1: 'Decode',\r\n\t\t\t0x01B2: 'DefaultImageColor',\r\n\t\t\t0x010D: 'DocumentName',\r\n\t\t\t0x0150: 'DotRange',\r\n\t\t\t0x0141: 'HalftoneHints',\r\n\t\t\t0x015A: 'Indexed',\r\n\t\t\t0x015B: 'JPEGTables',\r\n\t\t\t0x011D: 'PageName',\r\n\t\t\t0x0129: 'PageNumber',\r\n\t\t\t0x013D: 'Predictor',\r\n\t\t\t0x013F: 'PrimaryChromaticities',\r\n\t\t\t0x0214: 'ReferenceBlackWhite',\r\n\t\t\t0x0153: 'SampleFormat',\r\n\t\t\t0x022F: 'StripRowCounts',\r\n\t\t\t0x014A: 'SubIFDs',\r\n\t\t\t0x0124: 'T4Options',\r\n\t\t\t0x0125: 'T6Options',\r\n\t\t\t0x0145: 'TileByteCounts',\r\n\t\t\t0x0143: 'TileLength',\r\n\t\t\t0x0144: 'TileOffsets',\r\n\t\t\t0x0142: 'TileWidth',\r\n\t\t\t0x012D: 'TransferFunction',\r\n\t\t\t0x013E: 'WhitePoint',\r\n\t\t\t0x0158: 'XClipPathUnits',\r\n\t\t\t0x011E: 'XPosition',\r\n\t\t\t0x0211: 'YCbCrCoefficients',\r\n\t\t\t0x0213: 'YCbCrPositioning',\r\n\t\t\t0x0212: 'YCbCrSubSampling',\r\n\t\t\t0x0159: 'YClipPathUnits',\r\n\t\t\t0x011F: 'YPosition',\r\n\r\n\t\t\t// EXIF\r\n\t\t\t0x9202: 'ApertureValue',\r\n\t\t\t0xA001: 'ColorSpace',\r\n\t\t\t0x9004: 'DateTimeDigitized',\r\n\t\t\t0x9003: 'DateTimeOriginal',\r\n\t\t\t0x8769: 'Exif IFD',\r\n\t\t\t0x9000: 'ExifVersion',\r\n\t\t\t0x829A: 'ExposureTime',\r\n\t\t\t0xA300: 'FileSource',\r\n\t\t\t0x9209: 'Flash',\r\n\t\t\t0xA000: 'FlashpixVersion',\r\n\t\t\t0x829D: 'FNumber',\r\n\t\t\t0xA420: 'ImageUniqueID',\r\n\t\t\t0x9208: 'LightSource',\r\n\t\t\t0x927C: 'MakerNote',\r\n\t\t\t0x9201: 'ShutterSpeedValue',\r\n\t\t\t0x9286: 'UserComment',\r\n\r\n\t\t\t// IPTC\r\n\t\t\t0x83BB: 'IPTC',\r\n\r\n\t\t\t// ICC\r\n\t\t\t0x8773: 'ICC Profile',\r\n\r\n\t\t\t// XMP\r\n\t\t\t0x02BC: 'XMP',\r\n\r\n\t\t\t// GDAL\r\n\t\t\t0xA480: 'GDAL_METADATA',\r\n\t\t\t0xA481: 'GDAL_NODATA',\r\n\r\n\t\t\t// Photoshop\r\n\t\t\t0x8649: 'Photoshop',\r\n\t\t};\r\n\r\n\t\tvar fieldTagName;\r\n\r\n\t\tif (fieldTag in fieldTagNames) {\r\n\t\t\tfieldTagName = fieldTagNames[fieldTag];\r\n\t\t} else {\r\n\t\t\t//console.log( \"Unknown Field Tag:\", fieldTag);\r\n\t\t\tfieldTagName = \"Tag\" + fieldTag;\r\n\t\t}\r\n\r\n\t\treturn fieldTagName;\r\n\t},\r\n\r\n\tgetFieldTypeName: function (fieldType) {\r\n\t\tvar fieldTypeNames = {\r\n\t\t\t0x0001: 'BYTE',\r\n\t\t\t0x0002: 'ASCII',\r\n\t\t\t0x0003: 'SHORT',\r\n\t\t\t0x0004: 'LONG',\r\n\t\t\t0x0005: 'RATIONAL',\r\n\t\t\t0x0006: 'SBYTE',\r\n\t\t\t0x0007: 'UNDEFINED',\r\n\t\t\t0x0008: 'SSHORT',\r\n\t\t\t0x0009: 'SLONG',\r\n\t\t\t0x000A: 'SRATIONAL',\r\n\t\t\t0x000B: 'FLOAT',\r\n\t\t\t0x000C: 'DOUBLE',\r\n\t\t};\r\n\r\n\t\tvar fieldTypeName;\r\n\r\n\t\tif (fieldType in fieldTypeNames) {\r\n\t\t\tfieldTypeName = fieldTypeNames[fieldType];\r\n\t\t}\r\n\r\n\t\treturn fieldTypeName;\r\n\t},\r\n\r\n\tgetFieldTypeLength: function (fieldTypeName) {\r\n\t\tvar fieldTypeLength;\r\n\r\n\t\tif (['BYTE', 'ASCII', 'SBYTE', 'UNDEFINED'].indexOf(fieldTypeName) !== -1) {\r\n\t\t\tfieldTypeLength = 1;\r\n\t\t} else if (['SHORT', 'SSHORT'].indexOf(fieldTypeName) !== -1) {\r\n\t\t\tfieldTypeLength = 2;\r\n\t\t} else if (['LONG', 'SLONG', 'FLOAT'].indexOf(fieldTypeName) !== -1) {\r\n\t\t\tfieldTypeLength = 4;\r\n\t\t} else if (['RATIONAL', 'SRATIONAL', 'DOUBLE'].indexOf(fieldTypeName) !== -1) {\r\n\t\t\tfieldTypeLength = 8;\r\n\t\t}\r\n\r\n\t\treturn fieldTypeLength;\r\n\t},\r\n\r\n\tgetBits: function (numBits, byteOffset, bitOffset) {\r\n\t\tbitOffset = bitOffset || 0;\r\n\t\tvar extraBytes = Math.floor(bitOffset / 8);\r\n\t\tvar newByteOffset = byteOffset + extraBytes;\r\n\t\tvar totalBits = bitOffset + numBits;\r\n\t\tvar shiftRight = 32 - numBits;\r\n\r\n\t\tif (totalBits <= 0) {\r\n\t\t\tconsole.log( numBits, byteOffset, bitOffset );\r\n\t\t\tthrow RangeError(\"No bits requested\");\r\n\t\t} else if (totalBits <= 8) {\r\n\t\t\tvar shiftLeft = 24 + bitOffset;\r\n\t\t\tvar rawBits = this.tiffDataView.getUint8(newByteOffset, this.littleEndian);\r\n\t\t} else if (totalBits <= 16) {\r\n\t\t\tvar shiftLeft = 16 + bitOffset;\r\n\t\t\tvar rawBits = this.tiffDataView.getUint16(newByteOffset, this.littleEndian);\r\n\t\t} else if (totalBits <= 32) {\r\n\t\t\tvar shiftLeft = bitOffset;\r\n\t\t\tvar rawBits = this.tiffDataView.getUint32(newByteOffset, this.littleEndian);\r\n\t\t} else {\r\n\t\t\tconsole.log( numBits, byteOffset, bitOffset );\r\n\t\t\tthrow RangeError(\"Too many bits requested\");\r\n\t\t}\r\n\r\n\t\tvar chunkInfo = {\r\n\t\t\t'bits': ((rawBits << shiftLeft) >>> shiftRight),\r\n\t\t\t'byteOffset': newByteOffset + Math.floor(totalBits / 8),\r\n\t\t\t'bitOffset': totalBits % 8,\r\n\t\t};\r\n\r\n\t\treturn chunkInfo;\r\n\t},\r\n\r\n\tgetBytes: function (numBytes, offset) {\r\n\t\tif (numBytes <= 0) {\r\n\t\t\tconsole.log( numBytes, offset );\r\n\t\t\tthrow RangeError(\"No bytes requested\");\r\n\t\t} else if (numBytes <= 1) {\r\n\t\t\treturn this.tiffDataView.getUint8(offset, this.littleEndian);\r\n\t\t} else if (numBytes <= 2) {\r\n\t\t\treturn this.tiffDataView.getUint16(offset, this.littleEndian);\r\n\t\t} else if (numBytes <= 3) {\r\n\t\t\treturn this.tiffDataView.getUint32(offset, this.littleEndian) >>> 8;\r\n\t\t} else if (numBytes <= 4) {\r\n\t\t\treturn this.tiffDataView.getUint32(offset, this.littleEndian);\r\n\t\t} else {\r\n\t\t\tconsole.log( numBytes, offset );\r\n\t\t\tthrow RangeError(\"Too many bytes requested\");\r\n\t\t}\r\n\t},\r\n\r\n\tgetFieldValues: function (fieldTagName, fieldTypeName, typeCount, valueOffset) {\r\n\t\tvar fieldValues = [];\r\n\r\n\t\tvar fieldTypeLength = this.getFieldTypeLength(fieldTypeName);\r\n\t\tvar fieldValueSize = fieldTypeLength * typeCount;\r\n\r\n\t\tif (fieldValueSize <= 4) {\r\n\t\t\t// The value is stored at the big end of the valueOffset.\r\n\t\t\tif (this.littleEndian === false) {\r\n\t\t\t\tvar value = valueOffset >>> ((4 - fieldTypeLength) * 8);\r\n\t\t\t} else {\r\n\t\t\t\tvar value = valueOffset;\r\n\t\t\t}\r\n\r\n\t\t\tfieldValues.push(value);\r\n\t\t} else {\r\n\t\t\tfor (var i = 0; i < typeCount; i++) {\r\n\t\t\t\tvar indexOffset = fieldTypeLength * i;\r\n\r\n\t\t\t\tif (fieldTypeLength >= 8) {\r\n\t\t\t\t\tif (['RATIONAL', 'SRATIONAL'].indexOf(fieldTypeName) !== -1) {\r\n\t\t\t\t\t\t// Numerator\r\n\t\t\t\t\t\tfieldValues.push(this.getBytes(4, valueOffset + indexOffset));\r\n\t\t\t\t\t\t// Denominator\r\n\t\t\t\t\t\tfieldValues.push(this.getBytes(4, valueOffset + indexOffset + 4));\r\n//\t\t\t\t\t} else if (['DOUBLE'].indexOf(fieldTypeName) !== -1) {\r\n//\t\t\t\t\t\tfieldValues.push(this.getBytes(4, valueOffset + indexOffset) + this.getBytes(4, valueOffset + indexOffset + 4));\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tconsole.log( fieldTypeName, typeCount, fieldValueSize );\r\n\t\t\t\t\t\tthrow TypeError(\"Can't handle this field type or size\");\r\n\t\t\t\t\t}\r\n\t\t\t\t} else {\r\n\t\t\t\t\tfieldValues.push(this.getBytes(fieldTypeLength, valueOffset + indexOffset));\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tif (fieldTypeName === 'ASCII') {\r\n\t\t\tfieldValues.forEach(function(e, i, a) { a[i] = String.fromCharCode(e); });\r\n\t\t}\r\n\r\n\t\treturn fieldValues;\r\n\t},\r\n\r\n\tclampColorSample: function(colorSample, bitsPerSample) {\r\n\t\tvar multiplier = Math.pow(2, 8 - bitsPerSample);\r\n\r\n\t\treturn Math.floor((colorSample * multiplier) + (multiplier - 1));\r\n\t},\r\n\r\n\tmakeRGBAFillValue: function(r, g, b, a) {\r\n\t\tif(typeof a === 'undefined') {\r\n\t\t\ta = 1.0;\r\n\t\t}\r\n\t\treturn \"rgba(\" + r + \", \" + g + \", \" + b + \", \" + a + \")\";\r\n\t},\r\n\r\n\tparseFileDirectory: function (byteOffset) {\r\n\t\tvar numDirEntries = this.getBytes(2, byteOffset);\r\n\r\n\t\tvar tiffFields = [];\r\n\r\n\t\tfor (var i = byteOffset + 2, entryCount = 0; entryCount < numDirEntries; i += 12, entryCount++) {\r\n\t\t\tvar fieldTag = this.getBytes(2, i);\r\n\t\t\tvar fieldType = this.getBytes(2, i + 2);\r\n\t\t\tvar typeCount = this.getBytes(4, i + 4);\r\n\t\t\tvar valueOffset = this.getBytes(4, i + 8);\r\n\r\n\t\t\tvar fieldTagName = this.getFieldTagName( fieldTag );\r\n\t\t\tvar fieldTypeName = this.getFieldTypeName( fieldType );\r\n\r\n\t\t\tvar fieldValues = this.getFieldValues(fieldTagName, fieldTypeName, typeCount, valueOffset);\r\n\r\n\t\t\ttiffFields[fieldTagName] = { 'type': fieldTypeName, 'values': fieldValues };\r\n\t\t}\r\n\r\n\t\tthis.fileDirectories.push( tiffFields );\r\n\r\n\t\tvar nextIFDByteOffset = this.getBytes(4, i);\r\n\r\n\t\tif (nextIFDByteOffset === 0x00000000) {\r\n\t\t\treturn this.fileDirectories;\r\n\t\t} else {\r\n\t\t\treturn this.parseFileDirectory(nextIFDByteOffset);\r\n\t\t}\r\n\t},\r\n\r\n\tparseTIFF: function (tiffArrayBuffer, canvas) {\r\n\t\tcanvas = canvas || document.createElement('canvas');\r\n\r\n\t\tthis.tiffDataView = new DataView(tiffArrayBuffer);\r\n\t\tthis.canvas = canvas;\r\n\r\n\t\tthis.littleEndian = this.isLittleEndian(this.tiffDataView);\r\n\r\n\t\tif (!this.hasTowel(this.tiffDataView, this.littleEndian)) {\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tvar firstIFDByteOffset = this.getBytes(4, 4);\r\n\r\n\t\tthis.fileDirectories = this.parseFileDirectory(firstIFDByteOffset);\r\n\r\n\t\tvar fileDirectory = this.fileDirectories[0];\r\n\r\n\t\t//console.log( fileDirectory );\r\n\r\n\t\tvar imageWidth = fileDirectory.ImageWidth.values[0];\r\n\t\tvar imageLength = fileDirectory.ImageLength.values[0];\r\n\r\n\t\tthis.canvas.width = imageWidth;\r\n\t\tthis.canvas.height = imageLength;\r\n\r\n\t\tvar strips = [];\r\n\r\n\t\tvar compression = (fileDirectory.Compression) ? fileDirectory.Compression.values[0] : 1;\r\n\r\n\t\tvar samplesPerPixel = fileDirectory.SamplesPerPixel.values[0];\r\n\r\n\t\tvar sampleProperties = [];\r\n\r\n\t\tvar bitsPerPixel = 0;\r\n\t\tvar hasBytesPerPixel = false;\r\n\r\n\t\tfileDirectory.BitsPerSample.values.forEach(function(bitsPerSample, i, bitsPerSampleValues) {\r\n\t\t\tsampleProperties[i] = {\r\n\t\t\t\t'bitsPerSample': bitsPerSample,\r\n\t\t\t\t'hasBytesPerSample': false,\r\n\t\t\t\t'bytesPerSample': undefined,\r\n\t\t\t};\r\n\r\n\t\t\tif ((bitsPerSample % 8) === 0) {\r\n\t\t\t\tsampleProperties[i].hasBytesPerSample = true;\r\n\t\t\t\tsampleProperties[i].bytesPerSample = bitsPerSample / 8;\r\n\t\t\t}\r\n\r\n\t\t\tbitsPerPixel += bitsPerSample;\r\n\t\t}, this);\r\n\r\n\t\tif ((bitsPerPixel % 8) === 0) {\r\n\t\t\thasBytesPerPixel = true;\r\n\t\t\tvar bytesPerPixel = bitsPerPixel / 8;\r\n\t\t}\r\n\r\n\t\tvar stripOffsetValues = fileDirectory.StripOffsets.values;\r\n\t\tvar numStripOffsetValues = stripOffsetValues.length;\r\n\r\n\t\t// StripByteCounts is supposed to be required, but see if we can recover anyway.\r\n\t\tif (fileDirectory.StripByteCounts) {\r\n\t\t\tvar stripByteCountValues = fileDirectory.StripByteCounts.values;\r\n\t\t} else {\r\n\t\t\tconsole.log(\"Missing StripByteCounts!\");\r\n\r\n\t\t\t// Infer StripByteCounts, if possible.\r\n\t\t\tif (numStripOffsetValues === 1) {\r\n\t\t\t\tvar stripByteCountValues = [Math.ceil((imageWidth * imageLength * bitsPerPixel) / 8)];\r\n\t\t\t} else {\r\n\t\t\t\tthrow Error(\"Cannot recover from missing StripByteCounts\");\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\t// Loop through strips and decompress as necessary.\r\n\t\tfor (var i = 0; i < numStripOffsetValues; i++) {\r\n\t\t\tvar stripOffset = stripOffsetValues[i];\r\n\t\t\tstrips[i] = [];\r\n\r\n\t\t\tvar stripByteCount = stripByteCountValues[i];\r\n\r\n\t\t\t// Loop through pixels.\r\n\t\t\tfor (var byteOffset = 0, bitOffset = 0, jIncrement = 1, getHeader = true, pixel = [], numBytes = 0, sample = 0, currentSample = 0; byteOffset < stripByteCount; byteOffset += jIncrement) {\r\n\t\t\t\t// Decompress strip.\r\n\t\t\t\tswitch (compression) {\r\n\t\t\t\t\t// Uncompressed\r\n\t\t\t\t\tcase 1:\r\n\t\t\t\t\t\t// Loop through samples (sub-pixels).\r\n\t\t\t\t\t\tfor (var m = 0, pixel = []; m < samplesPerPixel; m++) {\r\n\t\t\t\t\t\t\tif (sampleProperties[m].hasBytesPerSample) {\r\n\t\t\t\t\t\t\t\t// XXX: This is wrong!\r\n\t\t\t\t\t\t\t\tvar sampleOffset = sampleProperties[m].bytesPerSample * m;\r\n\r\n\t\t\t\t\t\t\t\tpixel.push(this.getBytes(sampleProperties[m].bytesPerSample, stripOffset + byteOffset + sampleOffset));\r\n\t\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\t\tvar sampleInfo = this.getBits(sampleProperties[m].bitsPerSample, stripOffset + byteOffset, bitOffset);\r\n\r\n\t\t\t\t\t\t\t\tpixel.push(sampleInfo.bits);\r\n\r\n\t\t\t\t\t\t\t\tbyteOffset = sampleInfo.byteOffset - stripOffset;\r\n\t\t\t\t\t\t\t\tbitOffset = sampleInfo.bitOffset;\r\n\r\n\t\t\t\t\t\t\t\tthrow RangeError(\"Cannot handle sub-byte bits per sample\");\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\tstrips[i].push(pixel);\r\n\r\n\t\t\t\t\t\tif (hasBytesPerPixel) {\r\n\t\t\t\t\t\t\tjIncrement = bytesPerPixel;\r\n\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\tjIncrement = 0;\r\n\r\n\t\t\t\t\t\t\tthrow RangeError(\"Cannot handle sub-byte bits per pixel\");\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\tbreak;\r\n\r\n\t\t\t\t\t// CITT Group 3 1-Dimensional Modified Huffman run-length encoding\r\n\t\t\t\t\tcase 2:\r\n\t\t\t\t\t\t// XXX: Use PDF.js code?\r\n\t\t\t\t\tbreak;\r\n\r\n\t\t\t\t\t// Group 3 Fax\r\n\t\t\t\t\tcase 3:\r\n\t\t\t\t\t\t// XXX: Use PDF.js code?\r\n\t\t\t\t\tbreak;\r\n\r\n\t\t\t\t\t// Group 4 Fax\r\n\t\t\t\t\tcase 4:\r\n\t\t\t\t\t\t// XXX: Use PDF.js code?\r\n\t\t\t\t\tbreak;\r\n\r\n\t\t\t\t\t// LZW\r\n\t\t\t\t\tcase 5:\r\n\t\t\t\t\t\t// XXX: Use PDF.js code?\r\n\t\t\t\t\tbreak;\r\n\r\n\t\t\t\t\t// Old-style JPEG (TIFF 6.0)\r\n\t\t\t\t\tcase 6:\r\n\t\t\t\t\t\t// XXX: Use PDF.js code?\r\n\t\t\t\t\tbreak;\r\n\r\n\t\t\t\t\t// New-style JPEG (TIFF Specification Supplement 2)\r\n\t\t\t\t\tcase 7:\r\n\t\t\t\t\t\t// XXX: Use PDF.js code?\r\n\t\t\t\t\tbreak;\r\n\r\n\t\t\t\t\t// PackBits\r\n\t\t\t\t\tcase 32773:\r\n\t\t\t\t\t\t// Are we ready for a new block?\r\n\t\t\t\t\t\tif (getHeader) {\r\n\t\t\t\t\t\t\tgetHeader = false;\r\n\r\n\t\t\t\t\t\t\tvar blockLength = 1;\r\n\t\t\t\t\t\t\tvar iterations = 1;\r\n\r\n\t\t\t\t\t\t\t// The header byte is signed.\r\n\t\t\t\t\t\t\tvar header = this.tiffDataView.getInt8(stripOffset + byteOffset, this.littleEndian);\r\n\r\n\t\t\t\t\t\t\tif ((header >= 0) && (header <= 127)) { // Normal pixels.\r\n\t\t\t\t\t\t\t\tblockLength = header + 1;\r\n\t\t\t\t\t\t\t} else if ((header >= -127) && (header <= -1)) { // Collapsed pixels.\r\n\t\t\t\t\t\t\t\titerations = -header + 1;\r\n\t\t\t\t\t\t\t} else /*if (header === -128)*/ { // Placeholder byte?\r\n\t\t\t\t\t\t\t\tgetHeader = true;\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\tvar currentByte = this.getBytes(1, stripOffset + byteOffset);\r\n\r\n\t\t\t\t\t\t\t// Duplicate bytes, if necessary.\r\n\t\t\t\t\t\t\tfor (var m = 0; m < iterations; m++) {\r\n\t\t\t\t\t\t\t\tif (sampleProperties[sample].hasBytesPerSample) {\r\n\t\t\t\t\t\t\t\t\t// We're reading one byte at a time, so we need to handle multi-byte samples.\r\n\t\t\t\t\t\t\t\t\tcurrentSample = (currentSample << (8 * numBytes)) | currentByte;\r\n\t\t\t\t\t\t\t\t\tnumBytes++;\r\n\r\n\t\t\t\t\t\t\t\t\t// Is our sample complete?\r\n\t\t\t\t\t\t\t\t\tif (numBytes === sampleProperties[sample].bytesPerSample) {\r\n\t\t\t\t\t\t\t\t\t\tpixel.push(currentSample);\r\n\t\t\t\t\t\t\t\t\t\tcurrentSample = numBytes = 0;\r\n\t\t\t\t\t\t\t\t\t\tsample++;\r\n\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\t\t\tthrow RangeError(\"Cannot handle sub-byte bits per sample\");\r\n\t\t\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\t\t\t// Is our pixel complete?\r\n\t\t\t\t\t\t\t\tif (sample === samplesPerPixel)\r\n\t\t\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\t\t\tstrips[i].push(pixel);\r\n\r\n\t\t\t\t\t\t\t\t\tpixel = [];\r\n\t\t\t\t\t\t\t\t\tsample = 0;\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\t\tblockLength--;\r\n\r\n\t\t\t\t\t\t\t// Is our block complete?\r\n\t\t\t\t\t\t\tif (blockLength === 0) {\r\n\t\t\t\t\t\t\t\tgetHeader = true;\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\tjIncrement = 1;\r\n\t\t\t\t\tbreak;\r\n\r\n\t\t\t\t\t// Unknown compression algorithm\r\n\t\t\t\t\tdefault:\r\n\t\t\t\t\t\t// Do not attempt to parse the image data.\r\n\t\t\t\t\tbreak;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n//\t\t\tconsole.log( strips[i] );\r\n\t\t}\r\n\r\n//\t\tconsole.log( strips );\r\n\r\n\t\tif (canvas.getContext) {\r\n\t\t\tvar ctx = this.canvas.getContext(\"2d\");\r\n\r\n\t\t\t// Set a default fill style.\r\n\t\t\tctx.fillStyle = this.makeRGBAFillValue(255, 255, 255, 0);\r\n\r\n\t\t\t// If RowsPerStrip is missing, the whole image is in one strip.\r\n\t\t\tif (fileDirectory.RowsPerStrip) {\r\n\t\t\t\tvar rowsPerStrip = fileDirectory.RowsPerStrip.values[0];\r\n\t\t\t} else {\r\n\t\t\t\tvar rowsPerStrip = imageLength;\r\n\t\t\t}\r\n\r\n\t\t\tvar numStrips = strips.length;\r\n\r\n\t\t\tvar imageLengthModRowsPerStrip = imageLength % rowsPerStrip;\r\n\t\t\tvar rowsInLastStrip = (imageLengthModRowsPerStrip === 0) ? rowsPerStrip : imageLengthModRowsPerStrip;\r\n\r\n\t\t\tvar numRowsInStrip = rowsPerStrip;\r\n\t\t\tvar numRowsInPreviousStrip = 0;\r\n\r\n\t\t\tvar photometricInterpretation = fileDirectory.PhotometricInterpretation.values[0];\r\n\r\n\t\t\tvar extraSamplesValues = [];\r\n\t\t\tvar numExtraSamples = 0;\r\n\r\n\t\t\tif (fileDirectory.ExtraSamples) {\r\n\t\t\t\textraSamplesValues = fileDirectory.ExtraSamples.values;\r\n\t\t\t\tnumExtraSamples = extraSamplesValues.length;\r\n\t\t\t}\r\n\r\n\t\t\tif (fileDirectory.ColorMap) {\r\n\t\t\t\tvar colorMapValues = fileDirectory.ColorMap.values;\r\n\t\t\t\tvar colorMapSampleSize = Math.pow(2, sampleProperties[0].bitsPerSample);\r\n\t\t\t}\r\n\r\n\t\t\t// Loop through the strips in the image.\r\n\t\t\tfor (var i = 0; i < numStrips; i++) {\r\n\t\t\t\t// The last strip may be short.\r\n\t\t\t\tif ((i + 1) === numStrips) {\r\n\t\t\t\t\tnumRowsInStrip = rowsInLastStrip;\r\n\t\t\t\t}\r\n\r\n\t\t\t\tvar numPixels = strips[i].length;\r\n\t\t\t\tvar yPadding = numRowsInPreviousStrip * i;\r\n\r\n\t\t\t\t// Loop through the rows in the strip.\r\n\t\t\t\tfor (var y = 0, j = 0; y < numRowsInStrip, j < numPixels; y++) {\r\n\t\t\t\t\t// Loop through the pixels in the row.\r\n\t\t\t\t\tfor (var x = 0; x < imageWidth; x++, j++) {\r\n\t\t\t\t\t\tvar pixelSamples = strips[i][j];\r\n\r\n\t\t\t\t\t\tvar red = 0;\r\n\t\t\t\t\t\tvar green = 0;\r\n\t\t\t\t\t\tvar blue = 0;\r\n\t\t\t\t\t\tvar opacity = 1.0;\r\n\r\n\t\t\t\t\t\tif (numExtraSamples > 0) {\r\n\t\t\t\t\t\t\tfor (var k = 0; k < numExtraSamples; k++) {\r\n\t\t\t\t\t\t\t\tif (extraSamplesValues[k] === 1 || extraSamplesValues[k] === 2) {\r\n\t\t\t\t\t\t\t\t\t// Clamp opacity to the range [0,1].\r\n\t\t\t\t\t\t\t\t\topacity = pixelSamples[3 + k] / 256;\r\n\r\n\t\t\t\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\tswitch (photometricInterpretation) {\r\n\t\t\t\t\t\t\t// Bilevel or Grayscale\r\n\t\t\t\t\t\t\t// WhiteIsZero\r\n\t\t\t\t\t\t\tcase 0:\r\n\t\t\t\t\t\t\t\tif (sampleProperties[0].hasBytesPerSample) {\r\n\t\t\t\t\t\t\t\t\tvar invertValue = Math.pow(0x10, sampleProperties[0].bytesPerSample * 2);\r\n\t\t\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\t\t\t// Invert samples.\r\n\t\t\t\t\t\t\t\tpixelSamples.forEach(function(sample, index, samples) { samples[index] = invertValue - sample; });\r\n\r\n\t\t\t\t\t\t\t// Bilevel or Grayscale\r\n\t\t\t\t\t\t\t// BlackIsZero\r\n\t\t\t\t\t\t\tcase 1:\r\n\t\t\t\t\t\t\t\tred = green = blue = this.clampColorSample(pixelSamples[0], sampleProperties[0].bitsPerSample);\r\n\t\t\t\t\t\t\tbreak;\r\n\r\n\t\t\t\t\t\t\t// RGB Full Color\r\n\t\t\t\t\t\t\tcase 2:\r\n\t\t\t\t\t\t\t\tred = this.clampColorSample(pixelSamples[0], sampleProperties[0].bitsPerSample);\r\n\t\t\t\t\t\t\t\tgreen = this.clampColorSample(pixelSamples[1], sampleProperties[1].bitsPerSample);\r\n\t\t\t\t\t\t\t\tblue = this.clampColorSample(pixelSamples[2], sampleProperties[2].bitsPerSample);\r\n\t\t\t\t\t\t\tbreak;\r\n\r\n\t\t\t\t\t\t\t// RGB Color Palette\r\n\t\t\t\t\t\t\tcase 3:\r\n\t\t\t\t\t\t\t\tif (colorMapValues === undefined) {\r\n\t\t\t\t\t\t\t\t\tthrow Error(\"Palette image missing color map\");\r\n\t\t\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\t\t\tvar colorMapIndex = pixelSamples[0];\r\n\r\n\t\t\t\t\t\t\t\tred = this.clampColorSample(colorMapValues[colorMapIndex], 16);\r\n\t\t\t\t\t\t\t\tgreen = this.clampColorSample(colorMapValues[colorMapSampleSize + colorMapIndex], 16);\r\n\t\t\t\t\t\t\t\tblue = this.clampColorSample(colorMapValues[(2 * colorMapSampleSize) + colorMapIndex], 16);\r\n\t\t\t\t\t\t\tbreak;\r\n\r\n\t\t\t\t\t\t\t// Transparency mask\r\n\t\t\t\t\t\t\tcase 4:\r\n\t\t\t\t\t\t\t\tthrow RangeError( 'Not Yet Implemented: Transparency mask' );\r\n\t\t\t\t\t\t\tbreak;\r\n\r\n\t\t\t\t\t\t\t// CMYK\r\n\t\t\t\t\t\t\tcase 5:\r\n\t\t\t\t\t\t\t\tthrow RangeError( 'Not Yet Implemented: CMYK' );\r\n\t\t\t\t\t\t\tbreak;\r\n\r\n\t\t\t\t\t\t\t// YCbCr\r\n\t\t\t\t\t\t\tcase 6:\r\n\t\t\t\t\t\t\t\tthrow RangeError( 'Not Yet Implemented: YCbCr' );\r\n\t\t\t\t\t\t\tbreak;\r\n\r\n\t\t\t\t\t\t\t// CIELab\r\n\t\t\t\t\t\t\tcase 8:\r\n\t\t\t\t\t\t\t\tthrow RangeError( 'Not Yet Implemented: CIELab' );\r\n\t\t\t\t\t\t\tbreak;\r\n\r\n\t\t\t\t\t\t\t// Unknown Photometric Interpretation\r\n\t\t\t\t\t\t\tdefault:\r\n\t\t\t\t\t\t\t\tthrow RangeError( 'Unknown Photometric Interpretation:', photometricInterpretation );\r\n\t\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\tctx.fillStyle = this.makeRGBAFillValue(red, green, blue, opacity);\r\n\t\t\t\t\t\tctx.fillRect(x, yPadding + y, 1, 1);\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\r\n\t\t\t\tnumRowsInPreviousStrip = numRowsInStrip;\r\n\t\t\t}\r\n\t\t}\r\n\r\n/*\t\tfor (var i = 0, numFileDirectories = this.fileDirectories.length; i < numFileDirectories; i++) {\r\n\t\t\t// Stuff\r\n\t\t}*/\r\n\r\n\t\treturn this.canvas;\r\n\t},\r\n}\r\n// if (typeof module === \"undefined\") {\r\n//     this.TIFFParser = TIFFParser;\r\n// } else {\r\n//     module.exports = TIFFParser;\r\n// }\r\n// if (typeof define === \"function\") {\r\n//     define(function () { return TIFFParser; });\r\n// }\r\nexport default TIFFParser;\r\n","﻿import CSG from '../ThirdParty/csg/csg.js';\r\n\r\n/**\r\n*@param {Cesium.Geometry}\r\n*@param {Cesium.Cartesian3}[offset]\r\n*@return {CSG}\r\n*/\r\nCSG.toCSG = function (geometry, offset) {\r\n    if (!offset) {\r\n        offset = { x: 0, y: 0, z: 0 };\r\n    }\r\n    if (!geometry.attributes.normal) {\r\n        geometry = Cesium.GeometryPipeline.computeNormal(geometry);\r\n    }\r\n    if (geometry.primitiveType !== Cesium.PrimitiveType.TRIANGLES) {\r\n        throw new Error(\"暂不支持此类几何体\");\r\n    }\r\n     \r\n    var polygons = [], vertices = [];\r\n    var positions = geometry.attributes.position.values;\r\n    var normals = geometry.attributes.normal.values;\r\n    var normalIdx = 0, positionIdx = 0;\r\n\r\n    for (var i = 0; i < geometry.indices.length; i += 3) {\r\n        vertices = [];\r\n\r\n        var idx1 = geometry.indices[i];\r\n        var idx2 = geometry.indices[i + 1];\r\n        var idx3 = geometry.indices[i + 2];\r\n\r\n        positionIdx = idx1 * 3;\r\n        normalIdx = idx1 * 3;\r\n\r\n        vertices.push(new CSG.Vertex(\r\n            [positions[positionIdx++] + offset.x, positions[positionIdx++] + offset.y, positions[positionIdx++] + offset.z],\r\n            [normals[normalIdx++], normals[normalIdx++], normals[normalIdx++]]\r\n        ));\r\n\r\n        positionIdx = idx2 * 3;\r\n        normalIdx = idx2 * 3;\r\n        vertices.push(new CSG.Vertex(\r\n            [positions[positionIdx++] + offset.x, positions[positionIdx++] + offset.y, positions[positionIdx++] + offset.z],\r\n            [normals[normalIdx++], normals[normalIdx++], normals[normalIdx++]]\r\n        ));\r\n\r\n        positionIdx = idx3 * 3;\r\n        normalIdx = idx3 * 3;\r\n        vertices.push(new CSG.Vertex(\r\n            [positions[positionIdx++] + offset.x, positions[positionIdx++] + offset.y, positions[positionIdx++] + offset.z],\r\n            [normals[normalIdx++], normals[normalIdx++], normals[normalIdx++]]\r\n        ));\r\n        polygons.push(new CSG.Polygon(vertices));\r\n    }\r\n    return CSG.fromPolygons(polygons);\r\n}\r\n/**\r\n*@param {CSG}csg_model\r\n*@return {Cesium.Geometry}\r\n*/\r\nCSG.fromCSG = function (csg_model) {\r\n    var i, j, vertices,\r\n        polygons = csg_model.toPolygons();\r\n\r\n    if (!CSG) {\r\n        throw new Error('CSG 库未加载。请从 https://github.com/evanw/csg.js 获取');\r\n    }\r\n\r\n    var positions = [];\r\n    var normals = [];\r\n    var indices = [];\r\n\r\n    for (i = 0; i < polygons.length; i++) {\r\n\r\n        // Vertices\r\n        vertices = [];\r\n        for (j = 0; j < polygons[i].vertices.length; j++) {\r\n            vertices.push(this.getGeometryVertice(positions, normals, polygons[i].vertices[j].pos, polygons[i].plane.normal));\r\n        }\r\n        if (vertices[0] === vertices[vertices.length - 1]) {\r\n            vertices.pop();\r\n        }\r\n\r\n        for (var j = 2; j < vertices.length; j++) {\r\n            indices.push(vertices[0], vertices[j - 1], vertices[j]);\r\n        }\r\n    }\r\n\r\n    positions = new Float32Array(positions);\r\n    normals = new Float32Array(normals);\r\n\r\n    indices = new Int32Array(indices);\r\n    var attributes = {};\r\n    attributes.position = new Cesium.GeometryAttribute({\r\n        componentDatatype: Cesium.ComponentDatatype.FLOAT,\r\n        componentsPerAttribute: 3,\r\n        values: positions\r\n    });\r\n    attributes.normal = new Cesium.GeometryAttribute({\r\n        componentDatatype: Cesium.ComponentDatatype.FLOAT,\r\n        componentsPerAttribute: 3,\r\n        values: normals\r\n    });\r\n\r\n    var cesGeometry = new Cesium.Geometry({\r\n        attributes: attributes,\r\n        indices: indices,\r\n        primitiveType: Cesium.PrimitiveType.TRIANGLES\r\n    });\r\n\r\n    return cesGeometry;\r\n}\r\n/**\r\n*@param {Array<Number>}positions\r\n*@param {Array<Number>}normals\r\n*@param {Cesium.CSG.Vector}vertice_position\r\n*@param {Cesium.CSG.Vector}plane_normal\r\n*@return {Number}\r\n*@private\r\n*/\r\nCSG.getGeometryVertice = function (positions, normals, vertice_position, plane_normal) {\r\n    var i, idx = 0;\r\n    for (i = 0; i < positions.length; i += 3) {\r\n        if (positions[i] === vertice_position.x\r\n            && positions[i + 1] === vertice_position.y\r\n            && positions[i + 2] === vertice_position.z) {\r\n            // Vertice already exists\r\n            return idx;\r\n        }\r\n        idx++;\r\n    };\r\n\r\n    positions.push(vertice_position.x, vertice_position.y, vertice_position.z);\r\n    normals.push(plane_normal.x, plane_normal.y, plane_normal.z);\r\n    return idx;\r\n}\r\n\r\nexport default CSG;"," \r\n/**\r\n*@class\r\n*@memberof Cesium\r\n*/\r\nfunction Path() { }\r\n/**\r\n*\r\n*获取文件扩展名（后缀）\r\n*@param {String}fname 文件名\r\n*/\r\nPath.GetExtension = function (fname) {\r\n    var start = fname.lastIndexOf(\".\");\r\n    if (start >= 0) {\r\n        return fname.substring(start, fname.length);\r\n    }\r\n    return \"\";\r\n}\r\n\r\n/**\r\n*\r\n*获取文件扩展名（后缀）\r\n*@param {String}fname 文件名\r\n*/\r\nPath.GetFileName = function (fname) {\r\n    var start = fname.lastIndexOf(\"/\");\r\n    if (start < 0) {\r\n        return fname;\r\n    }\r\n    return fname.substring(start + 1, fname.length);\r\n}\r\n/**\r\n*\r\n*获取文件夹\r\n*@param {String}fname 文件名\r\n*/\r\nPath.GetDirectoryName = function (fname) {\r\n    var start = fname.lastIndexOf(\"/\");\r\n    if (start < 0) {\r\n        return \"\";\r\n    }\r\n    return fname.substring(0, start);\r\n}\r\n/**\r\n*\r\n*获取文件夹\r\n*@param {String}fname 文件名\r\n*/\r\nPath.Combine = function (dir, fname) {\r\n    return dir + fname;\r\n}\r\nPath.ChangeExtension = function (fname, newExt) {\r\n    return fname.replace(Path.GetExtension(fname), newExt);\r\n}\r\n \r\nexport default Path;","﻿\r\n/**\r\n*定义属性，并监听属性变化事件,属性值的数据类型可以实现equals接口用于进行更进一步的比较\r\n*@param {Object}owner\r\n*@param {String}name\r\n*@param {Any}defaultVal\r\n*@param {(\r\n        changed: string, owner: object, newVal: *, oldVal: *\r\n        ) => void}onChanged\r\n*@memberof Cesium\r\n*/\r\nfunction defineProperty(owner, name, defaultVal, onChanged) {\r\n    owner[\"_\" + name] = defaultVal;\r\n    var value = {\r\n        get: function () {\r\n            return this[\"_\" + name];\r\n        },\r\n        set: function (val) {\r\n            var changed = val != this[\"_\" + name];\r\n            if (this[\"_\" + name] && this[\"_\" + name].equals && val) {\r\n                changed = this[\"_\" + name].equals(val);\r\n            }\r\n            var oldVal = this[\"_\" + name];\r\n            this[\"_\" + name] = val;\r\n            if (typeof onChanged == 'function' && changed) {\r\n                onChanged(changed, owner, val, oldVal);\r\n            }\r\n        }\r\n    };\r\n    var properties = {};\r\n    properties[name] = value;\r\n    Object.defineProperties(owner, properties)\r\n}\r\n\r\nexport default defineProperty;"]}